var DragDropTouch;function BulbToastService(e){this.show=function(t){e.defaultOptions.message=t,iziToast.show(e.defaultOptions)}}function getSearchTestData(){return{fake0Results:{totalResults:0,query:"nothing",from:0,unitDTOs:[]},fake1Result:{totalResults:1,query:"page 1",from:0,unitDTOs:[{"@c":".PublishedPageUnitDTO",id:"54f74eb2da06d990f409b14d",parentId:"54f74eb0da06d990f409b14a",name:"Page 1",description:"Page 1",likeCount:0,likedByUser:!1,unitType:"PublishedPageUnit",accentIndex:5,path:"page-1",permissions:["CREATE","READ","UPDATE","DELETE","GRANT"],recurseChildren:!1,publishedDate:"2015-03-04T18:31:43Z"}]},fakeFirst10of12Results:{totalResults:12,query:"page",from:0,unitDTOs:[{"@c":".PublishedPageUnitDTO",id:"54f62e87da06d990f409b09d",parentId:"54f62e7ada06d990f409b096",name:"Page 1",description:"Page 1",likeCount:0,likedByUser:!1,unitType:"PublishedPageUnit",accentIndex:4,path:"page-1",permissions:["CREATE","READ","UPDATE","DELETE","GRANT"],recurseChildren:!1,publishedDate:"2015-03-03T22:06:43Z"},{"@c":".PublishedPageUnitDTO",id:"54f74f97da06d990f409b160",parentId:"54f74eb0da06d990f409b14a",name:"Page 2",description:"Page 2",likeCount:0,likedByUser:!1,unitType:"PublishedPageUnit",accentIndex:5,path:"page-2",permissions:["CREATE","READ","UPDATE","DELETE","GRANT"],recurseChildren:!1,publishedDate:"2015-03-04T18:32:22Z"},{"@c":".PublishedPageUnitDTO",id:"54f74eb2da06d990f409b14d",parentId:"54f74eb0da06d990f409b14a",name:"Page 3",description:"Page 3",likeCount:0,likedByUser:!1,unitType:"PublishedPageUnit",accentIndex:5,path:"page-3",permissions:["CREATE","READ","UPDATE","DELETE","GRANT"],recurseChildren:!1,publishedDate:"2015-03-04T18:31:43Z"},{"@c":".PublishedPageUnitDTO",id:"54f62f0bda06d990f409b0c1",parentId:"54f62f09da06d990f409b0be",name:"Page 4",description:"Page 4",likeCount:0,likedByUser:!1,unitType:"PublishedPageUnit",accentIndex:5,path:"page-4",permissions:["CREATE","READ","UPDATE","DELETE","GRANT"],recurseChildren:!1,publishedDate:"2015-03-03T22:06:23Z"},{"@c":".PublishedPageUnitDTO",id:"54f74fbada06d990f409b173",parentId:"54f74eb0da06d990f409b14a",name:"Page 5",description:"Page 5",likeCount:0,likedByUser:!1,unitType:"PublishedPageUnit",accentIndex:5,path:"page-5",permissions:["CREATE","READ","UPDATE","DELETE","GRANT"],recurseChildren:!1,publishedDate:"2015-03-04T18:32:55Z"},{"@c":".PublishedPageUnitDTO",id:"54f74fdbda06d990f409b186",parentId:"54f74eb0da06d990f409b14a",name:"Page 6",description:"Page 6",likeCount:0,likedByUser:!1,unitType:"PublishedPageUnit",accentIndex:5,path:"page-6",permissions:["CREATE","READ","UPDATE","DELETE","GRANT"],recurseChildren:!1,publishedDate:"2015-03-04T18:33:31Z"},{"@c":".PublishedPageUnitDTO",id:"54f8760bda06d990f409b1b3",parentId:"54f74eb0da06d990f409b14a",name:"Page 7",description:"Page 7",likeCount:0,likedByUser:!1,unitType:"PublishedPageUnit",accentIndex:5,path:"page-7",permissions:["CREATE","READ","UPDATE","DELETE","GRANT"],recurseChildren:!1,publishedDate:"2015-03-05T15:28:45Z"},{"@c":".PublishedPageUnitDTO",id:"54f87632da06d990f409b1c6",parentId:"54f74eb0da06d990f409b14a",name:"Page 8",description:"Page 8",likeCount:0,likedByUser:!1,unitType:"PublishedPageUnit",accentIndex:5,path:"page-8",permissions:["CREATE","READ","UPDATE","DELETE","GRANT"],recurseChildren:!1,publishedDate:"2015-03-05T15:29:17Z"},{"@c":".PublishedPageUnitDTO",id:"54f87653da06d990f409b1d9",parentId:"54f74eb0da06d990f409b14a",name:"Page 9",description:"Page 9",likeCount:0,likedByUser:!1,unitType:"PublishedPageUnit",accentIndex:5,path:"page-9",permissions:["CREATE","READ","UPDATE","DELETE","GRANT"],recurseChildren:!1,publishedDate:"2015-03-05T15:30:25Z"},{"@c":".PublishedPageUnitDTO",id:"54f87696da06d990f409b1ec",parentId:"54f74eb0da06d990f409b14a",name:"Page 10",description:"Page 10",likeCount:0,likedByUser:!1,unitType:"PublishedPageUnit",accentIndex:5,path:"page-10",permissions:["CREATE","READ","UPDATE","DELETE","GRANT"],recurseChildren:!1,publishedDate:"2015-03-05T15:31:00Z"}]},fakeLast2of12Results:{totalResults:12,query:"page",from:10,unitDTOs:[{"@c":".CompositeUnitDTO",id:"54f74eb0da06d990f409b14a",parentId:"54f629f6da06d990f409b038",name:"Collection of pages",description:"Collection of pages",likeCount:0,likedByUser:!1,unitType:"CompositeUnit",accentIndex:5,path:"collection-of-pages",permissions:["CREATE","READ","UPDATE","DELETE","GRANT"],recurseChildren:!1,children:[]},{"@c":".PublishedPageUnitDTO",id:"54f62fb2da06d990f409b0e5",parentId:"54f62fb0da06d990f409b0e2",name:"Page 11",description:"Page 11",likeCount:0,likedByUser:!1,unitType:"PublishedPageUnit",accentIndex:2,path:"page-11",permissions:["CREATE","READ","UPDATE","DELETE","GRANT"],recurseChildren:!1,publishedDate:"2015-03-04T15:52:23Z"}]}}}function AssetLibraryGooglePhotoController(e,t,n,o,i){var r=this;this.stopBusyIndicatorCallback=null,this.selectedAlbumName="",this.selectedMediaItemId=[],this.selectedAlbumId="",this.query=null,this.currentView="tiles",this.mediaItemsFound=!0,this.isAscending=!0,this.isSearch=!1;var a=o;function s(e){r.query="",r.mediaItemsFound=r.mediaItemList.length>0,r.stopBusyIndicatorCallback&&r.stopBusyIndicatorCallback()}function l(){$(".bulb-assetlibrary-googlephoto-scrollbox").scrollTop(0),a=o}this.mediaItemList=t.mediaItemList.slice(0,o),this.albumList=t.albumList,this.allowMultipleSelection=t.allowMultipleSelection,this.showOnlyVideo=t.showOnlyVideo,this.switchView=function(e){r.selectedMediaItemId.length=0,r.currentView=e},this.openAlbum=function(e,i){var a=this;r.stopBusyIndicatorCallback=n.showBusy(),t.getAlbumPhotos(e,!0).then(function(e){l(),a.mediaItemList=t.mediaItemList.slice(0,o),s(),r.selectedAlbumName=i,r.isSearch=!1},function(e){r.stopBusyIndicatorCallback()})},this.showMediaItems=function(){var e=this;r.selectedAlbumId=null,r.selectedMediaItemId.length=0,r.stopBusyIndicatorCallback=n.showBusy(),t.getAlbumPhotos(null,!0).then(function(n){l(),e.mediaItemList=t.mediaItemList.slice(0,o),s(),r.albumList=t.albumList,r.selectedAlbumName="",r.isSearch=!1},function(e){console.log("Error while fetching media items",e),r.stopBusyIndicatorCallback()})},this.getMediaItems=function(){r.query||r.isAscending&&(r.mediaItemList.length!=t.mediaItemList.length&&(r.mediaItemList=r.mediaItemList.concat(t.mediaItemList.slice(a,a+o)),a+=o),t.nextPhotoPageToken&&t.getAlbumPhotos(r.selectedAlbumId,!1).then(function(e){},function(e){console.log("Error while fetching media items",e)}))},this.selectPhoto=function(e){var t=r.selectedMediaItemId.indexOf(e);t>-1?r.selectedMediaItemId.splice(t,1):(r.allowMultipleSelection||(r.selectedMediaItemId.length=0),r.selectedMediaItemId.push(e)),r.selectedAlbumId=""},this.selectAlbum=function(e){r.selectedAlbumId=e,r.selectedMediaItemId.length=0},this.uploadSelectedPhoto=function(){e.dialog.closeCurrentModal(),t.selectPhotoHandler(r.selectedMediaItemId)},this.searchPhoto=function(){if(l(),!r.query)return r.isSearch=!1,r.mediaItemList=t.mediaItemList.slice(0,o),void(r.albumList=t.albumList);r.isSearch=!0,r.mediaItemList=i.filter(t.mediaItemList,function(e){return e.filename.toLowerCase().indexOf(r.query.toLowerCase())>-1}),r.albumList=i.filter(t.albumList,function(e){return e.title.toLowerCase().indexOf(r.query.toLowerCase())>-1})},this.sortList=function(){l(),r.isAscending?(r.mediaItemList=i.sortBy(r.mediaItemList,"filename"),r.albumList=i.sortBy(r.albumList,"title")):(r.mediaItemList=i.sortBy(r.mediaItemList,"filename").reverse(),r.albumList=i.sortBy(r.albumList,"title").reverse()),r.isAscending=!r.isAscending},this.queryOnKeyDown=function(e){switch(e.keyCode){case 13:r.query=e.currentTarget.value,r.searchPhoto()}},this.cancel=function(){e.dialog.closeCurrentModal()}}BulbToastService.$inject=["IZITOAST"],AssetLibraryGooglePhotoController.$inject=["BulbAssetLibraryService","BulbAssetLibraryGooglePhotoService","BulbBusyCoverService","MAX_ITEM_THRESHOLD_SIZE","_"],AgeVerificationController.$inject=["$log","$modalStack","$scope","$state","$translate","$window","moment","BulbAuthService","BulbBusyService","BulbModalService","Restangular","CONFIG"],OffBoardingController.$inject=["$log","$translate","$modalStack","moment","BulbAuthService","BulbBusyService","Restangular"],DeletedUnitBlockController.$inject=["$animateCss","$element","$scope","$state","$translate","iziToast","BulbAuthService","BulbBlockViewSwitcherService","BulbBusyCoverService","BulbDeletedUnitService","BulbErrorService","BulbModalService","magnitudeFilter","CONFIG","_"],function(){"use strict";function e(e,t,n,o,i,r,a,s,l){var c=this;function u(){return n.current.name.replace(/[^a-zA-Z0-9]/g,"-")}this.currentUser=e,this.state=u(),t.$on("$stateChangeSuccess",function(){c.state=u()}),o.verifyEmail&&this.currentUser.email&&(this.verifyEmail=this.currentUser.email),this.wrapInSpan=function(e){return"<span>"+e+"</span>"},this.resendEmailVerification=function(){a.showBusyDuring(r.one("accounts",c.currentUser.id).customOperation("post","sendEmailVerification").then(function(e){var t=c.wrapInSpan(c.currentUser.pendingEmail||c.currentUser.email);i("account_settings_verify_email_resent",{email:t}).then(function(e){var t={titleCode:"account_settings_verify_email_title",bodyText:e,showOkButton:!1,showCancelButton:!1};l.show(t)})},function(e){s.error("Cannot send email verification",e)}))}}e.$inject=["currentUser","$scope","$state","$stateParams","$translate","Restangular","BulbBusyService","BulbErrorService","BulbModalService"],angular.module("bulbApp.applicationModule",[]).controller("ApplicationController",e)}(),angular.module("bulbApp.accountModule",["angularPayments","googleModule","lodash","mm.foundation","stripeModule","ui.router","ui.select","bulbApp.authModule","bulbApp.badgesModule","bulbApp.busyModule","bulbApp.configModule","bulbApp.errorModule","bulbApp.filtersModule","bulbApp.jwplayerModule","bulbApp.modalModule","bulbApp.translateModule","bulbApp.validationModule"]).constant("ACCOUNT",{PLAN_PREFIX:"account_settings_plan_",CUSTOM_PLAN_PREFIX:"account_settings_custom_plan_"}).run(["$rootScope","ACCOUNT",function(e,t){e.ACCOUNT=t}]).config(["$stateProvider","AUTH","CONFIG",function(e,t,n){e.state("account",{parent:"bulbView",abstract:!0,url:"^/b/account",resolve:{account:["currentUser","Restangular",function(e,t){return t.one("accounts",e.username).get()}]},views:{bulbView:{template:"<ui-view/>"}}}).state("account.settings",{url:"/settings?errorConnected",params:{book:{value:!1,squash:!0},errorConnected:{value:"",squash:!0}},resolve:{$title:["$translate",function(e){return e("account_settings_title")}]},templateUrl:n.resource.cdnRoot+"ajs/account/accountsettings.html",controller:"AccountSettingsController as accountSettingsCtrl",bulbAuth:{authorizedRoles:[t.ROLES.REGISTERED_USER]}}).state("account.options",{url:"/planoptions/{category}",params:{category:{value:"EDUCATION",squash:!0}},resolve:{planInfo:["$http",function(e){return e.get(n.resource.path+"/public/planinfo.json").then(function(e){return e.data})}],$title:["$translate",function(e){return e("account_plan_customization_title")}]},views:{"header@root":{templateUrl:n.resource.cdnRoot+"ajs/components/auth/bulb-header.html",controller:"BulbHeaderController as bulbHeaderCtrl"},"content@root":{templateUrl:n.resource.cdnRoot+"ajs/account/accountoptions.html",controller:"AccountOptionsController as accountOptionsCtrl"}},onEnter:["$state",function(e){e.go("account.billing",{mode:"new",category:this.category,period:this.selectedPeriodCode,institutionName:this.institutionName,numberOfAccounts:this.numberOfAccounts})}]}).state("account.billing",{url:"/billing/{mode}/{institutionName}",params:{mode:{value:"CURRENT",squash:!1},period:{value:"YEAR",squash:!0},category:{value:"STANDARD",squash:!0},institutionName:{value:"",squash:!0},numberOfAccounts:{value:1,squash:!0}},resolve:{billingInfo:["currentUser","Restangular",function(e,t){return t.one("accounts",e.id).customGET("billing")}],planInfo:["$http",function(e){return e.get(n.resource.path+"/public/planinfo.json").then(function(e){return e.data})}],$title:["$translate",function(e){return e("account_billing_title")}]},views:{"header@root":{templateUrl:n.resource.cdnRoot+"ajs/components/auth/bulb-header.html",controller:"BulbHeaderController as bulbHeaderCtrl"},"content@root":{templateUrl:n.resource.cdnRoot+"ajs/account/accountbilling.html",controller:"AccountBillingController as accountBillingCtrl"}},onEnter:["$state","$stateParams","_",function(e,t,n){t.mode=t.mode.toUpperCase(),t.category=t.category.toUpperCase(),t.period=t.period.toUpperCase(),("CURRENT"!==t.mode&&"NEW"!==t.mode||"STANDARD"!==t.category&&"EDUCATION"!==t.category||"MONTH"!==t.period&&"YEAR"!==t.period||"NEW"===t.mode&&"EDUCATION"===t.category&&n.isEmpty(t.institutionName))&&e.go("notFound",{},{location:!1})}],bulbAuth:{authorizedRoles:[t.ROLES.REGISTERED_USER]}}).state("account.history",{url:"/history",resolve:{history:["currentUser","Restangular",function(e,t){return t.one("accounts",e.id).customGET("history")}],$title:["$translate",function(e){return e("account_history_title")}]},templateUrl:n.resource.cdnRoot+"ajs/account/accounthistory.html",controller:"AccountHistoryController as accountHistoryCtrl",bulbAuth:{authorizedRoles:[t.ROLES.USER]}}).state("account.receipt",{url:"/receipt/{id}",resolve:{invoice:["currentUser","$stateParams","Restangular",function(e,t,n){return n.one("accounts",e.id).one("receipts",t.id).get()}],$title:["$translate",function(e){return e("account_receipt_title")}]},templateUrl:n.resource.cdnRoot+"ajs/account/accountreceipt.html",controller:"AccountReceiptController as accountReceiptCtrl",bulbAuth:{authorizedRoles:[t.ROLES.REGISTERED_USER]}}).state("account.verifyemail",{url:"/verifyemail?token",resolve:{verifyEmail:["$window",function(e){return e.bulbRootModel.verifyEmail}],$title:["$translate",function(e){return e("account_verify_email_title")}]},templateUrl:n.resource.cdnRoot+"ajs/account/accountverifyemail.html",controller:"AccountVerifyEmailController as accountVerifyEmailCtrl"}).state("account.planlist",{url:"/planlist",resolve:{$title:["$translate",function(e){return e("account_planlist_title")}]},templateUrl:n.resource.cdnRoot+"ajs/account/planlist.html",controller:"AccountSettingsController as accountSettingsCtrl",bulbAuth:{authorizedRoles:[t.ROLES.REGISTERED_USER]}})}]),function(){"use strict";function e(e,t,n,o,i,r,a,s){var l=this;this.addChild=function(){a.showBusyDuring(i.all("accounts/"+r.currentUser.id+"/familyMembers/addChild").patch({username:l.username,inviteCode:l.studentCode.toUpperCase()}).then(function(e){n.$close(e)},function(e){l.addStudentError=!0}))},this.disconnectChild=function(){n.$close(l.lastAddedEmail)},this.disconnectParent=function(){n.$close(l.lastAddedEmail)}}e.$inject=["$modal","$rootScope","$scope","$window","Restangular","BulbAuthService","BulbBusyService","CONFIG"],angular.module("bulbApp.accountModule").controller("AccountAddChildModalController",e)}(),function(){"use strict";function e(e,t,n,o,i,r){var a=this;this.add=function(){n.$close(a.lastAddedEmail)},this.cancel=function(e){r.cancel(e)}}e.$inject=["$modal","$rootScope","$scope","$window","CONFIG","BulbModalService"],angular.module("bulbApp.accountModule").controller("AccountAddEmailModalController",e)}(),function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c,u,d,p,h,g){var m=this;this.account=e,this.coupon=t.coupon,this.card=t.card,this.preexistingCard=void 0!==this.card,this.planInfo=n,this.mode=a.mode||"CURRENT",this.forceCardFormDisplay=!1,this.planCodePrefix=g.PLAN_PREFIX,this.numberOfAccounts="CURRENT"===this.mode?e.billing.subscriptionCount:a.numberOfAccounts,this.pricePerAccount=this.account.bulbSchoolDirectMemberships>0?this.planInfo.STANDARD.plans.BULBSCHOOLDIRECT.pricePerYear:this.planInfo.STANDARD.plans.BULB30.pricePerYear,this.validCouponCode=!1,this.preexistingCard&&(this.cardNumberPlaceholder=this.card.number,delete this.card.number),this.months=["01","02","03","04","05","06","07","08","09","10","11","12"];var f=(new Date).getFullYear();function b(e){var t={token:e,plan:m.isBulbSchoolDirectMember()?"BULBSCHOOLDIRECT":"BULB30"};m.billing.institutionName&&(t.institutionName=m.billing.institutionName),m.couponCode&&(t.coupon=m.couponCode),m.numberOfAccounts&&(t.subscriptionCount=m.numberOfAccounts),m.billingEmailAddress&&(t.billingEmailAddress=m.billingEmailAddress),d.showBusyDuring(l.one("accounts",m.account.id).customPOST(t,"subscribe").then(function(e){angular.copy(e,m.account),u.setCurrentUser(e);var t={okButtonCode:"button_continue",showCancelButton:!1},n=m.getTotal();"CURRENT"===m.mode?(t.titleCode="account_billing_new_subscription_confirm_title","PAST_DUE"===m.billing.status?t.bodyCode="account_billing_past_due_renewal_confirm_body":t.bodyCode="account_billing_update_confirm_body"):(t.titleCode="account_billing_new_subscription_confirm_title",t.templateUrl="subscribeconfirm.nested",t.controller=["$scope",function(e){e.plan=m.billing.plan,e.category=m.billing.category,e.amount=n,e.prepaidCode=m.account.billing.prepaidCode,e.planName="ORG_DIRECT"===m.account.type||"ORG_DIRECT_SUBSCRIPTION"===m.account.type?"account_settings_plan_BULBSCHOOLDIRECT":"account_settings_plan_BULB_STANDARD"}]);var o=m.account.features.FamilyFeature.studentAccountEnabled?function(){r.go("account.settings")}:function(){r.go("author",{username:m.account.username})};h.show(t).finally(o)},function(e){e.data.errorMap?i.accountBillingForm.handleRemoteErrors(e):p.showError(null,e)}))}this.years=s.range(f,f+15),this.initialize=function(){var e;if(this.numberOfAccounts>0?this.billing={period:"YEAR",price:this.numberOfAccounts*this.pricePerAccount,institutionName:a.institutionName}:"CURRENT"===this.mode?(this.billing=this.account.billing,(this.account.billing.numGroupAddOns>0||this.account.billing.numStorageAddOns>0)&&(this.planCodePrefix=g.CUSTOM_PLAN_PREFIX)):(this.billing={plan:"PRO",category:a.category||"STANDARD",period:a.period||"YEAR",institutionName:a.institutionName},this.billing.price=(e="MONTH"===m.billing.period?"pricePerMonth":"pricePerYear",m.planInfo[m.billing.category].plans.BULBSCHOODIRECT[e])),!(this.account.email&&"VERIFIED"===this.account.emailStatus||this.numberOfAccounts)){h.show({titleCode:"account_billing_verified_email_required_title",bodyCode:"account_billing_verified_email_required_body",okButtonCode:"account_settings_title",showCancelButton:!1}).then(function(){r.go("account.settings")})}},this.initialize(),this.useDefaultEmailAsBilling=function(){m.billingEmailAddress?($(".toggle-default-email").removeClass("active"),m.billingEmailAddress=null):($(".toggle-default-email").addClass("active"),m.billingEmailAddress=m.account.defaultEmail||null)},this.isBulbSchoolDirectMember=function(){return this.account.bulbSchoolDirectMemberships>0},this.deleteCard=function(){h.show({titleCode:"account_billing_delete_card_confirm_title",bodyCode:"account_billing_delete_card_confirm_body",okButtonCode:"button_continue"}).then(function(){l.one("accounts",m.account.id).customDELETE("billing/card").then(function(){delete m.card,m.preexistingCard=!1})})},this.editCard=function(){m.forceCardFormDisplay=!0},this.isCardFormRequired=function(){return!!this.forceCardFormDisplay||!this.preexistingCard&&this.getTotal()>0},this.isNewCardRequired=function(){return!m.card&&!(m.coupon&&m.billing.price-m.coupon.amount<=0)},this.submit=function(){m.isCardFormRequired()?d.showBusyDuring(m.generateCardToken().then(function(e){b(e)},function(e,t){h.show({titleCode:"server_error_title",bodyCode:"server_error_body",okButtonCode:"button_continue",showCancelButton:!1})})):b()},this.generateCardToken=function(){var e=o.defer();return c.card.createToken({number:m.card.number,cvc:m.card.cvc,exp_month:Number(m.card.expirationMonth),exp_year:m.card.expirationYear,name:m.card.name,address_zip:m.card.zip},function(t,n){n.error?e.reject(t,n):e.resolve(n.id)}),e.promise},this.couponCodeValidationCallback=function(e){e.valid?(m.validCouponCode=!0,m.coupon=e.payload):m.validCouponCode=!1},this.handleSettingExpirationMonth=function(e){this.card.expirationMonth=e.selectedOption},this.handleSettingExpirationYear=function(e){this.card.expirationYear=e.selectedOption},this.getTotal=function(){var e=this.numberOfAccounts*this.pricePerAccount;return this.coupon&&(e-=this.coupon.amount),e},i.$watch("accountBillingCtrl.numberOfAccounts",function(){m.numberOfAccounts||(m.numberOfAccounts=1)})}e.$inject=["account","billingInfo","planInfo","$q","$scope","$state","$stateParams","_","Restangular","Stripe","BulbAuthService","BulbBusyService","BulbErrorService","BulbModalService","ACCOUNT"],angular.module("bulbApp.accountModule").controller("AccountBillingController",e)}(),function(){"use strict";function e(e,n,o,i,r,a,s,l,c,u,d){var p=this;this.allAccountEmails=l.currentUser.emails,this.isDefaultEmail=function(e){return e.email===l.currentUser.defaultEmail||e===l.currentUser.defaultEmail},this.isBillingEmail=function(e){return e.email===l.currentUser.billingEmail||e===l.currentUser.billingEmail},this.changeDefault=function(e,t,n){p.isDefaultEmail(t)||p.isBillingEmail(t)||(JSON.parse(i.planType).subscriptionCount>0&&!n?a("account_settings_default_email_error_body",{email:t}).then(function(t){var n={titleCode:"account_settings_default_email_error",bodyCode:t,showCancelButton:!1,focusAfterClosed:e.currentTarget};d.show(n)}):c.showBusyDuring(s.all("accounts/"+l.currentUser.id+"/setDefaultEmail").post({email:t}).then(function(){l.currentUser.defaultEmail=t,r.reload()},function(e){u.showError(null,e)})))},this.sendEmailVerification=function(e,t,n){n?a("account_settings_add_new_email_body",{email:t}).then(function(n){c.showBusyDuring(s.all("accounts/"+l.currentUser.id+"/sendEmailVerification").post({email:t}).then(function(){var t={titleCode:"account_settings_add_new_email",bodyCode:n,showCancelButton:!1,focusAfterClosed:e.currentTarget};d.show(t)},function(e){u.showError(null,e)}))}):a("account_settings_verify_email_resent",{email:t}).then(function(n){c.showBusyDuring(s.all("accounts/"+l.currentUser.id+"/sendEmailVerification").post({email:t}).then(function(){var t={titleCode:"account_settings_verify_email_resend",bodyCode:n,showCancelButton:!1,focusAfterClosed:e.currentTarget};d.show(t)},function(e){u.showError(null,e)}))})},this.canRemoveEmail=function(e){if(0===JSON.parse(i.planType).subscriptionCount)return!0;if(p.isDefaultEmail(e))return!1;for(var t=0,n=0;n<p.allAccountEmails.length;n++)p.allAccountEmails[n].email!==e&&p.allAccountEmails[n].verified&&t++;return t>=1},this.removeEmail=function(e,t){if(p.canRemoveEmail(t))if(JSON.parse(i.planType).subscriptionCount>0&&p.allAccountEmails.length<=1){var n={titleCode:"account_settings_disconnect_error_subscibed_unverified",bodyCode:"account_settings_disconnect_error_subscibed_no_email_body",showCancelButton:!1,focusAfterClosed:e.currentTarget};d.show(n)}else a("account_settings_disconnect_remove_email_body",{email:t}).then(function(n){a("account_settings_disconnect_remove_email_body_last_one").then(function(o){var i={titleCode:"account_settings_disconnect_remove_email",bodyCode:n+(p.allAccountEmails.length<=1?o:""),okButtonCode:"group_member_remove_label",focusAfterClosed:e.currentTarget};d.show(i).then(function(){c.showBusyDuring(s.all("accounts/"+l.currentUser.id+"/emails").customDELETE("",{email:t},{"Content-Type":"application/json"}).then(function(e){for(var n=0;n<p.allAccountEmails.length;n++)if(p.allAccountEmails[n].email===t){p.allAccountEmails.splice(n,1);break}l.currentUser.defaultEmail=e.message},function(e){u.showError(null,e)}))})})});else{var o={titleCode:"account_settings_disconnect_error_subscibed_unverified",bodyCode:"account_settings_disconnect_error_subscibed_unverified_body",showCancelButton:!1,focusAfterClosed:e.currentTarget};d.show(o)}},this.addEmail=function(n){var o={templateUrl:"add-email-form.nested",focusAfterClosed:n.currentTarget},i=d.showCustomModal(o);i.opened.then(t(e)),i.result.then(function(e){c.showBusyDuring(s.all("accounts/"+l.currentUser.id+"/emails").post({email:e}).then(function(){p.sendEmailVerification(n,e,!0),p.allAccountEmails.push({email:e,verified:!1})},function(e){u.showError(null,e)}))})},this.editEmail=function(n,i){var r=o.$new();r.params={currentEmailAddress:i};var a={scope:r,templateUrl:"edit-email-form.nested",controller:"AccountEditEmailModalController",focusAfterClosed:n.currentTarget},h=d.showCustomModal(a);h.opened.then(t(e)),h.result.then(function(e){c.showBusyDuring(s.all("accounts/"+l.currentUser.id+"/billingEmail").patch({email:e}).then(function(t){p.allAccountEmails=p.allAccountEmails.filter(function(e){return e.email!==t}),p.allAccountEmails.push({email:e,verified:!1}),l.currentUser.billingEmail=e},function(e){u.showError(null,e)}))})},o.$watch(function(){return l.currentUser.emails},function(){p.allAccountEmails=l.currentUser.emails})}function t(e){var t=0,n=e(function(){if(t<20){t++;var o=jQuery(".reveal-modal-bg");1===o.length&&(o.attr("role","none"),e.cancel(n))}else t>=20&&e.cancel(n)},100)}e.$inject=["$interval","$modal","$rootScope","$scope","$state","$translate","Restangular","BulbAuthService","BulbBusyService","BulbErrorService","BulbModalService"],angular.module("bulbApp.accountModule").controller("AccountEmailController",e)}(),angular.module("bulbApp.accountModule").directive("bulbEmailsTable",["$compile","$translate","CONFIG",function(e,t,n){return{scope:{storedEmails:"@",planType:"@"},controller:"AccountEmailController as accountEmailCtrl",templateUrl:n.resource.cdnRoot+"ajs/account/accountemails.html"}}]),function(){"use strict";function e(e){this.history=e}e.$inject=["history"],angular.module("bulbApp.accountModule").controller("AccountHistoryController",e)}(),function(){"use strict";function e(e,t,n,o,i){var r=this;this.account=e,this.planInfo=t,this.periods={YEAR:"Annual",MONTH:"Monthly"},this.selectedPeriod="Annual",this.selectedPeriodCode="YEAR",this.institutionName="",this.userHasInstitution=!!e.billing.institutionName,this.price=0,this.category="STANDARD",this.pricePerAccount=this.planInfo.STANDARD.plans.BULB30.pricePerYear,this.initialize=function(){this.category="EDUCATION","BULBFREE"!==this.account.billing.plan||"BULBFREE2018"!==this.account.billing.plan?(this.selectedPeriodCode=this.account.billing.period,this.selectedPeriod=this.periods.YEAR):(this.selectedPeriodCode="YEAR",this.selectedPeriod=this.periods.YEARS)},this.account.billing&&(this.category=this.account.billing.category,this.institutionName=this.account.billing.institutionName?this.account.billing.institutionName:"",this.selectedPeriodCode="FREE"!==this.account.billing.plan||"BULBFREE2018"!==this.account.billing.plan?this.account.billing.period:"YEAR","YEAR"===this.selectedPeriodCode?this.selectedPeriod=this.periods.YEAR:"MONTH"===this.selectedPeriodCode&&(this.selectedPeriod=this.periods.MONTH),this.price=this.account.billing.price),i.category&&(this.category=i.category),"STANDARD"===this.category?this.currentCategory=this.planInfo.STANDARD:this.currentCategory=this.planInfo.EDUCATION,this.getPlanPrice=function(){r.setSelectedPeriodCode();var e="MONTH"===r.selectedPeriodCode?"pricePerMonth":"pricePerYear";return r.planInfo[r.category].plans.PRO[e]},this.setSelectedPeriodCode=function(){this.selectedPeriod===this.periods.YEAR?this.selectedPeriodCode="YEAR":this.selectedPeriod===this.periods.MONTH&&(this.selectedPeriodCode="MONTH")},this.submit=function(){this.setSelectedPeriodCode(),o.go("account.billing",{mode:"new",category:this.category,period:this.selectedPeriodCode,institutionName:this.institutionName,numberOfAccounts:this.numberOfAccounts})},this.cancel=function(){o.go("account.settings")},n.$watch("accountOptionsCtrl.numberOfAccounts",function(){r.totalAmount=r.numberOfAccounts*r.pricePerAccount/100})}e.$inject=["account","planInfo","$scope","$state","$stateParams"],angular.module("bulbApp.accountModule").controller("AccountOptionsController",e)}(),function(){"use strict";function e(e){this.card=e.card,this.receipt=e.receipt}e.$inject=["invoice"],angular.module("bulbApp.accountModule").controller("AccountReceiptController",e)}(),function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c,u,d,p,h,g,m,f,b,v,C,y,w,A,_){var E=this;switch(this.connectedMembers=m.currentUser,this.account=p.copy(e),this.urlOrigin=window.location.origin,E.notification={},this.storedAccount=e,this.emailfrequencyType=["IMMEDIATELY","DAILY","WEEKLY"],this.handleBadgrOAuth=function(e){var t={templateUrl:"badges.linkBadgesSuccess.nested",titleCode:"badgr_link_successful",showTitle:!0,showCancelButton:!1,showOkButton:!1,fontAwesomeCode:"fas fa-badge-check",windowClass:"updated-modal-design",controller:"AccountAddBadgeModalController as accountAddBadgeModalCtrl"},n={authCode:e};f.showBusyDuring(p.all("/accounts/"+this.account.id+"/badges/auth").post(n).then(function(e){v.show(t)},function(e){v.show({titleCode:"server_error_title",bodyCode:"server_error_body",showCancelButton:!1})}))},t.search().code&&(this.handleBadgrOAuth(t.search().code),t.url(t.path())),e.type){case"ORG":this.accountTypeText="bulbEd";break;case"ORG_DIRECT":this.accountTypeText="bulbEd Direct";break;case"ORG_DIRECT_SUBSCRIPTION":this.accountTypeText="bulbEd Direct+";break;case"BULB_SUBSCRIPTION":this.accountTypeText="bulb+";break;case"SENIOR_GIFT":this.accountTypeText="Senior";break;case"MACMILLAN":this.accountTypeText="bulb+ NextStation";break;case"MARISTA":this.accountTypeText="bulb+ MaristaNS";break;case"TRANSFOR_ME":this.accountTypeText="bulb+ Transforme";break;case"VITAL_SOURCE":this.accountTypeText="bulb+ VitalSource";break;case"TRIAL":switch(e.billing.trialSource){case"HP_SCHOOLPACK":this.accountTypeText="HP Trial";break;case"MICROSOFT":this.accountTypeText="MS60 Trial";break;case"EU":this.accountTypeText="EU Trial";break;default:this.accountTypeText="Trial"}break;case"TEACHER":this.accountTypeText="Teacher - bulb+";break;default:this.accountTypeText="bulb"}function S(){m.fetchCurrentUser().then(function(e){E.storedAccount=e,E.account=p.copy(e)})}this.enableOrRefreshMFA=function(){if(E.account.connections.password||E.account.connections.mfa)f.showBusyDuring(p.one("accounts",E.account.id).post("connections/multiFactorAuth").then(function(e){S(),E.mfaQRCode=e.qrCodeLink},function(e){b.showError(null,e)}));else{v.show({titleCode:"account_settings_enable_mfa_failed_modal_title",bodyText:"account_settings_enable_mfa_failed_modal_description",showOkButton:!0,showCancelButton:!1,windowClass:"updated-modal-design"})}},this.language=l.localeToString(),this.languages=l.getLanguagesList(),this.changeLanguage=function(e){e.selectedOption!==l.getLanguage()&&(l.use(e.selectedOption),E.language=l.localeToString(),E.account.language=e.selectedOption,E.update(),u.location.reload())},this.joinGroup=function(e){var t={templateUrl:"join-group-form.nested",showOkButton:!1,showCancelButton:!1,focusAfterClosed:e.currentTarget};v.show(t).then(function(e){f.showBusyDuring(p.all("token/member/"+e).post({}).then(function(e){var t="FREE"!==m.currentUser.billing.plan&&"BULBFREE2018"!==m.currentUser.billing.plan;angular.copy(e,E.account),angular.copy(e,E.storedAccount),m.setCurrentUser(e),!t&&m.currentUser.bulbSchoolDirectMemberships>0&&a.go("account.billing",{mode:"new",category:"EDUCATION",period:"YEAR",numberOfAccounts:1,institutionName:"bulbEdDirect",institutionWebsite:" "})},function(e){v.show({titleCode:"server_error_title",bodyCode:e.data.developerMessage||"server_error_body",showCancelButton:!1})}))})},this.update=function(){var e={prefs:E.storedAccount.prefs};if(E.account.username!==E.storedAccount.username&&(e.username=E.account.username.trim()),E.account.firstName!==E.storedAccount.firstName&&(e.firstName=E.account.firstName.trim()),E.account.lastName!==E.storedAccount.lastName&&(e.lastName=E.account.lastName.trim()),E.account.displayName!==E.storedAccount.displayName&&(E.account.displayName.length<1&&(e.displayName=""),e.displayName=E.account.displayName.trim()),E.account.language!==E.storedAccount.language&&(e.language=E.account.language),E.account.password&&(e.password=E.account.password),void 0!==E.account.prefs&&E.account.prefs.marketing.optIn!==E.storedAccount.prefs.marketing.optInt&&(e.prefs.marketing.optIn=E.account.prefs.marketing.optIn),void 0!==E.account.prefs&&E.account.prefs.importingGoogleAssetAsPdfEnabled!==E.storedAccount.prefs.importingGoogleAssetAsPdfEnabled&&(e.prefs.importingGoogleAssetAsPdfEnabled=E.account.prefs.importingGoogleAssetAsPdfEnabled),!_.isEmpty(e))if(""!==e.email||E.account.connections.google||"FREE"!==E.account.billing.plan&&"BULBFREE2018"!==E.account.billing.plan)E.sendAccountUpdate(e);else{v.show({titleCode:"account_settings_verify_email_title",bodyCode:"account_settings_verify_email_delete_body",okButtonCode:"button_continue",showCancelButton:!0}).then(function(){E.sendAccountUpdate(e)},function(){E.account=p.copy(E.storedAccount),r.accountSettingsForm.$setPristine()})}},this.updatePhoneNumber=function(){var e={};e.phoneNumber=this.account.phoneNumber,this.account.phoneNumber&&E.sendAccountUpdate(e)},this.checkNotificationSettings=function(e,t){"sms.enabled"===e?this.account.features.SMSFeature.enabled?E.updateNotification(e,t):(this.account.notificationPref.sms.enabled=!1,E.showModal("notification_feature_check_title","notification_feature_sms_modal_content","notification_feature_check_content_bulbSchoolDirect")):"pushNotification.enabled"===e&&this.account.notificationPref.pushNotification.enabled?this.account.features.PushFeature.enabled?(E.checkBrowser(),E.updateNotification(e,t)):(this.account.notificationPref.pushNotification.enabled=!1,E.showModal("notification_feature_check_title","notification_feature_push_modal_content","notification_feature_check_content_bulbSchoolDirect")):E.updateNotification(e,t)},this.setActiveTabForEvent=function(e,t){if("mousedown"===e.type||13===e.keyCode||32===e.keyCode)if("SETTING"===t)this.activeTab={},this.activeTab[t]=!0;else if("NOTIFICATION"===t){if(!m.currentUser.features.NotificationFeature.enabled)return E.showModal("notification_feature_check_title","notification_feature_modal_content","notification_feature_check_content_bulbSchoolDirect"),E.activeTab={},E.activeTab.NOTIFICATION=!1,void(E.activeTab.SETTING=!0);E.activeTab={},E.activeTab.NOTIFICATION=!0}},this.checkBrowser=function(){if("safari"in window&&"pushNotification"in window.safari)if(C.checkBrowserVersion()>=11){var e=window.safari.pushNotification.permission(w.pushnotification.apns.safari.webPushId);C.checkRemotePermission(e,this.account,r.accountSettingsForm)}else E.showModal("push_notification_version_upgrade_title","push_notification_version_upgrade_content","")},this.updateNotification=function(e,t){var n=E.getValueFromObjectByKey(e,E.account.notificationPref),o=E.getValueFromObjectByKey(e,E.storedAccount.notificationPref);if("notificationType"!==t||n!==o){var i={};i[e]=n;var r={notificationPref:i};E.sendAccountUpdate(r)}},this.updateGroupNotification=function(e,t,n){var o=E.getValueFromObjectByKey(e,E.account.notificationPref)[n],i=o[t];if(i!==E.getValueFromObjectByKey(e,E.storedAccount.notificationPref)[n][t]){var r={},a={groupId:o.groupId};a[t]=i,r[e]=a;var s={notificationPref:r};E.sendAccountUpdate(s)}},this.getValueFromObjectByKey=function(e,t){return e.split(".").reduce(function(e,t){return e[t]},t||this)},this.sendAccountUpdate=function(e){f.showBusyDuring(p.one("accounts",E.account.id).patch(e).then(function(){S(),r.accountSettingsForm&&r.accountSettingsForm.$setPristine()},function(e){e.data.errorMap?r.accountSettingsForm.handleRemoteErrors(e):b.showError(null,e)}))},this.checkFeaturePage=function(e){switch(e){case"commentsReply":case"newComments":return!m.currentUser.features.CommentingFeature.enabled}return!1},this.showModal=function(e,t,n){v.show({titleCode:e,bodyCode:m.currentUser.bulbSchoolDirectMemberships>0?n:t,showOkButton:!1,showCancelButton:!1})},this.hasNonContentGroups=function(){return _.countBy(E.account.groupMemberships,"type").CONTENT!==E.account.groupMemberships.length},this.isBulbSchoolDirectMember=function(){return E.account.bulbSchoolDirectMemberships>0&&"TEACHER"!==E.account.type},this.isBulbSchoolDirectPaidMember=function(){return"BULBSCHOOLDIRECT"===this.account.billing.plan&&E.isBulbSchoolDirectMember()},this.isOrganizationMember=function(){return _.countBy(E.account.groupMemberships,"type").ORGANIZATION>0},this.isAdmin=function(){return _.intersection(E.account.roles,["ADMIN","ORGANIZATION_ADMIN"]).length>0},this.isOwner=function(e){return E.account.id===e.ownerId},this.isEducator=function(){return"EDUCATOR"===E.account.position},this.isFamilyAccount=function(){return null!==E.account.family&&E.account.family.studentIds.length>0},this.isOrgAdminSwitchUserClient=function(){return _.intersection(m.currentUser.roles,["SWITCHED_USER"]).length>0},this.isValidKey=function(e){return("teacherVisibility"!==e||!E.isEducator())&&(("studentActivity"!==e||!E.isFamilyAccount())&&-1!==["frequency","enabled","groupNotificationPreferences","questionDeleted","questionAnswered","questionAsked","simpleMessage","teacherVisibility","studentActivity"].indexOf(e))},this.checkEmailVerification=function(e){if(E.isDefaultVerified())a.go("signUp",{targetUrl:"/b/account/planoptions/"});else{e.preventDefault();var t={titleCode:"account_settings_email_required_title",bodyCode:"account_settings_email_required_body",okButtonCode:"button_ok",showCancelButton:!1,focusAfterClosed:e.currentTarget};v.show(t)}},this.cancelSubscription=function(t){if("click"===t.type||"Enter"===t.key||" "===t.key){var n={titleCode:"unsubscribe_confirmation_dialog_title",bodyCode:"unsubscribe_confirmation_dialog_message",okButtonCode:"unsubscribe_confirmation_dialog_continue",cancelButtonCode:"unsubscribe_confirmation_dialog_cancel",focusAfterClosed:t.currentTarget};e.billing.subscriptionCount>1&&(n.bodyCode="unsubscribe_confirmation_dialog_message_provider"),v.show(n).then(function(){E.unsubscribe()})}},this.unsubscribe=function(){f.showBusyDuring(p.one("accounts",E.account.id).customDELETE("subscribe").then(function(){S()},function(e){}))},this.googleConnect=function(){var e=i.defer();f.showBusyDuring(e.promise),d.load("auth2",function(){var t=function(e,t){t.error?(n.debug("User did not sign into google: "+JSON.stringify(t.error)),e.reject(t)):p.one("accounts",E.account.id).post("connections",{},{code:t.code}).then(function(t){S(),e.resolve(t.plain())},function(t){e.reject(t);v.show({titleCode:"account_settings_google_already_connected_title",bodyCode:"account_settings_google_already_connected_body",okButtonCode:"button_ok",showCancelButton:!1})})}.bind(E,e);d.auth2.authorize({client_id:w.google.client.id,scope:"email profile",response_type:"code",prompt:"select_account",cookie_policy:"single_host_origin"},t)})},this.microsoftConnect=function(){u.location.href=w.context.name+"/b/auth/microsoft?entryMode=connect&targetUrl="+encodeURIComponent("/b/account/settings")},this.cleverConnect=function(){u.location.href=w.context.name+"/b/auth/clever?entryMode=connect&targetUrl="+encodeURIComponent("/b/account/settings")},this.disconnect=function(e,t){var n;"SYNC"===t.createdVia?(n={titleCode:"account_settings_"+e+"_disconnect_confirm_title",bodyCode:"account_settings_cannot_disconnect_connection_created_via_sync",showCancelButton:!1},v.show(n)):(n={titleCode:"account_settings_"+e+"_disconnect_confirm_title",okButtonCode:"account_settings_disconnect_button",templateUrl:"disconnectwarning.nested",controller:["$scope",function(t){t.onlyConnection=1===Object.keys(E.account.connections).length&&1===Object.keys(E.account.connections[e]).length,t.emailMissing=E.account.emails.length<=0,t.emailUnverified=E.countVerifiedEmails()<=0,t.connectionType=e}]},v.show(n).then(function(){f.showBusyDuring(p.one("accounts",E.account.id).customDELETE("connections/"+t.id).then(function(){S()}))}))},this.isDefaultVerified=function(){E.account=p.copy(e);for(var t=E.account.emails,n=0;n<t.length;n++)if(t[n].verified&&t[n].email===E.account.defaultEmail)return!0;return!1},this.countVerifiedEmails=function(){for(var e=0,t=E.account.emails,n=0;n<t.length;n++)t[n].verified&&e++;return e},this.connectionInfo=function(e){var t={titleCode:"account_connection_info_title",bodyCode:"account_connection_info_third_party",showCancelButton:!1,focusAfterClosed:e.currentTarget};v.show(t)},this.reactivateSubscription=function(){p.one("accounts",E.account.id).post("reactivate").then(function(e){S();v.show({titleCode:"account_settings_reactivate_success_title",bodyCode:"account_settings_reactivate_success_body",okButtonCode:"button_continue",showCancelButton:!1})})},this.openBadgesInfoModal=function(e){var t={templateUrl:"badges.badgeInfo.nested",titleCode:"badgr_about",showTitle:!0,showCancelButton:!1,showOkButton:!1,fontAwesomeCode:"fas fa-medal",windowClass:"updated-modal-design",controller:"AccountAddBadgeModalController as accountAddBadgeModalCtrl",focusAfterClosed:e.currentTarget};v.show(t)},this.redirectToBadgr=function(){var e="https://"+w.badgr.url+"/auth/oauth2/authorize?client_id="+w.badgr.clientId+"&redirect_uri="+w.ngclient.url+"/b/account/settings&scope=rw:backpack r:profile";u.location.href=e},this.wrapInSpan=function(e){return"<span>"+e+"</span>"},this.planlistJump=function(){u.location.href="https://www.bulbapp.com/h/contact/"},this.toggleMarketing=function(){E.account.prefs.marketing.optIn=!E.storedAccount.prefs.marketing.optIn,E.update()},this.toggleDisplayFamilyView=function(){E.storedAccount.prefs.displayFamilyView=!E.storedAccount.prefs.displayFamilyView,E.update()},this.toggleSnapshotPdf=function(e){E.account.prefs.importingGoogleAssetAsPdfEnabled=!E.storedAccount.prefs.importingGoogleAssetAsPdfEnabled,E.update(),E.account.prefs.importingGoogleAssetAsPdfEnabled&&g.enableSnapshotPdf("settings",e)},this.applyCode=function(e,t){f.showBusyDuring(p.one("accounts").post("usePromoCode/"+e).then(function(e){m.setCurrentUser(e);var n=$(".apply-code-message");n.addClass("apply-code-show-message"),c(function(){n.removeClass("apply-code-show-message"),a.go("account.settings",{book:"EDUCATOR"===t},{reload:!0})},2e3)},function(e){b.showError(null,e)}))};var T=m.currentUser.features.ActivatedCodesFeature.codes,I="EDUCATOR"===m.currentUser.position;if(this.ableToCreateMacMillanGroups=m.isAbleToMakeMacMillanGroups(T),s.book&&I&&this.ableToCreateMacMillanGroups&&y.showMacMillanBookDialog(!0,!0),s.errorConnected&&"true"===s.errorConnected){let e={titleCode:"account_settings_duplicate_email_title",bodyCode:"account_settings_duplicate_email_body",showOkButton:!0,showCancelButton:!1};v.show(e).finally(function(){c(function(){a.go("account.settings",{},{inherit:!1,reload:"account.settings"})})})}this.copyStudentCode=function(){var e=$(".studentcode-copied-text"),t=$(".copy-student-code-button");e.addClass("studentcode-show-copied-text"),t.attr("aria-labelledby","studentcode-copied-text"),c(function(){t.attr("aria-labelledby","student-invite-code"),e.removeClass("studentcode-show-copied-text")},A.COPY.COPY_TIMEOUT)},this.toggleFamilyAccounts=function(e){f.showBusyDuring(p.all("accounts/"+m.currentUser.id+"/familyMembers/"+e).patch({firstName:m.currentUser.firstName,lastName:m.currentUser.lastName}).then(function(e){var t={event:"FamilyAccountActivation",activationType:"parentActivation",userId:m.currentUser.id};h.pushEvent(t),S()},function(t){b.showError("unable_to_"+e+"_family_accounts",t)}))},this.studentCode=function(){return this.account.family.inviteCode},this.openDisconnectDialogue=function(){v.show({titleCode:"account_settings_disconnect_modal_title",okButtonCode:"account_settings_disconnect_confirm_button",showCancelButton:!1})},this.addChildModal=function(){v.show({templateUrl:"add-child-form.nested",showTitle:!1,showCancelButton:!1,showOkButton:!1,titleCode:""}).then(function(e){var t={event:"FamilyAccountAddStudent",studentId:e.id,studentUsername:e.username,userId:m.currentUser.id};h.pushEvent(t),S()})},this.disconnectParentModal=function(e){v.show({templateUrl:"disconnect-parent-form.nested",showOkButton:!1,showCancelButton:!0,showTitle:!1}).then(function(){f.showBusyDuring(p.all("accounts/"+m.currentUser.id+"/familyMembers/removeParent").patch({familyMemberId:e.id}).then(function(t){var n={event:"FamilyAccountParentDisconnect",parentId:e.id,parentUsername:e.username,userId:m.currentUser.id};h.pushEvent(n),S()},function(e){b.showError(null,e)}))})},this.disconnectChildModal=function(e){v.show({templateUrl:"disconnect-child-form.nested",showOkButton:!1,showCancelButton:!0,showTitle:!1}).then(function(){f.showBusyDuring(p.all("accounts/"+m.currentUser.id+"/familyMembers/removeChild").patch({familyMemberId:e.id}).then(function(t){var n={event:"FamilyAccountStudentDisconnect",studentId:e.id,studentUsername:e.username,userId:m.currentUser.id};h.pushEvent(n),S()},function(e){b.showError(null,e)}))})},this.analyticsEvent=function(){var e={event:"FamilyAccountActivation",activationType:"studentActivation",userId:m.currentUser.id};h.pushEvent(e)}}e.$inject=["account","$location","$log","$modal","$q","$scope","$state","$stateParams","$translate","$timeout","$window","google","Restangular","AnalyticsService","BulbAssetLibrarySnapshotPdfService","BulbAuthService","BulbBusyService","BulbErrorService","BulbModalService","PushNotificationService","AeroDynamicDialogService","CONFIG","PERMISSIONS","_"],angular.module("bulbApp.accountModule").controller("AccountSettingsController",e)}(),function(){"use strict";function e(e,t,n,o){this.success=!1,this.failureCode="account_verify_email_token_invalid",this.currentUser=n.currentUser,o&&(this.success=o.success,this.failureCode=o.failureCode),this.goToProfile=function(){this.currentUser.isAuthenticated()?e.go("author",{username:this.currentUser.username}):t.location.href="/"}}e.$inject=["$state","$window","BulbAuthService","verifyEmail"],angular.module("bulbApp.accountModule").controller("AccountVerifyEmailController",e)}(),function(){"use strict";function e(e,t){var n=this;n.currentEmailAddress=e.params.currentEmailAddress.email||e.params.currentEmailAddress,this.add=function(){e.$close(n.currentEmailAddress)},this.cancel=function(e){t.cancel(e)}}e.$inject=["$scope","BulbModalService"],angular.module("bulbApp.accountModule").controller("AccountEditEmailModalController",e)}(),function(){"use strict";function e(e,t){var n=this;this.addGroup=function(){e.$close(n.groupToken)},this.cancel=function(e){t.cancel(e)}}e.$inject=["$scope","BulbModalService"],angular.module("bulbApp.accountModule").controller("AccountSettingsJoinGroupModalController",e)}(),angular.module("bulbApp.adminModule",["ui.router","bulbApp.authModule","bulbApp.configModule"]).config(["$stateProvider","AUTH","CONFIG",function(e,t,n){e.state("admin",{parent:"bulbView",url:"^/b/admin",resolve:{maintenanceAlert:["Restangular",function(e){return e.one("admin/maintenance_alert").get()}],$title:["$translate",function(e){return e("admin_title")}]},views:{bulbView:{templateUrl:n.resource.cdnRoot+"ajs/admin/admin.html",controller:"AdminController as adminCtrl"}},bulbAuth:{authorizedRoles:[t.ROLES.ADMIN]}})}]),function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c,u){var d=this;this.sitemapStatus="",this.emailReportStatus="",this.reportEmail="",this.foundAccounts="",this.searchAccounts="",this.searchedFor="",this.maintenanceMessage="",this.maintenanceExample="",this.currentMaintenaceAlert="",this.maintenanceBeginsInput="",this.organizations=null,this.indexingStatus="",this.indexDuration="",this.indexedBeforeDate=null,this.indexAll=!1,i&&i.date&&(this.currentMaintenaceAlert=e("date")(new Date(i.date),"yyyy-MM-dd HH:mm"),this.maintenanceBeginsInput=this.currentMaintenaceAlert);var p=new Date(3e5*Math.ceil((new Date).getTime()/3e5));this.maintenanceExample=e("date")(p,"yyyy-MM-dd HH:mm"),this.isDefaultEmail=function(e){return e.email===a.currentUser.defaultEmail.email},this.findAccounts=function(){d.foundAccounts="",r.all("admin/accounts").getList({search:d.searchAccounts}).then(function(e){d.searchedFor=d.searchAccounts,d.foundAccounts=e},function(e){t.debug("error is "+angular.toJson(e))}),d.fetchOrgs()},this.isOrganizationMember=function(e){return u.countBy(e.groupMemberships,"type").ORGANIZATION>0},this.setMaintenanceBegins=function(){d.maintenanceMessage="Attempting to set the maintenance begins.";try{var n=new Date(d.maintenanceBeginsInput.replace(/-/g,"/"));r.all("admin/set_maintenance_alert").post({dateMS:n.getTime()}).then(function(t){t.date&&(d.currentMaintenaceAlert=e("date")(new Date(t.date),"yyyy-MM-dd HH:mm"),d.maintenanceBeginsInput=d.currentMaintenaceAlert,d.maintenanceMessage="")},function(e){d.maintenanceMessage="Set maintenance alert failed. Error logged to console.",e.data&&e.data.developerMessage&&(d.maintenanceMessage=e.data.developerMessage),t.debug("error is "+angular.toJson(e))})}catch(e){d.maintenanceMessage="Invalid maintenance begins value."}},this.deleteMaintenanceBegins=function(){d.maintenanceMessage="Attempting to delete the maintenance begins.",r.one("admin/delete_maintenance_alert").remove().then(function(e){d.currentMaintenaceAlert="",d.maintenanceMessage=""},function(e){d.maintenanceMessage="Delete maintenance alert failed. Error logged to console.",t.debug("error is "+angular.toJson(e))}),d.maintenanceBeginsInput=d.currentMaintenaceAlert},this.createSitemap=function(){d.sitemapStatus="Attempting to create a sitemap.",r.one("admin/create_sitemap").post().then(function(e){d.sitemapStatus="Sitemap created."},function(e){d.sitemapStatus="Sitemap creation failed. Error logged to console.",t.debug("error is "+angular.toJson(e))})},this.runESBulkIndexing=function(){d.indexingStatus="Starting indexing process";let e="?time="+(null===d.indexDuration||""===d.indexDuration?"1.0":d.indexDuration);e+=!0===d.indexAll?"&all=true":"",e+=null!==d.indexedBeforeDate&&""!==d.indexedBeforeDate?"&before="+d.indexedBeforeDate:"",r.all("search/reindex"+e).post().then(function(e){d.indexingStatus="Indexing started"},function(e){d.indexingStatus="Indexing failed. Error logged to console.",t.debug("ES Indexing error is "+angular.toJson(e))})},this.sendEmailReport=function(){d.emailReportStatus="Attempting to send report.",r.all("admin/email_report").post({email:d.reportEmail}).then(function(e){e.emailReportStatus?d.emailReportStatus=e.emailReportStatus:d.emailReportStatus="POST: b/admin/email_report completed"},function(e){d.emailReportStatus="Send report failed. Error logged to console.",t.debug("error is "+angular.toJson(e))})},this.signInAs=function(e){a.adminSignInAs(e)},this.fetchOrgs=function(){return null===d.organizations?s.showBusyDuring(r.all("organizations").getList().then(function(e){d.organizations=e.plain().sort(function(e,t){return e.displayName.toUpperCase().localeCompare(t.displayName.toUpperCase())})})):d.organizations},this.findOrganization=function(e){return u.find(d.organizations,"id",e)},this.editOrgs=function(e){o.when(d.fetchOrgs(),function(){d.showOrgModal(e)})},this.setUserEnabled=function(e){a.setUserEnabled(e.id,e.enabled).then(function(t){e.enabled=t.enabled}).catch(function(e){var t={titleCode:"admin_user_enable_error_title",bodyText:"admin_user_enable_error_message"+e,showOkButton:!0,showCancelButton:!1};l.show(t)})},this.showOrgModal=function(e){n.open({templateUrl:c.resource.cdnRoot+"ajs/admin/orgmodal.html",controller:"OrgModalController as orgModalCtrl",resolve:{account:function(){return e},organizations:function(){return d.organizations}}}).result.then(function(e){d.foundAccounts[d.foundAccounts.findIndex(function(t){return t.id===e.id})]=e})}}e.$inject=["$filter","$log","$modal","$q","maintenanceAlert","Restangular","BulbAuthService","BulbBusyService","BulbModalService","CONFIG","_"],angular.module("bulbApp.adminModule").controller("AdminController",e)}(),angular.module("bulbApp.adminModule").filter("organizationFilter",function(){return function(e){for(var t=[],n=0;n<e.length;n++)"ORGANIZATION"===e[n].type&&t.push(e[n]);return t}}),function(){"use strict";function e(e,t,n,o,i,r){var a=this;this.account=e,this.allOrganizations=t,this.addOrganization=function(e){a.account.patch({addedOrganization:e.id}).then(function(e){n.close(e)})},this.removeOrganization=function(e){i.show({titleCode:"organization_bulb_school_direct_toggle_warning_title",bodyCode:"organization_modal_remove_warning",showOkButton:!0,showCancelButton:!0,fontAwesomeCode:"fas fa-exclamation-triangle",windowClass:"updated-modal-design"}).then(function(){a.account.patch({removedOrganization:e.groupId}).then(function(e){n.close(e)})})},this.addAdmin=function(t){o.one("organizations",t.groupId).patch({adminToAdd:a.account.id}).then(function(){n.close(a.account),a.findOrganization(t.groupId).administratorIds.push("Account:"+e.id),t.statuses.isAdmin=!0})},this.removeAdmin=function(t){o.one("organizations",t.groupId).patch({adminToRemove:a.account.id}).then(function(){n.close(a.account);var o=a.findOrganization(t.groupId),i=o.administratorIds.indexOf("Account:"+e.id);o.administratorIds.splice(i,1),t.statuses.isAdmin=!1})},this.findOrganization=function(e){return r.find(a.allOrganizations,"id",e)}}e.$inject=["account","organizations","$modalInstance","Restangular","BulbModalService","_"],angular.module("bulbApp.adminModule").controller("OrgModalController",e)}(),angular.module("bulbApp.alertsModule",["ngAnimate","bulbApp.ajaxModule","bulbApp.browserModule","bulbApp.configModule","bulbApp.translateModule"]).constant("ALERT",{MAINTENANCE:{COOKIE_NAME:"bulb-maintenanceBegins",ACK_PATTERN:":ACK"},UNSUPPORTED_BROWSER:{COOKIE_NAME:"bulb-hasSeenBrowserWarning",COOKIE_EXPIRES:365}}).run(["$rootScope","ALERT",function(e,t){e.ALERT=t}]),angular.module("bulbApp.alertsModule").directive("bulbAlert",["CONFIG",function(e){return{restrict:"E",templateUrl:e.resource.cdnRoot+"ajs/alerts/alert.html",transclude:!0,scope:{close:"&"},link:function(e,t,n){t.addClass("bulb-alert")}}}]),function(){"use strict";function e(e,t,n,o){var i=this;function r(){var n=e.get(o.MAINTENANCE.COOKIE_NAME);if(Boolean(n)){var r=n.trim().replace(/"(.*)"/,"$1");r.indexOf(o.MAINTENANCE.ACK_PATTERN)>=0?(i.maintenanceBegins=null,i.translateValues={}):(i.maintenanceBegins=new Date(r),i.translateValues={date:t("date")(i.maintenanceBegins,"longDate"),time:t("date")(i.maintenanceBegins,"shortTime")})}else i.maintenanceBegins=null,i.translateValues={}}n.addResponseInterceptor(function(e,t,n,o,i,a){return r(),e}),this.close=function(){var t=e.get(o.MAINTENANCE.COOKIE_NAME);if(Boolean(t)){var n=t.trim().replace(/"(.*)"/,"$1")+o.MAINTENANCE.ACK_PATTERN;e.put(o.MAINTENANCE.COOKIE_NAME,n)}r()}}e.$inject=["$cookies","$filter","BulbAjaxService","ALERT"],angular.module("bulbApp.alertsModule").controller("MaintenanceAlertController",e)}(),angular.module("bulbApp.alertsModule").directive("bulbMaintenanceAlert",["CONFIG",function(e){return{restrict:"E",scope:!0,controller:"MaintenanceAlertController as maintenanceAlertCtrl",templateUrl:e.resource.cdnRoot+"ajs/alerts/maintenancealert.html"}}]),function(){"use strict";function e(e,t,n,o){var i=this;this.supportedBrowsersPath="supported-browsers",this.isBrowserSupported=n.isSupported(),this.usingFacebookOrInstagramInAppBrowser=n.isFacebookOrInstagramInAppBrowser(),this.isLoggedIn=t.currentUser.isAuthenticated();var r=e.get(o.UNSUPPORTED_BROWSER.COOKIE_NAME);Boolean(r)?this.hasSeenUnsupportedBrowserAlert=!0:this.isLoggedIn?this.isBrowserSupported||this.usingFacebookOrInstagramInAppBrowser?(e.put(o.UNSUPPORTED_BROWSER.COOKIE_NAME,(!0).toString(),{secure:!0,expires:new Date(Date.now()+864e5*o.UNSUPPORTED_BROWSER.COOKIE_EXPIRES)}),this.hasSeenUnsupportedBrowserAlert=!0):this.hasSeenUnsupportedBrowserAlert=!1:this.hasSeenUnsupportedBrowserAlert=!0,this.close=function(){e.put(o.UNSUPPORTED_BROWSER.COOKIE_NAME,(!0).toString(),{secure:!0}),i.hasSeenUnsupportedBrowserAlert=!0}}e.$inject=["$cookies","BulbAuthService","BulbBrowserService","ALERT"],angular.module("bulbApp.alertsModule").controller("UnsupportedBrowserAlertController",e)}(),angular.module("bulbApp.alertsModule").directive("bulbUnsupportedBrowserAlert",["CONFIG",function(e){return{restrict:"E",scope:!0,controller:"UnsupportedBrowserAlertController as unsupportedBrowserAlertCtrl",templateUrl:e.resource.cdnRoot+"ajs/alerts/unsupportedbrowseralert.html"}}]),function(){"use strict";angular.module("bulbApp.alertsModule").controller("VerifyEmailAlertController",function(){})}(),angular.module("bulbApp.alertsModule").directive("bulbVerifyEmailAlert",["CONFIG",function(e){return{restrict:"E",scope:!0,controller:"VerifyEmailAlertController as verifyEmailAlertCtrl",templateUrl:e.resource.cdnRoot+"ajs/alerts/verifyemailalert.html"}}]),angular.module("bulbApp.assetLibraryModule",["bw.paging","ngDragDrop","ui.router","bulbApp.authModule","bulbApp.configModule","bulbApp.translateModule"]).constant("ASSET_LIBRARY",{FILTER:{IMAGE:"image/heic,image/bmp,image/webp,image/jpeg,image/gif,image/png,image/psd,image/tiff,image/x-portable-anymap,image/vnd.zbrush.pcx,image/x-pcx,image/sgi,image/pcx,image/ppm,image/pbm",VIDEO:"video/mp4,video/3gpp,video/3gpp2,video/x-ms-asf,video/avi,video/x-flv,video/x-matroska,video/quicktime,video/mpeg,video/x-ms-vob,video/x-ms-wmv",ATTACHED_FILE:"*",AUDIO:"audio/m4a,audio/x-m4a,audio/*,audio/mp3,audio/wav"},CROP:{MIN_CROP_WIDTH:50,MIN_CROP_HEIGHT:50,MAX_IMAGE_SIZE_ON_LARGE_DISPLAY:500,MAX_IMAGE_SIZE_ON_MEDIUM_DISPLAY:350},ROTATE:{CONSTANT_ROTATION_DEGREE:90,IMAGE_ASPECT_RATIO_THRESHOLD:1.25,IMAGE_HEIGHT_RATIO:4,INITIAL_START_DEGREE:0}}).run(["$rootScope","ASSET_LIBRARY",function(e,t){e.ASSET_LIBRARY=t}]).config(["$stateProvider","AUTH","CONFIG",function(e,t,n){e.state("assetlibrary",{parent:"root",url:"^/b/assetlibrary",views:{"content@root":{templateUrl:n.resource.cdnRoot+"ajs/assetlibrary/assetlibrary.html",controller:"AssetLibraryController as assetLibraryCtrl"}},resolve:{$title:["$translate",function(e){return e("asset_library_title")}]},bulbAuth:{authorizedRoles:[t.ROLES.REGISTERED_USER]}})}]),function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c,u,d,p,h,g,m,f,b,v,C,y,w,A,_,E){var S=this;a.bulbVars.AssetContainerController=this,this.currentUserPrefs=g.currentUser.prefs,this.isMobile=f.isMobile(),this.breadcrumb=[],this.entries=null,this.totalResults=0,this.itemsPerPage=S.currentUserPrefs.assetLibraryEntriesPerPage,o.viewSwitcherService=m,o.assetLibraryService=p,o.currentUser=g.currentUser,this.infiniteScrollWindowEnabled=!0,this.infoType="asset_library",this.currentFolderId=null,this.searchEnabled=!1,this.searchComplete=!1,this.query=null,this.condition={assetLibrarySortKey:"NAME",assetLibrarySortOrderAsc:!0,typeFilter:{IMAGE:!1,VIDEO:!1,ATTACHED_FILE:!1,AUDIO:!1}},this.hasReferenceToTheArchiveCollection=function(e){return-1!==E.findIndex(e,function(e){return"ARCHIVE_COMPOSITE"===e.type})};var T=g.currentUser.prefs;T.assetLibrarySortKey&&$.extend(this.condition,T),this.itemDragOptions={get:function(){return m.isTile(S.infoType)?S.itemDragOptions.tile:S.itemDragOptions.list},list:{revert:"invalid",containment:"#bulb-asset-library-container",opacity:.5,stop:function(e){$(e.currentTarget).removeClass("ui-draggable-dragging")}},tile:{revert:"invalid",containment:"#bulb-content",opacity:.5,stop:function(e){$(e.currentTarget).removeClass("ui-draggable-dragging")}}},this.itemDropOptions={list:{hoverClass:"bulb-asset-droppable"},tile:{hoverClass:"bulb-asset-droppable"}};var I,B=null,k=null,U=!1,O=null,M=function(e){if(!("touchstart"===e.type&&I!==$(document).scrollTop()||(B&&(clearTimeout(B),B=null),k||C.getTopModalElement()))){var t=$(e.currentTarget);t.is(".ui-draggable")&&(k=t.draggable("destroy")),(k=t.draggable(S.itemDragOptions.get())).addClass("ui-draggable-dragging"),k.trigger(e)}};this.onItemMouseDown=function(e){k||(U=!0,O=e)},this.onItemTouchStart=function(e){k||(I=$(document).scrollTop(),B=setTimeout(function(){B&&M(e)},_.TOUCH_DELAY))},this.initDraggable=function(){i(function(){m.isTile(S.infoType)?$("#bulb-assetlibrary-tile").children().on("mousedown",S.onItemMouseDown).on("touchstart",S.onItemTouchStart):$("#bulb-assetlibrary-list").children().on("mousedown",S.onItemMouseDown).on("touchstart",S.onItemTouchStart)},200)},this.finishDragging=function(e){U=!1,B&&(clearTimeout(B),B=null),k&&i(function(){k.removeClass("ui-draggable-dragging"),k.draggable("disable"),k=null},e)},this.readOnly||($("body").on("mouseup touchend",function(){S.finishDragging(_.END_EVENT_DRAG_KILL_WAIT)}),f.isMobile()||$("body").on("mousemove",function(e){U&&(O.pageX===e.pageX&&O.pageY===e.pageY||(U=!1,M(O)))})),o.onEntryDrop=function(e,t,o){var i=t.draggable.scope().entry,r=n.defer();b.showBusyDuring(r.promise),t.draggable.fadeOut(500,function(){p.api.moveEntry(i.id,o.id).then(function(e){S.getEntriesAndUpdateList(),r.resolve()},r.reject)})};var P=function(e){return t=e.id,$("#asset-"+t);var t};this.updateList=function(e){S.entries=e.entries,S.breadcrumb=e.breadcrumb,r("assetlibrary_breadcrumb_root").then(function(e){S.breadcrumb.unshift({id:null,name:e})}),S.totalResults=e.totalResults,S.readOnly||S.initDraggable(),o.$emit("listUpdated")},this.redirectTo=function(e,t){a.open(e+"?utm_source="+A.unsplash.client.application.name+"&utm_medium=referral","_blank"),t.stopPropagation()},this.getEntries=function(e,t){var n=angular.merge({},S.condition),o=n.typeFilter;o.IMAGE||o.VIDEO||o.ATTACHED_FILE||o.AUDIO||(n.typeFilter={IMAGE:!0,VIDEO:!0,ATTACHED_FILE:!0,AUDIO:!0}),n.currentPage=t&&t>0?t-1:0,n.itemsPerPage=S.itemsPerPage&&S.itemsPerPage>0?S.itemsPerPage:0,(S.searchEnabled?p.api.search(S.query,n).finally(function(){S.lastQuery=S.query,S.searchComplete=S.searchEnabled}):p.api.getEntries(S.currentFolderId,n)).then(e)},this.getEntriesAndUpdateList=function(e){S.getEntries(function(t){S.page=e,S.updateList(t)},e)},this.search=function(){this.searchEnabled=!0,this.getEntriesAndUpdateList()},this.cancelSearch=function(){this.query=null,this.lastQuery=null,this.searchEnabled=!1,this.searchComplete=!1,this.entries=null,this.totalResults=0,this.getEntriesAndUpdateList()},this.queryOnKeyDown=function(e){switch(e.keyCode){case 13:this.query=e.currentTarget.value,this.search()}},this.changeSort=function(e,t){this.condition.assetLibrarySortKey===e?this.condition.assetLibrarySortOrderAsc=!this.condition.assetLibrarySortOrderAsc:(this.condition.assetLibrarySortKey=e,this.condition.assetLibrarySortOrderAsc=!0),setTimeout(function(){g.currentUser.isAuthenticated()&&(g.currentUser.prefs.assetLibrarySortKey=S.condition.assetLibrarySortKey,g.currentUser.prefs.assetLibrarySortOrderAsc=S.condition.assetLibrarySortOrderAsc,p.api.updateAccountPrefs())},1),this.getEntriesAndUpdateList(),$(t.currentTarget).focus()},this.showFolder=function(e){this.currentFolderId=e,this.getEntriesAndUpdateList()},this.switchFilter=function(e){this.condition.typeFilter[e]=!this.condition.typeFilter[e],this.getEntriesAndUpdateList()},this.targetEntry=null,this.targetEntryIdx=null,this.refreshTargetEntry=function(e,t){S.targetEntry&&P(S.targetEntry).removeClass("bulb-assetlibrary-focused-entry"),S.targetEntry=e,S.targetEntryIdx=t,S.targetEntry.id&&P(S.targetEntry).addClass("bulb-assetlibrary-focused-entry")},this.showDetailModal=function(e,t,n){e&&e.stopPropagation(),P(t).blur(),S.refreshTargetEntry(t,n),e&&(t.focusAfterClosed=e.currentTarget,p.dialog.showDetailModal(S,t))},this.updateTargetEntry=function(){switch(this.targetEntry.type){case"FOLDER":this.targetEntry.id?p.api.updateFolder(this.targetEntry).then(this.getEntriesAndUpdateList):p.api.createFolder(this.targetEntry).then(this.getEntriesAndUpdateList);break;case"IMAGE":p.api.updateImage(this.targetEntry).then(this.getEntriesAndUpdateList);break;case"VIDEO":p.api.updateVideo(this.targetEntry).then(this.getEntriesAndUpdateList);break;case"AUDIO":p.api.updateAudio(this.targetEntry).then(this.getEntriesAndUpdateList);break;case"ATTACHED_FILE":p.api.updateAttachedFile(this.targetEntry).then(this.getEntriesAndUpdateList)}},this.showAddVideoModal=function(e){p.dialog.video.showAddDialog(S,e.currentTarget)},this.showAddAudioModal=function(e){p.dialog.audio.showSelectionModal(null,function(){p.dialog.dismissAllModals(),d.uploadFile(S.uploadOptions.createAudioUploadOptions(!0),w.FILTER.AUDIO,!1,!0,"assetlibrary")},null,null,S.uploadOptions.createAudioUploadOptions(!1),!0,e.currentTarget)};var D=null;this.onClick=function(e,t,n){if(!k){D&&clearTimeout(D);var o=function(){switch(S.finishDragging(1e3),e.type){case"FOLDER":S.searchEnabled=!1,S.query=null,S.lastQuery=null,S.showFolder(e.id);break;default:S.showDetailModal(n,e,t)}};f.isMobile()?o():D=setTimeout(o,500)}},this.onDblclick=function(e,t,n){f.isMobile()||(D&&clearTimeout(D),S.showDetailModal(n,e,t))},this.isFirstEntry=function(){return 0===this.targetEntryIdx},this.isLastEntry=function(){return this.targetEntryIdx===this.entries.length-1},this.getTargetEntryDetail=function(e){b.showBusyDuring(p.api.getEntry(this.entries[e].id).then(function(t){S.refreshTargetEntry(t.entry,e)}))},this.showPrevEntry=function(){if(0!==this.targetEntryIdx){var e=this.targetEntryIdx-1;this.getTargetEntryDetail(e)}},this.showNextEntry=function(){if(this.targetEntryIdx!==this.entries.length-1){var e=this.targetEntryIdx+1;this.getTargetEntryDetail(e)}},o.$watch(function(){return S.targetEntry?S.targetEntry.id:null},function(){p.dialog.setDefaultFocusInModal()}),this.consumeEvent=function(e){if(e.stopPropagation(),"INPUT"===e.currentTarget.tagName)switch(e.keyCode){case 13:e.preventDefault();break;case 27:p.dialog.closeCurrentModal()}},this.showDeleteEntryDialog=function(e,t){p.dialog.showDeleteEntryDialog(e,t,S.getEntriesAndUpdateList)},this.showCreateFolderDialog=function(e){var t={name:"",folderId:S.currentFolderId,type:"FOLDER",focusAfterClosed:e.currentTarget};this.showDetailModal(e,t,null)},this.onSelectedHandler=function(e,t,n,o){b.showBusyDuring(p.api.importFromGoogleDrive(e,S.currentFolderId,t,n,o).then(function(){S.getEntriesAndUpdateList(),g.fetchCurrentUser()}))},this.isGoogleAsset=function(e){return!!S.targetEntry&&(e?e.startsWith("application/vnd.google-apps"):S.targetEntry.mimeType.startsWith("application/vnd.google-apps"))},this.googlePhotoSelectHandler=function(e,t){angular.forEach(t,function(t){b.showBusyDuring(p.api.importFromGooglePhoto(e,S.currentFolderId,t).then(function(e){S.getEntriesAndUpdateList(),g.fetchCurrentUser()}))})},this.openPicker=function(){g.currentUser.features.AddFileFeature.enabled?l.openAllTypePicker(S.onSelectedHandler):l.openImageAndVideoTypePicker(S.onSelectedHandler)},this.openGooglePhotoPicker=function(){c.initializeGooglePhotoPicker(S.googlePhotoSelectHandler,!0,!1,!0)},this.openGooglePickerForVideos=function(){p.dialog.dismissAllModals(),c.initializeGooglePhotoPicker(S.googlePhotoSelectHandler,!0,!0)},this.openImageTypePicker=function(){l.openImageTypePicker(S.onSelectedHandler)},this.openVideoTypePicker=function(){l.openVideoTypePicker(S.onSelectedHandler)},this.openOneDrivePicker=function(){var e=[];g.currentUser.features.AddFileFeature.enabled||(e=[A.image.extensions,A.video.extensions]),h.initializeOneDrivePicker(function(e){b.showBusyDuring(h.importFromOneDrive(e.id,S.currentFolderId).then(function(e){S.getEntriesAndUpdateList(),g.fetchCurrentUser()}))},e,!0)},this.unsplashPhotoSelectionHandler=function(e){b.showBusyDuring(u.importFromUnsplash(e,S.currentFolderId).then(function(e){S.getEntriesAndUpdateList(),g.fetchCurrentUser(),p.dialog.closeCurrentModal()}))},this.openUnsplashImagePicker=function(e){var t={titleCode:"",template:"<bulb-asset-library-unsplash></bulb-asset-library-unsplash>",windowClass:"bulb-assetlibrary-selection-modal bulb-unsplash-image-search bulb-unsplash-search-results",closeOnClick:!0,showOkButton:!1,showCancelButton:!1,focusAfterClosed:e.currentTarget};u.initializeUnsplashPhotoPicker(S.unsplashPhotoSelectionHandler),p.dialog.show(t,null)},this.showImageCropModal=function(){p.dialog.image.showCropDialog(S.targetEntry,function(e){p.dialog.closeCurrentModal(),i(function(){b.showBusyDuring(p.api.crop(e).then(function(e){for(var t=e.entry,n=0;n<S.entries.length;n++){var o=S.entries[n];if(o&&o.id===t.id){S.entries[n]=angular.merge(o,t),S.targetEntry=S.entries[n];break}}}))},1)})},this.validation={getOptions:function(){return{assetLibraryEntryId:S.targetEntry.id,folderId:S.targetEntry.folderId}}};var R=e(function(){var e=!1;if(S.entries){for(var t=0;t<S.entries.length;t++){var n=S.entries[t];n.status&&"COMPLETE"!==n.status&&"ERROR"!==n.status&&(e=!0)}e&&S.getEntries(function(e){var t,n,o={};for(t=0;t<e.entries.length;t++)o[(n=e.entries[t]).id]=n;var i=!1;for(t=0;t<S.entries.length;t++){var r=o[(n=S.entries[t]).id].status;n&&n.status&&"COMPLETE"!==n.status&&n.status!==r&&("COMPLETE"===r||"ERROR"===r)&&(S.entries[t]=o[n.id],i=!0,S.targetEntry&&S.targetEntry.id===n.id&&(S.targetEntry=angular.merge(S.targetEntry,o[n.id])))}i&&(g.fetchCurrentUser(),S.initDraggable())})}},2e3);o.$on("$destroy",function(){e.cancel(R)}),this.uploadOptions={createImageUploadOptions:function(e){return d.createImageUploadOptions(function(){return S.currentFolderId},S,"uploadFileAdd",null,"uploadFileProgress","uploadFileDone",e)},createVideoUploadOptions:function(e){return d.createVideoUploadOptions(function(){return S.currentFolderId},S,"uploadFileAdd",null,"uploadFileProgress","uploadFileDone",e)},createAttachedFileUploadOptions:function(e){return d.createAttachedFileUploadOptions(function(){return S.currentFolderId},S,"uploadFileAdd",null,"uploadFileProgress","uploadFileDone",e)},createAudioUploadOptions:function(e){return d.createAudioUploadOptions(function(){return S.currentFolderId},S,"uploadFileAdd",null,"uploadFileProgress","uploadFileDone",e)}},this.isModalExists=function(){return t.getTop()};var x=function(){return!S.isModalExists()&&!l.pickerVisibility};if(!this.readOnly){var F=$(d.createInputFileElement(!0));F.attr("accept",w.FILTER.IMAGE);var L=angular.merge({},S.uploadOptions.createImageUploadOptions(!1));L.add=function(e,t){x()&&function(e,t){switch(e){case"image":return!!d.checkImageFileName(t.name);case"video":return!!d.checkVideoFileName(t.name);case"audio":return!!d.checkAudioFileName(t.name);case"attachedFile":return!(d.checkImageFileName(t.name)||d.checkVideoFileName(t.name)||d.checkAudioFileName(t.name))}}("image",t.files[0])&&(t.abortUploading=!0,S.uploadOptions.createImageUploadOptions().add(e,t))},F.fileupload(L),$("#bulb-asset-library-drop-area").bind("drop",function(e){if(e.preventDefault(),e.originalEvent.dataTransfer.items)for(var t=0;t<e.originalEvent.dataTransfer.items.length;t++)if("file"===e.originalEvent.dataTransfer.items[t].kind){var n=e.originalEvent.dataTransfer.items[t].getAsFile(),o="*";n.type.includes("image")?o=w.FILTER.IMAGE:n.type.includes("audio")?o=w.FILTER.AUDIO:n.type.includes("video")&&(o=w.FILTER.VIDEO);var i=new CustomEvent("initDragAndDrop",{detail:{file:n,attr:o,fromWithinAssetLibrary:!0,uploadState:"draganddrop"}});a.dispatchEvent(i)}}),o.$on("$destroy",function(){F.remove()})}i(function(){if(S.readOnly){var e=function(){$("#assetlibrary-file-drop-area-cover").show()},t=function(){$("#assetlibrary-file-drop-area-cover").hide()};S.condition.typeFilter.ATTACHED_FILE?$("#assetlibrary-file-drop-area").on("dragover",e):$("#assetlibrary-file-drop-area-second").on("dragover",e),$("body").on("mouseup",t),$("#assetlibrary-file-drop-area-cover").on("dragleave",t),S.condition.typeFilter.ATTACHED_FILE?$("#assetlibrary-file-drop-area").on("drop",t):$("#assetlibrary-file-drop-area-second").on("drop",t)}else{var n=function(){$("#bulb-asset-library-drop-area").hide()};$("body").on("dragover",function(){x()&&$("#bulb-asset-library-drop-area").show()}),$("body").on("mouseup",n),$("#bulb-asset-library-drop-area-inner").on("dragleave",n),$("#bulb-asset-library-drop-area-inner").on("drop",n)}},200),this.uploadImage=function(){d.uploadFile(this.uploadOptions.createImageUploadOptions(!0),w.FILTER.IMAGE,!0,!0,"assetlibrary")},this.uploadVideo=function(){p.dialog.dismissAllModals(),d.uploadFile(this.uploadOptions.createVideoUploadOptions(!0),w.FILTER.VIDEO,!0,!0,"assetlibrary")},this.uploadAttachedFiles=function(){d.uploadFile(this.uploadOptions.createAttachedFileUploadOptions(!0),w.FILTER.ATTACHED_FILE,!0,!0,"assetlibrary")},this.uploadAudio=function(){p.dialog.dismissAllModals(),d.uploadFile(this.uploadOptions.createAudioUploadOptions(!0),w.FILTER.AUDIO,!0,"assetlibrary")},this.uploadFileAdd=function(e,t){S.getEntriesAndUpdateList(),p.dialog.dismissAllModals()},this.uploadFileDone=function(e,t){S.updateUploadProgressBar(t.entry.id,100),S.getEntriesAndUpdateList()},this.uploadFileProgress=function(e,t,n){S.updateUploadProgressBar(t.entry.id,n)},this.updateUploadProgressBar=function(e,t){for(var n=0;n<S.entries.length;n++){var o=S.entries[n];if(o&&o.id===e){o.progress=t;break}}S.targetEntry&&S.targetEntry.id===e&&(S.targetEntry.progress=t)},this.isListHeaderVisible=function(){return!m.isTile(this.infoType)&&Foundation.utils.is_medium_up()},this.isEmptyImageVisible=function(){return null!==this.entries&&0===this.entries.length&&!this.readOnly&&Foundation.utils.is_large_up()&&!this.searchEnabled},this.isEntriesScrollable=function(){return this.readOnly&&Foundation.utils.is_medium_up()},this.isUsageScrollable=function(){return Foundation.utils.is_medium_up()}}e.$inject=["$interval","$modalStack","$q","$scope","$timeout","$translate","$window","Restangular","BulbAssetLibraryGoogleDriveService","BulbAssetLibraryGooglePhotoService","BulbAssetLibraryUnsplashService","BulbAssetLibraryUploadService","BulbAssetLibraryService","BulbAssetLibraryOneDriveService","BulbAuthService","BulbBlockViewSwitcherService","BulbBrowserService","BulbBusyCoverService","BulbErrorService","BulbModalService","BulbOnboardingService","ASSET_LIBRARY","CONFIG","DRAG","_"],angular.module("bulbApp.assetLibraryModule").controller("AssetContainerController",e)}(),angular.module("bulbApp.assetLibraryModule").directive("bulbAssetContainer",["CONFIG",function(e){return{restrict:"E",scope:{readOnly:"@",typeFilter:"@"},templateUrl:e.resource.cdnRoot+"ajs/assetlibrary/assetcontainer.html",controller:"AssetContainerController as assetContainerCtrl",bindToController:!1,link:function(e,t,n,o){o.readOnly="true"===n.readOnly;var i=$(t).closest("bulb-asset-library-use-modal");if(n.typeFilter){var r={IMAGE:!1,VIDEO:!1,ATTACHED_FILE:!1,AUDIO:!1};r[n.typeFilter]=!0,o.condition.typeFilter=r}o.getEntriesAndUpdateList(),i&&e.$watch("viewSwitcherService.isTile(assetContainerCtrl.infoType)",function(){e.$emit("viewChanged")}),o.readOnly||e.$watch("viewSwitcherService.isTile(assetContainerCtrl.infoType)",function(){o.initDraggable()})}}}]),function(){"use strict";function e(e,t,n){e.assetLibraryService=t,e.currentUser=n.currentUser}e.$inject=["$scope","BulbAssetLibraryService","BulbAuthService"],angular.module("bulbApp.assetLibraryModule").controller("AssetLibraryController",e)}(),function(){"use strict";function e(e,t,n,o,i,r,a,s,l){var c,u=this,d=window===parent?o.location.origin:document.referrer,p=l.google.client.id,h=["https://www.googleapis.com/auth/drive"],g=!1,m=null,f=null,b=!1,v={fontAwesomeCode:"fab fa-google-drive",titleCode:"assetlibrary_googledoc_permission_heading",bodyCode:"assetlibrary_googledoc_permission_subheading",okButtonCode:"button_update",cancelButtonCode:"button_google_doc_permission_cancel",showCancelButton:!0,windowClass:"updated-modal-design bulb-google-doc-modal"};this.pickerVisibility=!1;var C=function(e){switch(e[window.google.picker.Response.ACTION]){case window.google.picker.Action.LOADED:u.pickerVisibility=!0;break;case window.google.picker.Action.PICKED:u.pickerVisibility=!1;var t=e[window.google.picker.Response.DOCUMENTS][0],n=t[window.google.picker.Document.MIME_TYPE];c(m,t[window.google.picker.Document.ID],n,t.parentId,t.url,f);break;case window.google.picker.Action.CANCEL:u.pickerVisibility=!1}},y=function(e,t){if(c=e,g&&m){var n=new window.google.picker.DocsView(window.google.picker.ViewId.DOCS).setParent("root").setIncludeFolders(!0);return t&&n.setMimeTypes(t),(new window.google.picker.PickerBuilder).addView(n).setOrigin(d).setOAuthToken(m).hideTitleBar().disableFeature(window.google.picker.Feature.MULTISELECT_ENABLED).setCallback(C)}},w=function(){var e=t.defer();return m=null,window.gapi.auth.setToken(null),window.gapi.auth.signOut(),window.gapi.auth.authorize({client_id:p,scope:h,response_type:"code token",immediate:!1},function(n){(function(e){var n=t.defer();return e&&!e.error?(m=e.access_token,f=e.code,n.resolve()):n.reject(),n.promise})(n).then(e.resolve)}),e.promise};function A(e){var o=t.defer();return a.client.drive.permissions.insert({fileId:e,resource:{type:"anyone",role:"reader",withLink:!0}}).execute(function(e){404!==e.code&&403!==e.code||(i.showError(n.instant("assetlibrary_googledoc_permission_error"),e),o.reject(e)),o.resolve()},function(e){o.reject(e)}),o.promise}o.onGoogleAPILoad=function(){window.gapi.load("auth"),window.gapi.load("picker",{callback:function(){g=!0}}),a.client?a.client.load("drive","v2",function(){b=!0}):window.gapi.load("client",{callback:function(){a.client=window.gapi.client,window.gapi.client.load("drive","v2",function(){b=!0})}})},this.openImageTypePicker=function(e){w().then(function(){y(e,s.FILTER.IMAGE).build().setVisible(!0)})},this.openVideoTypePicker=function(e){w().then(function(){y(e,s.FILTER.VIDEO).build().setVisible(!0)})},this.openAttachedFileTypePicker=function(e){w().then(function(){y(e).build().setVisible(!0)})},this.openAudioTypePicker=function(e){w().then(function(){y(e,s.FILTER.AUDIO).build().setVisible(!0)})},this.openImageAndVideoTypePicker=function(e){w().then(function(){y(e,s.FILTER.IMAGE+","+s.FILTER.VIDEO).build().setVisible(!0)})},this.openAllTypePicker=function(e){w().then(function(){y(e).build().setVisible(!0)})},this.enableShareableLink=function(e){var o=t.defer();b&&m&&a.client?a.client.drive.permissions.get({fileId:e,permissionId:"anyoneWithLink"}).execute(function(t){404===t.code?r.show(v).then(function(){A(e).then(function(){a.client.drive.files.get({fileId:e}).execute(function(e){var t={code:f,url:e.alternateLink};o.resolve(t)})},function(e){o.reject(e)})}):o.resolve()},function(e){o.reject(e)}):i.showError(n.instant("google_drive_api_not_loaded"));return o.promise},this.getShareableLinkForUrl=function(e){var n=t.defer();return r.show(v).then(function(){b&&a.client&&w().then(function(){A(e).then(function(){a.client.drive.files.get({fileId:e}).execute(function(e){var t={code:f,url:e.alternateLink};n.resolve(t)},function(e){n.reject(e)})},function(e){n.reject(e)})})}),n.promise};var _=e[0].createElement("script");_.src="https://apis.google.com/js/api.js?onload=onGoogleAPILoad",e[0].body.appendChild(_)}e.$inject=["$document","$q","$translate","$window","BulbErrorService","BulbModalService","google","ASSET_LIBRARY","CONFIG"],angular.module("bulbApp.assetLibraryModule").service("BulbAssetLibraryGoogleDriveService",e)}(),function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c,u,d,p,h,g,m,f,b,v){var C=this;this.sortKeys=["NAME","CREDIT","TYPE","DATE","SIZE"],this.download=function(e){var t=document.createElement("a");t.href=v.location.href+"/"+e.id+"/download",t.click()};var y=u.all("assetlibrary");this.api={updateAccountPrefs:function(e){u.one("accounts",o.currentUser.id).patch({prefs:o.currentUser.prefs}).catch(C.api.errorFn)},createSearchCondition:function(e,t,n){return{folderId:e,query:n,sortKey:t.assetLibrarySortKey,sortOrderAsc:t.assetLibrarySortOrderAsc,from:t.from,count:t.count,filterImage:t.typeFilter.IMAGE,filterVideo:t.typeFilter.VIDEO,filterAttachedFile:t.typeFilter.ATTACHED_FILE,filterAudio:t.typeFilter.AUDIO,currentPage:t.currentPage,itemsPerPage:t.itemsPerPage}},getEntries:function(e,t){return y.get("",C.api.createSearchCondition(e,t)).catch(C.api.errorFn)},search:function(e,t){return y.get("search",C.api.createSearchCondition(null,t,e)).catch(C.api.errorFn)},getEntry:function(e){return y.one(e).get().then(function(e){return e.entry&&(e.entry.usage=e.usage,e.entry.used=e.used),e},C.api.errorFn)},moveEntry:function(e,t){return y.one(e,"move").post("","",{folderId:t}).catch(C.api.errorFn)},deleteEntry:function(e){return y.all(e.id).remove().catch(C.api.errorFn).finally(o.fetchCurrentUser)},importFromGoogleDrive:function(e,t,n,i,r,a){if(i.startsWith("application/vnd.google-apps")&&o.currentUser.prefs.importingGoogleAssetAsPdfEnabled&&o.currentUser.features.SnapshotPdfFeature.enabled||!i.startsWith("application/vnd.google-apps"))return y.all("googledrive").all("import").post("",{token:e,mimeType:i,folderId:t,fileId:n,photoParentId:r,forceAttachedFile:!!a}).catch(C.api.errorFn);C.dialog.showError("assetlibrary_googledrive_import_error")},importFromGooglePhoto:function(e,t,n){return y.all("googledrive").all("import").post("",{token:e,folderId:t,mediaId:n,googlePhoto:!0}).catch(C.api.errorFn)},errorFn:function(e){if(e.data&&(e.data.message||e.data.developerMessage)){var t=e.data.message?e.data.message:e.data.developerMessage;C.dialog.showError(t)}else C.dialog.showError("unknown_error")},createFolder:function(e){return y.all("folder").post({folderId:e.folderId,name:e.name}).catch(C.api.errorFn)},updateFolder:function(e){return y.one("folder",e.id).patch({name:e.name}).catch(C.api.errorFn)},createImage:function(e,t){return y.all("image").post({folderId:e,name:t.name,credit:t.credit,fileSize:t.fileSize}).catch(C.api.errorFn).finally(o.fetchCurrentUser)},updateImage:function(e){return y.one("image",e.id).patch({name:e.name,credit:e.credit,rotationDegree:e.rotationDegree}).catch(C.api.errorFn)},crop:function(e){return y.one("image",e.id).all("crop").patch({cropRect:e.cropRect}).catch(C.api.errorFn)},createVideo:function(e,t){return y.all("video").post({folderId:e,name:t.name,credit:t.credit,fileSize:t.fileSize}).catch(C.api.errorFn).finally(o.fetchCurrentUser)},createExternalServiceVideo:function(e,t){return y.all("video/externalservice").post({folderId:e,videoUrl:t})},updateVideo:function(e){return y.one("video",e.id).patch({name:e.name,credit:e.credit,selectedSplashImageId:e.selectedSplashImageId?e.selectedSplashImageId:e.video.splashImageId,jspType:e.video.jspType}).catch(C.api.errorFn)},createAttachedFile:function(e,t){return y.all("attachedFile").post({folderId:e,name:t.name,credit:t.credit,fileSize:t.fileSize}).catch(C.api.errorFn).finally(o.fetchCurrentUser)},updateAttachedFile:function(e){return y.one("attachedFile",e.id).patch({name:e.name,credit:e.credit}).catch(C.api.errorFn)},createAudio:function(e,t){return y.all("audio").post({folderId:e,name:t.name,credit:t.credit,fileSize:t.fileSize}).catch(C.api.errorFn).finally(o.fetchCurrentUser)},updateAudio:function(e){return y.one("audio",e.id).patch({name:e.name,credit:e.credit}).catch(C.api.errorFn)}};var w={};this.dialog={modalOptions:{titleCode:"",showOkButton:!1,showCancelButton:!1,windowClass:"bulb-assetlibrary-modal",controller:["$scope",function(e){e.assetLibraryService=C}]},setDefaultFocusInModal:function(){var e=s.getTopModalElement();if(e){var t=e.find(".bulb-modal-body").eq(0).find("button:last");if(t.length)t.focus();else e.find(".bulb-modal-body").parent().eq(0).find(".reveal-modal-close").children().eq(0).focus()}},show:function(e,t){var n=s.open(e);return t&&n.opened.then(t),n.opened.then(function(){f(function(){C.dialog.setDefaultFocusInModal()},1)}),n.result},closeCurrentModal:function(){var e=p.getTop();e&&p.close(e.key)},closeCurrentModalKeyPress:function(e){s.clearDialog(e)},dismissAllModals:function(){p.dismissAll()},showMessage:function(e,t,n){var o;b(t,n).then(function(e){o=e});var i=angular.extend({},C.dialog.modalOptions,e);return i.templateUrl="assetlibrary.message",i.windowClass=i.windowClass,i.controller=["$scope",function(e){e.message=o}],C.dialog.show(i)},showError:function(e,t){"heic"===e.split(".").pop().toLowerCase()?C.dialog.showImageHEICUnsupportedError():b(e,t).then(function(t){if(!w[e]){w[e]=!0;var n={titleCode:"server_error_title",fontAwesomeCode:"fas fa-exclamation-triangle",bodyCode:t,showOkbutton:!0,showCancelButton:!0,windowClass:"assetlibrary_googledrive_import_error"===e?"updated-modal-design bulb-snapshot-pdf":"updated-modal-design"};s.show(n).finally(function(){w[e]=null})}})},showUnsupportedFileFormatError:function(e){var t={titleCode:"server_error_title",fontAwesomeCode:"fas fa-exclamation-triangle",bodyCode:e,showOkbutton:!0,showCancelButton:!1,windowClass:"updated-modal-design bulb-aero-modal bulb-onedrive-embed-modal"};s.show(t)},showImageHEICUnsupportedError:function(){s.show({titleCode:"modal_image_heic_warning",templateUrl:"imageheicalert.nested",fontAwesomeCode:"fas fa-exclamation-triangle",okButtonCode:"onboarding_got_it_button",windowClass:"updated-modal-design image-heic-alert"})},showFileSizeExceedError:function(){C.dialog.showError("upload_error_size_exceeded")},showStorageSizeExceedError:function(){C.dialog.showError("error_storage_size_exceeded")},showUnauthorizedError:function(){C.dialog.showError("error_file_upload_user_not_authorized")},showDeleteEntryDialog:function(e,t,n){i.showBusyDuring(C.api.getEntry(t.id).then(function(t){var o=t.entry,r={showOkButton:!0};if(r.focusAfterClosed=e.currentTarget,"FOLDER"===o.type){if(o.used)return r.okButtonCode="button_ok",void C.dialog.showMessage(r,"assetlibrary_can_not_delete_folder")}else if(o.usage.collections.length>0)return r.okButtonCode="button_ok",void C.dialog.showMessage(r,"assetlibrary_can_not_delete_asset");r.okButtonCode="button_delete",C.dialog.showMessage(r,"assetlibrary_delete_asset_dialog_label",{name:o.name}).then(function(){var e=h.defer();i.showBusyDuring(e.promise),C.dialog.dismissAllModals(),f(function(){g.$apply(),C.api.deleteEntry(o).then(function(){n&&n(),e.resolve()},e.reject)},1)})}))},processSelectHandler:function(e){"bound imageCarouselSelectHandler"===C.selectHandler.name?i.showBusyDuring(C.selectHandler(e)).then(C.dialog.dismissAllModals):C.selectHandler&&(C.dialog.dismissAllModals(),f(function(){i.showBusyDuring(C.selectHandler(e))},300))},_initDragAndDropUploader:function(e,t,n,o,i){f(function(){var e;e=t?"#assetlibrary-file-drop-area-second":"#assetlibrary-file-drop-area",i&&(jQuery(e).on("dragover",function(){$("#assetlibrary-file-drop-area-cover").show()}),jQuery("#assetlibrary-file-drop-area-cover").on("dragleave",function(){$("#assetlibrary-file-drop-area-cover").hide()})),$(e).bind("drop",function(e){if(e.preventDefault(),e.originalEvent.dataTransfer.items)for(var r=0;r<e.originalEvent.dataTransfer.items.length;r++)if("file"===e.originalEvent.dataTransfer.items[r].kind){var a=e.originalEvent.dataTransfer.items[r].getAsFile(),s="draganddrop";o?s=o:n&&(s="pageImageCarousel");var l=new CustomEvent("initDragAndDrop",{detail:{file:a,attr:t||"*",fromWithinAssetLibrary:!!i,uploadState:s}});v.dispatchEvent(l)}})},100)},showDetailModal:function(e,t){var n=angular.extend({},C.dialog.modalOptions);n.templateUrl="assetlibrary.detail.edit",n.windowClass=n.windowClass+" bulb-assetlibrary-detail-modal bulb-assetlibrary-modal-no-footer",n.controller=["$scope",function(t){t.assetLibraryService=C,t.assetContainerCtrl=e}],n.focusAfterClosed=t.focusAfterClosed;var o=function(){C.dialog.show(n).then(function(){e.updateTargetEntry()})};t.id?i.showBusyDuring(C.api.getEntry(t.id).then(function(t){e.targetEntry=t.entry,o()})):o()},image:{showCropDialog:function(e,t){var n=angular.extend({},C.dialog.modalOptions);n.templateUrl=c.resource.cdnRoot+"ajs/assetlibrary/modal/assetlibrary-crop-modal.html",n.windowClass=n.windowClass+" bulb-assetlibrary-modal-crop bulb-assetlibrary-modal-no-footer",n.controller=["$scope",function(n){n.assetLibraryService=C,n.entry=e,n.saveHandler=t}],C.dialog.show(n)},showSelectionModal:function(e,t,n,o,i,r,a,s,l,u){C.selectHandler=e;var d=angular.extend({},C.dialog.modalOptions);return d.templateUrl=c.resource.cdnRoot+"ajs/assetlibrary/modal/assetlibrary-selection-modal.html",d.titleCode="assetlibrary_modal_use_image_title",d.windowClass="bulb-assetlibrary-selection-modal bulb-assetlibrary-modal-no-footer",d.controller=["$scope",function(e){e.assetLibraryService=C,e.assetType="IMAGE",e.uploadFileHandler=t,e.importGoogleDriveItemHandler=n,e.googlePhotoHandler=o,e.unsplashPhotoHandler=i,e.importOneDriveItemHandler=r}],d.focusAfterClosed=u,C.dialog.show(d,function(){a&&C.dialog._initDragAndDropUploader(a,"image/*",s,l)})},showEditProfileImageModal:function(e,t){var n=angular.extend({},C.dialog.modalOptions);n.templateUrl=c.resource.cdnRoot+"ajs/assetlibrary/modal/assetlibrary-crop-modal.html",n.windowClass="bulb-assetlibrary-modal-crop bulb-assetlibrary-modal-no-footer",n.controller=["$scope",function(n){n.assetLibraryService=C,n.entry=e,n.saveHandler=t,n.fromProfileImageSelection=!0}],n.titleCode="update_avatar_image",C.dialog.show(n)}},video:{showAddDialog:function(e,t){var n=angular.extend({},C.dialog.modalOptions);n.templateUrl="assetlibrary.video.add",n.windowClass=n.windowClass+" bulb-assetlibrary-modal-no-footer",n.controller=["$scope",function(t){t.assetLibraryService=C,t.assetContainerCtrl=e}],n.focusAfterClosed=t,C.dialog.show(n)},showSelectionModal:function(e,t,n,o,i,r,a,s){C.selectHandler=e;var l=angular.extend({},C.dialog.modalOptions);return l.templateUrl=c.resource.cdnRoot+"ajs/assetlibrary/modal/assetlibrary-selection-modal.html",l.titleCode="assetlibrary_modal_use_video_title",l.windowClass="bulb-assetlibrary-selection-modal bulb-assetlibrary-modal-no-footer",l.controller=["$scope",function(e){e.assetLibraryService=C,e.assetType="VIDEO",e.uploadFileHandler=t,e.importGoogleDriveItemHandler=n,e.googlePhotoHandler=o,e.createExternalServiceVideoHandler=i,e.importOneDriveItemHandler=r}],l.focusAfterClosed=s,C.dialog.show(l,function(){C.dialog._initDragAndDropUploader(a,"video/*")})}},attachedFile:{showSelectionModal:function(e,t,n,o,i,r){C.selectHandler=e;var a=angular.extend({},C.dialog.modalOptions);return a.templateUrl=c.resource.cdnRoot+"ajs/assetlibrary/modal/assetlibrary-selection-modal.html",a.titleCode="assetlibrary_modal_use_attached_file_title",a.windowClass="bulb-assetlibrary-selection-modal bulb-assetlibrary-modal-no-footer",a.controller=["$scope",function(e){e.assetLibraryService=C,e.assetType="ATTACHED_FILE",e.importGoogleDriveItemHandler=n,e.uploadFileHandler=t,e.importOneDriveItemHandler=o}],a.focusAfterClosed=r,C.dialog.show(a,function(){C.dialog._initDragAndDropUploader(i)})}},audio:{showAddDialog:function(e){var t=angular.extend({},C.dialog.modalOptions);t.templateUrl="assetlibrary.audio.add.nested",t.windowClass=t.windowClass+" bulb-assetlibrary-modal-no-footer",t.controller=["$scope",function(t){t.assetLibraryService=C,t.assetContainerCtrl=e}],C.dialog.show(t)},showSelectionModal:function(o,i,l,u,d,p,h){C.selectHandler=o,C.dragAndDropUploaderOption=d;var g=angular.extend({},C.dialog.modalOptions);return g.templateUrl=c.resource.cdnRoot+"ajs/assetlibrary/modal/assetlibrary-selection-modal.html",g.titleCode="assetlibrary_modal_use_audio_title",g.windowClass=p?"bulb-assetlibrary-selection-modal bulb-assetlibrary-modal-no-footer bulb-audio-assetlibrary-modal":"bulb-assetlibrary-selection-modal bulb-assetlibrary-modal-no-footer",g.controller=["$scope",function(o){o.assetLibraryService=C,o.assetType="AUDIO",o.fromWithinAssetlibrary=p,o.uploadFileHandler=i,o.isMobile=r.isIOSMobile()||r.isAndroid(),o.importGoogleDriveItemHandler=l,o.importOneDriveItemHandler=u,o.recordAudio=function(i){i.preventDefault();var l={event:"AudioCapture",browser:n.browserDetails().name,OS:n.osName()},c=i.currentTarget.getElementsByClassName("SLIM bulb-audio-recording")[0];if(!n.isWebRTCSupported||n.isChromeBrowser()&&(r.isIOSMobile()||r.isIpad())){t.pushEvent(l);var u={titleCode:"modal_audio_capture_warning",bodyCode:"audio_capture_compatibility_body",fontAwesomeCode:"fas fa-exclamation-triangle",windowClass:"updated-modal-design audio-compatibility-modal",focusAfterClosed:c};s.show(u)}else if(n.isSafariBrowser()&&(r.isIOSMobile()||r.isIpad())){t.pushEvent(l);var d={titleCode:"modal_audio_external_audioinput_alert",templateUrl:"audiocaptureiosalert.nested",okButtonCode:"update_agreement_button",fontAwesomeCode:"fas fa-exclamation-triangle",windowClass:"updated-modal-design audio-capture-iOS-Safari-alert",focusAfterClosed:c};s.show(d)}else if(n.isSafariBrowser())t.pushEvent(l),a.isUsingExternalAudioInputDevice(!0).then(function(t){if(t){var n={titleCode:"modal_audio_external_audioinput_alert",bodyCode:"audio_capture_external_audioinput_body",okButtonCode:"update_agreement_button",fontAwesomeCode:"fas fa-exclamation-triangle",windowClass:"updated-modal-design audio-safari-external-audioinput-alert",focusAfterClosed:c};s.show(n).then(function(){m.reload()})}else{C.dialog.closeCurrentModal(),e.showAudioRecordingDialog(!0,p).onClose.subscribe(function(){C.dialog.audio.showSelectionModal(C.selectHandler,o.uploadFileHandler,o.importGoogleDriveItemHandler,o.importOneDriveItemHandler,C.dragAndDropUploaderOption,!1,null)}),s.setAccessibilityOnDialog(c)}},function(e){console.log("error retrieving audio input devices from user.",e)});else{t.pushEvent(l),C.dialog.closeCurrentModal(),e.showAudioRecordingDialog(!0,p).onClose.subscribe(function(){C.dialog.audio.showSelectionModal(C.selectHandler,o.uploadFileHandler,o.importGoogleDriveItemHandler,o.importOneDriveItemHandler,C.dragAndDropUploaderOption,!1,null)}),s.setAccessibilityOnDialog(c)}}}],g.focusAfterClosed=h,C.dialog.show(g,function(){C.dialog._initDragAndDropUploader(C.dragAndDropUploaderOption,"audio/*",!1,!1,p)})}}},this.playVideo=function(e,t){if("VIMEO"===e.video.jspType)C.vimeoPlayer&&C.vimeoPlayer.api("paused",function(e,t){e?C.vimeoPlayer.api("play"):C.vimeoPlayer.api("pause")});else{g.$broadcast("bulb-video-play-toggle","assetlibrary-detail-modal-player");var n=$("#"+t);n.children(".overlay").hide(),n.find(".jw-controls").show()}}}e.$inject=["AeroDynamicDialogService","AnalyticsService","AudioCompatibilityService","BulbAuthService","BulbBusyCoverService","BulbBrowserService","BulbFetchMediaDataService","BulbModalService","Foundation","CONFIG","Restangular","$modal","$modalStack","$q","$rootScope","$state","$timeout","$translate","$window"],angular.module("bulbApp.assetLibraryModule").service("BulbAssetLibraryService",e)}(),angular.module("bulbApp.assetLibraryModule").directive("bulbAssetLibraryVideoSplashImages",["CONFIG",function(e){return{restrict:"E",scope:{splashImages:"=",selectedSplashImageId:"=",currentTarget:"="},controller:function(){},controllerAs:"assetLibrarySplashImagesCtrl",bindToController:!0,templateUrl:e.resource.cdnRoot+"ajs/assetlibrary/assetlibrary-splash-images.html"}}]),function(){"use strict";function e(e,t,n,o,i,r,a,s,l){var c=this,u=/(\.|\/)(mp3|wav|m4a)$/i,d=/(\.|\/)(gif|jpe?g|png|tiff?|pnm|pcx|sgi|bmp|webp|heic)$/i,p=/(\.|\/)(3g2|3gp|asf|avi|flv|m4v|mkv|mov|mp4|mpg|vob|wmv|quicktime)$/i;this.fileUploadOptions={paramName:"files[]",maxChunkSize:5242880,maxFileSize:1e10,headers:{"X-XSRF-TOKEN":e.get("XSRF-TOKEN")},dataType:"json",sequentialUploads:!0};var h=function(e){return"/b/rest/assetlibrary/"+e.id+"/upload"};this.checkImageFileName=function(e){return e.match(d)},this.checkVideoFileName=function(e){return e.match(p)},this.checkAudioFileName=function(e){return e.match(u)};var g=function(e){var t=Math.ceil(e.files[0].size/c.fileUploadOptions.maxChunkSize),n=0;e.formData=function(){var o=[{name:"entryId",value:e.entry.id},{name:"folderId",value:e.folderId},{name:"chunks",value:t},{name:"chunk",value:n}];return n++,o}},m=function(e,t,n){(new XMLHttpRequest).upload&&(n.progress=function(n,o){var i=parseInt(o.loaded/o.total*100,10);$.proxy(e,t,n,o,i)()})},f=function(e){return function(e){return e.size<=1e10}(e)?!!function(e){var t=i.currentUser.features.StorageFeature;return t.maxStorageBytes<0||t.currentUsedStorageBytes+e.size<=t.maxStorageBytes}(e)||(o.dialog.showStorageSizeExceedError(),!1):(o.dialog.showFileSizeExceedError(),!1)},b=function(e,t){t.files.length>1&&(t.abortUploading=!0,o.dialog.showMessage({},"assetlibrary_multiple_file_upload_error"))};this.createImageUploadOptions=function(e,t,n,i,a,s,l,u){var p=angular.merge({},{acceptFileTypes:d,add:function(i,a){if(!a.abortUploading){var s=a.files[0],l={name:s.name,credit:"",fileSize:s.size};if(!c.checkImageFileName(s.name))return"heic"===s.name.split(".").pop().toLowerCase()?void o.dialog.showImageHEICUnsupportedError():void(!1!==a.unsupportedFileFormatErrorVisible&&o.dialog.showUnsupportedFileFormatError());f(s)&&r.showBusyDuring(o.api.createImage(e?e():null,l).then(function(e){a.entry=e.entry,a.url=h(e.entry),n&&$.proxy(t,n,i,a)(),a.process().done(function(){var e=new FileReader;e.onload=function(e){a.target=e.target,a.submit()},e.readAsDataURL(a.files[0])})}))}},submit:function(e,n){g(n),i&&$.proxy(t,i,e,n)()},done:function(e,n){s&&$.proxy(t,s,e,n)(),l&&$(e.target).remove()}},this.fileUploadOptions);return u||(p.drop=b),a&&m(t,a,p),p},this.createVideoUploadOptions=function(e,t,n,i,a,s,l,u){var d=angular.merge({},{acceptFileTypes:p,add:function(i,a){if(!a.abortUploading){var s=a.files[0],l={name:s.name,credit:"",fileSize:s.size};c.checkVideoFileName(s.name)?f(s)&&r.showBusyDuring(o.api.createVideo(e?e():null,l).then(function(e){a.entry=e.entry,a.url=h(e.entry),n&&$.proxy(t,n,i,a)(),a.process().done(function(){var e=new FileReader;e.onload=function(e){a.submit()},e.readAsDataURL(a.files[0])})})):!1!==a.unsupportedFileFormatErrorVisible&&o.dialog.showUnsupportedFileFormatError()}},submit:function(e,n){g(n),i&&$.proxy(t,i,e,n)()},done:function(e,n){s&&$.proxy(t,s,e,n)(),l&&$(e.target).remove()}},this.fileUploadOptions);return u||(d.drop=b),a&&m(t,a,d),d},this.createAttachedFileUploadOptions=function(e,t,n,a,s,l,c,u){var d=angular.merge({},{add:function(a,s){if(!s.abortUploading)if(i.currentUser.features.AddFileFeature.enabled){var l=s.files[0],c={name:l.name,credit:"",fileSize:l.size};f(l)&&r.showBusyDuring(o.api.createAttachedFile(e?e():null,c).then(function(e){s.entry=e.entry,s.url=h(e.entry),n&&$.proxy(t,n,a,s)(),s.process().done(function(){var e=new FileReader;e.onload=function(e){s.submit()},e.readAsDataURL(s.files[0])})}))}else o.dialog.showUnauthorizedError()},submit:function(e,n){g(n),a&&$.proxy(t,a,e,n)()},done:function(e,n){l&&$.proxy(t,l,e,n)(),c&&$(e.target).remove()}},this.fileUploadOptions);return u||(d.drop=b),s&&m(t,s,d),d},this.createAudioUploadOptions=function(e,t,n,i,a,s,l,d){var p=angular.merge({},{acceptFileTypes:u,add:function(i,a){if(!a.abortUploading){var s=a.files[0],l={name:s.name,credit:"",fileSize:s.size};c.checkAudioFileName(s.name)?f(s)&&r.showBusyDuring(o.api.createAudio(e?e():null,l).then(function(e){a.entry=e.entry,a.url=h(e.entry),n&&$.proxy(t,n,i,a)(),a.process().done(function(){var e=new FileReader;e.onload=function(e){a.submit()},e.readAsDataURL(a.files[0])})})):!1!==a.unsupportedFileFormatErrorVisible&&o.dialog.showUnsupportedFileFormatError()}},submit:function(e,n){g(n),i&&$.proxy(t,i,e,n)()},done:function(e,n){s&&$.proxy(t,s,e,n)(),l&&$(e.target).remove()}},this.fileUploadOptions);return d||(p.drop=b),a&&m(t,a,p),p},this.createInputFileElement=function(e){return e?'<input type="file" multiple>':'<input type="file">'},this.uploadFile=function(e,t,n,o,i){var r=$(c.createInputFileElement(n));r.attr("accept",t),r.addClass("hiddenUploader"),$("body").append(r),s.uploadFile(r,t,o,i)},n.addEventListener("initDragAndDrop",function(e){var t=e.detail.file,n=e.detail.attr,i=e.detail.fromWithinAssetLibrary,r=e.detail.uploadState;o.dialog.closeCurrentModal(),s.uploadFileWithoutBrowser(t,n,i,r)}),this.uploadImageBySelectionModal=function(e,t,n,o,i,r,a){var s=this.createImageUploadOptions(null,e,t,n,o,i,!1);this.uploadFile(s,l.FILTER.IMAGE,!1,r,a)},this.uploadVideoBySelectionModal=function(e,t,n,o,i,r,a){var s=this.createVideoUploadOptions(null,e,t,n,o,i,!1);this.uploadFile(s,l.FILTER.VIDEO,!1,r,a)},this.uploadAttachedFileBySelectionModal=function(e,t,n,o,i,r,a){var s=this.createAttachedFileUploadOptions(null,e,t,n,o,i,!1);this.uploadFile(s,l.FILTER.ATTACHED_FILE,!1,r,a)},this.uploadAudioBySelectionModal=function(e,t,n,o,i,r,a){var s=this.createAudioUploadOptions(null,e,t,n,o,i,!1);this.uploadFile(s,l.FILTER.AUDIO,!1,r,a)}}e.$inject=["$cookies","$q","$window","BulbAssetLibraryService","BulbAuthService","BulbBusyCoverService","BulbModalService","UploadAssetService","ASSET_LIBRARY"],angular.module("bulbApp.assetLibraryModule").service("BulbAssetLibraryUploadService",e)}(),angular.module("bulbApp.assetLibraryModule").directive("bulbAssetlibraryAddAudioPane",["CONFIG",function(e){return{restrict:"E",transclude:!0,templateUrl:e.resource.cdnRoot+"ajs/assetlibrary/modal/add-audio-pane.html",controllerAs:"addAudioPaneCtrl",controller:function(){this.assetContainerCtrl=null},link:function(e,t,n,o){o.assetContainerCtrl=e.assetContainerCtrl,e.selectionModal=n.selectionModal}}}]),angular.module("bulbApp.assetLibraryModule").directive("bulbAssetlibraryAddVideoPane",["CONFIG","BulbAssetLibraryService","BulbBusyCoverService","$q",function(e,t,n,o){return{restrict:"E",transclude:!0,templateUrl:e.resource.cdnRoot+"ajs/assetlibrary/modal/add-video-pane.html",controllerAs:"addVideoModalCtrl",controller:["$scope",function(e){var i=this;this.videoUrl=null,this.videoUrlErrorMessage=null,this.assetContainerCtrl=null;var r=function(e){i.videoUrlErrorMessage=e.data.message};this.createExternalServiceVideo=function(){var a=o.defer();n.showBusyDuring(a.promise),e.selectionModal?i.createExternalServiceVideoHandler(i.videoUrl).then(null,r).finally(a.resolve):t.api.createExternalServiceVideo(i.assetContainerCtrl.currentFolderId,i.videoUrl).then(function(e){t.dialog.dismissAllModals(),i.assetContainerCtrl.getEntriesAndUpdateList()},r).finally(a.resolve)}}],link:function(e,t,n,o,i){o.assetContainerCtrl=e.assetContainerCtrl,o.createExternalServiceVideoHandler=e.createExternalServiceVideoHandler,e.selectionModal=n.selectionModal}}}]),angular.module("bulbApp.assetLibraryModule").directive("bulbAssetlibraryCroppable",["$rootScope","ASSET_LIBRARY",function(e,t){return{controllerAs:"croppableCtrl",controller:function(){var n=this;this.aspectRatio=null,this.element=null,this.entry=null,this.fromProfileImageSelection=!1,this.imageElement=null,this.imageHeight=null,this.imageWidth=null,this.init=!1,this.lastMaxSize=null,this.rotationDegree=t.ROTATE.INITIAL_START_DEGREE;var o={built:function(){var e=$(".cropper-crop-box"),t=$(".cropper-view-box");e.addClass("cropper-crop-box-profile"),t.addClass("cropper-crop-box-profile cropper-view-box-profile")},viewMode:3,aspectRatio:1,checkCrossOrigin:!1,guides:!1,highlight:!1,background:!1,dragMode:"move",rotatable:!0,movable:!0,zoomable:!0,scalable:!1,zoomOnWheel:!0,responsive:!0,minContainerWidth:n.imageWidth,minContainerHeight:n.imageHeight,minCanvasWidth:n.imageWidth,minCanvasHeight:n.imageHeight,minCropBoxWidth:t.CROP.MIN_CROP_WIDTH,minCropBoxHeight:t.CROP.MIN_CROP_HEIGHT};this.updateImageInfo=function(){var e=null,o=null,i=null;n.fromProfileImageSelection?(o=(e=n.entry).width,i=e.height):(o=(e=n.entry.image).width,i=e.height);var r,a=1,s=$(n.element).closest(".bulb-assetlibrary-modal-crop"),l=s.find(".bulb-modal-body"),c=s.css("margin-left"),u=s.css("margin-right"),d=s.css("padding-left"),p=s.css("padding-right"),h=l.css("margin-left"),g=l.css("margin-right"),m=l.css("padding-left"),f=l.css("padding-right"),b=parseInt(c||0)+parseInt(u||0),v=parseInt(d||0)+parseInt(p||0),C=parseInt(h||0)+parseInt(g||0),y=parseInt(m||0)+parseInt(f||0);l.width(),r=b+v+C+y;var w=null;w=Foundation.utils.is_large_up()?t.CROP.MAX_IMAGE_SIZE_ON_LARGE_DISPLAY:Foundation.utils.is_medium_only()?t.CROP.MAX_IMAGE_SIZE_ON_MEDIUM_DISPLAY:$("body").width()-r,n.lastMaxSize!==w&&(n.lastMaxSize=w,n.aspectRatio=o/i,n.aspectRatio>=1?o>w&&(a=w/o,o=w,i*=a):i>w&&(o*=a=w/i,i=w),n.imageWidth=o,n.imageHeight=i,n.element.css("width",o),n.element.css("height",i),n.imageElement.attr("src",e.url),n.imageElement.css("width",o),n.imageElement.css("height",i),n.imageElement.css("max-width",o),n.imageElement.css("max-height",i),s.css("min-width",o+r))},this.beginCrop=function(){var e=null;n.init&&(e=n.imageElement.cropper("getData","rounded"),n.cropStop()),n.updateImageInfo(),n.element.addClass("bulb-cropping"),n.fromProfileImageSelection?n.imageElement.cropper(o):n.imageElement.cropper({checkCrossOrigin:!1,movable:!1,rotatable:!1,scalable:!1,zoomable:!1,zoomOnTouch:!1,zoomOnWheel:!1,responsive:!0,minContainerWidth:n.imageWidth,minContainerHeight:n.imageHeight,minCanvasWidth:n.imageWidth,minCanvasHeight:n.imageHeight,minCropBoxWidth:Math.min(t.CROP.MIN_CROP_WIDTH,n.imageWidth),minCropBoxHeight:Math.min(t.CROP.MIN_CROP_HEIGHT,n.imageHeight),data:e||n.entry.cropRect||{}}),n.init=!0},this.cropSave=function(e){this.entry.cropRect=this.imageElement.cropper("getData","rounded"),e(this.entry)},this.cropStop=function(){n.imageElement.cropper("destroy"),n.element.removeClass("bulb-cropping"),e.$apply()},this.rotateRight=function(){n.imageElement.cropper("destroy"),n.rotationDegree+=t.ROTATE.CONSTANT_ROTATION_DEGREE,n.imageElement.rotate({animateTo:n.rotationDegree,callback:function(){n.imageElement.cropper(o),n.imageElement.cropper("rotate",$(this).getRotateAngle())}})}},link:function(e,t,n,o){o.entry=e.entry,o.fromProfileImageSelection=e.fromProfileImageSelection,o.element=t,o.imageElement=t.find("img"),o.beginCrop(),$(window).resize(o.beginCrop),e.$on("$destroy",function(){$(window).unbind("resize",o.beginCrop)})}}}]),angular.module("bulbApp.assetLibraryModule").directive("bulbAssetLibraryDetailModal",["$compile","$document","$timeout","BulbAssetLibraryService","BulbBrowserService","CONFIG",function(e,t,n,o,i,r){return{restrict:"E",transclude:!0,templateUrl:r.resource.cdnRoot+"ajs/assetlibrary/modal/assetlibrary-detail-modal.html",link:function(o,r,a){var s=function(){return"none"===$(r).closest(".modal-bg-outer").css("display")};if(o.assetContainerCtrl.targetEntry.id){var l=function(e){if(!s())switch(e.keyCode){case 37:e.preventDefault(),o.assetContainerCtrl.showPrevEntry();break;case 39:e.preventDefault(),o.assetContainerCtrl.showNextEntry();break;case 46:e.preventDefault(),o.assetContainerCtrl.showDeleteEntryDialog(o.assetContainerCtrl.targetEntry)}},c=t.find("body");c.keydown(l);var u=function(){$(".bulb-assetlibrary-modal-move-btn-prev").stop().show(),$(".bulb-assetlibrary-modal-move-btn-next").stop().show(),Foundation.utils.is_small_only()&&n(function(){if(Foundation.utils.is_small_only()){$(".bulb-assetlibrary-modal-move-btn-prev").fadeOut(500),$(".bulb-assetlibrary-modal-move-btn-next").fadeOut(500)}},2e3)};if(o.$watch("assetContainerCtrl.targetEntry",function(t,i){n(function(){var t=o.assetContainerCtrl.targetEntry;if(t&&t.video)if("VIMEO"===t.video.jspType){$("#vimeo-container").empty();var n=e('<vimeo-video player-id="{{assetContainerCtrl.targetEntry.video.id}}" ng-if="assetContainerCtrl.targetEntry.video.videoHref" _player-width="250" api="true" video-url="assetContainerCtrl.targetEntry.video.videoHref"></vimeo-video>')(o);$("#vimeo-container").append(n)}else $("#thumbnail-video-player").find(".overlay").show();u()},1)}),o.$watch("Foundation.utils.is_small_only()",function(e,t){u()}),o.$on("$destroy",function(){c.unbind("keydown",l)}),i.isMobile()){var d=$(r).closest(".modal-bg-outer");new Hammer(d.get(0)).on("swipeleft swiperight",function(e){if(!s())switch(e.type){case"swipeleft":e.preventDefault(),o.assetContainerCtrl.showNextEntry();break;case"swiperight":e.preventDefault(),o.assetContainerCtrl.showPrevEntry()}})}}}}}]),angular.module("bulbApp.assetLibraryModule").directive("bulbRotateImage",["$timeout","ASSET_LIBRARY","CONFIG","_",function(e,t,n,o){return{restrict:"E",require:"ngModel",templateUrl:n.resource.cdnRoot+"ajs/assetlibrary/modal/assetlibrary-rotate-buttons.html",link:function(n,i,r,a){var s,l;e(function(){s=$(".thumbnail").find("img"),l=s.width()/s.height();var e=$(".button-container");l>=t.ROTATE.IMAGE_ASPECT_RATIO_THRESHOLD&&o.forEach([s,e],function(e){e.animate({"margin-top":s.width()/t.ROTATE.IMAGE_HEIGHT_RATIO},"slow")})},200);var c=t.ROTATE.INITIAL_START_DEGREE,u=0;n.rotateRight=function(){u++,c+=t.ROTATE.CONSTANT_ROTATION_DEGREE,s.rotate({animateTo:c});var e=u*t.ROTATE.CONSTANT_ROTATION_DEGREE;e>=360&&(u=0),a.$setViewValue(e)}}}}]),angular.module("bulbApp.assetLibraryModule").directive("bulbAssetLibrarySelectionModal",["$timeout","BulbBrowserService",function(e,t){return{restrict:"E",transclude:!0,template:"<div><ng-transclude /></div>",link:function(n,o){n.activeTab={},n.setTabOnKeyPress=function(e,t){13===e.which&&n.setActiveTabAndHandler(t)},n.setActiveTabAndHandler=function(e){n.activeTab={},n.activeTab[e]=!0,"GOOGLE_DRIVE"===e?n.importGoogleDriveItemHandler():"ONE_DRIVE"===e?n.importOneDriveItemHandler():"UNSPLASH"===e&&n.unsplashPhotoHandler()},n.runningInPWAEnvironment=t.isPWAEnvironment();var i=$(o).closest(".reveal-modal").eq(0),r=null,a=null,s=null,l=null,c=!1,u=function(t){c&&(t&&a.scrollTop(0),e(function(){for(var e=0;e<a.length;e++)window.Ps.update(a.eq(e).get(0))},1))},d=function(){a=$(o).find(".bulb-assetlibrary-entry-scroll-content")},p=function(t,n){if(!c){if(r=$(o).find(".bulb-assetlibrary-entry-container"),s=r.eq(0),d(),l=$(".bulb-asset-library-selection-modal-body"),l.eq(0),i.find(".tabs-content"),!s.offset()||!s.get(0))return void e(p,100);c=!0}if(Foundation.utils.is_medium_up()){var a=i.height()-i.find(".tabs-content").eq(0).position().top;r.height(a-145-20)}else r.height("auto");u(!1)};$(window).resize(p),n.$on("$destroy",function(){$(window).unbind("resize",p)}),n.$watch(function(){return $(o).is(":hidden")},function(e){e||p()}),e(p,1),n.$on("viewChanged",function(){d()}),n.$on("listUpdated",function(){u(!0)})}}}]),angular.module("bulbApp.authorModule",["ui.router","bulbApp.ajaxModule","bulbApp.authModule","bulbApp.badgesModule","bulbApp.compositeViewModule","bulbApp.configModule","bulbApp.translateModule"]).config(["$stateProvider","AUTH","CONFIG",function(e,t,n){e.state("author",{parent:"root",url:"^/{username:[^/?.]{2,}}?welcome&trial&prepaidCode&verifyEmail",resolve:{BulbAjaxService:"BulbAjaxService",authorAccount:["$stateParams","Restangular",function(e,t){return t.one("accounts",e.username).get().then(function(e){return e})}],authorUnit:["$stateParams","BulbAjaxService",function(e,t){return t.getAuthor(e.username).then(function(e){return e.unitDTOs[0]})}],$title:["authorUnit",function(e){return e.name}]},views:{content:{templateUrl:n.resource.cdnRoot+"ajs/author/author.html",controller:"AuthorController as authorCtrl"}},bulbAuth:{authorizedRoles:[t.ROLES.USER]},onEnter:["authorUnit","BulbUnitService","BulbDeletedUnitService","authorAccount",function(e,t,n,o){t.setCurrentUnit(e),n.authorAccountId=o.id}],onExit:["BulbUnitService",function(e){e.setCurrentUnit(null)}]})}]),function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c,u,d,p,h,g,m){var f=this;this.FAMILY_ACTIVITY=r.instant("student_activity_header"),this.MY_PORTFOLIO=r.instant("myportfolio_header"),this.compositeUnit=e,this.authorAccount=t,this.parentAccount=this.authorAccount.plain(),this.newActivitiesExist=!1,this.parentAccount.roles&&p.fetchStudentActivities(this.parentAccount.id).then(e=>{f.allActivities=e.plain(),0!==f.allActivities.length&&(p.setNewActivitiesToTrue(f.allActivities),f.newActivitiesExist=p.newActivitiesExist)}),a.addEventListener("setNewFamilyAccountActivity",function(e){e.detail.setNewActivity&&e.detail.activities.forEach(e=>{e.isNew||(f.newActivitiesExist=!1)})}),this.parentAccount.roles?this.isFamilyAccount=this.parentAccount.roles.includes("FAMILY_MEMBER"):this.isFamilyAccount=!1,this.canEdit=c.currentUser.hasPermission(e,h.PERMISSIONS.UPDATE),this.showWelcome=o.welcome&&this.canEdit,this.showTrial=o.trial&&this.canEdit,this.showCodeUsed=o.prepaidCode&&this.canEdit;var b=this.parentAccount.prefs&&this.parentAccount.prefs.displayFamilyView?"FAMILY_ACTIVITY":"MY_PORTFOLIO";this.activeTab={},this.activeTab[b]=!0;var v=c.currentUser.features.ActivatedCodesFeature.codes;function C(){"UserUnit"===f.compositeUnit.unitType&&f.canEdit&&i(function(){m.startMainTour()},0)}this.teacherActivatedCode=v.length>0&&"EDUCATOR"===c.currentUser.position,this.ableToCreateMacMillanGroups=c.isAbleToMakeMacMillanGroups(v),c.currentUser.prefs.onBoarding.onboardingShowMainTour&&(this.teacherActivatedCode&&this.ableToCreateMacMillanGroups?s.showMacMillanBookDialog(!0,!1).onClose.subscribe(function(){C()}):C()),this.analyticsEvent=function(){var e={event:"FamilyAccountStudentActivityTab",userId:c.currentUser.id};l.pushEvent(e)}}e.$inject=["authorUnit","authorAccount","$location","$stateParams","$timeout","$translate","$window","AeroDynamicDialogService","AnalyticsService","BulbAuthService","BulbModalService","BulbOnboardingService","FamilyMemberService","AUTH","CONFIG","TourService"],angular.module("bulbApp.authorModule").controller("AuthorController",e)}(),angular.module("bulbApp.activityModule",["angularMoment","lodash","bulbApp.ajaxModule","bulbApp.authModule","bulbApp.configModule","bulbApp.filtersModule"]).constant("ACTIVITY",{CHECK_INTERVAL:6e4}),function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c){var u=this;o.currentUser.hasRole(l.ROLES.SWITCHED_USER)&&(u.switchedUser=!0),this.activityFeed=t.activityFeed,this.createCollection=function(){e.go("createCollection")},this.createPage=function(){s.createPage(o.currentUser.authorUnitId)},this.showOffBoardingModal=function(){if(null!==o.currentUser.prefs.offBoarding||!u.switchedUser){var e={headerTemplateUrl:c.resource.cdnRoot+"ajs/components/offboarding/offboarding-fontawesome.html",titleCode:"off_board_modal_header",template:"<bulb-offboarding></bulb-offboarding>",windowClass:"updated-modal-design bulb-offboarding-alert-modal",backdrop:"static",closeOnClick:!0,showOkButton:!1,showCancelButton:!1};a.open(e)}}}e.$inject=["$state","BulbActivityService","BulbAjaxService","BulbAuthService","BulbBusyService","BulbErrorService","BulbModalService","BulbPageService","AUTH","CONFIG"],angular.module("bulbApp.activityModule").controller("ActivityController",e)}(),angular.module("bulbApp.activityModule").service("BulbActivityService",["$interval","$modalStack","$q","$rootScope","$state","$translate","$window","Restangular","BulbAuthService","BulbCommentService","BulbErrorService","BulbModalService","ACTIVITY","CONFIG","_",function(e,t,n,o,i,r,a,s,l,c,u,d,p,h,g){var m,f,b,v,C,y,w=this,A=!1,_=!1,E=!1,S={activityFeed:{lastViewed:null,numNewActivities:null,activities:[]}};function T(){return!!g.find([{tab:"ACTIVITY",header:"general"},{tab:"ACTIVITY_MOBILE",header:"general-mobile"}],{tab:b,header:v})}function I(){if(l.fetchCurrentUser(),l.currentUser.isAuthenticated()){var e=l.currentUser.id,o={};S.activityFeed.activities.length>0&&(o.latestId=S.activityFeed.activities[0].id),c.commentable&&c.currentPage.unit&&(o.pageId=c.currentPage.unit.id),y&&(o.lastPollingTime=y),y=new Date,s.one("accounts",e).customGET("feed",o).then(function(e){if(e){var o,i,r,a=e.activityFeed,s=e.commentThreads,u=l.currentUser.features.TimeoutFeature,d=e.timeOfLastUserAction,p=new Date;u&&u.sessionTimeout>0&&d&&(o=60*u.sessionTimeout*1e3,p-new Date(d)>=o-3e5&&(_||(B(!0),_=!0)),p-new Date(d)>=o&&(E||(t.dismissAll(),B(!1),E=!0))),a&&(m=a.lastViewed,f=a.numNewActivities,i=a.activities,r=l.currentUser.groupMemberships,i.forEach(function(e){if("OFF_BOARDING"===e.activityType&&n.when(C,function(t){e.offBoardingLinkText='<a ng-click="activityCtrl.showOffBoardingModal();">'+t.group_upgrade_from_free_tier_pricing_link+"</a>"}),e.userName&&e.displayName?e.accountText='<a href="/'+e.userName+'">'+e.displayName+"</a>":n.when(C,function(t){e.accountText=t.activityfeed_account_null}),e.groupUrl&&e.groupName){for(var t=!1,o=0;o<r.length;o++)if(r[o].displayName===e.groupName){t=!0;break}t||"GROUP_INVITE"===e.displayName?e.groupText='<a href="/g/'+e.groupUrl+'">'+e.groupName+"</a>":n.when(C,function(t){e.groupText=t.activityfeed_group_non_member})}else n.when(C,function(t){e.groupText=t.activityfeed_group_null});n.when(C,function(t){if(e.unitPath&&e.unitName){var o="/u/"+e.unitPath;switch(e.unitText='<a href="'+o+'">'+e.unitName+"</a>",e.activityType){case"COMMENT_NEW":e.commentText='<a href="'+o+"/comment/"+e.commentThreadId+'">'+t.activityfeed_comment_new_link_text+"</a>";break;case"COMMENT_REPLY":e.commentText='<a href="'+o+"/comment/"+e.commentThreadId+'">'+t.activityfeed_comment_reply_link_text+"</a>"}}else switch(e.unitText=t.activityfeed_unit_null,e.activityType){case"COMMENT_NEW":e.commentText=t.activityfeed_comment_new_link_text;break;case"COMMENT_REPLY":e.commentText=t.activityfeed_comment_reply_link_text}e.collectionUnitPath&&e.collectionUnitName?e.collectionText='<a href="/u/'+e.collectionUnitPath+'">'+e.collectionUnitName+"</a>":n.when(C,function(t){e.collectionText=t.activityfeed_collection_null})}),n.when(C,function(t){e.questionId&&e.unitPath?e.questionText='<a href="/u/'+e.unitPath+"#"+e.questionId+'">'+t.activityfeed_question+"</a>":e.questionText=t.activityfeed_question_null})}),S.activityFeed.activities=a.activities.concat(S.activityFeed.activities),S.activityFeed.activities.length>h.activities.max&&(S.activityFeed.activities=S.activityFeed.activities.slice(0,h.activities.max-1)),T()?k():(S.activityFeed.lastViewed=m,S.activityFeed.numNewActivities=f)),s&&c.updateCommentThreadMap(s)}},function(e){u.error("Cannot fetch activity feed",e)})}else u.error("Must be authenticated to access activities.")}function B(e){e?d.show({titleCode:"session_inactivity_modal_title",bodyText:r.instant("session_inactivity_modal_text"),okButtonCode:"button_ok",fontAwesomeCode:"far fa-hourglass",windowClass:"updated-modal-design one-button-modal-design disable-modal-close",showCancelButton:!1,closeOnClick:!1,backdrop:"static"}).then(function(){l.fetchCurrentUser(),_=!1}):(o.$broadcast("navigationAwayApproval",!0),l.signOut(null,!0),l.fetchCurrentUser(),d.show({titleCode:"session_expired_modal_title",bodyText:r.instant("session_expired_modal_text"),okButtonCode:"sign_in_button",fontAwesomeCode:"far fa-hourglass",windowClass:"updated-modal-design one-button-modal-design disable-modal-close",showCancelButton:!1,closeOnClick:!1,backdrop:"static"}).then(function(){i.go("signIn",{targetUrl:a.location.href},{reload:!0}),w.hasSessionExpiredShown=!1}))}function k(){if(l.currentUser.isAuthenticated()&&!w.switchedUser){if(f>0){var e=l.currentUser.id,t=S.activityFeed.activities[0],n={id:t.id};A||(A=!0,s.one("accounts",e).customPOST(n,"feed").then(function(){S.activityFeed.numNewActivities=0,f=0,m=t.date},function(e){u.error("Cannot fetch update feed",e)}).finally(function(){A=!1}))}}else u.error("Must be authenticated to update the activity feed.")}return C=r(["activityfeed_question","activityfeed_question_null","activityfeed_account_null","activityfeed_unit_null","activityfeed_group_null","activityfeed_comment_new_link_text","activityfeed_comment_reply_link_text","activityfeed_student_private_profile_finished","activityfeed_toggle_private_profiles_completed","activityfeed_group_non_member","activityfeed_off_boarding_seniors","group_upgrade_from_free_tier_pricing_link"]),o.$on("headerTabSelected",function(e,t){b=t,T()?k():S.activityFeed.lastViewed=m}),o.$on("headerOpened",function(e,t){v=t,T()&&k()}),o.$on("headerClosed",function(e){v=!1,S.activityFeed.lastViewed=m}),void 0===S.intervalHandler&&l.currentUser.isAuthenticated()&&(I(),S.intervalHandler=e(function(){I()},p.CHECK_INTERVAL)),S}]),angular.module("bulbApp.activityModule").directive("bulbActivityHeader",["BulbActivityService","BulbAuthService","CONFIG","_",function(e,t,n,o){return{restrict:"E",templateUrl:n.resource.cdnRoot+"ajs/components/activity/activityheader.html",controller:"ActivityController as activityCtrl",link:function(e,t,n){e.$watchCollection("activityCtrl.activityFeed.activities",function(e,n){if(e!==n&&0!==e.length&&t.is(":visible")){var i=o.findIndex(e,n[0]);if(0!==i){i<0&&(i=99);var r=t.find(".bulb-activity-container .bulb-scroll-content"),a=jQuery(t.find(".bulb-activity")[i]).position().top;r.css("top","-"+a+"px"),r.css("position","relative"),r.animate({top:"0",position:"auto"},1e3)}}})}}}]),angular.module("bulbApp.activityModule").directive("bulbActivityIndicator",["CONFIG",function(e){return{restrict:"E",templateUrl:e.resource.cdnRoot+"ajs/components/activity/activityindicator.html",controller:"ActivityController as activityCtrl"}}]),angular.module("bulbApp.ajaxModule",["ngCookies","restangular","bulbApp.configModule"]),function(){"use strict";function e(e,t,n,o,i){var r=o.withConfig(function(e){e.setBaseUrl(i.context.name+"/b/angular")}),a=o.withConfig(function(e){e.setBaseUrl(i.context.name+"/b/unit")});this.addResponseInterceptor=function(e){o.addResponseInterceptor(e),r.addResponseInterceptor(e)},this.getCurrentAccount=function(){var e=o.all("auth").customGET("current"),i=n.defer();return e.then(function(e){i.resolve(e)},function(e){t.debug("error is "+angular.toJson(e)),i.reject()}),i.promise},this.getAuthor=function(e){return o.one("authors",e).get()},this.getUnit=function(e,t){return t=t||!1,r.one("units",e).get({published:t})},this.createPage=function(e){var t=n.defer();return a.all("create/DraftPageUnit/"+e).post().then(function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise},this.compositeUnitReorder=function(e,i){var r={moveTargetChildUnitId:null,moveChildUnitId:e.children[i].id};if(0!==i){var a=e.children[i-1];r.moveTargetChildUnitId=a.id}var s=o.one("units",e.id).one("reorder").patch(r),l=n.defer();return s.then(function(e){l.resolve(e)},function(e){t.debug("error is "+angular.toJson(e)),l.reject(e)}),l.promise},this.validateField=function(e,t,i){var r={validator:e,fieldValue:t,options:i},a=o.all("validate").customGET("",r),s=n.defer();return a.then(function(e){s.resolve(e)},function(e){s.reject(e)}),s.promise}}e.$inject=["$cookies","$log","$q","Restangular","CONFIG"],angular.module("bulbApp.ajaxModule").service("BulbAjaxService",e)}(),angular.module("bulbApp.animationModule",[]),angular.module("bulbApp.animationModule").animation(".bulb-alert",function(){return{leave:function(e,t){var n=e.outerHeight();e.find(".close-control,.bulb-alert-message").stop().animate({top:"-"+n+"px"},300),e.stop().slideUp(300,t)}}}),angular.module("bulbApp.animationModule").animation(".bulb-fade-in",function(){return{addClass:function(e,t,n){e.css("display","block"),e.animate({opacity:1},n)},removeClass:function(e,t,n){e.animate({opacity:0},function(){e.css("display","none"),n()})}}}),angular.module("bulbApp.animationModule").directive("mobileTabAnimations",["$timeout",function(e){return function(t,n,o){var i,r=jQuery("#mobileTabContainer").find(".accordion"),a=jQuery(n.children()[0]);function s(){r.find(".bulb-locked-header").remove(),i=null,r.find("dd > a.bulb-hidden").removeClass("bulb-hidden")}t.$watch(o.mobileTabAnimations,function(t){jQuery(window).unbind("scroll.mobileTab"),jQuery(window).scrollTop(0),null!==i&&s(),t?e(function(){var e=r.offset().top-a.offset().top;r.css({marginTop:e}),jQuery(window).bind("scroll.mobileTab",function(){var e=jQuery(window).scrollTop()>a.offset().top;e&&!i?((i=a.clone()).addClass("bulb-locked-header"),i.appendTo(a.parent()),i.click(function(e){e.stopImmediatePropagation(),a.click()}),a.addClass("bulb-hidden")):!e&&i&&s()})},100):r.css({marginTop:"0"})})}}]),angular.module("bulbApp.animationModule").animation(".bulb-slide",["$log",function(e){return{addClass:function(t,n,o){var i=function(e){var t=e.css("display"),n=e.css("visibility"),o=e.css({display:"inherit",visibility:"hidden"})[0].offsetHeight+"px";return e.css({display:t,visibility:n}),o}(t.find(".bulb-active-content"));e.debug(".bulb-slide animating to height "+i),t.animate({height:i},o)},removeClass:function(t,n,o){e.debug(".bulb-slide animating to height 0"),t.animate({height:0},function(){o()})}}}]),angular.module("bulbApp.animationModule").directive("bulbSlideAndFade",["$animate","$log","$q","$window",function(e,t,n,o){return{restrict:"E",scope:{activeClassName:"@",onAnimationsDone:"&"},link:function(i,r,a){var s=0;var l="";a.$observe("activeClassName",function(a){a!==l&&(function(a,l,c){var u;t.debug("bulbSlideAndFade from "+l+" to "+a);var d=!1;if(!a||(d=a.indexOf("-mobile")>-1,(u=r.find("."+a)).length)){var p=null;if(l){var h=l.indexOf("-mobile")>-1,g=r.find("."+l);g.length?(g.removeClass("bulb-active-content"),t.debug("fadeOut "+l),p=e.removeClass(g,"bulb-fade-in")):t.warn("[bulbSlideAndFade] no element with class ."+l)}n.when(p,function(){if(c===s){var n=o.innerHeight;h&&(r.css({minHeight:"",height:n}),jQuery(".bulb-content, .bulb-footer").css({display:""}),jQuery(".bulb-color-bar").css({position:"",bottom:""})),a?(u.addClass("bulb-active-content"),t.debug("slideIn "+a),d&&u.css({height:n}),r.removeClass("bulb-slide"),e.addClass(r,"bulb-slide").then(function(){c===s&&(d&&(r.css({minHeight:n,height:"inherit"}),jQuery(".bulb-content, .bulb-footer").css({display:"none"}),jQuery(".bulb-color-bar").css({position:"fixed",bottom:"0"})),t.debug("fadeIn "+a),e.addClass(u,"bulb-fade-in").done(function(){c===s&&i.onAnimationsDone()}))})):(t.debug("slideOut (to 0)"),e.removeClass(r,"bulb-slide").done(function(){r.height(0),c===s&&i.onAnimationsDone()}))}})}else t.error("[bulbSlideAndFade] no element with class ."+a)}(a,l,++s),l=a)})}}}]),angular.module("bulbApp.authModule",["angular-flatpickr","angularMoment","focus-if","googleModule","lodash","ngCookies","restangular","ui.router","ui.select","bulbApp.ajaxModule","bulbApp.busyModule","bulbApp.configModule","bulbApp.errorModule","bulbApp.modalModule","bulbApp.pushNotificationModule","bulbApp.translateModule"]).constant("AUTH",{ROLES:{ADMIN:"ADMIN",USER:"USER",REGISTERED_USER:"REGISTERED_USER",TEST_USER:"TEST_USER",SWITCHED_USER:"SWITCHED_USER",ORGANIZATION_ADMIN:"ORGANIZATION_ADMIN"},PERMISSIONS:{CREATE:"CREATE",READ:"READ",UPDATE:"UPDATE",DELETE:"DELETE",GRANT:"GRANT"},ANONYMOUS_ACCOUNT:{USERNAME:"Anonymous",FIRSTNAME:"Anonymous",LASTNAME:"User",DISPLAY_NAME:"Anonymous User"},PRIVATE_ACCOUNT:{USERNAME:"PrivateAccount",FIRSTNAME:"Private",LASTNAME:"Account",DISPLAY_NAME:"Private Account"}}).run(["$rootScope","AUTH",function(e,t){e.AUTH=t}]).config(["$stateProvider","CONFIG",function(e,t){e.state("signIn",{parent:"bulbView",url:"^/b/sign-in?mfa&redirected",params:{targetUrl:null,mfa:null,redirected:null},resolve:{$title:["$translate",function(e){return e("sign_in")}]},views:{"header@root":{templateUrl:t.resource.cdnRoot+"ajs/components/auth/bulb-header.html",controller:"BulbHeaderController as bulbHeaderCtrl"},"content@root":{templateUrl:t.resource.cdnRoot+"ajs/components/auth/signin.html",controller:"SignInController as signInCtrl"}}}).state("signUp",{parent:"bulbView",url:"^/b/sign-up?prepaidCode&orgToken&mode&uniqueName&&email&position&targetUrl&redirected",params:{connection:null,mode:{value:"default",squash:!0},subscribeMode:"free",targetUrl:null,uniqueName:null,email:null,position:null,redirected:null},resolve:{$title:["$translate",function(e){return e("sign_up")}]},views:{"header@root":{templateUrl:t.resource.cdnRoot+"ajs/components/auth/bulb-header.html",controller:"BulbHeaderController as bulbHeaderCtrl"},"content@root":{templateUrl:t.resource.cdnRoot+"ajs/components/auth/signup.html",controller:"SignUpController as signUpCtrl"}}}).state("trial60",{parent:"signUp",url:"^/b/trybulb60?mode&uniqueName&email&position",params:{mode:"default",subscribeMode:"tryit60",uniqueName:null,email:null,position:null},resolve:{$title:["$translate",function(e){return e("try_it_60")}]}}).state("trial180",{parent:"signUp",url:"^/b/trybulb180?mode&uniqueName&email&position",params:{mode:"default",subscribeMode:"tryit180",uniqueName:null,email:null,position:null},resolve:{$title:["$translate",function(e){return e("try_it_180")}]}}).state("resetPassword",{parent:"bulbView",url:"^/b/resetpassword/newpassword?{token}&redirected",params:{token:{value:"",squash:!0},redirected:null},resolve:{$title:["$translate",function(e){return e("reset_password_title")}]},views:{bulbView:{templateUrl:t.resource.cdnRoot+"ajs/components/auth/resetPassword.html",controller:"ResetPasswordController as resetPasswordCtrl"}}}).state("buyBulb",{parent:"signUp",url:"^/b/buybulb?mode&uniqueName&email&position",params:{connection:null,mode:"default",subscribeMode:"buy",targetUrl:null,uniqueName:null,email:null,position:null},resolve:{$title:["$translate",function(e){return e("buy_bulb")}]}}).state("trialEnding",{parent:"bulbView",url:"^/b/trialEnding"}).state("successfulSignup",{parent:"bulbView",url:"^/b/successful-signup?reloadUrl&setStorage",params:{reloadUrl:null,setStorage:null},onEnter:["$state","$stateParams","$window",function(e,t,n){window.dataLayer=window.dataLayer||[],window.dataLayer.push({event:"Pageview",pagePath:window.location.origin+"/b/successful-signup",pageTitle:"Successful Signup"}),t.setStorage&&localStorage.setItem("isAuthorized","isAuthorized"),t.reloadUrl&&(n.location.href=t.reloadUrl)}]})}]),angular.module("bulbApp.authModule").directive("bulbAuth",["$parse","BulbAuthService","ngIfDirective","AUTH",function(e,t,n,o){var i=n[0];return{transclude:i.transclude,priority:i.priority,terminal:i.terminal,restrict:i.restrict,link:function(n,r,a){var s=e(a.bulbAuth);a.ngIf=function(){return s(n,{currentUser:t.currentUser,PERMISSIONS:o.PERMISSIONS,ROLES:o.ROLES})},i.link.apply(i,arguments)}}}]),function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c,u,d,p,h,g,m,f,b,v){var C=h.originalUser,y=this;function w(e){localStorage.setItem("authMessage",JSON.stringify(e)),localStorage.removeItem("authMessage")}this.currentUser={roles:[f.ROLES.USER],fetched:!1,isAuthenticated:function(){return this.hasRole(f.ROLES.REGISTERED_USER)},hasRole:function(e){return v.isArray(e)||(e=[e]),v.intersection(this.roles,e).length>0},canCreate:function(e){return"Group"===e&&this.isAuthenticated()?this.features.GroupFeature.maxGroups<0||this.features.GroupFeature.maxGroups>this.features.GroupFeature.currentGroups:this.isAuthenticated()},hasPermission:function(e,t){return-1!==e.permissions.indexOf(t)},isPrivate:function(){return this.features.PrivateProfileFeature.enabled}},this.setCurrentUser=function(e){if(e){angular.extend(this.currentUser,e),w({event:"verifyAccount",accountId:e.id,accountVersion:e.version}),this.currentUser.acceptedLatestTerms||this.currentUser.hasRole(f.ROLES.SWITCHED_USER)||a(function(){g.open({titleCode:"",templateUrl:b.resource.cdnRoot+"ajs/components/auth/termsupdated-modal.html",windowClass:"bulb-onboarding-modal-with-close scrollable",closeOnClick:!0,showOkButton:!1,showCancelButton:!1}),u.one("accounts",y.currentUser.id).patch({acceptedLatestTerms:!0}).catch(function(e){n.error("failed to save acceptance of latest terms "+e)}),y.currentUser.acceptedLatestTerms=!0});var t=this.currentUser.prefs.offBoarding;if(null!==t&&!t.isEmailAdded&&(i=t.remindMeLaterDate,c.utc(Date.now())>i)&&!this.currentUser.hasRole(f.ROLES.SWITCHED_USER)){g.dismissAllModals();var o={headerTemplateUrl:b.resource.cdnRoot+"ajs/components/offboarding/offboarding-fontawesome.html",titleCode:"off_board_modal_header",template:"<bulb-offboarding></bulb-offboarding>",windowClass:"updated-modal-design bulb-offboarding-alert-modal",closeOnClick:!0,showOkButton:!1,showCancelButton:!1};g.open(o)}!this.currentUser.hasRole(f.ROLES.SWITCHED_USER)&&this.currentUser.prefs.showHPTrialExpiredModal&&(g.dismissAllModals(),g.show({titleCode:"account_hp_trial_ended_title",bodyCode:"account_hp_trial_ended_body",okButtonCode:"explore_get_it",cancelButtonCode:"account_hp_trial_ended_request_info",headerTemplateUrl:b.resource.cdnRoot+"ajs/components/auth/hp-trialend-modal-header.html",windowClass:"updated-modal-design bulb-aero-modal"}).then(function(){r.go("account.planlist")},function(e){"cancel"===e&&s.open("https://www.bulbapp.com/h/contact-request-a-demo/","_blank")}),this.currentUser.prefs.showHPTrialExpiredModal=!1,u.one("accounts",this.currentUser.id).patch({prefs:this.currentUser.prefs}).then(function(e){y.setCurrentUser(e)}).catch(function(e){n.error("failed to update showHPTrialExpiredModal "+e)}))}else this.currentUser.id=null,this.currentUser.displayName=f.ANONYMOUS_ACCOUNT.DISPLAY_NAME,this.currentUser.firstName=f.ANONYMOUS_ACCOUNT.FIRSTNAME,this.currentUser.lastName=f.ANONYMOUS_ACCOUNT.LASTNAME,this.currentUser.username=f.ANONYMOUS_ACCOUNT.USERNAME,this.currentUser.roles=[f.ROLES.USER];var i},this.setCurrentUser(C),this.signIn=function(e){var t=jQuery.param(e);return u.one("auth","authenticate").customPOST(t,"",{client_name:e.multiFactorCode?"UsernamePasswordMultiFactorClient":"UsernamePasswordClient",targetUrl:"/b/rest/auth/current"},{"Content-Type":"application/x-www-form-urlencoded"}).then(function(e){return w({event:"signIn"}),e})},this.authenticateViaGoogle=function(){var e=o.defer(),t=function(e,t){if(t.error)switch(t.error){case"access_denied":g.show({titleCode:"sign_in_google_access_denied_title",templateUrl:b.resource.cdnRoot+"ajs/components/auth/auth-googleaccessdenied.html",showCancelButton:!1}).finally(function(){e.reject("google_authentication_failed")});break;case"idpiframe_initialization_failed":m.showError("authorizeResponse.details"),e.reject("google_authentication_failed");break;case"popup_closed_by_user":e.reject("google_authentication_failed");break;default:e.reject("google_authentication_failed")}else{var n={client_name:"GoogleTokenClient",targetUrl:"/b/rest/auth/current",code:t.code};u.one("auth","authenticate").customGET("",n).then(function(t){w({event:"signIn"}),e.resolve(t)},function(t){e.reject(t)})}}.bind(y,e);return l.auth2.authorize({client_id:b.google.client.id,scope:"email profile",response_type:"code",prompt:"select_account",cookie_policy:"single_host_origin"},t),e.promise},this.signOut=function(e,t){u.one("auth","logout").customPOST().then(function(){w({event:"signOut"}),localStorage.removeItem("googleModalShown"),t||(s.location.href=e||"/")})},this.isStateAuthorized=function(e){var n=!1;return e.bulbAuth?(e.bulbAuth.authorizedRoles&&(n=this.currentUser.hasRole(e.bulbAuth.authorizedRoles)),e.bulbAuth.isAuthorized&&(n=n||t.invoke(e.bulbAuth.isAuthorized))):n=!0,n},this.fetchCurrentUser=function(){return d.getCurrentAccount().then(function(e){return y.setCurrentUser(e.plain()),y.currentUser.fetched=!0,y.currentUser})},this.adminSignInAs=function(e){var t={action:"switchUser",username:e};this.currentUser.hasRole(f.ROLES.ADMIN)?t.client_name="BulbAdminSwitchUserClient":this.currentUser.hasRole(f.ROLES.ORGANIZATION_ADMIN)&&(t.client_name="OrgAdminSwitchUserClient"),u.one("auth","authenticate").customGET("",t).then(function(){w({event:"adminSignInAs"}),s.location.href="/"+e},function(){g.show({titleCode:"Unable to switch users",bodyText:"Cannot sign in to account. The account cannot be found or you cannot login as another admin.",showOkButton:!0,showCancelButton:!1,fontAwesomeCode:"fas fa-exclamation-triangle",windowClass:"updated-modal-design"})})},this.setUserEnabled=function(e,t){return y.currentUser.hasRole(f.ROLES.ADMIN)?(t=!t,u.one("admin/accounts",e).customPOST({enabled:t},"enabled")):new Error("Unable to toggle user status at BulbAuthService.setUserEnabled.")},this.adminExitUser=function(){u.one("auth","authenticate").customGET("",{action:"switchBack",client_name:"BulbAdminSwitchUserClient"}).then(function(){y.fetchCurrentUser().then(function(e){if(y.setCurrentUser(e),w({event:"adminExitUser"}),y.currentUser.hasRole(f.ROLES.ADMIN))s.location.href="/b/admin";else if(y.currentUser.hasRole(f.ROLES.ORGANIZATION_ADMIN)){for(var t=y.currentUser.groupMemberships,n="",o=0;o<t.length;o++)if(t[o].statuses.isAdmin&&"ORGANIZATION"===t[o].type){n=t[o].groupId;break}r.go("organization",{id:n})}})})},this.isAbleToMakeMacMillanGroups=function(e){if(e)for(var t in e)if(e.hasOwnProperty(t)&&e[t].type.includes("MACMILLAN"))return!0},i.$on("$stateChangeStart",function(e,t,n){"signIn"!==t.name&&"signUp"!==t.name&&"trial60"!==t.name&&"trial180"!==t.name||!y.currentUser.isAuthenticated()?"buyBulb"===t.name&&y.currentUser.isAuthenticated()?(e.preventDefault(),"FREE"===y.currentUser.billing.plan||"BULBFREE2018"===y.currentUser.billing.plan?r.go("account.options"):r.go("account.settings")):"trialEnding"===t.name?(e.preventDefault(),y.currentUser.isAuthenticated()?r.go("account.billing"):r.go("unit.page",{unitPath:"upgrading-to-bulb"})):y.isStateAuthorized(t)||(e.preventDefault(),r.go("accessDenied",{},{location:!1})):n.orgToken&&"signUp"===t.name?(e.preventDefault(),g.show({titleCode:"organization_already_loggedin_error_title",fontAwesomeCode:"fas fa-random",okButtonCode:"logout",windowClass:"updated-modal-design bulb-aero-modal bulb-organization-modal",bodyCode:"organization_already_loggedin_error_body"}).then(function(){y.signOut()}).finally(function(){s.history.back()})):(e.preventDefault(),r.go("author",{username:y.currentUser.username}))}),s.addEventListener("storage",function(e){if("authMessage"===e.key&&null!==e.newValue){var t=JSON.parse(e.newValue);switch(t.event){case"signIn":case"signOut":case"adminSignInAs":case"adminExitUser":s.location.reload();break;case"verifyAccount":t.accountId!==y.currentUser.id?s.location.reload():t.accountVersion!==y.currentUser.version&&y.fetchCurrentUser()}}})}e.$inject=["$cookies","$injector","$log","$q","$rootScope","$state","$timeout","$window","google","moment","Restangular","BulbAjaxService","BulbBusyService","BulbFetchUserService","BulbModalService","BulbErrorService","AUTH","CONFIG","_"],angular.module("bulbApp.authModule").service("BulbAuthService",e)}(),angular.module("bulbApp.authModule").component("bulbAuthDivider",{templateUrl:["CONFIG",function(e){return e.resource.cdnRoot+"ajs/components/auth/authdivider.html"}]}),function(){"use strict";function e(e,t,n,o,i){this.currentUser=i.currentUser,this.languages=o.languages,this.languagesList=o.getLanguagesList(),this.getLanguage=o.getLanguage,this.getLanguageAsString=o.localeToString,this.setLanguage=function(t){var i=t.selectedOption?t.selectedOption:t;i!==o.getLanguage()&&(o.use(i),e.put("language",i),n.location.reload())},this.handleBulbLogoClick=function(){n.location.href="//bulbapp.com"}}e.$inject=["$cookies","$state","$window","$translate","BulbAuthService"],angular.module("bulbApp.authModule").controller("BulbHeaderController",e)}(),function(){"use strict";function e(e,t,n,o,i,r,a,s){var l=this;this.email="",this.password="",this.confirmPassword="",this.showBadTokenError=!1,t.redirected?this.redirected=t.redirected:this.redirected=!1,this.isResetPasswordView=!1,t.token&&(this.isResetPasswordView=!0,this.resetPasswordToken=t.token),this.requestResetPassword=function(e){this.email&&(this.showBadTokenError=!1,i.showBusyDuring(s.all("accounts/passwordToken").post({email:l.email}).then(function(t){l.showConfirmationDialog(e)},function(e){e.data.errorMap?l.resetPasswordForm.handleRemoteErrors(e):r.showError(null,e)})))},this.resetPassword=function(){this.resetPasswordToken&&(this.showBadTokenError=!1,i.showBusyDuring(s.all("accounts/newPassword").patch({password1:l.password,password2:l.confirmPassword,resetPasswordToken:l.resetPasswordToken}).then(function(t){o.setCurrentUser(t.plain()),e.go("author",{username:o.currentUser.username})},function(e){if(e.data.errorMap){var t=e.data.errorMap;t.fieldErrors.resetPasswordToken?(l.showBadTokenError=!0,l.formError=t.fieldErrors.resetPasswordToken,l.isResetPasswordView=!1):l.resetPasswordForm.handleRemoteErrors(e)}else r.showError(null,e)})))},this.showConfirmationDialog=function(e){var t={titleCode:"reset_password_title",bodyCode:"reset_password_look_for_email",showOkButton:!1,showCancelButton:!1,focusAfterClosed:e.currentTarget};a.show(t)},this.goBack=function(){n.history.back()}}e.$inject=["$state","$stateParams","$window","BulbAuthService","BulbBusyService","BulbErrorService","BulbModalService","Restangular"],angular.module("bulbApp.accountModule").controller("ResetPasswordController",e)}(),angular.module("bulbApp.autoSaveModule",["restangular","bulbApp.translateModule"]).constant("AUTO_SAVE",{STATUS:{PRISTINE:"AUTO_SAVE_PRISTINE",DIRTY:"AUTO_SAVE_DIRTY",SAVING:"AUTO_SAVE_SAVING",SAVED:"AUTO_SAVE_SAVED",ERROR:"AUTO_SAVE_ERROR"},EVENT:"bulbAutoSave"}).run(["$rootScope","AUTO_SAVE",function(e,t){e.AUTO_SAVE=t}]),angular.module("bulbApp.autoSaveModule").directive("bulbAutoSave",["$log","$parse","$rootScope","Restangular","BulbAutoSaveService","AUTO_SAVE",function(e,t,n,o,i,r){return{restrict:"A",require:"ngModel",link:function(n,o,r,a){var s,l=!1;try{if(s=n.$eval(r.bulbAutoSave),!angular.isObject(s))throw"bulb-auto-save's value must be an Object, with restCollection and restId fields"}catch(t){throw e.error(t.message),"bulb-auto-save's value must be an Object, with restCollection and restId fields"}if(angular.isFunction(s.customSave)&&(l=!0),!l){if(!angular.isString(s.restCollection))throw"bulb-auto-save's value Object must contain a (String) restCollection field";if(!angular.isString(s.restId))throw"bulb-auto-save's value Object must contain a (String) restId field";if(!angular.isString(r.name))throw"bulb-auto-save requires a name attribute"}if(s.callback&&!angular.isFunction(s.callback))throw"bulb-auto-save's value Object callback parameter must be a function if provided";if(s.getter&&!angular.isFunction(s.getter))throw"bulb-auto-save's value Object getter parameter must be a function if provided";var c=s.getter?s.getter():t(r.ngModel)(n);a.$viewChangeListeners.push(function(){var e=s.getter?s.getter():a.$modelValue;if(e!==c)if(l)i.customAutoSave(s.customSave,s.restId);else{var t={};t[a.$name]=e,i.autoSave(s.restId,s.restCollection,t,s.callback)}c=e})}}}]),function(){"use strict";function e(e,t,n){var o=this;function i(t){o.autoSaveDetails={status:n.STATUS.SAVING,restId:t},e.$emit(n.EVENT,o.autoSaveDetails)}function r(t,i,r,a){o.autoSaveDetails={restId:i},t.then(function(t){o.autoSaveDetails.status=n.STATUS.SAVED,"units"===r&&!1===t.success&&(o.autoSaveDetails.status=n.STATUS.ERROR),a&&a(t),e.$emit(n.EVENT,o.autoSaveDetails)},function(){o.autoSaveDetails.status=n.STATUS.ERROR,e.$emit(n.EVENT,o.autoSaveDetails)})}this.autoSaveDetails={},this.autoSave=function(e,n,o,a){i(e);var s=t.one(n,e);r("units"===n?s.customPOST(o,"update"):s.patch(o),e,n,a)},this.customAutoSave=function(e,t){i(t),r(e(),t)}}e.$inject=["$rootScope","Restangular","AUTO_SAVE"],angular.module("bulbApp.autoSaveModule").service("BulbAutoSaveService",e)}(),angular.module("bulbApp.autoSaveModule").directive("bulbAutoSaveStatus",["$log","$rootScope","$timeout","$window","AUTO_SAVE",function(e,t,n,o,i){return{restrict:"E",scope:{},template:"{{autoSaveStatus | translate}}",link:function(o,r,a){n(function(){var e=$(".bulb-page-post-footer").outerHeight();$(r).parent().css("bottom",e+28+"px")}),o.autoSaveStatus=i.STATUS.PRISTINE;var s=0,l=!1;t.$on(i.EVENT,function(t,n){switch(n.status){case i.STATUS.SAVING:++s,o.autoSaveStatus=i.STATUS.SAVING,l=!1,r.removeClass("bulb-auto-save-error");break;case i.STATUS.SAVED:--s<0&&(e.warn("bulbAutoSaveStatus.savingReferenceCount was decremented below zero"),s=0),0!==s||l||(o.autoSaveStatus=i.STATUS.SAVED);break;case i.STATUS.ERROR:l=!0,o.autoSaveStatus=i.STATUS.ERROR,r.addClass("bulb-auto-save-error"),--s;break;default:o.autoSaveStatus=status}})}}}]),angular.module("bulbApp.avatarImageModule",["bulbApp.configModule"]),angular.module("bulbApp.avatarImageModule").service("BulbAvatarService",["CONFIG",function(e){this.getDefaultAvatarImage=function(t,n){var o=e.resource.cdnRoot;if("author"===t)return o+"resources/images/bulb_user_avatar.svg";if("group"===t){if(n.features&&n.features.macMillan){var i=n.features.macMillan.book;return"NEXT_STATION_2"===i?o+"resources/images/next_station_2_circle.svg":"NEXT_STATION_3"===i?o+"resources/images/next_station_3_circle.svg":"NEXT_STATION_4"===i?o+"resources/images/next_station_4_circle.svg":o+"resources/images/bulb_group_avatar.svg"}return o+"resources/images/bulb_group_avatar.svg"}}}]),angular.module("bulbApp.badgesModule",["ui.router","bulbApp.authModule","bulbApp.configModule","bulbApp.utilsModule","bulbApp.authorModule"]).config(["$stateProvider","AUTH","CONFIG",function(e,t,n){e.state("badges",{parent:"author",url:"/badges",resolve:{$title:["$translate",function(e){return e("badges_title")}],userBadgeInfo:["authorAccount","$stateParams","BulbBusyService","Restangular",function(e,t,n,o){return o.one("accounts",e.id).one("badges").get().then(function(e){return e})}]},views:{profileDetails:{templateUrl:n.resource.cdnRoot+"ajs/components/badge/badgecontainer.html",controller:"BadgeContainerController as badgeContainerCtrl"}},onEnter:["$state","BulbAuthService","authorAccount","userBadgeInfo",function(e,t,n,o){(t.currentUser.id===n.id||o)&&n.hasBadges||e.go("notFound",{},{location:!1})}]})}]),function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c,u,d,p){var h=this;e.result.then(function(){n.showBusyDuring(r.one("accounts",t.currentUser.id).one("badges").post().then(function(e){e?c.reload():h.showBadgeMissingModal()}).catch(function(e){o.error("Cannot update the user badges",e)}).finally(function(){l.$dismiss("cancel")}))});var g={okButtonCode:"button_ok",bodyCode:"badge_modal_not_found_text",windowClass:"bulb-badgenotfound-modal",showTitle:!1,showCancelButton:!1};this.showBadgeMissingModal=function(){i.show(g)},this.cancel=function(){l.$dismiss("cancel")}}e.$inject=["$modalInstance","BulbAuthService","BulbBusyService","BulbErrorService","BulbModalService","Restangular","$modal","$rootScope","$scope","$state","$stateParams","$window","CONFIG"],angular.module("bulbApp.badgesModule").controller("AccountAddBadgeModalController",e)}(),function(){"use strict";function e(e,t,n,o,i,r,a){var s=this;this.currentBadge=e.badgeCtrl.badgeObject,this.hoverIn=function(){this.showTitle=!0},this.hoverOut=function(){this.showTitle=!1};var l={okButtonCode:"button_ok",templateUrl:"badgeinfomodal",showCancelButton:!1,windowClass:"bulb-badge-modal",controller:["$scope",function(e){e.fullBadge=s.currentBadge}]};this.showBadgeModal=function(e){e.stopPropagation(),e.preventDefault(),i.show(l)}}e.$inject=["$scope","$state","BulbAuthService","BulbBlockViewSwitcherService","BulbModalService","BulbPresentationService","AUTH"],angular.module("bulbApp.badgesModule").controller("BadgeController",e)}(),angular.module("bulbApp.badgesModule").directive("bulbBadge",["CONFIG",function(e){return{templateUrl:e.resource.cdnRoot+"ajs/components/badge/badge.html",scope:{badgeObject:"="},controller:"BadgeController as badgeCtrl",bindToController:!0}}]),function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c){var u=this;u.accordion=t?{oneAtATime:!1,groups:t.badgeGroups}:{oneAtATime:!1,groups:[]},this.userInfo=e,i(function(){$(".bulb-badges-accordion-group a").click()}),this.canRefreshBadges=function(){return u.userInfo.id===r.currentUser.id},this.toggleChevron=function(e){$("#chevron_for_"+e).toggleClass("rot180")};var d={templateUrl:"badges.addBadges.nested",windowClass:"bulb-badgenotfound-modal",showTitle:!1,showCancelButton:!1,showOkButton:!1,controller:"AccountAddBadgeModalController as accountAddBadgeModalCtrl"};this.showAddBadgesModal=function(){l.show(d)},this.cancelAddBadgesModal=function(){n.$dismiss("cancel")},this.manuallyRefreshBadges=function(){a.showBusyDuring(c.one("accounts",r.currentUser.id).one("badges").post().then(function(e){e?o.reload():u.showBadgeMissingModal()}).catch(function(e){s.error("Cannot update the user badges",e)}))};var p={okButtonCode:"button_ok",bodyCode:"badge_modal_no_more_badges_text",windowClass:"bulb-badgenotfound-modal",showTitle:!1,showCancelButton:!1};this.showBadgeMissingModal=function(){l.show(p)}}e.$inject=["authorAccount","userBadgeInfo","$scope","$state","$timeout","BulbAuthService","BulbBusyService","BulbErrorService","BulbModalService","Restangular"],angular.module("bulbApp.badgesModule").controller("BadgeContainerController",e)}(),angular.module("bulbApp.bitRateModule",["lodash"]).constant("BITRATE",{defaultOptions:{timeout:1e3,lowerBoundBitrate:32e4,highestBoundBitrate:192e4},downloadFile:{size:3e5,url:"https://d88n5qxmt9dn1.cloudfront.net/connection/test_connection_300kb.txt"}}).run(["$rootScope","BITRATE",function(e,t){e.BITRATE=t}]),function(){"use strict";function e(e,t,n){this.getOptimalQuality=function(o){var i,r,a,s,l=0;(i=n.downloadFile,r=t.defer(),a=new XMLHttpRequest,s=(new Date).getTime(),a.open("GET",i.url+"?timestamp="+s,!0),a.onreadystatechange=function(){if(4===a.readyState)if(200===a.status){var e=((new Date).getTime()-s)/1e3;r.resolve(e)}else r.reject(a.statusText)},a.send(),r.promise).then(function(e){l=n.downloadFile.size/e,o(l)},function(t){e.error(t),o(n.defaultOptions.lowerBoundBitrate)})}}e.$inject=["$log","$q","BITRATE"],angular.module("bulbApp.bitRateModule").service("BulbBitRateService",e)}(),angular.module("bulbApp.blockModule",["as.sortable","mm.foundation","ui.utils","bulbApp.ajaxModule","bulbApp.authModule","bulbApp.avatarImageModule","bulbApp.configModule","bulbApp.translateModule"]).constant("TITLE_THRESHOLD_LENGTH",{shortenedTitleLength:45}).run(["$rootScope","TITLE_THRESHOLD_LENGTH",function(e,t){e.TITLE_THRESHOLD_LENGTH=t}]).value("uiJqConfig",{dotdotdot:{watch:!0,callback:function(e,t){}}}),function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c,u){var d=this,p=this.unit;this.shortTitle=u.shortenedTitleLength,this.blockType=function(e){switch(e.unitType){case"CompositeUnit":return"collection";case"ArchiveCompositeUnit":return"archiveCollection";case"DraftPageUnit":case"PublishedPageUnit":case"ArchivePageUnit":return"page";case"GroupUnit":return"group";case"UserUnit":return"user";default:return e.unitType}}(p),this.presentation=!1,this.myArchiveCollectionTitle=o.instant("ArchiveCompositeUnit"),this.isDeleted=p.deleteAfterDays&&p.deleteAfterDays>0,this.canOpen=!(this.isDeleted&&"page"===d.blockType),this.getAvatarImage=r.getDefaultAvatarImage,t.viewSwitcherService=a,this.init=function(){switch(this.blockType){case"group":this.uiSref='group({groupUrl: "'+p.url+'"})',this.avatarImage=p.circularImage;break;case"user":this.uiSref='author({username: "'+p.ownerUsername+'"})',this.avatarImage=p.circularImage;break;case"collection":case"archiveCollection":this.uiSref=this.isDeleted?".":'unit({unitPath: "'+p.path+'"})',this.coverImage=p.coverImage;break;case"page":this.uiSref=this.presentation?l.createHref(p):'unit({unitPath: "'+p.path+'"})',p.isModified&&(this.statusClass=p.isPublished?"bulb-block-modified":"bulb-block-unpublished"),this.coverImage=p.horizontalImage}this.titleBreak(p.name)},this.canEdit=!this.isDeleted&&i.currentUser.hasPermission(this.unit,c.PERMISSIONS.UPDATE),this.publishStatusClick=function(){if(!d.canOpen)return!1;if(this.unit.isPublished){s.show({titleCode:"block_publish_status_modified_dialog_title",bodyCode:"block_publish_status_modified_dialog_body",okButtonCode:"block_publish_status_modified_dialog_submit_button",cancelButtonCode:"button_later"}).then(function(){n.go("unit",{unitPath:d.unit.path})})}else n.go("unit",{unitPath:d.unit.path,publish:!0})},this.titleBreak=function(e){if(" "!==e.charAt(this.shortTitle)&&e.length>this.shortTitle){var t=e.lastIndexOf(" ",this.shortTitle);this.shortenedTitleLength=t}else this.shortenedTitleLength=this.shortTitle;if(this.shortenedTitleLength<0){var n=(this.shortTitle/3).toFixed(0);this.shortenedTitleLength=n}},this.open=function(t){if(this.canOpen)t&&"CompositeUnit"===t.unitType&&this.isDeleted&&e.$broadcast("openDeletedCollection",t);else{var n=o.instant("type_draft_page_unit"),i=o.instant("soft_delete_open_deleted_unit",{type:n});s.show({bodyText:i,showCancelButton:!1})}},this.handleKeyPress=function(e,t){d.open(e),"Enter"!==t.key&&" "!==t.key||!this.canOpen||"CompositeUnit"===e.unitType&&this.isDeleted||n.go("unit",{unitPath:e.path})}}e.$inject=["$rootScope","$scope","$state","$translate","BulbAuthService","BulbAvatarService","BulbBlockViewSwitcherService","BulbModalService","BulbPresentationService","AUTH","TITLE_THRESHOLD_LENGTH"],angular.module("bulbApp.blockModule").controller("BlockController",e)}(),angular.module("bulbApp.blockModule").directive("bulbBlock",["$compile","CONFIG",function(e,t){return{restrict:"E",scope:{unit:"=",authorImpliedByContext:"=?",typeImpliedByContext:"=?",tile:"@"},template:'<div ng-include="getTemplateUrl()"></div>',controller:"BlockController as blockCtrl",bindToController:!0,link:function(e,n,o,i){function r(){var e=i.unit.coverImage;if(e){var t=jQuery(".bulb-block-cover-image",n);e.width/e.height>t.width()/t.height()?i.coverImageAspect="wide":i.coverImageAspect="tall"}else i.coverImageAspect=null}e.getTemplateUrl=function(){return t.resource.cdnRoot+"ajs/components/block/"+("true"===o.tile?"block-tile":"block")+".html"},""===o.authorImpliedByContext&&(i.authorImpliedByContext=!0),""===o.typeImpliedByContext&&(i.typeImpliedByContext=!0),i.isTile=o.tile,i.presentation=o.presentation,i.init(),"collection"===i.blockType&&(i.unit.hasOwnProperty("coverImage")||i.unit.hasOwnProperty("horizontalImageUrl"))&&n.find("footer").appendTo(n.find(".bulb-block")),"collection"===i.blockType&&(e.$watch("blockCtrl.unit.coverImage",r),e.$watch(function(){return jQuery(".bulb-block-cover-image",n).width()},r))}}}]),function(){"use strict";function e(e,t){e.viewSwitcherService=t,this.showTile=function(){t.disableDraggingForArchiveCollection("tile"),t.updateAccountPreferences(this.infoType,!0)},this.showList=function(){t.disableDraggingForArchiveCollection("list"),t.updateAccountPreferences(this.infoType,!1)},this.isDisplayed=function(){return t.isSwitchable(this.infoType)}}e.$inject=["$scope","BulbBlockViewSwitcherService"],angular.module("bulbApp.blockModule").controller("BlockViewSwitcherController",e)}(),angular.module("bulbApp.blockModule").directive("bulbBlockViewSwitcher",["CONFIG",function(e){return{restrict:"E",scope:{infoType:"@"},templateUrl:e.resource.cdnRoot+"ajs/components/block/blockviewswitcher.html",controller:"BlockViewSwitcherController as blockViewSwitcherCtrl",bindToController:!0,link:function(e,t,n,o){o.infoType=n.infoType}}}]),function(){"use strict";function e(e,t,n,o,i,r){if(this.isAnonymous=!i.currentUser.isAuthenticated(),this.prefs={useTileViewProfile:!0,useTileViewCollection:!0,useTileViewGroupMember:!0,useTileViewGroupContent:!0,useTileViewAssetLibrary:!1},this.getViewSettingKey=function(e){var t="useTileView";switch(e){case"profile":t+="Profile";break;case"collection":t+="Collection";break;case"group_member":t+="GroupMember";break;case"group_content":t+="GroupContent";break;case"asset_library":t+="AssetLibrary"}return t},this.isAnonymous){var a=e.get("prefs");a&&$.extend(this.prefs,$.parseJSON(a))}else $.extend(this.prefs,i.currentUser.prefs);this.isSwitchable=function(e){return n.utils.is_large_up()||"asset_library"===e&&n.utils.is_medium_up()},this.isTile=function(e){return!!this.isSwitchable(e)&&this.prefs[this.getViewSettingKey(e)]},this.updateAccountPreferences=function(t,n){if(this.isSwitchable(t)){this.prefs[this.getViewSettingKey(t)]=n;var a=new Date;a.setFullYear(a.getFullYear()+10),e.put("prefs",JSON.stringify(this.prefs),{expires:a}),this.isAnonymous||(angular.copy(this.prefs,i.currentUser.prefs),o.one("accounts",i.currentUser.id).patch({prefs:this.prefs}).catch(function(e){r.error("Cannot update the user preferences",e)}))}},this.disableDraggingForArchiveCollection=function(e){t(function(){var t=jQuery(".bulb-block-archive-collection");t&&t.draggable("option","disabled",!0),"tile"===e?$(".bulb-block-switch-view-btn-list").focus():"list"===e&&$(".bulb-block-switch-view-btn-tile").focus()})}}e.$inject=["$cookies","$timeout","Foundation","Restangular","BulbAuthService","BulbErrorService"],angular.module("bulbApp.blockModule").service("BulbBlockViewSwitcherService",e)}(),function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c,u,d){this.isSingleAuthor="GroupUnit"!==this.compositeUnit.unitType,this.isSingleType="CompositeUnit"===this.compositeUnit.unitType,this.isTemplate=this.compositeUnit.isTemplate;var p=s.currentUser,h=this.compositeUnit.children;if(this.showRecycleBin=this.compositeUnit.deleteAfterDays>0,e.readOnly=this.readOnly=!p.hasPermission(this.compositeUnit,u.PERMISSIONS.UPDATE),e.viewSwitcherService=l,e.showRecentlyDeletedButton=!1,e.deletedCompositeUnit=void 0,c.authorAccountId&&(p.id===c.authorAccountId||c.isAdmin())&&c.getDeletedUnitCount().then(function(t){e.noOfDeletedUnit=t||0,e.showRecentlyDeletedButton=c.isAdmin()||e.noOfDeletedUnit>0}),e.showBreadcrumbForDeletedUnit=function(t,i){"DeletedUserUnit"===i?n.reload():(e.deletedCompositeUnit=void 0,o(function(){"UserUnit"!==t.unitType&&(e.deletedCompositeUnit=t)}))},"UserUnit"===this.compositeUnit.unitType){var g=this.compositeUnit.children.findIndex(function(e){return"ArchiveCompositeUnit"===e.unitType});if(-1!==g){var m=h[g];h.splice(g,1),h.push(m)}}this.toggleRecycleBin=function(e){e?this.showRecycleBin=e:n.reload()},this.saveReorder=function(e){this.compositeUnit.children||t("Invalid argument","The unit does not have any children");var n=this.compositeUnit.children.length;(e<0||e>=n)&&t("Invalid argument","The child index is not valid"),a.compositeUnitReorder(this.compositeUnit,e)}}e.$inject=["$scope","$exceptionHandler","$state","$timeout","$window","Foundation","BulbAjaxService","BulbAuthService","BulbBlockViewSwitcherService","BulbDeletedUnitService","AUTH","_"],$("body").on("touchmove",function(e){$("body").hasClass("disable-scroll")&&e.preventDefault()}),angular.module("bulbApp.blockModule").controller("DraggableUnitBlockContainerController",e)}(),angular.module("bulbApp.blockModule").constant("DRAG",{TOUCH_DELAY:1e3,END_EVENT_DRAG_KILL_WAIT:200}).run(["$rootScope","DRAG",function(e,t){e.DRAG=t}]).directive("bulbDraggableUnitBlockContainer",["$log","$timeout","BulbAuthService","BulbBlockViewSwitcherService","BulbSubCollectionService","BulbUnitDroppableService","BulbBrowserService","CONFIG","DRAG",function(e,t,n,o,i,r,a,s,l){return{restrict:"E",scope:{compositeUnit:"=",infoType:"@"},templateUrl:s.resource.cdnRoot+"ajs/components/block/draggableunitblockcontainer.html",controller:"DraggableUnitBlockContainerController as draggableUnitBlockContainerCtrl",bindToController:!0,link:function(e,s,c,u){e.isMobile=a.isMobile();var d=u.compositeUnit;s.find(".bulb-sortable-block-container").removeAttr("tabindex"),u.infoType=c.infoType,o.disableDraggingForArchiveCollection();var p=function(){var n=!1,o=null,i=null;e.mobileTouchHoldReached=!1;var r=function(e){null!==o&&(t.cancel(o),o=null),null},c=function(){var s=function(t,o){n=!0,r(),e.mobileTouchHoldReached=!0,jQuery(o).draggable("enable"),jQuery(o).trigger(t),jQuery(o).addClass("ui-draggable-dragging")},c=function(){s(i.event,i.node)}.bind(this);return a.androidBlockAndExecuteCallbackOnOptionsMenu(c),{handleMoveEvents:function(e){r()},handleEndEvents:function(o,i){t(function(){!function(t,o){n=!1,e.mobileTouchHoldReached=!1,jQuery(t).draggable("disable")}(i)},l.END_EVENT_DRAG_KILL_WAIT),r()},handleStartEvents:function(e,r){a.isIOSMobile()&&null!==o&&e.preventDefault(),i={event:e,node:r},n||(o=t(function(){s(e,r)},l.TOUCH_DELAY))}}}();t(function(){s.find("article").each(function(e,t){jQuery(t).on("touchend mouseup mouseleave",function(e){c.handleEndEvents(e,t)}).on("touchstart",function(e){c.handleStartEvents(e,t)}).on("mousemove",function(e){c.handleMoveEvents(e)})})})};e.evaluateMobile=function(){e.isMobile&&p()},e.dragAndDrop={onDragStart:function(e,t,o,r){"CompositeUnit"!==r.unitType||n.currentUser.features.SubCollectionFeature.enabled&&i.canDropCollectionIntoSubCollection()||jQuery(".bulb-block-wrapper.bulb-block-collection").droppable("disable"),t.helper.addClass("bulb-dragging"),jQuery("#drop-order-"+o+", #drop-order-"+(o+1)).droppable("disable"),jQuery("body").addClass("dummyClass").removeClass("dummyClass")},onDragStop:function(e,t,n){jQuery(".bulb-block-wrapper.bulb-block-collection").droppable("enable"),t.helper.removeClass("bulb-dragging"),jQuery("#drop-order-"+n+", #drop-order-"+(n+1)).droppable("enable")},onOrderDrop:function(e,t,n){var o,i,r;t.draggable.removeAttr("style"),o=n>t.draggable.scope().$index?n-1:n,i=t.draggable.scope().childUnit,(r=d.children).forEach(function(e,t){e!==i||r.splice(t,1)}),r.splice(o,0,i),u.saveReorder(o)},onEntryDrop:function(e,t,n,o){r.onUnitDroppable(d.children,t.draggable.scope().childUnit,o)}}}}}]),function(){"use strict";function e(e,t,n){this.browserInfo={firefox:{name:"Firefox",version:11},safari:{name:"Safari",version:5},chrome:{name:"Chrome",version:16},ipad:{name:"Safari iPad",version:6},iphone:{name:"Safari iPhone",version:6},msedge:{name:"Microsoft Edge",version:14.14393}},this.browserNames={Chrome:"chrome",ChromeHeadless:"chromeheadless","Microsoft Edge":"msedge",Firefox:"firefox",Safari:"safari",iPad:"safari-ipad",iPhone:"safari-iphone",iPod:"safari-ipod","Internet Explorer":"ie","Windows Phone":"windows-phone",Opera:"opera",Sailfish:"sailfish",SeaMonkey:"seamonkey","Amazon Silk":"silk",Android:"android",PhantomJS:"phantomjs",BlackBerry:"blackberry",WebOS:"webos",Bada:"bada",Tizen:"tizen"},this.browserBots=["Googlebot","bingbot","Yahoo! Slurp","Baiduspider"],this.safariAliases={iPad:"safari",iPhone:"safari",iPod:"safari"},this.isSupported=function(){for(var o in e.debug("BulbBrowserService.isSupported: bowser: "+JSON.stringify(n)),this.browserInfo)if(n[o]){var i=this.browserInfo[o],r=parseFloat(n.version);return isNaN(r)?(e.debug("BulbBrowserService.isSupported: info: "+JSON.stringify(i)+" cannot parse version: not supported"),!1):r>=i.version?(e.debug("BulbBrowserService.isSupported: info: "+JSON.stringify(i)+" version supported"),!0):(e.debug("BulbBrowserService.isSupported: info: "+JSON.stringify(i)+" version not supported"),!1)}for(var a=0;a<this.browserBots.length;a++)if(t.navigator.userAgent.search(this.browserBots[a])>=0)return!0;return e.debug("BulbBrowserService.isSupported: browser not supported"),!1},this.getBrowserAttributes=function(){var e,t,o=[];for(var i in n)if(!0===n[i]){if(i.match(/\b[acx]\b/))continue;o.push(i)}else if("version"===i)t=parseInt(n[i],10);else if("name"===i){e=this.browserNames[n[i]];var r=this.safariAliases[n[i]];r&&o.push(r)}return e&&t&&o.push(e+"-"+t),o.join(" ")},this.isChromeBook=function(){return n.chromeBook||!1},this.isMobile=function(){var e=navigator.userAgent;return e.indexOf("iPad")>=0||e.indexOf("iPhone")>=0||e.indexOf("iPod")>=0||e.indexOf("Android")>=0||e.indexOf("Windows Phone")>=0},this.isIOSMobile=function(){return navigator.userAgent.indexOf("iPhone")>=0||navigator.userAgent.indexOf("iPod")>=0},this.isIpad=function(){return navigator.userAgent.indexOf("iPad")>=0},this.isAndroid=function(){return navigator.userAgent.indexOf("Android")>=0},this.isWindowsMobile=function(){return navigator.userAgent.indexOf("Windows Phone")>=0},this.isSafari=function(){var e=navigator.userAgent;return/^((?!chrome|android).)*safari/i.test(e)},this.isPWAEnvironment=function(){return navigator.userAgent.indexOf("MSAppHost")>-1&&jQuery("html").attr("bulb-browser").indexOf("msedge")>-1},this.isMsEdge=function(){var e=jQuery("html").attr("bulb-browser").indexOf("msedge")>-1,t=window.navigator.userAgent.indexOf("Edg")>-1,n=window.navigator.userAgent.indexOf("MSAppHost")>-1;return(e||t)&&!n},this.isFireFox=function(){return jQuery("html").attr("bulb-browser").indexOf("firefox")>-1},this.isFacebookOrInstagramInAppBrowser=function(){var e=navigator.userAgent;return e.indexOf("FBAN")>-1||e.indexOf("FBAV")>-1||e.indexOf("Instagram")>-1},this.isTouchDevice=function(){return $("html").hasClass("touch")},this.androidBlockAndExecuteCallbackOnOptionsMenu=function(e){this.isAndroid()&&(window.oncontextmenu=function(t){return t.preventDefault(),t.stopPropagation(),null!==e&&e instanceof Function&&e.call(),!1})}}e.$inject=["$log","$window","bowser"],angular.module("bulbApp.browserModule",[]).value("bowser",window.bowser).service("BulbBrowserService",e)}(),angular.module("bulbApp.busyModule",["bulbApp.configModule","bulbApp.modalModule"]),function(){"use strict";function e(e,t,n,o,i,r){var a=r.resource.cdnRoot+"ajs/components/busy/busy-cover.html",s=null,l=0;function c(e){e.preventDefault()}function u(){--l<=0&&(l=0,e.off("keydown",c),s&&(s.remove(),s=null))}this.showBusyDuring=function(n){var r;return l++,(r=t.defer(),1===l?(e.on("keydown",c),o.get(a,{cache:i}).then(function(e){s=$(e.data),$("body").append(s)}).finally(function(){r.resolve()})):r.resolve(),r.promise).finally(function(){n.finally(u)}),n},this.showBusy=function(){var e=t.defer();return this.showBusyDuring(e.promise),e.resolve}}e.$inject=["$document","$q","$timeout","$http","$templateCache","CONFIG"],angular.module("bulbApp.busyModule").service("BulbBusyCoverService",e)}(),function(){"use strict";function e(e,t,n,o,i){var r=this,a={templateUrl:i.resource.cdnRoot+"ajs/components/busy/busy.html",windowClass:"bulb-busy-modal",keyboard:!1,backdrop:"static"},s=null,l=0;function c(e){e.preventDefault()}this.hideBusy=function(){--l<=0&&(l=0,s&&(s.close(),s=null))},this.showBusyDuring=function(n){return l++,s||(s=t.open(a),e.on("keydown",c),s.opened.then(function(){o(function(){jQuery(".reveal-modal-bg").addClass("bulb-busy-bg")})}),s.result.finally(function(){e.off("keydown",c)}),r.showBusyDuring(s.opened)),n.finally(r.hideBusy),n},this.showBusy=function(){var e=n.defer();return this.showBusyDuring(e.promise),e.resolve}}e.$inject=["$document","$modal","$q","$timeout","CONFIG"],angular.module("bulbApp.busyModule").service("BulbBusyService",e)}(),angular.module("bulbApp.busyModule").directive("bulbInlineBusy",["$compile","$templateRequest","CONFIG",function(e,t,n){return{restrict:"A",scope:!0,link:function(o,i,r){o.busy=!0,r.$observe("bulbInlineBusy",function(e){o.busy="true"===e||""===e}),t(n.resource.cdnRoot+"ajs/components/busy/inlinebusy.html").then(function(t){var n=angular.element(t);i.append(n),e(n)(o)})}}}]),angular.module("bulbApp.checkboxModule",[]),angular.module("bulbApp.checkboxModule").directive("bulbCheckbox",function(){return{restrict:"A",replace:!0,compile:function(){return{pre:function(e,t,n){t.wrap('<label class="bulb-checkbox"></label>'),t.parent().append('<div class="custom-checkbox"></div>')}}}}}),angular.module("bulbApp.commentModule",["ui.router","bulbApp.authModule","bulbApp.configModule","bulbApp.unitModule"]),function(){"use strict";function e(e,t,n,o,i){var r=this;this.pageComment=null,this.isCommentPrivate=!1,this.canMakePrivateComment=!1,this.menuVisible=!1,this.currentEditingCommentId=null,this.currentEditingCommentContent=null,this.switchMenu=function(e){this.menuVisible=!this.menuVisible,e.stopPropagation()},this.consumeEvent=function(e){e.stopPropagation()},this.switchArchivedVisible=function(){n.showArchivedComments=!n.showArchivedComments,n.refreshBubbleButtons(),n.api.updateAccountPreferences()},this.switchReply=function(e){var t=!0===n.lowerCommentExpanded[e.id];n.lowerCommentExpanded[e.id]=!t;for(var o=1;o<e.comments.length;o++)e.comments[o].privateComment=e.privateComment,e.comments[o].isQuotation=e.quotation},this.comment=function(e){n.draftThread=null,e.comments&&e.comments.length?(n.lowerCommentExpanded[e.id]=!0,n.api.comment(e,n.threadComment[e.id],r.isCommentPrivate).then(r.resetCommentState(e.id))):n.api.createThread(e.targetId,e.quotation,n.threadComment[e.id],r.isCommentPrivate).then(r.resetCommentState(e.id))},this.commentPage=function(){n.api.commentPage(this.pageComment,this.isCommentPrivate).then(r.resetCommentState())},this.resetCommentState=function(e){e?n.threadComment[e]="":r.pageComment=null,r.isCommentPrivate=n.canMakePrivateComment()},this.editComment=function(e){this.currentEditingCommentId=e.id,this.currentEditingCommentContent=e.content};var a=function(e){r.currentEditingCommentId=null,r.currentEditingCommentContent=null,e.$pristine=!0};this.updateComment=function(e,t,o){n.api.updateComment(e,r.currentEditingCommentId,r.currentEditingCommentContent).then(function(e){t.content=r.currentEditingCommentContent,a(o)})},this.cancelEdit=function(e){a(e)},this.deleteComment=function(e,t){o.showMessage("comment_delete_comment_confirm",{windowClass:"",okButtonCode:"button_delete",showCancelButton:!0}).then(function(o){o.result.then(function(){n.api.deleteComment(e,t)})})},this.deleteCommentThread=function(e){o.showMessage("comment_delete_comment_thread_confirm",{windowClass:"",okButtonCode:"button_delete",showCancelButton:!0}).then(function(t){t.result.then(function(){n.api.deleteThread(e).then(function(){n.updateCommentThreads(e.targetId),n.updateCommentButtons()})})})};var s=function(e,t,i){o.showMessage(e,{windowClass:"",okButtonCode:i?"button_archive":"button_unarchive",showCancelButton:!0}).then(function(e){e.result.then(function(){n.api.archiveThread(t,i).then(function(){n.refreshBubbleButtons()})})})};this.archive=function(e){s("comment_archive_comment_thread_confirm",e,!0)},this.unarchive=function(e){s("comment_unarchive_comment_thread_confirm",e,!1)},this.cancel=function(e){o.showMessage("comment_delete_comment_thread_confirm",{windowClass:"",okButtonCode:"button_delete",showCancelButton:!0}).then(function(e){e.result.then(function(){n.removeDraftThread()})})},this.getActiveCommentIdx=function(){return n.activeCommentIdx},this.activate=function(e){n.activeCommentIdx=e};this.processCommentInView=function(e,t,o){e&&n.readComment(t,o,1e3)}}e.$inject=["$document","$scope","BulbCommentService","BulbModalService","BulbPageService"],angular.module("bulbApp.commentModule").controller("CommentController",e)}(),angular.module("bulbApp.commentModule").directive("bulbCommentLower",["$compile","$document","BulbAuthService","BulbCommentService","CONFIG",function(e,t,n,o,i){return{restrict:"E",templateUrl:i.resource.cdnRoot+"ajs/components/comment/comment-lower.html",controller:"CommentController as commentCtrl",link:function(e,t,i,r){e.currentUser=n.currentUser,e.commentService=o,e.jump=function(e){var t=jQuery("#"+e.targetId);jQuery("html,body").animate({scrollTop:t.offset().top-90}),o.updateCommentThreads(e.targetId)};var a=function(){r.menuVisible=!1,e.$apply()};$("#bulb-main").on("click touch",a),e.$on("$destroy",function(){$("#bulb-main").off("click touch",a)}),e.$watch(function(){return o.lowerScrollTargetId},function(e){if(e){var t="#comment-lower-thread-"+o.lowerScrollTargetId;$("html,body").animate({scrollTop:jQuery(t).offset().top},500),o.lowerScrollTargetId=null}})}}}]),angular.module("bulbApp.commentModule").directive("bulbCommentQuotation",["$compile","$document","$timeout","$window","BulbAuthService","BulbCommentService","CONFIG",function(e,t,n,o,i,r,a){return{restrict:"E",templateUrl:a.resource.cdnRoot+"ajs/components/comment/comment-quotation.html",scope:{commentThread:"=",lowerComment:"="},link:function(e,t,o){e.maxHeightOver=!1,e.expanded=e.lowerComment?r.lowerQuotationExpanded:r.sideQuotationExpanded,n(function(){var o=t.find("span").height()>=70;if(e.maxHeightOver=o,e.commentService=r,o){var i=e.commentThread,a=t.closest("[bulb-themed-scrollbar]").get(0);$(t).on("click",function(){n(function(){var t=!0===e.expanded[i.id];e.expanded[i.id]=!t,e.lowerComment||n(function(){window.Ps.update(a)})})})}})}}}]),function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c,u,d,p,h){var g=this,m=null;this.currentPage=null,this.authorFlg=!1,this.currentTargetId=null,this.currentMediumEditor=null,this.commentThreadMap=null,this.threadComment={},this.lowerCommentExpanded={},this.sideQuotationExpanded={},this.lowerQuotationExpanded={},this.targetList=null,this.defaultThreadId=null,this.showArchivedComments=!1,this.isSideCommentEnabled=function(){return jQuery(a).width()>=1320},this.setDefaultThread=function(e){this.defaultThreadId=e},this.getPageElementHeight=function(){return m.height()},this.pageHasPrivateComments=function(){return g.pageHasCommentType("private")},this.pageHasArchivedComments=function(){return g.pageHasCommentType("archived")},this.pageHasCommentType=function(e){if(!g.commentThreadMap)return!1;for(var t=0;t<Object.keys(g.commentThreadMap).length;t++){var n=Object.keys(g.commentThreadMap)[t];if(g.commentThreadMap[n].filter(function(t){return"private"===e?!0===t.privateComment:!0===t.archived}).length>0)return!0}return!1},this.getPageCommentsCount=function(){var e=0;if(!g.commentThreadMap)return e;for(var t=0;t<Object.keys(g.commentThreadMap).length;t++){var n=Object.keys(g.commentThreadMap)[t];e+=g.commentThreadMap[n].filter(function(e){return!1===e.privateComment}).length}return e};var f=0;o.$on("$includeContentLoaded",function(){f--}),o.$on("$includeContentRequested",function(){f++}),this.api={updateInternalData:function(e){if(g.updateCommentThreadMap(e),g.defaultThreadId){var t=null,n=0;for(var i in g.commentThreadMap)for(var r=g.commentThreadMap[i],a=0;a<r.length;a++)r[a].id===g.defaultThreadId&&(t=i,n=a);if(g.currentTargetId=null,g.isSideCommentEnabled())g.updateCommentThreads(t,n);else{var s,l=g.defaultThreadId;g.lowerCommentExpanded[g.defaultThreadId]=!0;s=o.$on("$includeContentLoaded",function(e,t){0===f&&s&&(s(),s=null,g.lowerScrollTargetId=l)})}g.defaultThreadId=null}return e},getAllThreads:function(){return d.one("comment",g.currentPage.unit.id).all("thread").all("all").get("",{}).then(g.api.updateInternalData)},createBlankThread:function(e){return d.one("comment",g.currentPage.unit.id).all("thread").all("createblank").get("",{targetId:e})},createThread:function(e,t,n,o){return d.one("comment",g.currentPage.unit.id).all("thread").all("create").post({targetId:e,quotation:t,comment:n,isCommentPrivate:o}).then(g.api.updateInternalData)},deleteThread:function(e){return d.one("comment",g.currentPage.unit.id).one("thread",e.id).remove({targetId:e.targetId}).then(g.api.updateInternalData)},archiveThread:function(e,t){return d.one("comment",g.currentPage.unit.id).one("thread",e.id).all("archive").patch("",{targetId:e.targetId,archived:t}).then(function(){e.archived=t})},comment:function(e,t,n){return d.one("comment",g.currentPage.unit.id).one("thread",e.id).all("comment").post({targetId:e.targetId,comment:t,isCommentPrivate:n}).then(g.api.updateInternalData)},commentPage:function(e,t){return d.one("comment",g.currentPage.unit.id).all("comment").post({comment:e,isCommentPrivate:t}).then(g.api.updateInternalData)},updateComment:function(e,t,n){return d.one("comment",g.currentPage.unit.id).one("thread",e.id).one("comment",t).patch({targetId:e.targetId,comment:n})},deleteComment:function(e,t){return d.one("comment",g.currentPage.unit.id).one("thread",e.id).one("comment",t).remove({targetId:e.targetId}).then(g.api.updateInternalData)},markCommentRead:function(e,t){return d.one("comment",g.currentPage.unit.id).one("thread",e.id).one("comment",t).all("read").patch("",{targetId:e.targetId})},getParagraphIds:function(e){return d.all("id").post("",{count:e})},updateAccountPreferences:function(){return s.currentUser.prefs.showArchivedComments=g.showArchivedComments,d.one("accounts",s.currentUser.id).patch({prefs:s.currentUser.prefs}).catch(function(e){l.error("Cannot update the user preferences",e)})}};var b=function(e,t,n){var o=e[t];for(var i in o)if(o[i].id===n)return o[i];return null},v=function(){if(g.draftThread){var e=g.currentTargetId;g.commentThreadMap[e]||(g.commentThreadMap[e]=[]),g.commentThreadMap[e].unshift(g.draftThread)}},C=function(){var e=[];for(var t in g.commentThreadMap){var n=jQuery("#"+t),o=-1;n.position()&&(o=n.position().top),e.push({targetId:t,top:o});var i=n.length>0,r=g.commentThreadMap[t];for(var a in r)r[a].targetExist=i}if(e.sort(function(e,t){return e.top<t.top?-1:1}),g.targetList=[],e.forEach(function(e){g.targetList.push(e.targetId)}),null!==g.currentTargetId){var s=g.commentThreadMap[g.currentTargetId];s&&s.length>0&&!s[0].targetExist&&(g.currentTargetId=null,g.draftThread=null)}};this.updateCommentThreadMap=function(e){var n=t.scrollTop(),o=e.commentThreadMap;if(g.commentThreadMap){var i,a,s,l;for(i in g.commentThreadMap){var c=g.commentThreadMap[i];for(a in c)s=c[a],(l=b(o,i,s.id))?(s.comments=l.comments,s.unread=l.unread):c.splice(a,1)}for(i in o){var u=o[i];for(a in u)l=u[a],(s=b(g.commentThreadMap,i,l.id))||(g.commentThreadMap[i]||(g.commentThreadMap[i]=[]),g.commentThreadMap[i].unshift(l))}}else g.commentThreadMap=o;C(),v(),g.refreshBubbleButtons(),r(function(){t.scrollTop(n)})};var y=[];this.getParagraphIds=function(e){var t=n.defer(),o=function(){for(var n=[],o=0;o<e;o++)n.push(y.pop());t.resolve(n)};return y.length>=e?(o(),y.length<=5&&g.api.getParagraphIds(10).then(function(e){y=e})):g.api.getParagraphIds(e+10).then(function(e){y=e,o()}),t.promise},this.createCommentThread=function(e,t,n){var o,i,a="";if(t.options.contentWindow.getSelection().rangeCount>0?(o=jQuery(t.getSelectedParentElement().closest(".bulb-page-content > *")),i=o.attr("id")):n&&(i=n.id,o=jQuery("#"+n.id)),"CONTENT-BLOCK"!==o.prop("tagName")){var s=t.exportSelection();a=jQuery(t.getFocusedElement()).text().substring(s.start,s.end)}!function(){if(g.draftThread){var e=g.commentThreadMap[g.currentTargetId];e&&e.length&&e[0].draft&&(e.shift(),g.draftThread=null)}}(),this.currentTargetId=null,this.api.createBlankThread(i).then(function(e){g.draftThread=e,g.draftThread.draft=!0,g.draftThread.unread=!1,g.draftThread.quotation=a,g.draftThread.comments=[],g.currentTargetId=i,v(),C(),g.activeCommentIdx=0,g.updateCommentThreads(i),g.refreshBubbleButtons(),g.isSideCommentEnabled()||r(function(){var e=jQuery("#comment-lower-"+i+":visible");if(e[0]){jQuery("html,body").animate({scrollTop:e.offset().top-20});var t=e.find(".comment-field");t[0]&&t[0].focus()}})})},this.removeDraftThread=function(){g.draftThread=null,g.updateCommentButtons()},this.updateCommentThreads=function(e,t){g.currentTargetId!==e&&(g.activeCommentIdx=t||0),g.currentTargetId=e},this.refreshBubbleButtons=function(){jQuery("bulb-comment-button").remove(),g.commentThreadMap&&m.children().each(function(){var t=$(this).attr("id"),n=g.commentThreadMap[t];if(n&&n.length>0){var i=0;if(g.showArchivedComments?i=n.length:n.forEach(function(e){e.archived||i++}),i){var r=e("<bulb-comment-button thread-count="+i+' unit-id="'+g.currentPage.unit.id+'" target-id="'+t+'"></bulb-comment-button>')(o);$(".bulb-page-content").parent().prepend(r)}}})},this.updateCommentButtons=function(){return g.api.getAllThreads().then(g.refreshBubbleButtons)},this.switchCommentThreadVisible=function(e,t){g.draftThread=null,e===g.currentTargetId?g.currentTargetId=null:g.updateCommentThreads(e,t)},this.readComment=function(e,t,n){t&&r(function(){if(t.unread){var n=e.comments;t.unread=!1,g.api.markCommentRead(e,t.id);var o=!1;for(var i in n)if(n[i].unread){o=!0;break}e.unread=o}},n)},this.getTargetElementPosition=function(e){var t,n=jQuery("#"+e);if(n.children().children()[0])var o=n.children().children()[0].nodeName;return n[0]&&((t=n.position()).top=t.top+parseInt(n.css("marginTop")),t.nodeName=o||""),t};this.getCurrentCommentThreads=function(){return g.currentTargetId?g.commentThreadMap[g.currentTargetId]:null},this.isCommentable=function(e){var t=s.currentUser;return e&&e.unit.commentsEnabled&&!c.isFullScreen()&&t.isAuthenticated()&&("PublishedPageUnit"===e.unit.unitType||"DraftPageUnit"===e.unit.unitType)},this.canMakePrivateComment=function(e){var t=s.currentUser;return"EDUCATOR"===t.position||"ADMINISTRATOR"===t.position||t.hasPermission(e.unit,p.PERMISSIONS.DELETE)},this.init=function(e,t,n,o){this.currentTargetId=null,this.commentThreadMap=null,this.commentable=this.isCommentable(e),this.threadComment={},this.draftThread=null,this.currentPage=e,this.authorFlg=e.canEdit,this.lowerCommentExpanded={},this.sideQuotationExpanded={},this.lowerQuotationExpanded={},this.currentMediumEditor=n,m=t,o&&function(e){var t;e.$watch(function(){for(var e=[],n=0;n<m.children().length-1;n++){var o=m.children().eq(n);o.hasClass("bulb-content-trailer")||$(o).attr("id")||e.push($(o))}return t=e.length,e.length},function(e){t&&g.getParagraphIds(t).then(function(e){for(var t=!1,n=0;n<m.children().length-1&&e.length;n++){var o=m.children().eq(n);if(!o.hasClass("bulb-content-trailer")&&!$(o).attr("id")){var i=e.pop();$(o).attr("id",i),t=!0}}t&&g.currentMediumEditor.trigger("editableInput",null,m[0])})}),g.currentPage.canEdit&&e.$watch(function(){return m.children().length},function(){C(),g.refreshBubbleButtons()})}(o),this.commentable?this.updateCommentButtons():this.currentPage=null}}e.$inject=["$compile","$document","$q","$rootScope","$state","$timeout","$window","BulbAuthService","BulbErrorService","BulbPresentationService","BulbUnitService","Restangular","AUTH","CONFIG"],angular.module("bulbApp.commentModule").service("BulbCommentService",e)}(),angular.module("bulbApp.commentModule").directive("bulbCommentSide",["$compile","$document","$timeout","$window","BulbAuthService","BulbCommentService","CONFIG",function(e,t,n,o,i,r,a){return{restrict:"E",templateUrl:a.resource.cdnRoot+"ajs/components/comment/comment-side.html",controller:"CommentController as commentCtrl",link:function(e,t,a){e.currentUser=i.currentUser,e.commentService=r;var s=function(){var e=r.currentTargetId;if(e){var t=r.getTargetElementPosition(e);t&&jQuery("#bulb-comment-side-container-inner").css("top",t.top)}};e.$watch(function(){return r.currentTargetId},function(){s()}),e.$watch(function(){return r.currentTargetId+" "+r.activeCommentIdx},function(){n(function(){var e=jQuery(t).find(".comment-large").find("textarea:visible");e&&e.focus()})}),t.on("click",function(e){e.stopPropagation()}),e.isActive=function(e){return r.activeCommentIdx===e};var l=function(){r.isSideCommentEnabled()?t.show():t.hide()};n(function(){s(),r.currentMediumEditor&&r.currentMediumEditor.subscribe("editableInput",s),l()});var c=jQuery(o);c.on("resize",l),e.$on("$destroy",function(){c.off("resize",l)})}}}]),angular.module("bulbApp.commentModule").directive("bulbCommentUser",["CONFIG",function(e){return{restrict:"E",templateUrl:e.resource.cdnRoot+"ajs/components/comment/comment-user.html",scope:{commentUnit:"=",sideComment:"="}}}]),angular.module("bulbApp.commentModule").directive("bulbCommentButton",["$compile","$document","$timeout","$window","BulbAuthService","BulbCommentService","CONFIG","Foundation",function(e,t,n,o,i,r,a,s){return{restrict:"E",templateUrl:a.resource.cdnRoot+"ajs/components/comment/commentbutton.html",scope:{unitId:"@",targetId:"@",threadCount:"="},link:function(e,t,i){var a=i.targetId,l=function(){var e=r.getTargetElementPosition(a);e?("AUDIO-BLOCK"===e.nodeName&&e.left>=383?t.css("left",e.left+40):t.css("left",e.left),t.css("top",e.top)):t.remove()};l(),r.currentMediumEditor.subscribe("editableInput",l),e.$watch(function(){return r.getPageElementHeight()},function(){n(function(){l()},1)}),t.on("click",function(e){n(function(){if(r.isSideCommentEnabled())r.switchCommentThreadVisible(a);else{var e=jQuery("#comment-lower-"+a);jQuery("html,body").animate({scrollTop:e.offset().top-20})}},1),e.stopPropagation()}),e.isActive=function(){return r.isSideCommentEnabled()&&r.currentTargetId===a},e.isUnread=function(){if(!r.commentThreadMap)return!1;var e=r.commentThreadMap[a],t=!1;if(e&&e.length>0)for(var n=0;n<e.length;n++)if(e[n].unread){t=!0;break}return t};var c=function(){s.utils.is_large_up()?t.show():t.hide()};c();var u=jQuery(o);u.on("resize",c),e.$on("$destroy",function(){u.off("resize",c)})}}}]),angular.module("bulbApp.compositeViewModule",["foundationModule","bulbApp.ajaxModule","bulbApp.authorModule","bulbApp.authModule","bulbApp.autoSaveModule","bulbApp.avatarImageModule","bulbApp.configModule","bulbApp.errorModule","bulbApp.imageEditorModule","bulbApp.openGraphModule","bulbApp.permissionsModule","bulbApp.shareModule","bulbApp.translateModule","bulbApp.unitModule","bulbApp.uploadModule","bulbApp.utilsModule"]),function(){"use strict";function e(e,n,o,i,r,a,s,l,c,u,d,p,h,g,m,f,b,v,C,y,w,A,_,E,S,T,I,B){var k=this;p.currentUser.hasRole(I.ROLES.SWITCHED_USER)&&(k.switchedUser=!0),this.dataLayer=window.dataLayer||[],this.myArchiveCollectionTitle=s.instant("ArchiveCompositeUnit"),this.currentUserPrefs=p.currentUser.prefs,this.profileUsername=r.params.username,this.compositeViewOwner=i.authorCtrl?i.authorCtrl.authorAccount:null,this.defaultAvatarImage=h.getDefaultAvatarImage,this.viewType=t(this.compositeUnit);var U="author"!==t(this.compositeUnit)&&"group"!==t(this.compositeUnit)?"composite_unit_name_placeholder":"author"===t(this.compositeUnit)?"composite_unit_profile_name_placeholder":"composite_unit_group_name_placeholder";this.compositeHeaderTitle=s.instant(U),this.isHeaderExpanded=r.params.expandHeader||!1,this.edit=null,this.isCoverImageUploadActive=!1,this.isAvatarUploadActive=!1,this.avatarImage=null,T.fetchParent(),this.canNotCreateSubCollectionFreeUser="collection"===this.viewType&&!p.currentUser.features.SubCollectionFeature.enabled,this.canCopyTemplate=p.currentUser.isAuthenticated()&&this.compositeUnit.template,this.canUseTemplateFeature=p.currentUser.isAuthenticated()&&p.currentUser.features.TemplateFeature.enabled,this.isTemplate=this.compositeUnit.template,this.mode="default",this.canEdit=p.currentUser.hasPermission(this.compositeUnit,I.PERMISSIONS.UPDATE),"author"!==this.viewType&&"group"!==this.viewType||(this.avatarImage=this.compositeUnit.circularImage),this.openGraphImage=this.avatarImage||this.compositeUnit.coverImage,"author"===this.viewType&&this.canEdit&&!this.currentUserPrefs.onBoarding.onboardingShowMainTour&&d.enableSnapshotPdf("home"),i.$watchCollection(function(){return p.currentUser.prefs},function(){k.currentUserPrefs=p.currentUser.prefs}),this.autoSaveCallback=function(t){switch(k.viewType){case"collection":var n=t.unitDTOs[0];e.skipReload().path("/u/"+n.path).replace(),o.$title=n.name,k.isEditingVisibility&&(k.currentVisibility=k.selectedVisibilityChoices.map(function(e){return e.name}).join("; "),k.isEditingVisibility=!1),_.updateRecommend(n);break;case"group":v.updateGroup(t)}},this.getReadAccessSubjectIds=function(){return k.selectedVisibilityChoices.filter(function(e){return!e.inheritance}).map(function(e){return e.subjectId})},this.autoSaveOptions={restId:this.compositeUnit.id,callback:this.autoSaveCallback,restCollection:"group"===this.viewType?"groups":"units"},this.selectAutoSaveOptions=angular.copy(this.autoSaveOptions),this.selectAutoSaveOptions.getter=this.getReadAccessSubjectIds,this.toggleHeaderExpanded=function(){this.isHeaderExpanded=!this.isHeaderExpanded},this.editCoverImage=function(){g.showBusyDuring(c.one("images",k.compositeUnit.coverImage.id).customGET("originalimage/coverImage").then(function(e){k.edit={isNew:!k.compositeUnit.coverImage,asset:{id:e.id,assetDefinitionsKey:"coverImage",url:e.url,width:e.width,height:e.height,center:{X:e.centerX,Y:e.centerY}},cropType:"CROP_COVER_IMAGE"},k.mode="editor",k.isCoverImageUploadActive=!1},function(e){f.error("Cannot get original image for cover image",e)}))},this.deleteCoverImage=function(){s("cover_image_type").then(function(e){s("modal_delete_confirm_body",{type:e}).then(function(e){C.show({titleCode:"modal_delete_confirm_title",bodyText:e,fontAwesomeCode:"fas fa-trash-alt",windowClass:"updated-modal-design updated-bulb-delete-modal",okButtonCode:"button_delete"}).then(function(){g.showBusyDuring(k.onCoverImageDelete())})})})},this.onCoverImageUploaded=function(e){var t=n.defer();if(e){var o=B.coverimage;e.image.width<o.minwidth||e.image.height<o.minheight?(t.reject(),m.calculateCoverImageSize(e,o,k,"compositeView")):e.image.width>o.maxwidth||e.image.height>o.maxheight?(t.reject(),u.dialog.showError("error_validation_image_size_large",{width:o.maxwidth,height:o.maxheight})):(k.mode="editor",k.isCoverImageUploadActive=!1,k.edit={isNew:!k.compositeUnit.coverImage,asset:{id:e.image.id,assetDefinitionsKey:"coverImage",url:e.image.url,width:e.image.width,height:e.image.height},cropType:"CROP_COVER_IMAGE"},t.resolve())}else t.reject();var i=$(".bulb-main").parent();return i.hasClass("bulb-aria-hide")&&i.removeClass("bulb-aria-hide"),t.promise},this.onCoverImageEditComplete=function(e){var t=n.defer();if(this.edit=null,e){var o={assetId:e.asset.id,assetDefinitionsKey:e.asset.assetDefinitionsKey,centerX:e.center.X,centerY:e.center.Y};c.one("units",this.compositeUnit.id).customPOST(o,"coverimage").then(function(e){k.compositeUnit=e,k.mode="default",k.isCoverImageUploadActive=!1,_.updateRecommend(e),t.resolve(!0)},function(e){var n=f.error("Cannot update unit cover image",e);t.reject(n)})}else this.mode="default",this.isCoverImageUploadActive=!1,t.resolve(!0);return t.promise},this.onCoverImageDelete=function(){return c.one("units",k.compositeUnit.id).customDELETE("coverimage").then(function(e){k.compositeUnit=e,k.mode="default",k.isCoverImageUploadActive=!1,_.updateRecommend(e)},function(e){f.error("Cannot update unit cover image",e)})},this.onAvatarUploaded=function(e){k.isAvatarUploadActive=!1;var t=n.defer();if(e){var o,i,r,a,s=e.croppedImage||e.image,l=s.width,u=s.height;l>u?(o=(l-u)/2,i=0,r=u,a=u):(o=0,i=(u-l)/2,r=l,a=l);var d={assetId:s.id,assetDefinitionsKey:"circularImage",cropX:o,cropY:i,cropWidth:r,cropHeight:a};c.one("group"===k.viewType?"groups":"units",k.compositeUnit.id).customPOST(d,"circularimage").then(function(e){k.compositeUnit=e,"author"===k.viewType?k.avatarImage=k.compositeUnit.circularImage:"group"===k.viewType&&(k.avatarImage=k.compositeUnit.circularImage,v.updateGroup(k.compositeUnit)),t.resolve(!0)},function(e){var n=f.error("Cannot set avatar image",e);t.reject(n)}).then(function(){k.editAvatar()})}else t.resolve(!1);return t.promise},this.deleteAvatar=function(){s("avatar_type").then(function(e){s("modal_delete_confirm_body",{type:e}).then(function(e){C.show({titleCode:"modal_delete_confirm_title",bodyText:e,okButtonCode:"button_delete",showCancelButton:!1}).then(function(){g.showBusyDuring(c.one("group"===k.viewType?"groups":"units",k.compositeUnit.id).customDELETE("circularimage").then(function(e){k.compositeUnit=e,k.avatarImage=null,"group"===k.viewType&&v.updateGroup(k.compositeUnit)},function(e){f.error("Cannot delete avatar",e)}))},function(e){})})})},this.editAvatar=function(){g.showBusyDuring(c.one("images",k.compositeUnit.circularImage.id).customGET("originalimage/circularImage").then(function(e){u.dialog.image.showEditProfileImageModal(e,function(){var t={assetId:e.id,assetDefinitionsKey:"circularImage",cropX:e.cropRect.x,cropY:e.cropRect.y,cropWidth:e.cropRect.width,cropHeight:e.cropRect.height,rotationDegrees:e.cropRect.rotate};g.showBusyDuring(c.one("group"===k.viewType?"groups":"units",k.compositeUnit.id).customPOST(t,"circularimage").then(function(e){k.compositeUnit=e,k.avatarImage=k.compositeUnit.circularImage},function(e){f.error("Cannot update avatar",e)}).then(function(){u.dialog.dismissAllModals()}))})}))},this.share=function(e){E.displayShareDialog(e)},this.onboardingNeedsUpgrade=function(){k.switchedUser||y.displayNeedsUpgradeDialog(this.compositeUnit)},this.showPresentation=function(){var e=k.compositeUnit.children;0!==e.length&&(T.setCurrentUnit(e[0]),A.startPresentation(e[0]))},this.toggleRecommend=function(){if(localStorage.hasOwnProperty("isAuthorized")&&localStorage.removeItem("isAuthorized"),p.currentUser.isAuthenticated())k.compositeUnit.likedByUser?_.deleteRecommend(k.compositeUnit).then(function(){k.compositeUnit.likedByUser=!1,k.compositeUnit.likeCount--}):_.createRecommend(k.compositeUnit).then(function(){k.compositeUnit.likedByUser=!0,k.compositeUnit.likeCount++});else{var e="/u/"+this.compositeUnit.path,t=this.compositeUnit.id;C.open({titleCode:"",template:"<bulb-recommend-login></bulb-recommend-login>",windowClass:"updated-modal-design bulb-pageview-login-modal",closeOnClick:!0,showOkButton:!1,showCancelButton:!1,controller:["$scope",function(n){n.targetUrl=e,n.compositeUnit=t}]})}},this.canCreateCollection=function(){return("author"===this.viewType||"collection"===this.viewType)&&S.isSubCollectionCountUnderLimit()&&p.currentUser.hasPermission(this.compositeUnit,I.PERMISSIONS.UPDATE)},this.canDeleteCollection=function(){return"group"!==this.viewType&&p.currentUser.hasPermission(this.compositeUnit,I.PERMISSIONS.DELETE)},this.showHelpModal=function(e){var t={titleCode:"pageview_publish_panel_help_title",templateUrl:"collectionhelpmodal.nested",showOkButton:!1,showCancelButton:!1,focusAfterClosed:e.currentTarget};C.show(t)},this.createCollection=function(){"collection"===k.viewType?p.currentUser.features.SubCollectionFeature.enabled?r.go("createSubCollection",{unitPath:k.compositeUnit.path}):C.show({titleCode:"create_collection_limit_reached_title",bodyCode:p.currentUser.bulbSchoolDirectMemberships>0?"create_collection_limit_reached_content_bulbSchoolDirect":"create_collection_limit_reached_content",showOkButton:!1,showCancelButton:!1}):r.go("createCollection")},this.canCreatePage=function(){return("author"===this.viewType||"collection"===this.viewType)&&p.currentUser.hasPermission(this.compositeUnit,I.PERMISSIONS.UPDATE)},this.createPage=function(){w.createPage(k.compositeUnit.id)},this.showDeleteConfirmation=function(e){s("type_composite_unit").then(function(t){s("soft_delete_modal_delete_unit_type_confirm_body",{unitType:t,displayName:k.compositeUnit.name}).then(function(t){var n={titleCode:"modal_delete_confirm_title",bodyText:t,okButtonCode:"button_delete",focusAfterClosed:e.currentTarget};C.show(n).then(function(){k.deleteCollection()})})})},this.deleteCollection=function(){g.showBusyDuring(c.one("units",k.compositeUnit.id).remove().then(function(){var e=T.parentUnit;e&&"CompositeUnit"===e.unitType?r.go("unit",{unitPath:e.path}):r.go("author",{username:p.currentUser.username})},function(e){f.error("Cannot delete collection",e)}))},this.shareCode=function(){return Foundation.utils.is_small_only()?"":"button_share"},this.presentationCode=function(){return Foundation.utils.is_small_only()?"":"button_presentation"},this.recommendCode=function(){return Foundation.utils.is_small_only()?"":this.compositeUnit.likedByUser?"button_liked":"button_like"},this.deleteCode=function(){return Foundation.utils.is_small_only()?"":"button_delete"},this.shareableCode=function(){return Foundation.utils.is_small_only()?"":"button_shareable"},this.reSyncCode=function(){return Foundation.utils.is_small_only()?"":"import_class_from_classroom_resync"},this.copyPageAsTemplate=function(t){s("pageview_template_modal_description").then(function(n){var o={titleCode:"pageview_template_modal_title",bodyText:n,showOkButton:!0,showCancelButton:!0,fontAwesomeCode:"far fa-clone",windowClass:"updated-modal-design copy-template-modal",focusAfterClosed:t.currentTarget};C.show(o).then(function(){c.one("units",k.compositeUnit.id).customPOST({},"copyTemplate",{isArchive:!1}).then(function(){k.dataLayer.push({event:"TemplateCopyEvent",copiedUnitId:k.compositeUnit.id,copyToUserId:p.currentUser.id,copyType:"Collection"})}),e.path("/"+p.currentUser.username)})})},this.reSyncGoogleClass=function(e){b.reSyncGroupWithClassroom(e).then(function(){g.showBusyDuring(v.reSyncClassroomGroup(k.compositeUnit.id,e,b.oauthToken).then(function(e){o.$emit("members",e.members),k.compositeUnit.name=e.name},function(e){f.showError(s.instant("import_class_from_classroom_error_resync"),e)}))},function(e){e&&f.showError(s.instant("import_class_from_classroom_error_resync"),e)})},this.isCreatePageBadgeToBeShown=function(){return this.currentUserPrefs=p.currentUser.prefs,!this.currentUserPrefs.onBoarding.onboardingShowMainTour&&!this.currentUserPrefs.onBoarding.onboardingShowMenuTour&&this.currentUserPrefs.onBoarding.onboardingShowPageTour};var O=0;i.$on("$includeContentRequested",function(e,t){O++}),i.$on("$includeContentLoaded",function(e,t){if(0===--O){jQuery("#autosizejs").attr("aria-label","dummy-label"),jQuery("#autosizejs").attr("aria-hidden","true");var n=document.getElementsByClassName("assetLibraryDialog");n.length>1&&n[0].remove()}})}function t(e){switch(e.unitType){case"CompositeUnit":return"collection";case"GroupUnit":return"group";case"UserUnit":return"author";default:return e.unitType}}e.$inject=["$location","$q","$rootScope","$scope","$state","$timeout","$translate","$window","Restangular","BulbAssetLibraryService","BulbAssetLibrarySnapshotPdfService","BulbAuthService","BulbAvatarService","BulbBusyService","BulbCoverImageService","BulbErrorService","BulbGoogleClassroomImportService","BulbGroupService","BulbModalService","BulbOnboardingService","BulbPageService","BulbPresentationService","BulbRecommendService","BulbShareService","BulbSubCollectionService","BulbUnitService","AUTH","CONFIG"],angular.module("bulbApp.compositeViewModule").controller("CompositeViewController",e)}(),angular.module("bulbApp.compositeViewModule").directive("bulbCompositeView",["$log","$window","Foundation","CONFIG",function(e,t,n,o){return{restrict:"E",templateUrl:o.resource.cdnRoot+"ajs/components/compositeview/compositeview.html",controller:"CompositeViewController as compositeViewCtrl",bindToController:{compositeUnit:"="},scope:!0,transclude:!0,link:function(o,i,r){var a=o.compositeViewCtrl;i.attr("viewtype",a.viewType),i.addClass("bulb-accent"+a.compositeUnit.accentIndex);var s,l=500,c=jQuery(t);n.utils.is_large_up()||(l=c.height()/3),"isAuthorized"===localStorage.getItem("isAuthorized")&&a.toggleRecommend();var u=function(){if(s){var t=c.width(),n="",i="",r="",a="";o.style="";var u=jQuery(".bulb-cover-image-banner").height(),d=Math.max(l,u+47);s.width/s.height>t/d?r=(t-(i=d)/s.height*s.width)/2:a=(d-(n=t)/s.width*s.height)/2;var p={width:n,height:i,top:a,left:r};e.debug("bulbCompositeView: setCoverImage: window width): "+t+" style: "+JSON.stringify(p,null,2)),jQuery(".bulb-cover-image").css(p),o.style=p}},d=function(){var e,t=jQuery(".bulb-composite-header-unit-content-wrapper"),n=jQuery(".cropper-container"),o=jQuery(".bulb-composite-header-image-editor-content"),i={};t.length>0&&(e=t.height()),o.length>0&&(n.length>0?(i.width=n.width(),i.left="50%",i.marginLeft=-n.width()/2):(i.width="",i.left=0,i.marginLeft=0),e&&(i.height=e),o.css(i))};c.on("resize",function(e){"editor"===a.mode?d():a.compositeUnit.coverImage&&u()}),o.$watch(function(){return jQuery(".bulb-cover-image-banner").height()},function(){u()}),o.$watchGroup(["compositeViewCtrl.compositeUnit.coverImage.url","compositeViewCtrl.compositeUnit.coverImage.width","compositeViewCtrl.compositeUnit.coverImage.height","compositeViewCtrl.mode"],function(e){var t=jQuery(".bulb-unit-header"),n=!e[0],o=e[3];n?t.removeClass("bulb-has-cover-image"):"editor"!==o&&(t.addClass("bulb-has-cover-image"),s=a.compositeUnit.coverImage,u())}),o.$watch("compositeViewCtrl.isImageEditorActive",function(e){e&&d()})}}}]),angular.module("bulbApp.contentEditorModule",["bulbApp.configModule","bulbApp.filtersModule","bulbApp.translateModule","bulbApp.utilsModule"]).constant("CONTENT_EDITOR",{MEDIA_TYPES:{IMAGE:{assetDefinitionsKey:"blockImage",acceptFileTypes:/(\.|\/)(jpe?g|bmp|gif|png)$/i},VIDEO:{assetDefinitionsKey:"blockVideo",acceptFileTypes:/(\.|\/)(3g2|3gp|asf|avi|flv|m4v|mkv|mov|mp4|mpg|vob|wmv|quicktime)$/i},AUDIO:{assetDefinitionsKey:"blockAudio",acceptFileTypes:/(\.|\/)(mp3|m4a|wav)$/i}},BLOCK_PATHS:{IMAGE:"imageblock",IMAGE_CAROUSEL:"imagecarouselblock",VIDEO:"videoblock",ATTACHED_FILE:"attachedfileblock",EMBED:"embedblock",ATTACHED_FILE_EMBED:"attachedfileembedblock",AUDIO:"audioblock"},FULL_BLOCK_WIDTH_PERCENTAGE:.8,MOBILE_AUDIO_BLOCK_WIDTH_PERCENTAGE:.9,MOBILE_AUDIO_BLOCK_SET_WIDTH_TIMEOUT:150,CAROUSEL:{CAROUSEL_GRAB_IMAGE_TIMEOUT:200,SLICK_RENDER_DOTS_PADDING:35,SLICK_RENDER_FIGCAPTION:10},IMAGE_ASSET:{IMAGE_ASSET_IMAGE_TIMEOUT:200},ALLOWED_TAGS:["p","h2","h3","ol","ul","li","blockquote","content-block","b","strong","i","em","u","a","span","br"],GRAB_TOOLBAR_TIMEOUT:100,FONTS:[{FONT_CODE:"font_family_code_calluna",FONT:"calluna, serif"},{FONT_CODE:"font_family_code_baskerville",FONT:"baskerville-urw, serif"},{FONT_CODE:"font_family_code_courier_prime",FONT:"courier-prime, serif"},{FONT_CODE:"font_family_code_museo_sans",FONT:"museo-sans, sans-serif"},{FONT_CODE:"font_family_code_proxima_nova",FONT:"proxima-nova, sans-serif"}],COLORS:["#363d47","#2b91bf","#0077a7","#4f5967","#acb3bf"],DEFAULT_COLOR:"#363d47",DEFAULT_FONT:{FONT_CODE:"font_family_code_calluna",FONT:"calluna, serif"},DEFAULT_FONT_TIMEOUT:300,MINIMUM_IMAGE_WIDTH:200}).run(["CONTENT_EDITOR","$translate","$timeout",function(e,t,n){n(function(){for(var n=0;n<e.FONTS.length;n++){var o=e.FONTS[n];o.FONT_NAME=t.instant(o.FONT_CODE)}},e.DEFAULT_FONT_TIMEOUT)}]),angular.module("bulbApp.contentEditorModule").directive("bulbAlignable",function(){return{require:["^contentBlock","^ngModel"],scope:{},link:function(e,t,n,o){var i=o[0],r=o[1],a=i.contentBlockElement;a&&(i.alignment="center",a.hasClass("align-left")?i.alignment="left":a.hasClass("align-right")&&(i.alignment="right")),e.$watch(function(){return i.isFullWidth},function(e){e?angular.element(a).addClass("block-full-width"):angular.element(a).removeClass("block-full-width")},!0),e.$on("command-align",function(t,n){i.selected&&function(t){a.removeClass("align-"+i.alignment),i.alignment=t,a.addClass("align-"+i.alignment),e.$evalAsync(function(){r.$commitViewValue()})}(n)})}}}),function(){"use strict";function e(e,t){this.autoSaveOptions={restId:e.contentBlockCtrl.page.unit.id,customSave:function(){var n={title:e.contentBlockCtrl.contentBlock.title};return t.one("units",e.contentBlockCtrl.page.unit.id).one("attachedfileblock",e.contentBlockCtrl.contentBlock.id).patch(n)}}}e.$inject=["$scope","Restangular"],angular.module("bulbApp.contentEditorModule").controller("AttachedFileBlockController",e)}(),angular.module("bulbApp.contentEditorModule").directive("attachedFileBlock",["CONFIG",function(e){return{restrict:"E",controller:"AttachedFileBlockController as attachedFileBlockCtrl",templateUrl:e.resource.cdnRoot+"ajs/components/contenteditor/attachedfileblock.html"}}]),angular.module("bulbApp.contentEditorModule").directive("attachedFileEmbedBlock",["CONFIG",function(e){return{restrict:"E",controller:"EmbedBlockController as embedBlockCtrl",link:function(e,t,n,o){var i=e.$watch(function(){return t.find("iframe").length},function(e,t){e!==t&&e>0&&(i(),o.updateBlockSize())})},templateUrl:e.resource.cdnRoot+"ajs/components/contenteditor/attachedfileembedblock.html"}}]),function(){"use strict";function e(e,t,n,o,i){var r=this;this.width=o.page.content.max.width,this.height=45,this.isMobile=n.isMobile(),this.updateAudioSize=function(){var n=jQuery(".bulb-page-content").width(),a=o.page.content.max.width,s=n/a;r.width=e.contentBlockCtrl.contentBlock.width*s,t(function(){r.isMobile&&(a*=s,r.width=a*i.MOBILE_AUDIO_BLOCK_WIDTH_PERCENTAGE,t(function(){jQuery(".jp-audio").css("width",r.width)}),e.contentBlockCtrl.contentBlock.width=r.width)},i.MOBILE_AUDIO_BLOCK_SET_WIDTH_TIMEOUT),e.contentBlockCtrl.isFullWidth=e.contentBlockCtrl.contentBlock.width>a*i.FULL_BLOCK_WIDTH_PERCENTAGE},e.$watchCollection("contentBlockCtrl.contentBlock",function(){r.updateAudioSize()})}e.$inject=["$scope","$timeout","BulbBrowserService","CONFIG","CONTENT_EDITOR"],angular.module("bulbApp.contentEditorModule").controller("AudioBlockController",e)}(),angular.module("bulbApp.contentEditorModule").directive("audioBlock",["$timeout","CONFIG","JWPLAYER",function(e,t,n){return{restrict:"E",require:"?^contentBlock",controller:"AudioBlockController as audioBlockCtrl",templateUrl:t.resource.cdnRoot+"ajs/components/contenteditor/audioblock.html",link:function(t,o,i,r){var a=t.pageViewCtrl.page.mode;e(function(){var e=o.find(".bulb-audio");"default"===a&&(e.addClass("bulb-audio-initial-width"),t.$watch(function(){return r.alignment},function(t){"right"===t?(e.css("width","100%"),e.css("padding-left","44px")):(e.css("width","92%"),e.css("padding-left",""))}))},n.defaultOptions.timeout)}}}]),function(){"use strict";function e(e,t,n,o){this.autoSaveOptions={restId:e.contentBlockCtrl.page.unit.id,customSave:function(){var t={caption:e.contentBlockCtrl.contentBlock.caption};return n.one("units",e.contentBlockCtrl.page.unit.id).one(o.BLOCK_PATHS[e.contentBlockCtrl.contentBlock.blockType],e.contentBlockCtrl.contentBlock.id).patch(t).then(function(t){angular.copy(t.plain(),e.contentBlockCtrl.contentBlock)})}},this.setMaxWidth=function(){return"IMAGE"===e.contentBlockCtrl.contentBlock.blockType?e.contentBlockCtrl.contentBlock.scaledImageAsset?e.contentBlockCtrl.contentBlock.scaledImageAsset.width:e.contentBlockCtrl.contentBlock.fullImageAsset.width:("AUDIO"===e.contentBlockCtrl.contentBlock.blockType&&t.isMobile(),e.contentBlockCtrl.contentBlock.width)}}e.$inject=["$scope","BulbBrowserService","Restangular","CONTENT_EDITOR"],angular.module("bulbApp.contentEditorModule").controller("BlockCaptionController",e)}(),angular.module("bulbApp.contentEditorModule").directive("blockCaption",["$compile","$templateRequest","CONFIG",function(e,t,n){return{restrict:"A",require:"^contentBlock",controller:"BlockCaptionController as blockCaptionCtrl",link:function(o,i,r,a){o.contentBlockCtrl=a,t(n.resource.cdnRoot+"ajs/components/contenteditor/blockcaption.html").then(function(t){var n=angular.element(t);i.after(n),e(n)(o)})}}}]),angular.module("bulbApp.contentEditorModule").directive("blockContent",function(){return{require:"^contentBlock",compile:function(){return{pre:function(e,t,n,o){o.contentElement=t}}}}}),angular.module("bulbApp.contentEditorModule").directive("cleanSpans",function(){return{link:function(e,t,n){t.on("DOMNodeInserted",function(e){var t,n,o;"SPAN"===e.target.tagName?(console.debug("cleaning new span"),t=e.target,n=$("<b>helper</b>"),(o=$(t)).before(n),n.after(o.contents()),n.remove(),o.remove()):"BR"===e.target.tagName&&console.debug("cleaning new br")})}}}),function(){"use strict";function e(e,t,n,o){var i=this;this.contentElement=null,this.frameElement=null,this.selected=!1,this.busy=!1,this.isFullWidth=!1,this.isMobile=o.isMobile(),this.downloadAttachedFile=function(){t.location=i.contentBlock.attachedFileAsset.url},this.refetchContentBlock=function(){n.one("units",this.page.unit.id).one("contentblock",this.contentBlock.id).get().then(function(e){angular.copy(e.plain(),i.contentBlock)})},e.$on("selectionChange",function(e,t){i.selected=t[0]===i.contentBlockElement[0]})}e.$inject=["$scope","$window","Restangular","BulbBrowserService"],angular.module("bulbApp.contentEditorModule").controller("ContentBlockController",e)}(),angular.module("bulbApp.contentEditorModule").directive("contentBlock",["CONFIG","BulbCommentService",function(e,t){return{require:["^bulbPageView","contentBlock"],restrict:"E",scope:{},controller:"ContentBlockController as contentBlockCtrl",link:function(e,n,o,i){e.pageViewCtrl=i[0],e.commentService=t;var r=i[1];r.page=e.pageViewCtrl.page,r.contentBlock=r.page.unit.contentBlocks[o.id],r.contentBlockElement=n},templateUrl:e.resource.cdnRoot+"ajs/components/contenteditor/contentblock.html"}}]),function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c,u,d,p,h,g,m,f,b,v,C,y){var w=this,A=c.currentUser,_=A.isAuthenticated()&&A.features.CommentingFeature.enabled&&f.page.unit.commentsEnabled;function E(e){e.each(function(){var e=$("<b>helper</b>"),t=$(this);t.before(e),e.after(t.contents()),e.remove(),t.remove()})}this.isToolbarStateText=!1;var S=a.extensions.button.extend({name:"alignLeft",contentDefault:"<b translate>toolbar_align_left_content</b>",contentFA:'<i class="fa fa-align-left"></i>',aria:i.instant("toolbar_align_left_rollover"),handleClick:function(){o.$broadcast("command-align","left",w.selectedBlock),w.updateToolbar(),w.editor.trigger("editableInput",null,w.editor.elements[0])},isAlreadyApplied:function(e){return e.classList.contains("align-left")}}),T=a.extensions.button.extend({name:"alignCenter",contentDefault:"<b translate>toolbar_align_center_content</b>",contentFA:'<i class="fa fa-align-center"></i>',aria:i.instant("toolbar_align_center_rollover"),handleClick:function(){o.$broadcast("command-align","center",w.selectedBlock),w.updateToolbar(),w.editor.trigger("editableInput",null,w.editor.elements[0])},isAlreadyApplied:function(e){return e.classList.contains("align-center")}}),I=a.extensions.button.extend({name:"alignRight",contentDefault:"<b translate>toolbar_align_right_content</b>",contentFA:'<i class="fa fa-align-right"></i>',aria:i.instant("toolbar_align_right_rollover"),handleClick:function(){o.$broadcast("command-align","right",w.selectedBlock),w.updateToolbar(),w.editor.trigger("editableInput",null,w.editor.elements[0])},isAlreadyApplied:function(e){return e.classList.contains("align-right")}}),B=a.extensions.button.extend({name:"myUnorderedList",contentDefault:"<b translate>toolbar_unordered_list_content</b>",contentFA:'<i class="fa fa-list-ul"></i>',aria:i.instant("toolbar_unordered_list_rollover"),tagNames:["ul"],handleClick:function(){this.selectionState=this.base.exportSelection(),U("ul",this.document);var e=$(w.editorElement);this.base.queryCommandState("insertunorderedlist")?(e.find("p > ul br").remove(),e.find("p > ul").unwrap(),E(e.find("ul span:not(.handled-span)"))):(e.find("> span:not(.handled-span)").wrap("<p></p>"),E(e.find("> p span:not(.handled-span)"))),this.base.importSelection(this.selectionState),w.editor.trigger("editableInput",null,w.editor.elements[0]),w.updateToolbar()}}),k=a.extensions.button.extend({name:"myOrderedList",contentDefault:"<b translate>toolbar_ordered_list_content</b>",contentFA:'<i class="fa fa-list-ol"></i>',aria:i.instant("toolbar_ordered_list_rollover"),tagNames:["ol"],handleClick:function(e){this.selectionState=this.base.exportSelection(),U("ol",this.document);var t=$(w.editorElement);this.base.queryCommandState("insertorderedlist")?(t.find("p > ol br").remove(),t.find("p > ol").unwrap(),E(t.find("ol span:not(.handled-span)"))):(t.find("> span:not(.handled-span)").wrap("<p></p>"),E(t.find("> p span:not(.handled-span)"))),this.base.importSelection(this.selectionState),w.editor.trigger("editableInput",null,w.editor.elements[0]),w.updateToolbar()}});function U(e,t){var n=$(a.selection.getSelectedParentElement(window.getSelection().getRangeAt(0))).parent(),o="ol"===e?"ul":"ol";"li"===n.prop("tagName").toLowerCase()&&(n=$(n).parent()),n.prop("tagName").toLowerCase()===e?function(e,t){for(var n=$(e),o=n.find("li"),i=n.find("ol"),r=n.find("ul"),a=0;a<o.length;a++){var s=$($(o[a])[0]);s.replaceWith("<p>"+$(s).html()+"</p>")}for(var l=0;l<i.length;l++){var c=$($(i[l])[0]);c.contents().unwrap()}for(var u=0;u<r.length;u++){var d=$($(r[u])[0]);d.contents().unwrap()}n.contents().unwrap()}(n):n.prop("tagName").toLowerCase()===o?function(e,t){var n="ol"===e?"ul":"ol",o=t.html().replace(new RegExp("<"+n+">","g"),"<"+e+">").replace(new RegExp("</"+n+">","g"),"</"+e+">");$(t).replaceWith("<"+e+">"+o+"</"+e+">")}(e,n):(t.execCommand("formatBlock",!1,"pre"),function(e,t){for(var n=$("pre")[0],o=n.childNodes,i=0;i<o.length;i++){var r=$(o[i]);r.is("br")?(r.remove(),i--):r.wrap("<li></li>")}$(n).replaceWith(e+$(n).html()+t)}("<"+e+">","</"+e+">"))}var O=a.extensions.button.extend({name:"crop",contentDefault:"<b translate>toolbar_crop_content</b>",contentFA:'<i class="fas fa-crop"></i>',aria:i.instant("toolbar_crop_rollover"),handleClick:function(){o.$broadcast("command-crop",w.selectedBlock)},isAlreadyApplied:function(e){return e.classList.contains("bulb-cropping")}}),M=a.extensions.button.extend({name:"rotate",contentDefault:"<b translate>toolbar_rotate_content</b>",contentFA:'<i class="fas fa-redo-alt"></i>',aria:i.instant("toolbar_rotate_rollover"),handleClick:function(){o.$broadcast("command-rotate",w.selectedBlock)},isAlreadyApplied:function(e){return e.classList.contains("bulb-rotating")}}),P=a.extensions.button.extend({name:"updateVideo",contentDefault:"<b translate>toolbar_vide_thumbnail_content</b>",contentFA:'<i class="fas fa-edit"></i>',aria:i.instant("toolbar_video_thumbail_rollover"),handleClick:function(){if(w.selectedBlock.video.splashImages.length<=1){m.show({titleCode:"assetlibrary_modal_video_thumbnail_select",bodyCode:"assetlibrary_modal_video_thumbnail_unavailable",showOkButton:!0,showCancelButton:!1})}else s.one("video").customGET(w.selectedBlock.video.id).then(function(e){var t={titleCode:"",controller:function(){this.splashImages=w.selectedBlock.video.splashImages,this.selectedId=e.splashImage.id,this.currentTarget=e},templateUrl:"splashimages.modal.nested",controllerAs:"splashImagesModalCtrl",showOkButton:!1,showCancelButton:!1},n=w.selectedBlock.video.id;m.show(t).then(function(t){e.selectedSplashImageId!==t&&d.showBusyDuring(s.one("video",n).patch({selectedSplashImageId:e.selectedSplashImageId})).then(function(e){var t=w.page.unit.contentBlocks;for(var n in t)t.hasOwnProperty(n)&&"VIDEO"===t[n].blockType&&t[n].video.id===e.id&&angular.extend(t[n].video,e)})})})},isAlreadyApplied:function(e){return e.classList.contains("bulb-video-update")}}),D=a.extensions.button.extend({name:"carousel",contentDefault:"<b translate>toolbar_image_carousel_content</b>",contentFA:'<i class="far fa-images"></i>',aria:i.instant("toolbar_image_carousel_rollover"),handleClick:function(){var n=w.selectedBlock,i={originalImageBlockId:n.id};d.showBusyDuring(s.one("units",w.page.unit.id).customPOST(i,C.BLOCK_PATHS.IMAGE_CAROUSEL).then(function(t){w.page.unit.contentBlocks[t.contentBlock.id]=t.contentBlock,jQuery("#"+n.id).replaceWith(e('<content-block id="'+t.contentBlock.id+'" contenteditable="false" class="align-center"></content-block>')(o)),w.editor.trigger("editableInput",null,w.editor.elements[0]),w.updateToolbar();m.show({titleCode:"content_block_type_IMAGE_CAROUSEL",templateUrl:"imagecarouselconversionmodal.nested",showOkButton:!0,showCancelButton:!0}).then(function(){},function(n){var i=t.contentBlock,r={imageCarouselBlockId:i.id,selectedImageIndex:0};s.one("units",w.page.unit.id).one("revert").customPOST(r,C.BLOCK_PATHS.IMAGE_CAROUSEL).then(function(t){w.page.unit.contentBlocks[t.contentBlock.id]=t.contentBlock,jQuery("#"+i.id).replaceWith(e('<content-block id="'+t.contentBlock.id+'" contenteditable="false" class="align-center"></content-block>')(o)),w.editor.trigger("editableInput",null,w.editor.elements[0]),w.updateToolbar(),d.showBusyDuring(s.one("units",w.page.unit.id).one("blocks",i.id).remove().then(function(){delete w.page.unit.contentBlocks[i.id],element.removeClass("bulb-image-carousel")}))})})},function(){t.log("Error converting image carousel with original block id: ",n.id)}).then(function(){s.one("units",w.page.unit.id).one("blocks",n.id).remove().then(function(){delete w.page.unit.contentBlocks[n.id]})}))},isAlreadyApplied:function(e){return e.classList.contains("bulb-image-carousel")}}),R=a.extensions.button.extend({name:"addSlide",contentDefault:"<b translate>toolbar_image_carousel_add_image_content</b>",contentFA:'<i class="fa fa-plus"></i>',aria:i.instant("toolbar_image_carousel_add_image_rollover"),handleClick:function(){o.$broadcast("command-add-carousel-slide",w.selectedBlock)},isAlreadyApplied:function(e){return e.classList.contains("bulb-add-carousel-slide")}}),x=a.extensions.button.extend({name:"removeSlide",contentDefault:"<b translate>toolbar_image_carousel_remove_image_content</b>",contentFA:'<i class="fa fa-minus"></i>',aria:i.instant("toolbar_image_carousel_remove_image_rollover"),handleClick:function(){o.$broadcast("command-remove-carousel-slide",w.selectedBlock)},isAlreadyApplied:function(e){return e.classList.contains("bulb-remove-carousel-slide")}}),F=a.extensions.button.extend({name:"revertCarousel",contentDefault:"<b translate>toolbar_image_carousel_revert_content</b>",contentFA:'<i class="fas fa-eraser"></i>',aria:i.instant("toolbar_image_carousel_revert_rollover"),handleClick:function(){o.$broadcast("command-carousel-destroy",w.selectedBlock)}}),L=a.extensions.button.extend({name:"delete",contentDefault:"<b>X</b>",contentFA:'<i class="fas fa-trash-alt"></i>',aria:i.instant("toolbar_delete_rollover"),handleClick:function(){o.$broadcast("command-delete",w.selectedBlock)}}),N=a.extensions.button.extend({name:"dragCarousel",contentDefault:"<b translate>toolbar_image_carousel_draggable_content</b>",contentFA:'<i class="fas fa-arrows-alt"></i>',aria:i.instant("toolbar_image_carousel_draggable_content"),handleClick:function(){o.$broadcast("command-carousel-draggable",{draggable:!0,selectedBlock:w.selectedBlock,contentEditorCtrl:w});var e=jQuery(".medium-editor-action-dragCarousel"),t=i.instant("toolbar_image_carousel_undo_draggable_content");e.attr("title",t),e.hasClass("bulb-carousel-draggable-selected")?e.removeClass("bulb-carousel-draggable-selected"):e.addClass("bulb-carousel-draggable-selected")},isAlreadyApplied:function(e){return e.classList.contains("bulb-carousel-draggable-selected")}}),j=a.extensions.button.extend({name:"save",contentDefault:"<b translate>toolbar_save_content</b>",contentFA:'<i class="far fa-save"></i>',aria:i.instant("toolbar_save_rollover"),handleClick:function(){o.$broadcast("command-save",w.selectedBlock)}}),G=a.extensions.button.extend({name:"cancel",contentDefault:"<b translate>toolbar_cancel_content</b>",contentFA:'<i class="fa fa-times"></i>',aria:i.instant("toolbar_cancel_rollover"),handleClick:function(){o.$broadcast("command-cancel",w.selectedBlock)}}),H=a.extensions.button.extend({name:"cancelUpload",contentDefault:"<b translate>toolbar_cancel_upload_content</b>",contentFA:'<i class="fa fa-times"></i>',aria:i.instant("toolbar_cancel_upload_rollover"),handleClick:function(){o.$broadcast("command-cancel-upload",w.selectedBlock)}}),V=a.extensions.button.extend({name:"comment",contentDefault:"<b translate>toolbar_comment_content</b>",contentFA:'<i class="fa fa-comment"></i>',aria:i.instant("toolbar_comment_rollover"),handleClick:function(){p.createCommentThread(w.page.unit,w.editor,w.selectedBlock),w.editor.getExtensionByName("toolbar").hideToolbar()}}),z=a.extensions.button.extend({name:"text",contentDefault:"<b>T</b>",aria:i.instant("toolbar_text_rollover"),currentSelection:null,handleClick:function(){this.currentSelection=w.editor.exportSelection(),w.isToolbarStateText=!w.isToolbarStateText;var e=$(this.base.getExtensionByName("toolbar").getToolbarElement());_?w.isToolbarStateText&&!e.hasClass("medium-editor-text-options-styles")&&e.toggleClass("medium-editor-text-options-styles"):(w.isToolbarStateText&&!e.hasClass("medium-editor-text-options-styles-not-commentable")&&e.toggleClass("medium-editor-text-options-styles-not-commentable"),$(".medium-editor-list-container").hasClass("medium-editor-list-container-not-commentable")||$(".medium-editor-list-container").toggleClass("medium-editor-list-container-not-commentable")),w.updateToolbar()},isAlreadyApplied:function(){return w.isToolbarStateText&&y.isEqual(this.currentSelection,w.editor.exportSelection())?(_?$('div[id*="medium-editor-toolbar"]').addClass("medium-editor-text-options-styles"):$('div[id*="medium-editor-toolbar"]').addClass("medium-editor-text-options-styles-not-commentable"),!0):(w.isToolbarStateText=!1,!1)}}),q=a.extensions.button.extend({name:"colorPicker",action:"applyForeColor",aria:i.instant("toolbar_color_rollover"),contentDefault:'<span class="editor-color-picker"><i class="current-color-block fa fa-square fa-2x"></i><span>',shouldBeClosed:!1,handleClick:function(e){if(!this.shouldBeClosed&&(this.shouldBeClosed=!this.shouldBeClosed,e.preventDefault(),e.stopPropagation(),!this.selectionState||this.selectionState.end-this.selectionState.start!=0)){var t=C.COLORS,n=vanillaColorPicker(this.document.querySelector(".medium-editor-toolbar-active .editor-color-picker"));n.set("customColors",t),n.set("positionOnTop"),n.openPicker(),n.on("colorChosen",function(e){if(C.COLORS.includes(e)){this.document.execCommand("styleWithCSS",!1,!0),this.document.execCommand("foreColor",!1,e);for(var t=$(".bulb-page-content span"),o=0;o<t.length;o++){var i=$(t[o]);h.convertRGBtoHEX(i.css("color"))!==e||i.hasClass("handled-span")||i.addClass("handled-span")}var r=h.convertRGBtoHEX(this.document.queryCommandValue("ForeColor")+"");$(".current-color-block").css("color",r)}n.emit("lostFocus")}.bind(this))}},isAlreadyApplied:function(){var e=h.convertRGBtoHEX(this.document.queryCommandValue("ForeColor")+"");return $(".current-color-block").css("color",e),!(!C.COLORS.includes(e)||"#363d47"===e)}});this.selectedBlockElement=null,this.selectedBlock=null,this.insertBlockExtension=new g.createExtension({blockSelected:function(e){w.selectedBlockElement=angular.element(e),w.selectedBlock=e?w.page.unit.contentBlocks[e.id]:null,o.$broadcast("selectionChange",w.selectedBlockElement,w.selectedBlock),$(".medium-editor-text-options-styles").removeClass("medium-editor-text-options-styles"),$(".medium-editor-text-options-styles-not-commentable").removeClass("medium-editor-text-options-styles-not-commentable"),w.updateToolbar()},scope:o,contentEditorCtrl:w});this.toolbarExtension=new v.createExtension({buttons:["dropdownExtension","colorPicker",{name:"h2",aria:i.instant("toolbar_h2_rollover"),contentFA:'<i class="far fa-h2"></i>'},{name:"h3",aria:i.instant("toolbar_h3_rollover"),contentFA:'<i class="far fa-h3"></i>'},{name:"bold",aria:i.instant("toolbar_bold_rollover")},{name:"italic",aria:i.instant("toolbar_italic_rollover")},{name:"underline",aria:i.instant("toolbar_underline_rollover")},"text",{name:"quote",aria:i.instant("toolbar_quote_rollover")},"myUnorderedList","myOrderedList",{name:"anchor",aria:i.instant("toolbar_anchor_rollover")},"alignLeft","alignCenter","alignRight","updateVideo","crop","rotate","carousel","addSlide","removeSlide","revertCarousel","dragCarousel","delete","save","cancel","cancelUpload","comment"],static:!1,standardizeSelectionStart:!0,sticky:!1});var Q=new r.MediumEditorToolbarStates({default:{buttons:["bold","italic","underline","text","quote","myUnorderedList","myOrderedList","anchor"]},textEdit:{buttons:["dropdownExtension","colorPicker","h2","h3","bold","italic","underline","text","h2","h3","quote","myUnorderedList","myOrderedList","anchor"]},image:{buttons:["alignLeft","alignCenter","alignRight","crop","rotate","delete"]},imagePro:{buttons:["alignLeft","alignCenter","alignRight","crop","rotate","carousel","delete"]},imageCarousel:{buttons:["crop","rotate","addSlide","removeSlide","revertCarousel","dragCarousel","delete"]},embeddedVideo:{buttons:["alignLeft","alignCenter","alignRight","delete"]},uploadedVideo:{buttons:["alignLeft","alignCenter","alignRight","updateVideo","delete"]},uploadedAudio:{buttons:["alignLeft","alignCenter","alignRight","delete"]},crop:{buttons:["crop","save","cancel"]},caption:{buttons:["bold","italic","underline","anchor"]},attachedFile:{buttons:["delete"]},uploading:{buttons:["cancelUpload"]},embed:{buttons:["alignLeft","alignCenter","alignRight","delete"]},widgetEmbed:{buttons:["delete"]}}),W=new r.MediumEditorToolbarStates({default:{buttons:["bold","italic","underline","text","quote","myUnorderedList","myOrderedList","anchor","comment"]},textEdit:{buttons:["dropdownExtension","colorPicker","h2","h3","bold","italic","underline","text","h2","h3","quote","myUnorderedList","myOrderedList","anchor","comment"]},image:{buttons:["alignLeft","alignCenter","alignRight","crop","rotate","delete","comment"]},imagePro:{buttons:["alignLeft","alignCenter","alignRight","crop","rotate","carousel","delete","comment"]},imageCarousel:{buttons:["crop","rotate","addSlide","removeSlide","revertCarousel","dragCarousel","delete","comment"]},embeddedVideo:{buttons:["alignLeft","alignCenter","alignRight","delete","comment"]},uploadedVideo:{buttons:["alignLeft","alignCenter","alignRight","updateVideo","delete","comment"]},uploadedAudio:{buttons:["alignLeft","alignCenter","alignRight","delete","comment"]},crop:{buttons:["crop","save","cancel"]},caption:{buttons:["bold","italic","underline","anchor"]},attachedFile:{buttons:["delete","comment"]},uploading:{buttons:["cancelUpload"]},embed:{buttons:["alignLeft","alignCenter","alignRight","delete","comment"]},widgetEmbed:{buttons:["delete","comment"]}});this.editorOptions={imageDragging:!1,anchor:{linkValidation:!0,placeholderText:i.instant("toolbar_anchor_placeholder")},targetBlank:!0,buttonLabels:"fontawesome",placeholder:{hideOnClick:!1},extensions:{dropdownExtension:new a.extensions.dropdown({execOn:"fontName",defaultContentItems:C.FONTS,classList:["medium-editor-action-fontname"],browserService:u}),tabBehavior:new a.extensions.tabBehavior,alignLeft:new S,alignCenter:new T,alignRight:new I,crop:new O,rotate:new M,carousel:new D,addSlide:new R,removeSlide:new x,revertCarousel:new F,dragCarousel:new N,updateVideo:new P,myUnorderedList:new B,myOrderedList:new k,delete:new L,save:new j,cancel:new G,cancelUpload:new H,comment:new V,text:new z,colorPicker:new q,bulbInsertBlock:this.insertBlockExtension,toolbar:this.toolbarExtension,paste:new b.createExtension({forcePlainText:!1,cleanPastedHTML:!0}),"medium-editor-toolbar-states":new r.MediumEditorToolbarStates({states:_?W:Q,getStateNameForNode:function(e){if(["P","H2","H3","LI","UL","I","B","U","SPAN","BLOCKQUOTE"].indexOf(e.nodeName)>=0){var t=$(e).closest(".bulb-edit-caption").length>0;return w.isToolbarStateText&&!t?"textEdit":t?"caption":"default"}return e.getAttribute(this.attributeName)},attributeName:"toolbar-state"})},keyboardCommands:!0},this.updateToolbar=function(){w.editor.checkSelection()};var K=n.$on("$stateChangeStart",function(e,t,n){r.getSelection().removeAllRanges(),w.updateToolbar(),K()});a.selection.importSelection=function(e,t,n,o){if(e&&t){var i=n.createRange();i.setStart(t,0),i.collapse(!0);var r,s=t,l=[],c=0,u=!1,d=!1,p=0,h=!1,g=!1,m=null;for((o||e.startsWithImage||void 0!==e.emptyBlocksIndex)&&(g=!0);!h&&s;)if(s.nodeType>3)s=l.pop();else{if(3!==s.nodeType||d){if(e.trailingImageCount&&d&&("img"===s.nodeName.toLowerCase()&&p++,p===e.trailingImageCount)){for(var f=0;s.parentNode.childNodes[f]!==s;)f++;i.setEnd(s.parentNode,f+1),h=!0}if(!h&&1===s.nodeType)for(var b=s.childNodes.length-1;b>=0;)l.push(s.childNodes[b]),b-=1}else r=c+s.length,!u&&e.start>=c&&e.start<=r&&(g||e.start<r?(i.setStart(s,e.start-c),u=!0):m=s),u&&e.end>=c&&e.end<=r&&(e.trailingImageCount?d=!0:(i.setEnd(s,e.end-c),h=!0)),c=r;h||(s=l.pop())}!u&&m&&(i.setStart(m,m.length),i.setEnd(m,m.length)),o&&(i=a.selection.importSelectionMoveCursorPastAnchor(e,i));var v=n.getSelection();v.removeAllRanges(),v.addRange(i)}}}e.$inject=["$compile","$log","$rootScope","$scope","$translate","$window","MediumEditor","Restangular","BulbAssetLibraryService","BulbAuthService","BulbBrowserService","BulbBusyService","BulbCommentService","BulbContentEditorService","BulbInsertBlockExtensionFactory","BulbModalService","BulbPageService","BulbPasteExtensionFactory","BulbToolbarExtensionFactory","CONTENT_EDITOR","_"],angular.module("bulbApp.contentEditorModule").controller("ContentEditorController",e)}(),angular.module("bulbApp.contentEditorModule").directive("contentEditor",["$cookies","$compile","$timeout","BulbCommentService","BulbContentEditorService","MediumEditor","CONTENT_EDITOR","_",function(e,t,n,o,i,r,a,s){return{priority:999,require:"ngModel",restrict:"A",controller:"ContentEditorController as contentEditorCtrl",link:function(e,l,c,u){var d=e.contentEditorCtrl;function p(e,t,n){var o=jQuery(e),i=jQuery(t).clone();if(n){var r=i[0];r.className=e.className||"",jQuery.extend(r.classList,e.classList||{}),jQuery.extend(r.attributes,e.attributes)}return o.wrapAll(i),o.contents().unwrap(),e}function h(){return((new Date).getTime()/1e3|0).toString(16)+"xxxxxxxxxxxxxxxx".replace(/[x]/g,function(){return(16*Math.random()|0).toString(16)}).toLowerCase()}function g(e){for(var t=0;t<e.length;t++){var n=$(e[t]),o=null,r=null;if(n.parent().is("ol")||n.parent().is("ul")){var a=n.prev();a.is("li")&&a.append(n)}var s=i.hasBulbFont(n);!0===s.accepted&&(r=s.formattedFont);var l=i.hasBulbColor(n);if(!0===l.accepted&&(o=l.colorInHEX),o||r){var c=$("<span></span>");o&&c.attr("bulb-font-color",o),r&&c.attr("bulb-font-face",r);for(var u=n.find("li"),d=0;d<u.length;d++){var p=$(u[d]);if(p.find("span").length>0){var h=$(p.find("span")[0]);h.attr("bulb-font-color",o||h.attr("bulb-font-color")),h.attr("bulb-font-face",r||h.attr("bulb-font-face"))}else p.contents().wrap(c);p.removeAttr("style")}}n.removeAttr("style")}}function m(e){var t=$("<div />").html(e);return $(".bulb-page-content span").filter(function(){var e=$(this)[0].hasAttribute("bulb-font-color");return!($(this)[0].hasAttribute("bulb-font-face")||!s.find(a.FONTS,{FONT:$(this).css("font-family")}))||!(e||!a.COLORS.includes(i.convertRGBtoHEX($(this).css("color"))))}).addClass("handled-span"),function(e){for(var t=0;t<e.length;t++){var n=$(e[t]),o=$("<span></span>"),r=n[0].hasAttribute("color"),a=n[0].hasAttribute("face");r&&!0===i.hasBulbColor(n).accepted&&o.attr("bulb-font-color",n.attr("color")),a&&!0===i.hasBulbFont(n).accepted&&o.attr("bulb-font-face",n.attr("face")),n.contents().wrap(o),n.contents().unwrap()}}(t.find("font")),function(e){for(var t=0;t<e.length;t++){var n=0,o=$(e[t]);if(!o.parent().is("button")){var r=i.hasBulbFont(o);!0===r.accepted?o.attr("bulb-font-face",r.formattedFont):(o.removeAttr("bulb-font-face"),o[0].style.fontFamily=null,n++);var a=i.hasBulbColor(o);!0===a.accepted?o.attr("bulb-font-color",a.colorInHEX):(o.removeAttr("bulb-font-color"),o[0].style.color=null,n++);var s=o.attr("style");s&&i.hasBoldItalicUnderlineStyling(s)&&i.applySpecificStyling(o,s),2!==n?(o.removeAttr("style"),o.removeAttr("class"),o.removeAttr("id")):o.contents().unwrap()}}}(t.find("span")),g(t.find("ol")),g(t.find("ul")),function(e){for(var t=0;t<e.length;t++){var n=$(e[t]),o=$("<span></span>"),r=!1,a=i.hasBulbFont(n);!0===a.accepted&&(o.attr("bulb-font-face",a.formattedFont),r=!0);var s=i.hasBulbColor(n);!0===s.accepted&&(o.attr("bulb-font-color",s.colorInHEX),r=!0);var l=n.attr("style");l&&i.hasBoldItalicUnderlineStyling(l)&&i.applySpecificStyling(n,l),r&&n.contents().wrap(o),n.removeAttr("style")}}(t.find("*[style]")),t.find('[class*="bulb-media-transient"]').remove(),t.find('[class*="reveal-modal"]').remove(),t.find(".modal-bg-outer").remove(),t.find(".bulb-media-active").removeClass("bulb-media-active"),t.find(".bulb-media-temp-placeholder").removeClass("bulb-media-temp-placeholder").removeAttr("id").html("<br/>"),t.find(".ng-scope").removeClass("ng-scope"),t.find(".ng-isolate-scope").removeClass("ng-isolate-scope"),t.find(".modal-open").removeClass("modal-open"),t.find('*[class=""]').removeAttr("class"),t.find("[contenteditable]").removeAttr("contenteditable"),t.html()}d.page=e.$eval(c.page),angular.element(l).addClass("angular-medium-editor"),u.editor=new r(l,d.editorOptions),d.editor=u.editor,d.editorElement=l[0],n(function(){for(var e=document.getElementsByClassName("bulb-page-editable"),t=e.length,n=0;n<t;n++){e[n].setAttribute("data-gramm","false")}}),u.editor.getExtensionByName("placeholder").updatePlaceholder=function(e,t){if(e.querySelector("img, blockquote, ul, ol, table, content-block"))return this.hidePlaceholder(e);var n=$(e).clone();if(n.find(".bulb-media-transient").remove(),""!==n.get(0).textContent.replace(/^\s+|\s+$/g,""))return this.hidePlaceholder(e);t||this.showPlaceholder(e)},u.$render=function(){var n=u.$viewValue||"",o=(n=function(e){var t=jQuery.parseHTML(e),n="";if(1!==t.length)return!1;return t.forEach(function(e){var t=$(e);"BR"===t.prop("tagName")?("P"!==t.parent().prop("tagName")&&t.wrap('<p id="'+h()+'"></p>'),n+=t.parent()[0].outerHTML):(0===t.children().length&&t.append("<br />"),n+=e.outerHTML)}),n}(n)||u.$viewValue).indexOf("<");o>0&&(n="<p>"+n.substring(0,o)+"</p>"+n.substring(o)),n+='<p class="bulb-content-trailer bulb-media-transient"></p>',l.html(t(n)(e)),function(e){var t=e.children();if(t.length>2)return!1;for(var n=0;n<t.length;n++){var o=jQuery(t[n]);"P"!==o.prop("tagName")&&"BR"===o.find(">:first-child").prop("tagName")&&o.replaceWith('<p id="'+h()+'"><br/></p>')}}(l),function e(t,n){var o=t.children();var i=void 0===n||n;for(var r=0;r<o.length;r++)if(o[r]){var a=jQuery(o[r]),s=a.prop("tagName").toLowerCase();if(i&&!a.hasClass("bulb-media-transient")&&("content-block"!==s&&(jQuery.trim(a.text())||0!==a.children().length||a.remove()),a&&"p"!==s&&"h2"!==s&&"h3"!==s&&"ol"!==s&&"ul"!==s&&"content-block"!==s&&"blockquote"!==s)){for(var l=h();jQuery("#"+l).length;)l=h();a.wrap('<p id="'+l+'"></p>')}if("content-block"!==s&&a&&!a.hasClass("bulb-media-transient")&&e(a,!1),"span"===s&&a&&(a[0].hasAttribute("bulb-font-face")||a[0].hasAttribute("bulb-font-color")))continue;"p"!==s&&"h2"!==s&&"h3"!==s&&"ol"!==s&&"ul"!==s&&"li"!==s&&"blockquote"!==s&&"content-block"!==s&&"b"!==s&&"strong"!==s&&"i"!==s&&"em"!==s&&"u"!==s&&"a"!==s&&("br"===s?a.parent().is("p")||a.parent().is("h2")||a.parent().is("h3")||a.remove():a.children().length>0?a.contents().unwrap():a.hasClass("bulb-media-transient")||(a.is(":empty")?a.remove():a.replaceWith(p(a,"<p>",!0))))}}(l),u.editor.getExtensionByName("placeholder").updatePlaceholder(l[0])},u.editor.subscribe("editableInput",function(e,t){var n=m(t.innerHTML.trim());u.$setViewValue(n)}),e.$watch("contentEditorCtrl.editorOptions",function(e){u.editor.init(l,e)});var f=u.editor.getExtensionByName("toolbar");f.on(f.document.documentElement,"touchend",f.handleDocumentMouseup.bind(f)),o.init(d.page,l,u.editor,e)}}}]),function(){"use strict";function e(e,t){var n=this;this.contentEditorSettings=t,this.convertRGBtoHEX=function(e){if(-1===e.search("rgb"))return null;function t(e){return("0"+parseInt(e).toString(16)).slice(-2)}return"#"+t((e=e.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/))[1])+t(e[2])+t(e[3])},this.isAllowedTag=function(e){return e instanceof jQuery&&(e=e[0]),!!t.ALLOWED_TAGS.includes(e.nodeName.toLowerCase())},this.hasBulbFont=function(n){n instanceof jQuery||(n=$(n));var o=n.css("font-family");return o&&o!==t.DEFAULT_FONT.FONT&&"initial"!==o&&e.find(t.FONTS,{FONT:o})?{accepted:!0,formattedFont:o}:{accepted:!1,formattedFont:null}},this.hasBulbColor=function(e){e instanceof jQuery||(e=$(e));var o=n.convertRGBtoHEX(e.css("color"));return o&&o!==t.DEFAULT_COLOR&&"initial"!==o&&t.COLORS.includes(o)?{accepted:!0,colorInHEX:o}:{accepted:!1,colorInHEX:null}},this.applySpecificStyling=function(e,t){t.includes("bold")&&e.wrap("<b></b>"),t.includes("italic")&&e.wrap("<i></i>"),t.includes("underline")&&e.wrap("<u></u>")},this.hasBoldItalicUnderlineStyling=function(e){var t=e.split(";").filter(function(e){return""!==e});return t.forEach(function(e,t){this[t]=this[t].trim()},t),t.includes("text-decoration-line: underline")||t.includes("text-decoration: underline")||t.includes("font-style: italic")||t.includes("font-weight: bold")}}e.$inject=["_","CONTENT_EDITOR"],angular.module("bulbApp.contentEditorModule").service("BulbContentEditorService",e)}(),angular.module("bulbApp.contentEditorModule").directive("bulbCroppable",["$log","$timeout","Restangular","BulbAutoSaveService","BulbBusyService","BulbImageCarouselService","AUTO_SAVE","CONTENT_EDITOR","_",function(e,t,n,o,i,r,a,s,l){return{require:["^?contentEditor","^contentBlock","^bulbFrame","^?imageBlock","^?imageCarousel","^?imageAsset"],link:function(r,l,c,u){var d=null;if(u[0]&&(d=u[0]),!d||d.page.editing){var p,h,g,m,f=u[1],b=u[2],v=u[3],C=u[4],y=!1,w=f.contentBlock.blockType,A=null;"IMAGE"===w?t(function(){A=l.find("img")},s.IMAGE_ASSET.IMAGE_ASSET_IMAGE_TIMEOUT):"IMAGE_CAROUSEL"===w?r.$watchCollection("contentBlockCtrl.contentBlock",function(e,n){t(function(){try{var t=e.carouselImages[f.contentBlock.displayedImageIndex].uncroppedImageAsset||e.carouselImages[f.contentBlock.displayedImageIndex].fullImageAsset;A=$('img[id="'+t.id+'"]')}catch(e){}},s.IMAGE_ASSET.IMAGE_ASSET_IMAGE_TIMEOUT)}):e.error("currentBlockType is an undefined type."),r.$on("command-crop",function(){f.selected&&!y&&function(){var t=null;if("IMAGE"===w)t=f.contentBlock.uncroppedImageAsset||f.contentBlock.fullImageAsset,v.updateImageInfo(t);else if("IMAGE_CAROUSEL"===w){var n=f.contentBlock.carouselImages[f.contentBlock.displayedImageIndex];t=n.uncroppedImageAsset||n.fullImageAsset,A.attr("src",t.url),A.removeClass("bulb-carousel-display-image")}else e.error("currentBlockType is an undefined type.");p=b.frameState,b.setFrameState("default"),l.addClass("bulb-cropping"),h=f.frameElement.attr("toolbar-state"),f.frameElement.attr("toolbar-state","crop"),d.insertBlockExtension.selectBlock(l),"IMAGE"===w&&r.$apply();var o=f.contentBlock.cropRectangle;g=r.$on("command-save",_),m=r.$on("command-cancel",E);var i=l.width()/t.width;A.cropper({checkCrossOrigin:!1,movable:!1,rotatable:!1,scalable:!1,zoomable:!1,zoomOnTouch:!1,zoomOnWheel:!1,minCropBoxWidth:100*i,minCropBoxHeight:100*i,data:o}),y=!0}()}),r.$on("selectionChange",function(e,t){!f.selected&&y&&E()})}function _(){var t=A.cropper("getData","rounded"),l={cropRectangle:{x:t.x,y:t.y,width:t.width,height:t.height}};"IMAGE_CAROUSEL"===w&&(l.selectedImageIndex=f.contentBlock.displayedImageIndex);var c=f.contentBlock.displayedImageIndex;i.showBusyDuring(n.one("units",f.page.unit.id).one(s.BLOCK_PATHS[w],f.contentBlock.id).patch(l).then(function(t){"IMAGE"===w?(angular.copy(t.plain(),f.contentBlock),v.updateImageInfo()):"IMAGE_CAROUSEL"===w?(r.$emit("cropped-carousel-image",c),C.updateCarouselState(t)):e.error("currentBlockType is an undefined type.");var n={status:a.STATUS.SAVING,restId:d.page.unit.id};o.autoSave(d.page.unit.id,"units",n)})),E()}function E(){if(A.cropper("destroy"),"IMAGE_CAROUSEL"===w){A.addClass("bulb-carousel-display-image");var e=f.contentBlock.carouselImages[f.contentBlock.displayedImageIndex].scaledImageAsset||f.contentBlock.carouselImages[f.contentBlock.displayedImageIndex].fullImageAsset;A.attr("src",e.url)}b.setFrameState(p),l.removeClass("bulb-cropping"),f.frameElement.attr("toolbar-state",h),d.updateToolbar(),"IMAGE"===w&&(v.updateImageInfo(),r.$apply()),g(),m(),y=!1}}}}]),angular.module("bulbApp.contentEditorModule").directive("bulbDragNDrop",["$compile",function(e){return{require:["?^contentEditor","^contentBlock","^bulbFrame"],link:function(t,n,o,i,r){var a=i[0];if(a){var s,l,c=i[1],u=c.contentBlock.blockType,d=document.createElement("meta");d.name="viewport",d.content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no",n.append(d),t.$watch("contentBlockCtrl.selected",function(e,t){e!==t?n.attr("draggable","true"):n.attr("draggable","false")});var p=c.contentBlockElement[0];p&&(n.addClass("mobile-longpress-features-off"),jQuery(p).on("dragstart",function(e){null!==a.selectedBlock&&a.selectedBlock.id===p.id?(l=p.outerHTML,e.originalEvent.dataTransfer&&e.originalEvent.dataTransfer.setDragImage(p,0,0)):e.preventDefault()}));var h=a.editor.elements[0];h&&(jQuery(h).on("drop",function(n){n.preventDefault();var o=jQuery(s).closest("content-block")[0];if(s=jQuery(function e(t){return t&&t.parentElement!==jQuery(".bulb-page-content")[0]?e(t.parentNode):t}(s))[0],l&&s){var i=document.createElement("template");if(i.innerHTML=l,i=i.content.childNodes[0],i=angular.element(i),!o||i[0].id!==o.id){l="",jQuery("#"+i[0].id).remove();var r=e(i);d=i[0],h=(p=o||s).parentNode,(g=p.nextSibling)?h.insertBefore(d,g):h.appendChild(d),r(t),"IMAGE_CAROUSEL"===u&&t.$emit("command-carousel-draggable-drop",{draggable:!1,selectedBlock:c.contentBlock}),a.insertBlockExtension.unselectBlock(),a.updateToolbar(),a.editor.trigger("editableInput",null,a.editor.elements[0])}}var d,p,h,g}),jQuery(h).on("dragover",function(e){e.clientY<25?window.scrollBy(0,-25):e.clientY>jQuery(window).height()-25&&window.scrollBy(0,25);e.preventDefault(),s=jQuery(e.target)[0]}))}}}}]),function(){"use strict";var e=MediumEditor.Extension.extend({name:"dropdownExtension",execOn:"fontName",defaultFAItems:[],defaultContentItems:["Arial","Etc","Item 3"],classList:[""],constructor:function(e){MediumEditor.Extension.call(this,e)},init:function(){var e=this;this.listContainer=$.parseHTML('<div class="medium-editor-list-container"><select class="medium-editor-form-select"></select></div>');var t=$(this.listContainer).find("select");if(this.defaultFAItems.length>0)for(var n=0;n<this.defaultFAItems.length;n++){var o=this.document.createElement("option");o.innerHTML=this.defaultFAItems[n],o.value=this.defaultFAItems[n],t.append(o)}else for(var i=0;i<e.defaultContentItems.length;i++){var r=e.document.createElement("option");r.innerHTML=e.defaultContentItems[i].FONT_NAME,r.value=e.defaultContentItems[i].FONT,t.append(r)}this.attachToEditables(),this.on(t[0],"change",this.handleClickedOption.bind(this)),e.browserService.isAndroid()&&(this.on(t[0],"click",function(t){e.userSelection=e.base.exportSelection()}),this.on(t[0],"blur",function(t){$(".medium-editor-toolbar").css("visibility","visible"),e.base.importSelection(e.userSelection),$(".medium-editor-toolbar").css("visibility","")})),this.listContainer=this.listContainer[0]},getSelect:function(){return this.getButton().querySelector("select.medium-editor-form-select")},attachToEditables:function(){this.subscribe("positionToolbar",this.handleToolbarPosition.bind(this))},detachFromEditables:function(){this.unsubscribe("positionToolbar",this.handleToolbarPosition.bind(this))},handleToolbarPosition:function(e){var t=this.document.queryCommandValue(this.execOn)+"";t=t.replace(/['"]+/g,""),this.updateSelection(t)},updateSelection:function(e){var t=this.getSelect(),n=_.find(this.defaultContentItems,{FONT:e});t.value=n?n.FONT:"calluna, serif"},handleClickedOption:function(e){var t=this.getSelect().value;if(""===t)this.clearSelectedAttribute();else{var n=_.find(this.defaultContentItems,{FONT:t});this.document.execCommand("styleWithCSS",!1,!0),this.execAction("fontName",{name:n.FONT});for(var o=$(".bulb-page-content span"),i=0;i<o.length;i++){var r=$(o[i]);r.css("font-family").replace(/['"]+/g,"")!==n.FONT||r.hasClass("handled-span")||r.addClass("handled-span")}}},getButton:function(){return this.listContainer},destroy:function(){this.detachFromEditables()}});MediumEditor.extensions.dropdown=e}(),function(){"use strict";function e(e,t,n,o,i,r,a){var s=this;this.isCustomWidgetEmbed=function(){return t.contentBlockCtrl.contentBlock.html.indexOf(r.hosted4hGradingWidgetUrl)>-1};var l=t.$watch(function(){return e.url()},function(e){s.pageURL=e,o.parent.addEventListener("message",c,!1)});function c(e){e.origin===r.hosted4hGradingWidgetUrl&&(!0===e.data.loaded&&(jQuery(".bulb-iframe")[0].contentWindow.postMessage(s.pageURL,r.hosted4hGradingWidgetUrl),o.removeEventListener("message",c,!1),l()))}function u(){var e=!0,t=document.getElementsByTagName("iframe");angular.forEach(t,function(t){try{t&&-1!==t.src.indexOf("https://docs.google.com/viewer")&&t.contentWindow.document&&(e=!1,t.src+="")}catch(e){}}),e||n(u,3e3)}this.updateBlockSize=function(){var e=t.contentBlockCtrl.contentBlock.width,n=r.page.content.max.width,o=t.contentBlockCtrl.contentBlock.height,i=jQuery(".bulb-page-content").width()/r.page.content.max.width;s.width=Math.max(t.contentBlockCtrl.contentBlock.minWidth,Math.min(e,t.contentBlockCtrl.contentBlock.maxWidth))*i,s.height=o*i,t.contentBlockCtrl.isFullWidth=e>n*a.FULL_BLOCK_WIDTH_PERCENTAGE},t.$watchCollection("contentBlockCtrl.contentBlock",function(){s.updateBlockSize()}),n(function(){u(),function(){var e=t.contentBlockCtrl.contentBlock,n=decodeURIComponent(e.originalUrl);if("EMBED"===e.blockType&&-1!==n.indexOf("api.onedrive.com")){var o=n.split("shares/")[1].split("/root")[0],r=document.getElementById(t.contentBlockCtrl.contentBlock.id);angular.forEach(r.getElementsByClassName("embed-overlay"),function(e){var n=e.getElementsByTagName("iframe");i.updateOneDriveItemUrl(n[0],o,t.contentBlockCtrl.page.unit.id,t.contentBlockCtrl.contentBlock.id,e.children[0].innerHTML)})}}()})}e.$inject=["$location","$scope","$timeout","$window","BulbAssetLibraryOneDriveService","CONFIG","CONTENT_EDITOR"],angular.module("bulbApp.contentEditorModule").controller("EmbedBlockController",e)}(),angular.module("bulbApp.contentEditorModule").directive("embedBlock",["CONFIG",function(e){return{restrict:"E",controller:"EmbedBlockController as embedBlockCtrl",link:function(e,t,n,o){var i=e.$watch(function(){return t.find("iframe").length},function(e,t){e!==t&&e>0&&(i(),o.updateBlockSize())})},templateUrl:e.resource.cdnRoot+"ajs/components/contenteditor/embedblock.html"}}]),angular.module("bulbApp.contentEditorModule").directive("bulbFontColor",function(){return{scope:!1,link:function(e,t,n,o){var i=n.bulbFontColor;$(t).css("color",i),$(t).addClass("handled-span")}}}),angular.module("bulbApp.contentEditorModule").directive("bulbFontFace",["CONTENT_EDITOR",function(e){return{scope:!1,link:function(e,t,n,o){var i=n.bulbFontFace;$(t).css("font-family",i),$(t).addClass("handled-span")}}}]),function(){"use strict";function e(e){var t=this;this.frameState="default",this.setFrameState=function(n){t.frameState=n,e.$broadcast("frameStateChange",n)}}e.$inject=["$scope"],angular.module("bulbApp.contentEditorModule").controller("FrameController",e)}(),angular.module("bulbApp.contentEditorModule").directive("bulbFrame",function(){return{restrict:"E",require:"^contentBlock",transclude:!0,priority:999,templateUrl:"ajs/components/contenteditor/frame.html",controller:"FrameController as frameCtrl",compile:function(){return{pre:function(e,t,n,o){t.addClass("bulb-asset-container"),t.addClass("bulb-content-frame"),t.attr("selectable-block",""),o.frameElement=t}}}}}),function(){"use strict";function e(e,t,n){var o=this;this.updateImageInfo=function(i){var r=jQuery(".bulb-page-content").width(),a=t.page.content.max.width,s=r/a,l=i||e.contentBlockCtrl.contentBlock.scaledImageAsset||e.contentBlockCtrl.contentBlock.fullImageAsset,c=l.width,u=l.height,d=1;c>a&&(d=a/c,c=a,u*=d),o.url=l.url,o.width=c*s,o.height=u*s,o.maxWidth=l.width,o.photoMetaInfo=l,o.MINIMUM_IMAGE_WIDTH=n.MINIMUM_IMAGE_WIDTH,e.contentBlockCtrl.isFullWidth=c>a*n.FULL_BLOCK_WIDTH_PERCENTAGE},e.$watchCollection("contentBlockCtrl.contentBlock",function(){o.updateImageInfo()})}e.$inject=["$scope","CONFIG","CONTENT_EDITOR"],angular.module("bulbApp.contentEditorModule").controller("ImageBlockController",e)}(),angular.module("bulbApp.contentEditorModule").directive("imageBlock",["BulbAuthService","CONFIG",function(e,t){return{restrict:"E",controller:"ImageBlockController as imageBlockCtrl",templateUrl:t.resource.cdnRoot+"ajs/components/contenteditor/imageblock.html",link:function(t,n,o,i){t.currentUser=e.currentUser}}}]),function(){"use strict";function e(e){this.checkSlickNoSlide=function(e){e.slideCount<e.options.slidesToShow?e.$slider.addClass("slick-no-slide"):e.$slider.removeClass("slick-no-slide")},this.grabCurrentThumbnailSlide=function(t){e.forEach(t.$slides,function(t){-1!==e.indexOf(t.classList,"slick-current")?$(t).find("img").addClass("bulb-carousel-current-thumbnail-image"):$(t).find("img").removeClass("bulb-carousel-current-thumbnail-image")})},this.grabCurrentDisplaySlide=function(t,n){var o=n.scaledImageAsset||n.fullImageAsset;e.forEach(t.$slides,function(e){$(e).find("img")[0]&&(o.url===$(e).find("img")[0].src?$(e).find("img").addClass("bulb-carousel-current-thumbnail-image"):$(e).find("img").removeClass("bulb-carousel-current-thumbnail-image"))})}}e.$inject=["_"],angular.module("bulbApp.contentEditorModule").service("BulbImageCarouselService",e)}(),function(){"use strict";function e(e,t,n,o,i,r,a,s,l){var c=this;this.pageContentMaxWidth=a.page.content.max.width,this.thumbnailSlickInstance=null,this.contentBlockCtrl=e.contentBlockCtrl,this.mode=e.pageViewCtrl.page.mode,this.isMobile=i.isIOSMobile()||i.isAndroid(),this.draggableCarouselThumbnails=this.contentBlockCtrl.contentBlock.carouselImages,e.$watch("this.contentBlockCtrl.contentBlock.carouselImages",function(e,t){e!==t&&(c.draggableCarouselThumbnails=e)}),e.$on("added-carousel-image",function(e,t){c.event=e.name,c.currentIndex=t}),e.$on("removed-carousel-image",function(e,t){c.event=e.name,c.currentIndex=t}),e.$on("cropped-carousel-image",function(e,t){c.event=e.name,c.currentIndex=t}),e.$on("rotated-carousel-image",function(e,t){c.event=e.name,c.currentIndex=t});var u=e.$on("command-carousel-draggable",function(e,t){t.selectedBlock.id===c.contentBlockCtrl.contentBlock.id&&(c.slickConfigDisplayLoaded&&c.slickConfigThumbnailsLoaded?(c.slickConfigDisplayLoaded=!1,c.slickConfigThumbnailsLoaded=!1,c.isDraggable=t.draggable):(c.slickConfigDisplayLoaded=!0,c.slickConfigThumbnailsLoaded=!0,c.isDraggable=!1),c.contentBlockCtrl.contentBlockElement.click(),t.contentEditorCtrl.insertBlockExtension.selectBlock(c.contentBlockCtrl.contentElement[0]))});e.$on("command-carousel-draggable-drop",function(e,t){t.selectedBlock.id===c.contentBlockCtrl.contentBlock.id&&(jQuery(".medium-editor-action-dragCarousel").removeClass("bulb-carousel-draggable-selected"),c.slickConfigDisplayLoaded=!0,c.slickConfigThumbnailsLoaded=!0,c.isDraggable=t.draggable,u())});var d=e.$watchCollection("contentBlockCtrl.contentBlock",function(){c.updateCarouselDimensions()});this.autoSaveOptions={restId:this.contentBlockCtrl.page.unit.id,customSave:function(){var t={carouselCaption:c.contentBlockCtrl.contentBlock.carouselImages[c.contentBlockCtrl.contentBlock.displayedImageIndex].caption,selectedImageIndex:c.contentBlockCtrl.contentBlock.displayedImageIndex};return o.one("units",e.contentBlockCtrl.page.unit.id).one(s.BLOCK_PATHS[c.contentBlockCtrl.contentBlock.blockType],c.contentBlockCtrl.contentBlock.id).patch(t)}},this.slickConfigDisplayLoaded=!0,this.slickDisplayConfig={fade:!0,arrows:!0,asNavFor:".slider-nav-"+c.contentBlockCtrl.contentBlock.id,slidesToShow:1,slidesToScroll:1,infinite:!0,event:{init:function(e,n){t(function(){jQuery("figcaption").on("touchstart",function(e){$(this).find("p").focus(),e.preventDefault()}),void 0===c.currentIndex?(c.contentBlockCtrl.contentBlock.displayedImageIndex=0,n.slickGoTo(0)):"added-carousel-image"===c.event?n.slickGoTo(c.currentIndex+1):"removed-carousel-image"===c.event?(n.slickGoTo(c.currentIndex-1),1===c.contentBlockCtrl.contentBlock.carouselImages.length&&(c.contentBlockCtrl.contentBlock.displayedImageIndex=0)):"cropped-carousel-image"!==c.event&&"rotated-carousel-image"!==c.event||(n.slickGoTo(c.currentIndex),c.contentBlockCtrl.contentBlock.displayedImageIndex=c.currentIndex)}),d()},afterChange:function(e,n,o,i){c.contentBlockCtrl.contentBlock.displayedImageIndex=o,t(function(){r.grabCurrentDisplaySlide(c.thumbnailSlickInstance,c.contentBlockCtrl.contentBlock.carouselImages[o])})}}},this.slickConfigThumbnailsLoaded=!0,this.slickConfigThumbnailsDisplay={dots:!0,arrows:!1,slidesToShow:3,slidesToScroll:1,focusOnSelect:!0,centerMode:!0,centerPadding:this.isMobile?"":"130px",infinite:!0,asNavFor:".slider-for-"+c.contentBlockCtrl.contentBlock.id,event:{init:function(e,t){r.checkSlickNoSlide(t),c.thumbnailSlickInstance=t,r.grabCurrentThumbnailSlide(t)}}},this.slickConfigDisplayViewLoaded=!0,this.slickDisplayViewConfig={fade:!0,arrows:!0,slidesToShow:1,slidesToScroll:1,infinite:!0,event:{init:function(e,n){c.contentBlockCtrl.contentBlock.displayedImageIndex=0,n.$dots?n.$dots.css({top:c.height+s.CAROUSEL.SLICK_RENDER_DOTS_PADDING}):t(function(){jQuery("figcaption").css({top:c.height-s.CAROUSEL.SLICK_RENDER_FIGCAPTION})}),d()},afterChange:function(e,t,n,o){c.contentBlockCtrl.contentBlock.displayedImageIndex=n}}},this.updateCarouselState=function(e){this.slickConfigDisplayLoaded=!1,this.slickConfigThumbnailsLoaded=!1,angular.copy(e.plain(),c.contentBlockCtrl.contentBlock),t(function(){c.slickConfigDisplayLoaded=!0,c.slickConfigThumbnailsLoaded=!0})},this.conf={thumbnails:!1,thumbSize:80,inline:!1,bubbleSize:10,bgClose:!0,bubbles:!0,deletable:!1,imgBubbles:!1,piracy:!0,imgAnim:"fadeup"},this.methods={},this.openCarousel=function(){this.methods.open()},this.previewImages=[],this.opened=function(){jQuery(".bulb-page-header").addClass("move-to-background"),jQuery("content-block").not('content-block[id="'+c.contentBlockCtrl.contentBlock.id+'"]').css({zIndex:"-1"});var e=0;l.forEach(c.contentBlockCtrl.contentBlock.carouselImages,function(t){var n=t.scaledImageAsset||t.fullImageAsset,o={id:n.id+e,url:n.url,extUrl:n.url,thumbUrl:n.url,title:t.caption};e++,c.previewImages.push(o)})},this.closed=function(){this.previewImages=[],jQuery(".bulb-page-header").removeClass("move-to-background"),jQuery("content-block").not('content-block[id="'+c.contentBlockCtrl.contentBlock.id+'"]').css({zIndex:""})},this.updateCarouselDimensions=function(){var e=a.page.content.max.width,t=jQuery(".bulb-page-content").width()/e;c.pageContentMaxWidth=c.pageContentMaxWidth*t;var n=c.contentBlockCtrl.contentBlock.carouselImages,o=n[0].scaledImageAsset||n[0].fullImageAsset,i=o.width,r=o.height,s="3.5em";i>e&&(r*=e/i),this.isMobile&&(s="2em"),c.displayedImageAsset=o,c.width=c.pageContentMaxWidth,c.height=r*t,c.maxWidth=c.pageContentMaxWidth,c.carouselMargin=s},this.isUnsplashImage=function(e,t){return t&&t.source===a.unsplash.label||e&&e.source===a.unsplash.label}}e.$inject=["$scope","$timeout","$translate","Restangular","BulbBrowserService","BulbImageCarouselService","CONFIG","CONTENT_EDITOR","_"],angular.module("bulbApp.contentEditorModule").controller("ImageCarouselBlockController",e)}(),angular.module("bulbApp.contentEditorModule").directive("imageCarousel",["$compile","$log","$q","$timeout","$window","Restangular","BulbAssetLibraryService","BulbAssetLibraryGoogleDriveService","BulbAssetLibraryGooglePhotoService","BulbAssetLibraryOneDriveService","BulbAssetLibraryUnsplashService","BulbAssetLibraryUploadService","BulbBusyService","BulbBusyCoverService","BulbModalService","CONFIG","CONTENT_EDITOR",function(e,t,n,o,i,r,a,s,l,c,u,d,p,h,g,m,f){return{restrict:"E",controller:"ImageCarouselBlockController as imageCarouselBlockCtrl",templateUrl:m.resource.cdnRoot+"ajs/components/contenteditor/imagecarouselblock.html",require:["^?contentEditor","^contentBlock","^imageCarousel"],link:function(o,b,v,C){var y=this;i.bulbVars.ImageCarouselBlockDirective=this;var w=C[0],A=C[1],_=C[2],E=A.contentBlock.blockType;b.addClass("bulb-image-carousel");var S=o.$on("command-carousel-destroy",function(n,i){if(i.id===A.contentBlock.id){g.show({titleCode:"image_carousel_revert_block_form_title",bodyCode:"image_carousel_revert_block_instructions",showOkButton:!0,showCancelButton:!0}).then(function(){var t={imageCarouselBlockId:i.id,selectedImageIndex:A.contentBlock.displayedImageIndex};p.showBusyDuring(r.one("units",w.page.unit.id).one("revert").customPOST(t,f.BLOCK_PATHS.IMAGE_CAROUSEL).then(function(t){w.page.unit.contentBlocks[t.contentBlock.id]=t.contentBlock,jQuery("#"+i.id).replaceWith(e('<content-block id="'+t.contentBlock.id+'" contenteditable="false" class="align-center"></content-block>')(o)),w.editor.trigger("editableInput",null,w.editor.elements[0]),w.updateToolbar(),p.showBusyDuring(r.one("units",w.page.unit.id).one("blocks",i.id).remove().then(function(){delete w.page.unit.contentBlocks[i.id],b.removeClass("bulb-image-carousel"),S()}))}))},function(e){t.log("User cancelled the convert image carousel dialog!",e)})}});o.$on("command-add-carousel-slide",function(e,t){t.id===A.contentBlock.id&&function(){var e=y;e.addCarouselImageDeferred=n.defer();var t=function(e){return e.image.assetLibraryEntryId=e.id,y.addCarouselImageDeferred.resolve(e.image),y.addCarouselImageDeferred.promise}.bind(e),o=function(){d.uploadImageBySelectionModal(y,"","submitFileHandler","","doneFileHandler",!1,"pageImageCarousel")}.bind(e),i=function(){a.dialog.closeCurrentModal(),s.openImageTypePicker(function(e,t,n,o){h.showBusyDuring(a.api.importFromGoogleDrive(e,null,t,n,o).then(function(e){y.doneFileHandler("google-import",e)}))})}.bind(e),r=function(){a.dialog.closeCurrentModal(),l.initializeGooglePhotoPicker(function(e,t){h.showBusyDuring(a.api.importFromGooglePhoto(e,null,t).then(function(e){y.doneFileHandler("google-photo-import",e)}))})}.bind(e),p=function(){u.initializeUnsplashPhotoPicker(function(e){h.showBusyDuring(u.importFromUnsplash(e,null).then(function(e){y.doneFileHandler("unsplash-import",e),a.dialog.closeCurrentModal()}))})}.bind(e),g=function(){a.dialog.closeCurrentModal(),c.initializeOneDrivePicker(function(e){h.showBusyDuring(c.importFromOneDrive(e.id,null).then(function(e){y.doneFileHandler("onedrive-import",e)}))},[m.image.extensions])}.bind(e);return a.dialog.image.showSelectionModal(t,o,i,r,p,g,d.createImageUploadOptions(null,e,"","submitFileHandler","","doneFileHandler"),!0),e.addCarouselImageDeferred.promise}().then(function(e){var t={assetLibraryEntryId:e.assetLibraryEntryId,updateAction:"addImage",selectedImageIndex:A.contentBlock.displayedImageIndex},n=A.contentBlock.displayedImageIndex;p.showBusyDuring(r.one("units",A.page.unit.id).one(f.BLOCK_PATHS[E],A.contentBlock.id).patch(t).then(function(e){o.$broadcast("added-carousel-image",n),_.updateCarouselState(e),w.editor.trigger("editableInput",null,w.editor.elements[0])}).then(function(){var e=jQuery("body > .bulb-main").eq(0);$("body").css("overflow",""),e.css("position",""),e.css("top",""),e.css("width","")}))})}),o.$on("command-remove-carousel-slide",function(e,n){if(n.id===A.contentBlock.id){var i={};1===A.contentBlock.carouselImages.length?(i={titleCode:"image_carousel_delete_slide_form_title",bodyCode:"image_carousel_delete_only_slide_block_instructions",showOkButton:!0,showCancelButton:!1},g.show(i)):(i={titleCode:"image_carousel_delete_slide_form_title",bodyCode:"image_carousel_delete_slide_block_instructions",showOkButton:!0,showCancelButton:!0},g.show(i).then(function(){var e={updateAction:"removeImage",selectedImageIndex:A.contentBlock.displayedImageIndex},t=A.contentBlock.displayedImageIndex;p.showBusyDuring(r.one("units",A.page.unit.id).one(f.BLOCK_PATHS[E],A.contentBlock.id).patch(e).then(function(e){o.$broadcast("removed-carousel-image",t),_.updateCarouselState(e),w.editor.trigger("editableInput",null,w.editor.elements[0])}))},function(e){t.log("The user cancelled the deletion of the image from within the carousel!",e)}))}}),this.submitFileHandler=function(e,t){var n=p.showBusy();t.showBusyIndicator=n},this.doneFileHandler=function(e,n){var o=n.entry.id;a.api.getEntry(o).then(function(o){"google-import"===e||"google-photo-import"===e||"unsplash-import"===e||"onedrive-import"===e?t.debug(e+"event for image carousel"):n.showBusyIndicator(),o.entry.image.assetLibraryEntryId=o.entry.id,y.addCarouselImageDeferred.resolve(o.entry.image)},function(e){t.error("unable to upload image to carousel form desktop because of reason: ",e)})}}}}]),angular.module("bulbApp.contentEditorModule").factory("BulbInsertBlockExtensionFactory",["$compile","$cookies","$interval","$location","$modal","$modalStack","$q","$rootScope","$timeout","$translate","$window","MediumEditor","Restangular","BulbAuthService","BulbAssetLibraryGoogleDriveService","BulbAssetLibraryGooglePhotoService","BulbAssetLibraryOneDriveService","BulbAssetLibrarySnapshotPdfService","BulbAssetLibraryService","BulbAssetLibraryUnsplashService","BulbAssetLibraryUploadService","BulbBrowserService","BulbBusyCoverService","BulbBusyService","BulbCommentService","BulbErrorService","BulbModalService","CONFIG","CONTENT_EDITOR","_",function(e,t,n,o,i,r,a,s,l,c,u,d,p,h,g,m,f,b,v,C,y,w,A,_,E,S,T,I,B,k){var U=[8,13,37,38,39,40,46],O=function(){return E.getParagraphIds(1).then(function(e){return'<p id="'+e[0]+'"><br/></p>'})},M=d.Extension.extend({name:"bulbInsertBlock",selection:null,mediaFileUploadOptions:{url:"/b/rest/assets",paramName:"files[]",acceptFileTypes:/(\.|\/)(gif|jpe?g|png|3g2|3gp|asf|avi|flv|m4v|mkv|mov|mp4|mpg|vob|wmv|quicktime)$/i,maxChunkSize:5242880,maxFileSize:1e10,headers:{"X-XSRF-TOKEN":t.get("XSRF-TOKEN")}},attachmentUploadOptions:{url:"/b/rest/assets",paramName:"files[]",maxChunkSize:5242880,maxFileSize:1e10,headers:{"X-XSRF-TOKEN":t.get("XSRF-TOKEN")}},defaults:{messages:{acceptFileTypesError:"This file is not in a supported format: ",maxFileSizeError:"This file is too big: "}},init:function(){if(this.editor=this.getEditorElements()[0],u.bulbVars.BulbInsertBlockExtensionFactory=this,this.options=angular.merge({},this.defaults,this.options),this.subscribe("editableClick",this.handleClick.bind(this)),this.subscribe("editableInput",this.handleInput.bind(this)),this.subscribe("editableKeydown",this.handleKeydown.bind(this)),this.subscribe("editableKeyup",this.handleKeyup.bind(this)),this.subscribe("blur",this.handleBlur.bind(this)),this.subscribe("focus",this.updateButtons.bind(this)),this.scope.$on("command-cancel-upload",this.cancelUpload.bind(this)),this.scope.$on("command-delete",this.deleteSelectedBlock.bind(this)),this.page=this.scope.contentEditorCtrl.page,w.isTouchDevice()&&w.isMobile()){var e=this.base.exportSelection(),t=this;n(function(){var n=t.base.exportSelection();angular.equals(e,n)||(e=n,t.base.checkSelection(),t.updateButtons())},200)}},handleClick:function(e){var t=$(e.target),n=t.closest("[selectable-block]");if(n.length){var o=t.closest('[contenteditable="true"]');o.length&&jQuery.contains(n[0],o[0])?this.unselectBlock():this.selectBlock(n[0])}else this.unselectBlock()},handleEnterPress:function(){var e=$(".bulb-insert-block-buttons-media").parent().parent();$(e.find("p")[0]).addClass("bulb-media-active"),$(e.find("div")[0]).removeClass("hide"),e.attr("data-medium-focused","true")},unselectBlock:function(){$(this.editor).find(".selected-block").removeClass("selected-block"),this.blockSelected(null),this.selection=null,this.updateButtons()},handleKeydown:function(e){if(e.ctrlKey){if(36===e.keyCode){var t=$(this.editor).children().first();return t.is("content-block")?this.selectBlock(t[0]):this.placeSelectionCaretAtStart(t[0]),e.preventDefault(),void this.ensureElementIsVisible(t[0])}if(35===e.keyCode){var n=$(this.editor).children(".bulb-content-trailer").prev();return n.is("content-block")?(this.selectBlock(n[0]),$(this.editor).trigger("keypress")):this.placeSelectionCaretAtEnd(n[0]),e.preventDefault(),void this.ensureElementIsVisible(n[0])}}if(k.includes(U,e.keyCode))if(delete this.$preNavElement,this.selection)this.selectedBlockKeydown(e);else{var o=this.document.getSelection();$(o.focusNode).closest(".bulb-edit-caption").length?this.captionKeydown(e):this.textKeydown(e)}},handleKeyup:function(e){if(this.$preNavElement){var t,n,o=this.$preNavElement,i=this.document.getSelection(),r=$(i.focusNode);if(o.is(".bulb-edit-caption"))t=r.closest(".bulb-page-content > *"),0===o.closest(t).length&&(38===e.keyCode?e.shiftKey?this.base.restoreSelection():this.selectBlock(o.closest("content-block")[0]):(n=o.next()).is("content-block")?e.shiftKey?this.base.restoreSelection():this.selectBlock(n[0]):e.shiftKey&&this.base.restoreSelection()),e.preventDefault();else if(t=r.closest(".bulb-page-content > p"),!o.is(t)){if(38===e.keyCode){var a=o.prev();if(a.is("content-block"))if(e.shiftKey)this.base.restoreSelection();else 0===a.find(".bulb-edit-caption").length&&this.selectBlock(a[0])}else(n=o.next()).is("content-block")&&(this.base.restoreSelection(),e.shiftKey||this.selectBlock(n[0]));e.preventDefault()}}k.includes(U,e.keyCode)&&this.updateButtons()},placeSelectionCaretAtStart:function(e){this.unselectBlock(),d.selection.moveCursor(this.document,e,0),this.ensureElementIsVisible(e)},placeSelectionCaretAtEnd:function(e){this.unselectBlock();var t=this.document.createRange();t.selectNodeContents(e),t.collapse(!1);var n=window.getSelection();n.removeAllRanges(),n.addRange(t),this.ensureElementIsVisible(e)},ensureElementIsVisible:function(e){var t=e.getBoundingClientRect();t.top>=0&&t.left>=0&&t.bottom<=(window.innerHeight||this.document.documentElement.clientHeight)&&t.right<=(window.innerWidth||this.document.documentElement.clientWidth)||e.scrollIntoView()},textKeydown:function(e){var t=this.document.getSelection(),n=$(t.focusNode).closest(".bulb-page-content > *"),o={left:null,right:null};0!==n.length&&(o=d.selection.getCaretOffsets(n[0]));var i=n.prev(),r=n.next();switch(e.keyCode){case 37:if(0===o.left&&i.is("content-block")){var a=i.find(".bulb-edit-caption");a.length?this.placeSelectionCaretAtEnd(a[0]):this.selectBlock(i[0]),e.preventDefault()}else 0!==o.left||i[0]||(this.focusPageTitle(),e.preventDefault());break;case 39:0===o.right&&r.is("content-block")&&(this.selectBlock(r[0]),e.preventDefault());break;case 38:i[0]?(this.base.saveSelection(),this.$preNavElement=n):(this.focusPageTitle(o.left),e.preventDefault());break;case 40:this.base.saveSelection(),this.$preNavElement=n;break;case 8:0!==o.left||!i.is("content-block")&&i[0]||e.preventDefault();break;case 46:0===o.right&&0!==o.left&&t.isCollapsed&&r.is("content-block")&&e.preventDefault()}this.updateButtons()},selectedBlockKeydown:function(e){if(e.preventDefault(),!e.shiftKey){var t,n=this.contentEditorCtrl.selectedBlockElement,o=n.prev(),i=n.next();switch(e.keyCode){case 37:case 38:o.is("content-block")?(t=o.find(".bulb-edit-caption")).length?this.placeSelectionCaretAtEnd(t[0]):this.selectBlock(o[0]):o?this.placeSelectionCaretAtEnd(o[0]):(this.focusPageTitle(),e.preventDefault());break;case 39:case 40:0!==(t=n.find(".bulb-edit-caption")).length?this.placeSelectionCaretAtStart(t[0]):i.is("content-block")?this.selectBlock(i[0]):i.is("p")?this.placeSelectionCaretAtStart(i[0]):e.preventDefault();break;case 13:var r;e.ctrlKey?(n.before("<p><br/></p>"),r=n.prev()):(n.after("<p><br/></p>"),r=n.next()),this.unselectBlock(),d.selection.select(this.document,r[0],0);break;case 8:case 46:this.deleteSelectedBlock()}this.updateButtons()}},captionKeydown:function(e){var t=this.document.getSelection(),n=$(t.focusNode),o=n.closest(".bulb-edit-caption"),i=n.closest("content-block"),r=d.selection.getCaretOffsets(o[0]);switch(e.keyCode){case 37:0===r.left&&(e.preventDefault(),this.selectBlock(i[0]));break;case 39:if(0===r.right){var a=i.next();a.is("content-block")&&(this.selectBlock(a[0]),e.preventDefault())}break;case 38:case 40:this.base.saveSelection(),this.$preNavElement=o;break;case 13:this.base.saveSelection(),this.$preNavElement=o;var s=$(t.focusNode).closest("content-block"),c=this;this.appendNewLine(s).then(function(e){var t=e.next();l(function(){c.placeSelectionCaretAtStart(t[0])})}),e.preventDefault();break;case 8:0===r.left&&e.preventDefault();break;case 46:0===r.right&&e.preventDefault()}this.updateButtons()},selectBlock:function(e){var t=$(e),n=t.closest("[selectable-block]");if(0===n.length&&(n=t.find("[selectable-block]")),0!==n.length){$(this.editor).find(".selected-block").removeClass("selected-block"),n.addClass("selected-block"),this.selection=n[0];var o=n.children("[ng-transclude]")[0];d.selection.selectNode(o,this.document);var i=d.selection.getSelectionElement(this.window);i!==this.base.getFocusedElement()&&this.base.events.focusElement(i),this.ensureElementIsVisible(n[0]),this.blockSelected(n.closest("content-block")[0]),this.updateButtons()}},handleBlur:function(e,t){jQuery(t).find(".bulb-media-active").removeClass("bulb-media-active"),this.hideButtons(t),$(this.editor).find(".selected-block").removeClass("selected-block"),this.blockSelected(null),this.selection=null},handleInput:function(e,t){this.updateButtons();var n=this.document.getSelection(),o=$(n.focusNode).closest(".bulb-page-content > *");if(o){var i=o.length>0?o[0].childNodes[0]:null;i&&"A"===i.tagName&&!i.hasAttribute("target")&&i.setAttribute("target","_blank");var r=o.attr("id");1!==$("[id="+r+"]").length&&E.getParagraphIds(1).then(function(e){o.attr("id",e[0])})}},updateButtons:function(){this.buttons||this.editor.appendChild(this.getButtonsElement()),$(this.editor).find(".bulb-media-active").removeClass("bulb-media-active");var e=this.window.getSelection();if(e&&0!==e.rangeCount){var t=e.getRangeAt(0).commonAncestorContainer;if(null!==(t=this.getElementAncestor(t))){var n=$(t);n.is("p")&&t.parentElement===this.editor&&""===n.text().trim()?(this.showButtons(t),n.addClass("bulb-media-active")):this.hideButtons()}else this.hideButtons()}else this.hideButtons()},showButtons:function(e){this.positionButtons(e),this.buttons.classList.remove("hide"),$(this.buttons).find(".bulb-insert-block-buttons-options").addClass("hide")},hideButtons:function(){this.buttons.classList.add("hide"),$(this.buttons).find(".bulb-insert-block-buttons-show").removeClass("bulb-insert-block-button-rotate"),$(this.editor).find(".bulb-media-active").removeClass("bulb-media-active")},getButtonsElement:function(){return this.buttons||(this.buttons=this.createButtons()),this.buttons},createButtons:function(){var e=this.document.createElement("div");e.id="bulb-insert-block-buttons-"+this.getEditorId(),e.setAttribute("class","bulb-insert-block-buttons bulb-media-transient hide"),e.setAttribute("contentEditable",!1);var t=this.document.createElement("button");t.setAttribute("class","bulb-insert-block-buttons-media aero-button bulb-aero-blue-button"),t.setAttribute("tabindex","0"),t.innerHTML='<span class="button-icon fas fa-video"></span>'+c.instant("content_block_type_VIDEO"),e.appendChild(t),this.on(t,"click",this.handleVideoButtonClick.bind(this));var n=this.document.createElement("button");if(n.setAttribute("class","bulb-insert-block-buttons-media aero-button bulb-aero-blue-button"),n.setAttribute("tabindex","0"),n.innerHTML='<span class="button-icon far fa-image"></span>'+c.instant("content_block_type_IMAGE"),e.appendChild(n),this.on(n,"click",this.handleMediaButtonClick.bind(this)),h.currentUser.features.AddFileFeature.enabled){var o=this.document.createElement("button");o.setAttribute("class","bulb-insert-block-buttons-media aero-button bulb-aero-blue-button"),o.setAttribute("tabindex","0"),o.innerHTML='<span class="button-icon fa fa-paperclip"></span>'+c.instant("content_block_type_FILE"),e.appendChild(o),this.on(o,"click",this.handleAttachmentButtonClick.bind(this))}if(h.currentUser.features.AudioFeature.enabled){var i=this.document.createElement("button");i.setAttribute("class","bulb-insert-block-buttons-media aero-button bulb-aero-blue-button"),i.setAttribute("tabindex","0"),i.innerHTML='<span class="button-icon fas fa-music"></span>'+c.instant("content_block_type_AUDIO"),e.appendChild(i),this.on(i,"click",this.handleAudioButtonClick.bind(this))}if(h.currentUser.features.AddEmbedFeature.enabled){var r=this.document.createElement("button");r.setAttribute("class","bulb-insert-block-buttons-media aero-button bulb-aero-blue-button"),r.setAttribute("tabindex","0"),r.innerHTML='<span class="button-icon fa fa-sign-in"></span>'+c.instant("content_block_type_URL"),e.appendChild(r),this.on(r,"click",this.handleEmbedButtonClick.bind(this))}return e},positionButtons:function(){var e,t=this.window.getSelection();e=t&&0!==t.rangeCount?t.getRangeAt(0).commonAncestorContainer:this.base.getFocusedElement(),e=this.getElementAncestor(e),this.buttons.style.top=e.offsetTop+"px"},getElementAncestor:function(e){return e===this.editor?$(e).children().eq(0)[0]:e&&e.parentElement!==this.editor?this.getElementAncestor(e.parentNode):e},handleShowButtonClick:function(e){var t=$(this.buttons).find(".bulb-insert-block-buttons-options");t.hasClass("hide")?(t.removeClass("hide"),$(this.buttons).find(".bulb-insert-block-buttons-show").addClass("bulb-insert-block-button-rotate")):(t.addClass("hide"),$(this.buttons).find(".bulb-insert-block-buttons-show").removeClass("bulb-insert-block-button-rotate")),e.stopPropagation()},initContentBlock:function(e,t){this.hideButtons(),e.attr("id",t),e.addClass("bulb-media-temp-placeholder"),this.isLastContent(e)&&this.appendNewLine(e)},$lastPlace:null,addFileHandler:function(e,t){this.base.getExtensionByName("placeholder").hidePlaceholder(this.editor),t.tempId=this.generateTemporaryId(),v.dialog.dismissAllModals(),this.initContentBlock(this.$lastPlace,t.tempId)},submitFileHandler:function(e,t){switch(t.entry.type){case"IMAGE":this.showImagePreview(t.target.result,t);break;default:this.showUploadingFileProgressbar(t)}},progressFileHandler:function(e,t,n){var o=t.entry.tempId;switch(t.entry.type){case"IMAGE":var i=$(this.editor).find("#"+o+" .bulb-media-image-progress");i.css("width",100-n+"%"),100===n&&i.remove();break;default:this.page.unit.contentBlocks[o].progress=n,this.scope.$apply()}},doneFileHandler:function(e,t){var n=this,o=t.entry.id,i=t.entry.tempId;v.api.getEntry(o).then(function(e){var o=e.entry;switch(o.type){case"ATTACHED_FILE":n.createAttachedFileBlock(o,i);break;case"AUDIO":n.createAudioBlock(o,i,t.isRecordedAudio);break;case"IMAGE":n.createImageBlock(o,i);break;case"VIDEO":n.createVideoBlock(o,i)}})},handleMediaButtonClick:function(e){e.stopPropagation();var t=this,n=$(t.editor).find(".bulb-media-active");0===n.length&&(this.handleEnterPress(),n=$(this.editor).find(".bulb-media-active")),this.$lastPlace=n,v.dialog.image.showSelectionModal(function(e){var o=a.defer(),i=t.generateTemporaryId();return t.initContentBlock(n,i),t.createImageBlock(e,i),o.resolve(),o.promise},function(e){y.uploadImageBySelectionModal(t,"addFileHandler","submitFileHandler","progressFileHandler","doneFileHandler",!1,"page")},function(){v.dialog.closeCurrentModal(),g.openImageTypePicker(function(e,o,i,r){A.showBusyDuring(v.api.importFromGoogleDrive(e,null,o,i,r).then(function(e){var o=t.generateTemporaryId();e.entry.tempId=o,t.initContentBlock(n,o),t.doneFileHandler(null,e)}))})},function(){v.dialog.closeCurrentModal(),m.initializeGooglePhotoPicker(function(e,o){A.showBusyDuring(v.api.importFromGooglePhoto(e,null,o).then(function(e){var o=t.generateTemporaryId();e.entry.tempId=o,t.initContentBlock(n,o),t.doneFileHandler(null,e)}))})},function(){C.initializeUnsplashPhotoPicker(function(e){A.showBusyDuring(C.importFromUnsplash(e,null).then(function(e){var o=t.generateTemporaryId();e.entry.tempId=o,t.initContentBlock(n,o),t.doneFileHandler(null,e),v.dialog.closeCurrentModal()}))})},function(){v.dialog.closeCurrentModal(),f.initializeOneDrivePicker(function(e){A.showBusyDuring(f.importFromOneDrive(e.id,t.currentFolderId).then(function(e){var o=t.generateTemporaryId();e.entry.tempId=o,t.initContentBlock(n,o),t.doneFileHandler(null,e)}))},[I.image.extensions])},y.createImageUploadOptions(null,t,"addFileHandler","submitFileHandler","progressFileHandler","doneFileHandler"),!1,!1,e.currentTarget)},handleVideoButtonClick:function(e){e.stopPropagation();var t=this,n=$(t.editor).find(".bulb-media-active");0===n.length&&(this.handleEnterPress(),n=$(this.editor).find(".bulb-media-active")),this.$lastPlace=n,v.dialog.video.showSelectionModal(function(e){var o=a.defer(),i=t.generateTemporaryId();return t.initContentBlock(n,i),t.createVideoBlock(e,i),o.resolve(),o.promise},function(e){y.uploadVideoBySelectionModal(t,"addFileHandler","submitFileHandler","progressFileHandler","doneFileHandler",!1,"page")},function(){v.dialog.closeCurrentModal(),g.openVideoTypePicker(function(e,o,i){A.showBusyDuring(v.api.importFromGoogleDrive(e,null,o,i).then(function(e){var o=t.generateTemporaryId();e.entry.tempId=o,t.initContentBlock(n,o),t.doneFileHandler(null,e)}))})},function(){v.dialog.closeCurrentModal(),m.initializeGooglePhotoPicker(function(e,o){A.showBusyDuring(v.api.importFromGooglePhoto(e,null,o).then(function(e){var o=t.generateTemporaryId();e.entry.tempId=o,t.initContentBlock(n,o),t.doneFileHandler(null,e)}))},!1,!0)},function(e){return v.api.createExternalServiceVideo(null,e).then(function(e){v.dialog.dismissAllModals();var o=t.generateTemporaryId();t.initContentBlock(n,o),t.createVideoBlock(e.entry,o)})},function(){v.dialog.closeCurrentModal(),f.initializeOneDrivePicker(function(e){e.file&&e.file.mimeType.indexOf("video")>-1?A.showBusyDuring(f.importFromOneDrive(e.id,t.currentFolderId).then(function(e){var o=t.generateTemporaryId();e.entry.tempId=o,t.initContentBlock(n,o),t.doneFileHandler(null,e)})):v.dialog.showUnsupportedFileFormatError("error_unsupported_file_format")},void 0)},y.createVideoUploadOptions(null,t,"addFileHandler","submitFileHandler","progressFileHandler","doneFileHandler"),e.currentTarget)},handleAudioButtonClick:function(e){e.stopPropagation();var t=this,n=$(t.editor).find(".bulb-media-active");0===n.length&&(this.handleEnterPress(),n=$(this.editor).find(".bulb-media-active")),this.$lastPlace=n,v.dialog.audio.showSelectionModal(function(e){var o=a.defer(),i=t.generateTemporaryId();return t.initContentBlock(n,i),t.createAudioBlock(e,i,!1),o.resolve(),o.promise},function(){y.uploadAudioBySelectionModal(t,"addFileHandler","submitFileHandler","progressFileHandler","doneFileHandler",!1,"page")},function(){v.dialog.closeCurrentModal(),g.openAudioTypePicker(function(e,o,i,r){A.showBusyDuring(v.api.importFromGoogleDrive(e,null,o,i,r).then(function(e){var o=t.generateTemporaryId();e.entry.tempId=o,t.initContentBlock(n,o),t.doneFileHandler(null,e)}))})},function(){v.dialog.closeCurrentModal(),f.initializeOneDrivePicker(function(e){A.showBusyDuring(f.importFromOneDrive(e.id,t.currentFolderId).then(function(e){var o=t.generateTemporaryId();e.entry.tempId=o,t.initContentBlock(n,o),t.doneFileHandler(null,e)}))},[I.audio.extensions])},y.createAudioUploadOptions(null,t,"addFileHandler","submitFileHandler","progressFileHandler","doneFileHandler"),!1,e.currentTarget)},handleAttachmentButtonClick:function(e){e.stopPropagation();var t=this,n=$(t.editor).find(".bulb-media-active");0===n.length&&(this.handleEnterPress(),n=$(this.editor).find(".bulb-media-active")),this.$lastPlace=n,v.dialog.attachedFile.showSelectionModal(function(e){var o=a.defer(),i=t.generateTemporaryId();return t.initContentBlock(n,i),t.createAttachedFileBlock(e,i),o.resolve(),o.promise},function(e){y.uploadAttachedFileBySelectionModal(t,"addFileHandler","submitFileHandler","progressFileHandler","doneFileHandler",!1,"page")},function(){v.dialog.closeCurrentModal(),g.openAttachedFileTypePicker(function(e,o,i,r,a,s){if("application/vnd.google-apps.document"===i||"application/vnd.google-apps.spreadsheet"===i||"application/vnd.google-apps.drawing"===i||"application/vnd.google-apps.presentation"===i||"application/vnd.google-apps.form"===i||"application/pdf"===i){var l=t.generateTemporaryId();n.attr("id",l),n.addClass("bulb-media-temp-placeholder"),g.enableShareableLink(o).then(function(e){e&&(a=e.url),t.createEmbedBlock.call(t,null,a,l,null,null,o,s)},function(e){e&&(403===e.code?b.importPdfForOrgRestrictedDoc(o,t.page.unit.id,s).then(function(e){t.createAttachedFileBlock.call(t,e,l)}):S.showError(c.instant("embed_error_message_basic")+'<a href="'+a+'" target="_blank">'+a+"</a>",e))})}else 0===i.indexOf("application/vnd.google-apps")&&"application/vnd.google-apps.photo"!==i?c("error_google_drive_not_support_google_document").then(function(e){v.dialog.showMessage(null,e)}):A.showBusyDuring(v.api.importFromGoogleDrive(e,null,o,i,null,!0).then(function(e){var o=t.generateTemporaryId();e.entry.tempId=o,t.initContentBlock(n,o),t.doneFileHandler(null,e)}))})},function(){v.dialog.closeCurrentModal(),f.initializeOneDrivePicker(function(e){var o=e.file?e.file.mimeType:void 0,i=t.generateTemporaryId();if(o&&"text/plain"!==o)if(o.startsWith("application/vnd.openxmlformats"))if("business"===e.parentReference.driveType)A.showBusyDuring(f.importFromOneDrive(e.id,t.currentFolderId).then(function(e){e.entry.tempId=i,t.initContentBlock(n,i),t.doneFileHandler(null,e)}));else{var r=f.getItemContentByShareId(e.permissions[0].shareId);n.attr("id",i),n.addClass("bulb-media-temp-placeholder"),t.createEmbedBlock.call(t,null,r,i,null,null,null,null)}else A.showBusyDuring(f.importFromOneDrive(e.id,t.currentFolderId).then(function(e){e.entry.tempId=i,t.initContentBlock(n,i),t.doneFileHandler(null,e)}));else v.dialog.showUnsupportedFileFormatError("error_unsupported_file_format")},void 0,void 0,!0)},y.createAttachedFileUploadOptions(null,t,"addFileHandler","submitFileHandler","progressFileHandler","doneFileHandler"),e.currentTarget)},handleEmbedButtonClick:function(e){e.stopPropagation();var t,n=this,o=$(this.editor).find(".bulb-media-active");0===o.length&&(this.handleEnterPress(),o=$(this.editor).find(".bulb-media-active"));var i={templateUrl:I.resource.cdnRoot+"ajs/components/contenteditor/embedblockform.html",controller:["$scope",function(e){e.handlePaste=function(t,n){if(w.isMsEdge()||w.isFireFox()){t.preventDefault();var o=jQuery("#url"),i=(t.originalEvent||t).clipboardData.getData("text/plain");o.val(i),n.$setDirty(),n.$invalid=!1,n.$valid=!0,e.embedBlockFormCtrl.url=i}},this.submitUrl=function(i){var r=e.embedBlockFormCtrl.url;if(r.indexOf("vimeo.com")>-1||r.indexOf("youtube.com")>-1||r.indexOf("youtu.be")>-1)v.api.createExternalServiceVideo(null,r).then(function(e){var t=n.generateTemporaryId();n.initContentBlock(o,t),n.createVideoBlock(e.entry,t)});else{var a,s=n.generateTemporaryId();if(o.attr("id",s),o.addClass("bulb-media-temp-placeholder"),-1!==r.indexOf("docs.google.com")){var l=r.split("d/");-1!==(a=l[1].split("/")[0]).indexOf("e/")&&(a=a.split("/")[1])}r.indexOf("1drv.ms")>-1?f.getSharedEmbedUrl(r).then(function(o){e.embedBlockFormCtrl.url=o,n.createEmbedBlock.call(n,i,e.embedBlockFormCtrl.url,s,t,null,a,null)},function(e){f.showEmbedError({fontAwesomeCode:"fas fa-clouds",titleCode:"embed_onedrive_url_error_title",bodyCode:e,showCancelButton:!1,windowClass:"updated-modal-design bulb-aero-modal"})}):r.indexOf("onedrive.live.com")>-1?f.createSharableLinkForDocument(r).then(function(o){e.embedBlockFormCtrl.url=o,n.createEmbedBlock.call(n,i,e.embedBlockFormCtrl.url,s,t,null,a,null)},function(e){f.showEmbedError({fontAwesomeCode:"fas fa-clouds",titleCode:"embed_onedrive_url_error_title",bodyCode:e.data?e.data.message:e,showCancelButton:!1,windowClass:"updated-modal-design bulb-aero-modal"})}):r.indexOf("sharepoint.com")>-1?f.showEmbedError({fontAwesomeCode:"fas fa-exclamation-triangle",titleCode:"embed_onedrive_account_not_supported_title",cancelButtonCode:"onboarding_got_it_button",bodyCode:"embed_onedrive_account_not_supported",showCancelButton:!0,showOkButton:!1,windowClass:"updated-modal-design bulb-aero-modal bulb-onedrive-embed-modal"}):n.createEmbedBlock.call(n,i,e.embedBlockFormCtrl.url,s,t,null,a,null)}v.dialog.closeCurrentModal()},this.closeModal=function(e){T.clearDialog(e)}}],controllerAs:"embedBlockFormCtrl",scope:this.scope,backdrop:!0,windowClass:"bulb-media-transient",focusAfterClosed:e.currentTarget};t=T.showCustomModal(i)},showImagePreview:function(t,n){var o=n.entry.tempId,i=$(this.editor).find("#"+o),r={id:o,img:t,blockType:"UPLOADING_IMAGE",data:n};this.page.unit.contentBlocks[o]=r,i.replaceWith(e('<content-block id="'+o+'" contenteditable="false" class="bulb-media-transient align-center"></content-block>')(this.scope))},showUploadingFileProgressbar:function(t){var n=t.entry.tempId,o=$(this.editor).find("#"+n),i={id:n,blockType:"UPLOADING_FILE",data:t,progress:0};this.page.unit.contentBlocks[n]=i,o.replaceWith(e('<content-block id="'+n+'" contenteditable="false" class="bulb-media-transient align-center"></content-block>')(this.scope)),this.selectBlock($(this.editor).find("#"+n)[0])},updateId:function(e){$(this.editor).find("#"+e.tempId).attr("id",e.result.id),this.trigger("editableInput",null,this.editor)},cancelUpload:function(e,t){var n=this;t.data.jqXHR.abort(),delete this.page.unit.contentBlocks[t.id];var o=$(this.editor).find("#"+t.id);O().then(function(e){o.replaceWith(e);var t=n.base.getExtensionByName("toolbar");l(function(){t.hideToolbar()},B.GRAB_TOOLBAR_TIMEOUT)})},generateTemporaryId:function(){return Date.now().toString(36)+"_"+Foundation.utils.random_str(6)},createImageBlock:function(t,n){var o=this,i={assetLibraryEntryId:t.id},r=a.defer();A.showBusyDuring(r.promise),p.one("units",this.page.unit.id).customPOST(i,"imageblock").then(function(t){o.page.unit.contentBlocks[t.contentBlock.id]=t.contentBlock;var i=jQuery("#"+n),a=i.find(".selected-block").length>0;i.replaceWith(e('<content-block id="'+t.contentBlock.id+'" contenteditable="false" class="align-center"></content-block>')(o.scope)),a&&l(function(){o.selectBlock(jQuery("#"+t.contentBlock.id)[0])}),o.trigger("editableInput",null,o.editor),r.resolve()},r.reject)},createVideoBlock:function(t,n){var o=this,i={assetLibraryEntryId:t.id},r=a.defer();A.showBusyDuring(r.promise),p.one("units",o.page.unit.id).customPOST(i,"videoblock").then(function(t){o.page.unit.contentBlocks[t.contentBlock.id]=t.contentBlock;var i=jQuery("#"+n),a=i.find(".selected-block").length>0;i.replaceWith(e('<content-block id="'+t.contentBlock.id+'" contenteditable="false" class="align-center"></content-block>')(o.scope)),a&&l(function(){o.selectBlock(jQuery("#"+t.contentBlock.id)[0])}),o.trigger("editableInput",null,o.editor),r.resolve()},r.reject)},createAudioBlock:function(t,n,o){var i=this,r={assetLibraryEntryId:t.id},s=a.defer();A.showBusyDuring(s.promise),p.one("units",i.page.unit.id).customPOST(r,"audioblock").then(function(t){if(i.page.unit.contentBlocks[t.contentBlock.id]=t.contentBlock,o){var r=new CustomEvent("audioRecordingDone",{detail:{contentBlockId:t.contentBlock.id}});u.dispatchEvent(r)}var a=jQuery("#"+n),c=a.find(".selected-block").length>0;a.replaceWith(e('<content-block id="'+t.contentBlock.id+'" contenteditable="false" class="align-center"></content-block>')(i.scope)),c&&l(function(){i.selectBlock(jQuery("#"+t.contentBlock.id)[0])}),i.trigger("editableInput",null,i.editor),s.resolve()},s.reject)},createAttachedFileBlock:function(t,n){var o=this,i={assetLibraryEntryId:t.id},r=a.defer();A.showBusyDuring(r.promise),p.one("units",o.page.unit.id).customPOST(i,"attachedfileblock").then(function(t){if(t.hasOwnProperty("embedFailure"))c(t.embedFailure.toLowerCase()).then(function(e){c("attached_file_embed_failure_body",{fileType:e}).then(function(e){T.show({titleCode:"attached_file_embed_failure_title",bodyCode:e,showCancelButton:!1})})});else if(t.hasOwnProperty("embedSizeExceeded")){var i,a=t.embedSizeExceeded.toLowerCase();i="xls"===a||"xlsx"===a?5:10,c(a).then(function(e){c("attached_file_embed_too_large_body",{fileType:e,maxSize:i}).then(function(e){T.show({titleCode:"attached_file_embed_failure_title",bodyCode:e,showCancelButton:!1})})})}o.page.unit.contentBlocks[t.contentBlock.id]=t.contentBlock;var s=jQuery("#"+n),u=s.find(".selected-block").length>0;s.replaceWith(e('<content-block id="'+t.contentBlock.id+'" contenteditable="false"></content-block>')(o.scope)),u&&l(function(){o.selectBlock(jQuery("#"+t.contentBlock.id)[0])}),o.trigger("editableInput",null,o.editor),r.resolve()},r.reject)},deleteSelectedBlock:function(){var e=this,t=$(this.selection).closest("content-block"),n=this.page.unit.contentBlocks[t.attr("id")];c("content_block_type_"+n.blockType).then(function(o){c("modal_delete_confirm_body",{type:o}).then(function(o){T.show({titleCode:"modal_delete_confirm_title",bodyText:o,okButtonCode:"button_delete",parent:".bulb-page-content",windowClass:"bulb-media-transient"}).then(function(){_.showBusyDuring(p.one("units",e.page.unit.id).one("blocks",n.id).remove().then(function(){delete e.page.unit.contentBlocks[n.id],t=$("#"+n.id),t=$("<p><br/></p>").replaceAll(t),e.placeSelectionCaretAtStart(t[0]),e.unselectBlock(),e.trigger("editableInput",null,e.editor);var o=e.base.getExtensionByName("toolbar");l(function(){o.hideToolbar()},B.GRAB_TOOLBAR_TIMEOUT)}))})})})},createEmbedBlock:function(t,n,o,i,r,a,s){var l=this,u={url:n,attachedFileAssetId:r||null},d=jQuery("#"+o);_.showBusyDuring(p.one("units",l.page.unit.id).customPOST(u,"embedblock").then(function(t){a&&-1===n.indexOf("forms/")&&b.importPdfFromGoogleDrive(a,s,t.contentBlock.id,l.page.unit.id),l.page.unit.contentBlocks[t.contentBlock.id]=t.contentBlock,d.replaceWith(e('<content-block id="'+t.contentBlock.id+'" contenteditable="false"></content-block>')(l.scope)),l.trigger("editableInput",null,l.editor),i&&i.close()},function(e){if(i&&i.close(),e.data.errorMap&&t)t.handleRemoteErrors(e);else if(a)g.getShareableLinkForUrl(a).then(function(e){l.createEmbedBlock.call(l,t,e.url,o,i,null,a,e.code)},function(e){403===e.code&&b.importPdfForOrgRestrictedDoc(a,l.page.unit.id,s).then(function(e){l.createAttachedFileBlock.call(l,e,o)})});else{d.remove();var n=c.instant("embed_error_message_basic"),r=c.instant("embed_error_message_steps"),u=c.instant("embed_google_docs_instructions");S.showError(n+'<a href="'+e.config.data.url+'" target="_blank">'+e.config.data.url+"</a>"+r+u,e)}}));var h=$("#"+o);l.isLastContent(h)&&l.appendNewLine(h)},appendNewLine:function(e){return O().then(function(t){return e.after(t)})},isLastContent:function(e){return e.next().hasClass("bulb-content-trailer")},focusPageTitle:function(e){var t=jQuery(".bulb-page-title");$(window.getSelection().getRangeAt(0).startContainer).blur(),t.focus(),void 0===e&&(e=t.val().length);var n=t[0];if(n.createTextRange){var o=n.createTextRange();o.move("character",e),o.select()}else n.setSelectionRange&&n.setSelectionRange(e,e);return t}});return{createExtension:function(e){return new M(e)}}}]),angular.module("bulbApp.contentEditorModule").factory("MediumEditor",["$window",function(e){return e.MediumEditor}]),angular.module("bulbApp.contentEditorModule").factory("BulbPasteExtensionFactory",["$timeout","$translate","MediumEditor","Restangular","BulbAuthService","BulbBrowserService","BulbContentEditorService","BulbErrorService","BulbModalService","CONFIG","CONTENT_EDITOR",function(e,t,n,o,i,r,a,s,l,c,u){var d=t.instant(["pageview_paste_missing_table_text","pageview_paste_missing_image_text","pageview_paste_missing_video_text","pageview_paste_missing_file_text","pageview_paste_missing_embed_text","pageview_paste_missing_carousel_text"]);var p=n.extensions.paste.extend({cleanedImagesOnPaste:!1,cleanPaste:function(e){var t,n,o,i,r=/<p|<br|<div/.test(e),a=[].concat(this.preCleanReplacements||[],[[new RegExp(/^[\s\S]*<body[^>]*>\s*|\s*<\/body[^>]*>[\s\S]*$/g),""],[new RegExp(/<!--StartFragment-->|<!--EndFragment-->/g),""],[new RegExp(/<br>$/i),""],[new RegExp(/<[^>]*docs-internal-guid[^>]*>/gi),""],[new RegExp(/<\/b>(<br[^>]*>)?$/gi),""],[new RegExp(/<span class="Apple-converted-space">\s+<\/span>/g)," "],[new RegExp(/<br class="Apple-interchange-newline">/g),"<br>"],[new RegExp(/<span style="font-weight: bold;">/g),'<span class="replace-with bold">'],[new RegExp(/<span style="font-style: italic;">/g),'<span class="replace-with italic">'],[new RegExp(/<span style="text-decoration: underline;">/g),'<span class="replace-with underline">'],[new RegExp(/<span[^>]*(font-style:italic;font-weight:(bold|700)|font-weight:(bold|700);font-style:italic)[^>]*>/gi),'<span class="replace-with italic bold">'],[new RegExp(/<span[^>]*font-style:italic[^>]*>/gi),'<span class="replace-with italic">'],[new RegExp(/<span[^>]*font-weight:(bold|700)[^>]*>/gi),'<span class="replace-with bold">'],[new RegExp(/<span[^>]*text-decoration:underline[^>]*>/gi),'<span class="replace-with underline">'],[new RegExp(/&lt;(\/?)(i|b|a)&gt;/gi),"<$1$2>"],[new RegExp(/&lt;a(?:(?!href).)+href=(?:&quot;|&rdquo;|&ldquo;|"||)(((?!&quot;|&rdquo;|&ldquo;|"||).)*)(?:&quot;|&rdquo;|&ldquo;|"||)(?:(?!&gt;).)*&gt;/gi),'<a href="$1">'],[new RegExp(/<\/p>\n+/gi),"</p>"],[new RegExp(/\n+<p/gi),"<p"],[new RegExp(/<\/?o:[a-z]*>/gi),""],[new RegExp(/<!\[if !supportLists\]>(((?!<!).)*)<!\[endif]\>/gi),"$1"]],this.cleanReplacements||[]);for(t=0;t<a.length;t+=1)e=e.replace(a[t][0],a[t][1]);if(this.cleanedImagesOnPaste=!1,this.contentBlocksOnPaste=[],!r)return this.pasteHTML(e);for(var s=$(jQuery.parseHTML("<div>"+e+"</div>")),l=s.find("img"),c=0;c<l.length;c++){var u=$(l[c]);"a"===u.parent().prop("tagName").toLowerCase()&&u.unwrap(),$(u).replaceWith("<b>["+d.pageview_paste_missing_image_text+"]</b>"),this.cleanedImagesOnPaste=!0}for(var p=s.find("content-block"),h=0;h<p.length;h++){var g=$(p[h]).children().children().first().prop("tagName");$(p[h]).attr("bulb-tag-name",g)}for(e=s.html(),(o=this.document.createElement("div")).innerHTML="<p>"+e.split("<br><br>").join("</p><p>")+"</p>",n=o.querySelectorAll("a, p, div, br"),t=0;t<n.length;t+=1)switch((i=n[t]).innerHTML=i.innerHTML.replace(/\n/gi," "),i.nodeName.toLowerCase()){case"p":case"div":this.filterCommonBlocks(i);break;case"br":this.filterLineBreak(i)}this.pasteHTML(o.innerHTML)},pasteHTML:function(t,r){r=n.util.defaults({},r,{cleanAttrs:this.cleanAttrs,cleanTags:this.cleanTags});var u,d,p,h,g=this.document.createDocumentFragment();for(g.appendChild(this.document.createElement("body")),(h=g.querySelector("body")).innerHTML=t,this.cleanupSpans(h),u=h.querySelectorAll("*"),p=0;p<u.length;p+=1)d=u[p],this.handleTagInPaste(d),a.isAllowedTag(d)||(""!==$(d).text()?$(d).replaceWith("<p>"+$(d).html()+"</p>"):$(d).remove());n.util.insertHTMLCommand(this.document,h.innerHTML.replace(/&nbsp;/g," ")),this.cleanedImagesOnPaste&&!i.currentUser.prefs.hideSmartPasteModal&&e(function(){var e={titleCode:"pageview_paste_modal_title",templateUrl:c.resource.cdnRoot+"ajs/components/contenteditor/paste-modal.html",windowClass:"smart-paste-modal-styles",showOkButton:!0,showCancelButton:!1};l.show(e).then().finally(function(){$("#disablePasteNotice").is(":checked")&&o.one("accounts",i.currentUser.id).patch({prefs:{hideSmartPasteModal:!0}}).then(function(e){i.setCurrentUser(e)}).catch(function(e){s.error("Cannot update the user preferences",e)})})})},cleanupSpans:function(e){var t,o,i,r=e.querySelectorAll(".replace-with"),s=function(e){return e&&"#text"!==e.nodeName&&"false"===e.getAttribute("contenteditable")};for(t=0;t<r.length;t+=1)o=r[t],i=this.document.createElement(o.classList.contains("bold")?"b":o.classList.contains("italic")?"i":"u"),o.classList.contains("bold")&&o.classList.contains("italic")&&o.classList.contains("underline")?i.innerHTML="<i><u>"+o.innerHTML+"</u></i>":o.classList.contains("bold")&&o.classList.contains("italic")?i.innerHTML="<i>"+o.innerHTML+"</i>":i.innerHTML=o.innerHTML,o.parentNode.replaceChild(i,o);for(r=e.querySelectorAll("span"),t=0;t<r.length;t+=1){if(o=r[t],n.util.traverseUp(o,s))return!1;var l=!1,c={"font-family":null,color:null},u=a.hasBulbFont(o);!0===u.accepted&&(c["font-family"]=u.formattedFont,l=!0);var d=a.hasBulbColor(o);!0===d.accepted&&(c.color=d.colorInHEX,l=!0),$(o).removeAttr("style").css(c),l||n.util.unwrap(o,this.document)}},handleTagInPaste:function(e){switch(e.nodeName.toLowerCase()){case"content-block":case"table":this.handleReplacementInPaste(e);break;case"pre":case"div":$(e).replaceWith("<p>"+$(e).html()+"</p>");break;case"a":n.util.setTargetBlank(e);break;case"li":$(e).find("p").contents().unwrap();break;case"h1":case"h4":case"h5":case"h6":this.handleHeadingElementsOnPaste(e)}"span"!==e.nodeName.toLowerCase()&&this.removeAllStyles(e)},handleReplacementInPaste:function(e){var t="";switch(($(e).attr("bulb-tag-name")||e.nodeName).toLowerCase()){case"table":t=d.pageview_paste_missing_table_text;break;case"image-block":t=d.pageview_paste_missing_image_text;break;case"video-block":t=d.pageview_paste_missing_video_text;break;case"attached-file-block":t=d.pageview_paste_missing_file_text;break;case"embed-block":t=d.pageview_paste_missing_embed_text;break;case"image-carousel":t=d.pageview_paste_missing_carousel_text}$(e).replaceWith("<p><b>["+t.toUpperCase()+"]</b></p>")},handleHeadingElementsOnPaste:function(e){var t=$(e);switch(t.prop("tagName")){case"H1":t.replaceWith("<h2>"+t.text()+"</h2>");break;case"H4":t.replaceWith("<h3>"+t.text()+"</h3>");break;case"H5":case"H6":t.replaceWith("<p>"+t.html()+"</p>")}},removeAllStyles:function(e){$(e).removeAttr("style id dir align size width height target")}});return{createExtension:function(e){return new p(e)}}}]),angular.module("bulbApp.contentEditorModule").directive("bulbResizable",["Restangular","BulbAutoSaveService","BulbBrowserService","BulbBusyService","AUTO_SAVE","CONFIG","CONTENT_EDITOR",function(e,t,n,o,i,r,a){return{require:["?^contentEditor","^contentBlock","^bulbFrame"],link:function(o,s,l,c){var u=n.isMobile(),d=c[0];if(d){var p=c[1];if(!(p.contentBlock.html&&p.contentBlock.html.indexOf(r.hosted4hGradingWidgetUrl)>-1||"AUDIO"===p.contentBlock.blockType&&u)){var h=c[2],g=r.page.content.max.width,m=o.$eval(l.bulbResizable),f={maxWidth:g},b=angular.extend({},f,m),v=0,C=!1,y="#"+p.contentBlock.id,w=function(e,t){p.resizing=!0,s.addClass("bulb-resizing")},A=function(e,t){d.updateToolbar(),p.contentElement.css("left","")},_=function(n,o){p.busy=!0;var r,l,c,u,h=Math.round(o.size.width*v),g=Math.round(o.size.height*v);(r=h,l=g,c={width:r},u=p.contentBlock.blockType,"EMBED"!==u&&"ATTACHED_FILE_EMBED"!==u||(c.height=l),e.one("units",p.page.unit.id).one(a.BLOCK_PATHS[p.contentBlock.blockType],p.contentBlock.id).patch(c).then(function(e){angular.copy(e.plain(),p.contentBlock);var n={status:i.STATUS.SAVING,restId:d.page.unit.id};t.autoSave(d.page.unit.id,"units",n)}).finally(function(){p.busy=!1})).then(function(){p.resizing=!1,s.removeClass("bulb-resizing")})};h.setFrameState("resize"),o.$on("frameStateChange",function(e,t){S()}),o.$on("selectionChange",function(e,t){(p.selected||C)&&S()}),o.$watch("contentBlockCtrl.alignment",function(e,t){e!==t&&E()}),T(b),jQuery(y+" .ui-resizable-handle").hide(),l.$observe("bulbResizable",function(e){var t=o.$eval(e);T(angular.extend({},f,t));var n=p.contentElement.closest("bulb-frame");n.length&&n.eq(0).hasClass("selected-block")&&p.contentElement.click()})}}function E(){if(p.selected&&"resize"===h.frameState){var e,t;switch(jQuery(y+" .ui-icon").removeClass("ui-icon"),p.alignment){case"left":case"center":e="se",t="sw";break;case"right":e="sw",t="se"}jQuery(y+" .ui-resizable-"+t).hide(),jQuery(y+" .ui-resizable-"+e).show()}else jQuery(y+" .ui-resizable-handle").hide()}function S(){p.selected&&"resize"===h.frameState?(p.contentElement.resizable().resizable("enable"),C=!0,E()):C&&(p.contentElement.resizable().resizable("disable"),C=!1,E())}function T(e){e.maxWidth>g&&(e.maxWidth=g);var t=jQuery(d.editorElement).width(),n=100/(v=g/t);e.maxWidth=e.maxWidth/v;var o=!0,i=p.contentBlock;"EMBED"!==i.blockType&&"ATTACHED_FILE_EMBED"!==i.blockType&&"AUDIO"!==i.blockType||(o=!1),"AUDIO"===i.blockType&&(n=40),p.contentElement.resizable({aspectRatio:o,minWidth:"AUDIO"===i.blockType?g/2:i.minWidth,minHeight:n,maxHeight:"AUDIO"===i.blockType?40:"",maxWidth:e.maxWidth,handles:"sw, se",start:w,resize:A,stop:_,disabled:!0})}}}}]),angular.module("bulbApp.contentEditorModule").directive("bulbRotatable",["$log","$timeout","Restangular","BulbAutoSaveService","BulbBusyService","BulbImageCarouselService","ASSET_LIBRARY","AUTO_SAVE","CONTENT_EDITOR",function(e,t,n,o,i,r,a,s,l){return{require:["^?contentEditor","^contentBlock","^bulbFrame","^?imageBlock","^?imageCarousel"],link:function(r,c,u,d){var p=null;if(d[0]&&(p=d[0]),!p||p.page.editing){var h=d[1],g=d[3],m=d[4],f=a.ROTATE.INITIAL_START_DEGREE,b=a.ROTATE.INITIAL_START_DEGREE,v=h.contentBlock.blockType,C=!1,y=null;"IMAGE"===v?t(function(){y=c.find("img")},l.IMAGE_ASSET.IMAGE_ASSET_IMAGE_TIMEOUT):"IMAGE_CAROUSEL"===v?r.$watchCollection("contentBlockCtrl.contentBlock",function(e,n){t(function(){try{var t=e.carouselImages[h.contentBlock.displayedImageIndex].uncroppedImageAsset||e.carouselImages[h.contentBlock.displayedImageIndex].fullImageAsset;y=$('img[id="'+t.id+'"]')}catch(e){}},l.CAROUSEL.CAROUSEL_GRAB_IMAGE_TIMEOUT)}):e.error("currentBlockType is an undefined type."),r.$on("command-rotate",function(){h.selected&&!C&&function(){var t=null;if("IMAGE"===v)t=h.contentBlock.rotatedImageAsset||h.contentBlock.scaledImageAsset,g.updateImageInfo(t);else if("IMAGE_CAROUSEL"===v){var n=h.contentBlock.carouselImages[h.contentBlock.displayedImageIndex];t=n.scaledImageAsset||n.fullImageAsset}else e.error("currentBlockType is an undefined type.");c.addClass("bulb-rotating"),p.insertBlockExtension.selectBlock(c),r.$apply(),C=!0}(),c.hasClass("bulb-rotating")&&(f+=a.ROTATE.CONSTANT_ROTATION_DEGREE,y.rotate({animateTo:f,callback:function(){f%360==0&&y.rotate({angle:f,animateTo:f});var t={rotationDegree:f%360,unmodifiedRotationDegree:b+=f};"IMAGE_CAROUSEL"===v&&(t.selectedImageIndex=h.contentBlock.displayedImageIndex);var c=h.contentBlock.displayedImageIndex;i.showBusyDuring(n.one("units",h.page.unit.id).one(l.BLOCK_PATHS[v],h.contentBlock.id).patch(t).then(function(t){"IMAGE"===v?(angular.copy(t.plain(),h.contentBlock),g.updateImageInfo()):"IMAGE_CAROUSEL"===v?(r.$emit("rotated-carousel-image",c),m.updateCarouselState(t)):e.error("currentBlockType is an undefined type.")})).then(function(){y.css("transform","");var e={status:s.STATUS.SAVING,restId:p.page.unit.id};o.autoSave(p.page.unit.id,"units",e)}),f=a.ROTATE.INITIAL_START_DEGREE,y.rotate({angle:f,animateTo:f})}}))}),r.$on("selectionChange",function(e,t){!h.selected&&C&&(c.removeClass("bulb-rotating"),"IMAGE"===v&&g.updateImageInfo(),r.$apply(),C=!1)})}}}}]),function(){"use strict";var e=MediumEditor.Extension.extend({name:"tabBehavior",constructor:function(e){MediumEditor.Extension.call(this,e)},init:function(){var e=this;setTimeout(function(){e.base.events.customEvents.editableKeydownTab.splice(1,1)}),this.subscribe("editableKeydownTab",this.handleTabKeydown.bind(this))},handleTabKeydown:function(e){var t=MediumEditor.selection.getSelectionStart(this.base.options.ownerDocument),n=MediumEditor.util.getClosestBlockContainer(t),o=n&&n.nodeName.toLowerCase();if(event.shiftKey)return this.handleShiftTabKeydown(e,n,o);switch(o){case"pre":event.preventDefault(),MediumEditor.util.insertHTMLCommand(this.options.ownerDocument,"    ");break;case"li":event.preventDefault(),n.parentNode.firstChild!==n&&this.document.execCommand("indent",!1,null)}},handleShiftTabKeydown:function(e,t,n){switch(n){case"li":e.preventDefault();var o=$(MediumEditor.selection.getSelectedParentElement(window.getSelection().getRangeAt(0))).parent();if(o.parent().hasClass("bulb-page-content"))for(var i=o.children(),r=0;r<i.length;r++){if(i[r]===t){this.document.execCommand("outdent",!1,null),this.document.execCommand("formatBlock",!1,"pre");var a=$("pre")[0];$(a).replaceWith("<p>"+$(a).html()+"</p>")}}else $(t).unwrap()}}});MediumEditor.extensions.tabBehavior=e}(),angular.module("bulbApp.contentEditorModule").factory("BulbToolbarExtensionFactory",["$cookies","MediumEditor","BulbBrowserService",function(e,t,n){var o=t.extensions.toolbar.extend({getInteractionElements:function(){return this.getToolbarElement()},getToolbarElement:function(){return this.toolbar||(this.toolbar=this.createToolbar()),this.toolbar},handleFocus:function(){this.modifySelection(),this.checkState()},checkState:function(){var e,o,i=(e=this.base.extensions,o=this.base.events.lastMousedownTarget,!!e&&e.some(function(e){if("function"!=typeof e.getInteractionElements)return!1;var n=e.getInteractionElements();return!!n&&(Array.isArray(n)||(n=[n]),n.some(function(e){return t.util.isDescendant(e,o,!0)}))}));if(!this.base.preventSelectionUpdates){if(!this.base.getFocusedElement())return this.hideToolbar();var r=t.selection.getSelectionElement(this.window);if((!r||-1===this.getEditorElements().indexOf(r)||r.getAttribute("data-disable-toolbar"))&&!i)return this.hideToolbar();var a=!1,s=!1;return(t.selection.findMatchingSelectionParent(function(e){return"true"===(e&&e.getAttribute("contenteditable"))&&(a=!0),e&&e.hasAttribute("disable-toolbar")&&(s=!0),e&&e.hasAttribute("selectable-block")&&!a},this.window)||this.updateOnEmptySelection&&this.static)&&!s?this.showAndUpdateToolbar():(s||""===this.window.getSelection().toString().trim()||!1===this.allowMultiParagraphSelection&&this.multipleBlockElementsSelected())&&!i?this.hideToolbar():!(n.isTouchDevice()&&i&&!this.isToolbarDefaultActionsDisplayed()&&!1===r)&&void this.showAndUpdateToolbar()}},modifySelection:function(){var e=this.window.getSelection();if(0!==e.rangeCount){var n=e.getRangeAt(0);if(this.standardizeSelectionStart&&n.startContainer.nodeValue&&n.startOffset===n.startContainer.nodeValue.length){var o=t.util.findAdjacentTextNodeWithContent(t.selection.getSelectionElement(this.window),n.startContainer,this.document);if(o){for(var i=0;0===o.nodeValue.substr(i,1).trim().length;)i+=1;n=t.selection.select(this.document,o,i,n.endContainer,n.endOffset)}}}},positionToolbar:function(e){this.getToolbarElement().style.left="0",this.getToolbarElement().style.right="initial";var t=e.getRangeAt(0),o=t.getBoundingClientRect();(!o||0===o.height&&0===o.width&&t.startContainer===t.endContainer)&&(o=1===t.startContainer.nodeType&&t.startContainer.querySelector("img")?t.startContainer.querySelector("img").getBoundingClientRect():t.startContainer.getBoundingClientRect());var i,r,a=this.window.innerWidth,s=this.getToolbarElement(),l=s.offsetHeight,c=s.offsetWidth/2,u=this.diffLeft-c,d=this.getEditorOption("elementsContainer"),p={},h={};["absolute","fixed"].indexOf(window.getComputedStyle(d).getPropertyValue("position"))>-1?(r=d.getBoundingClientRect(),["top","left"].forEach(function(e){h[e]=o[e]-r[e]}),h.width=o.width,h.height=o.height,o=h,a=r.width,p.top=d.scrollTop):p.top=this.window.pageYOffset,i=o.left+o.width/2,p.top+=o.top-l-5,s.classList.add("medium-toolbar-arrow-under"),n.isMobile()&&(p.top+=this.diffTop+l+o.height+20,s.classList.add("medium-toolbar-arrow-over"),s.classList.remove("medium-toolbar-arrow-under")),i<c?(p.left=u+c,p.right="initial"):a-i<c?(p.left="auto",p.right=0):(p.left=u+i,p.right="initial"),["top","left","right"].forEach(function(e){s.style[e]=p[e]+(isNaN(p[e])?"":"px")})}});return{createExtension:function(e){return new o(e)}}}]),angular.module("bulbApp.contentEditorModule").directive("transcodingAsset",["$interval","$timeout","Restangular","CONFIG","CONTENT_EDITOR",function(e,t,n,o,i){return{restrict:"E",require:"^contentBlock",link:function(t,o,r,a){var s,l=a.contentBlock.blockType;function c(){n.one("units",a.page.unit.id).one(i.BLOCK_PATHS[l],"VIDEO"===l?a.contentBlock.video.id:a.contentBlock.audio.id).customGET("status").then(function(n){-1!==n.percentComplete&&(t.progress=n.percentComplete),t.status=n.statusCode,"VIDEO"===l&&n.splashImage&&(t.splashImageUrl=n.splashImageHref),n.complete&&(s&&e.cancel(s),a.refetchContentBlock())})}t.progress=0,t.blockType=l,t.status="AUDIO"===l?"transcoding_audio_init":"transcoding_video_init",c(),s=e(c,3e3),o.on("$destroy",function(){e.cancel(s)})},templateUrl:o.resource.cdnRoot+"ajs/components/contenteditor/transcodingasset.html"}}]),angular.module("bulbApp.contentEditorModule").directive("uploadingFileBlock",["CONFIG",function(e){return{restrict:"E",templateUrl:e.resource.cdnRoot+"ajs/components/contenteditor/uploadingfileblock.html"}}]),angular.module("bulbApp.contentEditorModule").directive("uploadingImageBlock",["CONFIG",function(e){return{restrict:"E",templateUrl:e.resource.cdnRoot+"ajs/components/contenteditor/uploadingimageblock.html",link:function(e,t,n){e.isBrowserSupportedImage=function(){if(this.isSupportedImage)return this.isSupportedImage;var t=e.contentBlockCtrl.contentBlock.data.originalFiles[0].name;return this.isSupportedImage=t.match(/\.(gif|jpe?g|bmp|png)$/i),this.isSupportedImage}}}}]),function(){"use strict";function e(e,t,n){var o=this;this.width=815,this.height=458,this.isPlaying=!1,this.updateVideoSize=function(){var i=jQuery(".bulb-page-content").width(),r=t.page.content.max.width,a=i/r;switch(o.width=e.contentBlockCtrl.contentBlock.width*a,e.contentBlockCtrl.contentBlock.video.jspType){case"ASSET":var s=e.contentBlockCtrl.contentBlock.video.transcodedAssets[0].width,l=e.contentBlockCtrl.contentBlock.video.transcodedAssets[0].height,c=s/l;o.height=o.width/c;break;case"VIMEO":o.vimeoPlayer?o.vimeoPlayer.getVideoWidth().then(function(t){o.vimeoPlayer.getVideoHeight().then(function(){var n=t/l;o.height=o.width/n,e.$apply()}).catch(function(){})}).catch(function(){}):o.height=o.width/t.embed.default.aspect.ratio;break;case"YOUTUBE":o.height=o.width/t.embed.default.aspect.ratio}e.contentBlockCtrl.isFullWidth=e.contentBlockCtrl.contentBlock.width>r*n.FULL_BLOCK_WIDTH_PERCENTAGE},this.play=function(){"VIMEO"===e.contentBlockCtrl.contentBlock.video.jspType?o.vimeoPlayer&&o.vimeoPlayer.getPaused().then(function(e){e?o.vimeoPlayer.play().catch(function(e){console.error("error playing the video:",e.name)}):o.vimeoPlayer.pause().catch(function(e){console.error("error playing the video:",e.name)})}):(e.$broadcast("bulb-video-play-toggle","content-block-"+e.contentBlockCtrl.contentBlock.id),o.isPlaying=!o.isPlaying)},e.$watchCollection("contentBlockCtrl.contentBlock",function(){o.updateVideoSize()})}e.$inject=["$scope","CONFIG","CONTENT_EDITOR"],angular.module("bulbApp.contentEditorModule").controller("VideoBlockController",e)}(),angular.module("bulbApp.contentEditorModule").directive("videoBlock",["$timeout","CONFIG",function(e,t){return{restrict:"E",require:"videoBlock",controller:"VideoBlockController as videoBlockCtrl",link:function(e,t,n,o){if("VIMEO"===e.contentBlockCtrl.contentBlock.video.jspType)var i=e.$watch(function(){return t.find("iframe").length},function(e,n){e!==n&&e>0&&(i(),o.vimeoPlayer=new Vimeo.Player(t.find("iframe")[0]),o.vimeoPlayer.ready().then(function(){o.updateVideoSize()}))})},templateUrl:t.resource.cdnRoot+"ajs/components/contenteditor/videoblock.html"}}]),function(){"use strict";function e(e,t,n,o,i){this.url=null,this.tempId=e,this.submit=function(r){var a={url:this.url};o.one("units",n.contentEditorCtrl.page.unit.id).customPOST(a,"embedblock").then(function(o){n.contentEditorCtrl.page.unit.contentBlocks[o.contentBlock.id]=o.contentBlock,jQuery("#"+e).replaceWith(t('<content-block id="'+o.contentBlock.id+'" contenteditable="false"></content-block>')(n)),n.contentEditorCtrl.editor.trigger("editableInput",null,n.contentEditorCtrl.editor.elements[0])},function(e){e.data.errorMap?r.handleRemoteErrors(e):i.showError(null,e)})}}e.$inject=["tempId","$compile","$scope","Restangular","BulbErrorService"],angular.module("bulbApp.contentEditorModule").controller("VideoBlockFormController",e)}(),angular.module("bulbApp.contentSelectorModule",["bulbApp.commentModule"]),function(){"use strict";function e(e,t,n,o,i,r,a){var s=this,l=o.extensions.button.extend({name:"comment",contentDefault:"<b translate>toolbar_comment_content</b>",contentFA:'<i class="fa fa-comment"></i>',aria:t.instant("toolbar_comment_rollover"),handleClick:function(){i.createCommentThread(s.page.unit,s.editor),s.editor.getExtensionByName("toolbar").hideToolbar()}});this.selectedBlockElement=null,this.selectedBlock=null;this.toolbarExtension=new a.createExtension({buttons:["comment"],standardizeSelectionStart:!0,static:!1,sticky:!1}),this.selectedBlockElement=null,this.selectedBlock=null,this.selectBlockExtension=new r.createExtension({blockSelected:function(t){s.selectedBlockElement=angular.element(t),s.selectedBlock=t?s.page.unit.contentBlocks[t.id]:null,e.$broadcast("selectionChange",s.selectedBlockElement,s.selectedBlock),s.updateToolbar()},scope:e,contentEditorCtrl:s}),this.editorOptions={anchor:{linkValidation:!0},buttonLabels:"fontawesome",disableEditing:!0,placeholder:{text:""},extensions:{comment:new l,toolbar:this.toolbarExtension,bulbSelectBlock:this.selectBlockExtension,"medium-editor-toolbar-states":new n.MediumEditorToolbarStates({states:{default:{buttons:["comment"]},image:{buttons:["comment"]},video:{buttons:["comment"]},attachedFile:{buttons:["comment"]},embed:{buttons:["comment"]}},attributeName:"toolbar-state"})},keyboardCommands:!0},this.updateToolbar=function(){s.editor.checkSelection()}}e.$inject=["$scope","$translate","$window","MediumEditor","BulbCommentService","BulbSelectBlockExtensionFactory","BulbToolbarExtensionFactory"],angular.module("bulbApp.contentSelectorModule").controller("ContentSelectorController",e)}(),angular.module("bulbApp.contentSelectorModule").directive("contentSelector",["$timeout","BulbCommentService","MediumEditor",function(e,t,n){return{priority:999,require:"ngModel",restrict:"A",controller:"ContentSelectorController as contentSelectorCtrl",link:function(e,o,i,r){var a=e.$eval(i.page);if(t.isCommentable(a)){var s=e.contentSelectorCtrl;s.page=a,r.editor=new n(o,s.editorOptions),s.editor=r.editor,s.editorElement=o[0];var l=r.editor.getExtensionByName("toolbar");l.on(l.document.documentElement,"touchend",l.handleDocumentMouseup.bind(l)),t.init(s.page,o,r.editor)}else t.init(a,o)}}}]),angular.module("bulbApp.contentEditorModule").factory("BulbSelectBlockExtensionFactory",["$interval","BulbAuthService","BulbBrowserService","BulbCommentService","MediumEditor",function(e,t,n,o,i){var r=i.Extension.extend({name:"bulbSelectBlock",selection:null,init:function(){if(this.editor=this.getEditorElements()[0],this.options=angular.merge({},this.defaults,this.options),this.subscribe("editableClick",this.handleClick.bind(this)),this.subscribe("blur",this.handleBlur.bind(this)),n.isTouchDevice()&&n.isMobile()){var t=this.base.exportSelection(),o=this;e(function(){var e=o.base.exportSelection();angular.equals(t,e)||(t=e,o.base.checkSelection())},200)}},handleClick:function(e){var t=$(e.target),n=t.closest("[selectable-block]");if(n.length){var o=t.closest('[contenteditable="true"]');o.length&&jQuery.contains(n[0],o[0])?this.unselectBlock():this.selectBlock(n[0])}else this.unselectBlock()},unselectBlock:function(){$(this.editor).find(".selected-block").removeClass("selected-block"),this.blockSelected(null),this.selection=null},ensureElementIsVisible:function(e){var t=e.getBoundingClientRect();t.top>=0&&t.left>=0&&t.bottom<=(window.innerHeight||this.document.documentElement.clientHeight)&&t.right<=(window.innerWidth||this.document.documentElement.clientWidth)||e.scrollIntoView()},selectBlock:function(e){var t=$(e),n=t.closest("[selectable-block]");if(0===n.length&&(n=t.find("[selectable-block]")),0!==n.length){$(this.editor).find(".selected-block").removeClass("selected-block"),n.addClass("selected-block"),this.selection=n[0];var o=n.children("[ng-transclude]")[0];i.selection.selectNode(o,this.document);var r=i.selection.getSelectionElement(this.window);r!==this.base.getFocusedElement()&&this.base.events.focusElement(r),this.ensureElementIsVisible(n[0]),this.blockSelected(n.closest("content-block")[0])}},handleBlur:function(e,t){jQuery(t).find(".bulb-media-active").removeClass("bulb-media-active"),$(this.editor).find(".selected-block").removeClass("selected-block"),this.blockSelected(null),this.selection=null}});return{createExtension:function(e){return new r(e)}}}]),angular.module("bulbApp.coverImageModule",["ui.router","bulbApp.authModule","bulbApp.configModule","bulbApp.filtersModule","bulbApp.utilsModule"]),function(){"use strict";function e(e,t,n,o,i,r){this.calculateCoverImageSize=function(e,o,a,s){return t("cover_image_too_small_label",{width:o.minWidth,height:o.minHeight}).then(function(t){var o={templateUrl:r.resource.cdnRoot+"ajs/components/coverimage/coverimage.html",showCancelButton:!1,showOkButton:!1,titleText:!1,windowClass:"bulb-cover-image-options-modal",controller:["$scope",function(e){e.coverImageBodyTemplate=t}]};i.show(o).then(function(){var t={id:e.image.id,assetDefinitionsKey:"coverImage",url:e.image.url,width:e.image.width,height:e.image.height};n.dialog.dismissAllModals(),"pageView"===s?(a.coverImageMode="editor",a.isCoverImageUploadActive=!1,a.coverImageEdit={isNew:!a.page.unit.coverImage,asset:t,cropType:"CROP_COVER_IMAGE"}):"compositeView"===s&&(a.mode="editor",a.isCoverImageUploadActive=!1,a.edit={isNew:!a.compositeUnit.coverImage,asset:t,cropType:"CROP_COVER_IMAGE"})})})}}e.$inject=["$rootScope","$translate","BulbAssetLibraryService","BulbAssetLibraryUploadService","BulbModalService","CONFIG"],angular.module("bulbApp.coverImageModule").service("BulbCoverImageService",e)}(),function(e){"use strict";var t=function(){function e(){this._dropEffect="move",this._effectAllowed="all",this._data={}}return Object.defineProperty(e.prototype,"dropEffect",{get:function(){return this._dropEffect},set:function(e){this._dropEffect=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"effectAllowed",{get:function(){return this._effectAllowed},set:function(e){this._effectAllowed=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"types",{get:function(){return Object.keys(this._data)},enumerable:!0,configurable:!0}),e.prototype.clearData=function(e){null!=e?delete this._data[e]:this._data=null},e.prototype.getData=function(e){return this._data[e]||""},e.prototype.setData=function(e,t){this._data[e]=t},e.prototype.setDragImage=function(e,t,o){var i=n._instance;i._imgCustom=e,i._imgOffset={x:t,y:o}},e}();e.DataTransfer=t;var n=function(){function e(){if(this._lastClick=0,e._instance)throw"DragDropTouch instance already created.";var t=!1;if(document.addEventListener("test",function(){},{get passive(){return t=!0,!0}}),"ontouchstart"in document){var n=document,o=this._touchstart.bind(this),i=this._touchmove.bind(this),r=this._touchend.bind(this),a=!!t&&{passive:!1,capture:!1};n.addEventListener("touchstart",o,a),n.addEventListener("touchmove",i,a),n.addEventListener("touchend",r),n.addEventListener("touchcancel",r)}}return e.getInstance=function(){return e._instance},e.prototype._touchstart=function(t){var n=this;if(this._shouldHandle(t)){if(Date.now()-this._lastClick<e._DBLCLICK&&this._dispatchEvent(t,"dblclick",t.target))return t.preventDefault(),void this._reset();this._reset();var o=this._closestDraggable(t.target);o&&(this._dispatchEvent(t,"mousemove",t.target)||this._dispatchEvent(t,"mousedown",t.target)||(this._dragSource=o,this._ptDown=this._getPoint(t),this._lastTouch=t,t.preventDefault(),setTimeout(function(){n._dragSource==o&&null==n._img&&n._dispatchEvent(t,"contextmenu",o)&&n._reset()},e._CTXMENU)))}},e.prototype._touchmove=function(t){if(this._shouldHandle(t)){var n=this._getTarget(t);if(this._dispatchEvent(t,"mousemove",n))return this._lastTouch=t,void t.preventDefault();if(this._dragSource&&!this._img)this._getDelta(t)>e._THRESHOLD&&(this._dispatchEvent(t,"dragstart",this._dragSource),this._createImage(t),this._dispatchEvent(t,"dragenter",n));this._img&&(this._lastTouch=t,t.preventDefault(),n!=this._lastTarget&&(this._dispatchEvent(this._lastTouch,"dragleave",this._lastTarget),this._dispatchEvent(t,"dragenter",n),this._lastTarget=n),this._moveImage(t),this._dispatchEvent(t,"dragover",n))}},e.prototype._touchend=function(e){if(this._shouldHandle(e)){if(this._dispatchEvent(this._lastTouch,"mouseup",e.target))return void e.preventDefault();this._img||(this._dragSource=null,this._dispatchEvent(this._lastTouch,"click",e.target),this._lastClick=Date.now()),this._destroyImage(),this._dragSource&&(e.type.indexOf("cancel")<0&&this._dispatchEvent(this._lastTouch,"drop",this._lastTarget),this._dispatchEvent(this._lastTouch,"dragend",this._dragSource),this._reset())}},e.prototype._shouldHandle=function(e){return e&&!e.defaultPrevented&&e.touches&&e.touches.length<2},e.prototype._reset=function(){this._destroyImage(),this._dragSource=null,this._lastTouch=null,this._lastTarget=null,this._ptDown=null,this._dataTransfer=new t},e.prototype._getPoint=function(e,t){return e&&e.touches&&(e=e.touches[0]),{x:t?e.pageX:e.clientX,y:t?e.pageY:e.clientY}},e.prototype._getDelta=function(e){var t=this._getPoint(e);return Math.abs(t.x-this._ptDown.x)+Math.abs(t.y-this._ptDown.y)},e.prototype._getTarget=function(e){for(var t=this._getPoint(e),n=document.elementFromPoint(t.x,t.y);n&&"none"==getComputedStyle(n).pointerEvents;)n=n.parentElement;return n},e.prototype._createImage=function(t){this._img&&this._destroyImage();var n=this._imgCustom||this._dragSource;if(this._img=n.cloneNode(!0),this._copyStyle(n,this._img),this._img.style.top=this._img.style.left="-9999px",!this._imgCustom){var o=n.getBoundingClientRect(),i=this._getPoint(t);this._imgOffset={x:i.x-o.left,y:i.y-o.top},this._img.style.opacity=e._OPACITY.toString()}this._moveImage(t),document.body.appendChild(this._img)},e.prototype._destroyImage=function(){this._img&&this._img.parentElement&&this._img.parentElement.removeChild(this._img),this._img=null,this._imgCustom=null},e.prototype._moveImage=function(e){var t=this;requestAnimationFrame(function(){if(t._img){var n=t._getPoint(e,!0),o=t._img.style;o.position="absolute",o.pointerEvents="none",o.zIndex="999999",o.left=Math.round(n.x-t._imgOffset.x)+"px",o.top=Math.round(n.y-t._imgOffset.y)+"px"}})},e.prototype._copyProps=function(e,t,n){for(var o=0;o<n.length;o++){var i=n[o];e[i]=t[i]}},e.prototype._copyStyle=function(t,n){if(e._rmvAtts.forEach(function(e){n.removeAttribute(e)}),t instanceof HTMLCanvasElement){var o=t,i=n;i.width=o.width,i.height=o.height,i.getContext("2d").drawImage(o,0,0)}for(var r=getComputedStyle(t),a=0;a<r.length;a++){var s=r[a];s.indexOf("transition")<0&&(n.style[s]=r[s])}n.style.pointerEvents="none";for(a=0;a<t.children.length;a++)this._copyStyle(t.children[a],n.children[a])},e.prototype._dispatchEvent=function(t,n,o){if(t&&o){var i=document.createEvent("Event"),r=t.touches?t.touches[0]:t;return i.initEvent(n,!0,!0),i.button=0,i.which=i.buttons=1,this._copyProps(i,t,e._kbdProps),this._copyProps(i,r,e._ptProps),i.dataTransfer=this._dataTransfer,o.dispatchEvent(i),i.defaultPrevented}return!1},e.prototype._closestDraggable=function(e){for(;e;e=e.parentElement)if(e.hasAttribute("draggable")&&e.draggable)return e;return null},e}();n._instance=new n,n._THRESHOLD=5,n._OPACITY=.5,n._DBLCLICK=500,n._CTXMENU=900,n._rmvAtts="id,class,style,draggable".split(","),n._kbdProps="altKey,ctrlKey,metaKey,shiftKey".split(","),n._ptProps="pageX,pageY,clientX,clientY,screenX,screenY".split(","),e.DragDropTouch=n}(DragDropTouch||(DragDropTouch={})),function(){"use strict";function e(e,t){this.error=function(t,n){var o=t||"Server error";return n&&(n.data&&n.data.developerMessage?o+=": Error: "+n.data.developerMessage:n.message?o+=": Error: "+n.message:n.statusText?o+=": Error: "+n.statusText:n.status&&(o+=": "+n.status)),e.error(o),o},this.showError=function(e,n){(e||n)&&this.error(e,n);var o={titleCode:"server_error_title",showOkButton:!1,showCancelButton:!1};return e?o.bodyText=e:o.bodyCode="server_error_title",t.show(o)}}e.$inject=["$log","BulbModalService"],angular.module("bulbApp.errorModule",["bulbApp.modalModule"]).service("BulbErrorService",e)}(),angular.module("bulbApp.filtersModule",[]),angular.module("bulbApp.filtersModule").filter("escapeHtml",function(){var e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};return function(t){return String(t).replace(/[&<>"'\/]/g,function(t){return e[t]})}}),angular.module("bulbApp.filtersModule").filter("magnitude",function(){function e(e,t){return+(Math.round(+(e+"e+"+t))+"e-"+t)}var t={count:["","K","M","B","T"],metric:["","k","M","G","T"]};return function(n,o){var i=(o=o||{}).factor||1e3,r=void 0!==o.precision?o.precision:1,a=o.unitPrefixes||"metric";Array.isArray(a)||(t.hasOwnProperty(a)||(console.error("[magnitude filter] Unknown options.unitPrefixes '"+a+"': using 'metric'"),a="metric"),a=t[a]);var s=n,l=1;n<0&&(s=Math.abs(n),l=-1);var c=0;if(s>=i){var u;do{++c,u=e(s/=i,r)}while(u>=i&&c+1<a.length);s=u}else s=e(s,r);return(s*=l)+a[c]}}),angular.module("bulbApp.filtersModule").filter("secondsToDate",["$translate",function(e){return function(t){var n=e.instant("organization_archive_seconds_calculating");return t<0?n:new Date(1970,0,1).setSeconds(t)}}]),angular.module("bulbApp.filtersModule").filter("trustAsHtml",["$sce",function(e){return e.trustAsHtml}]),angular.module("bulbApp.filtersModule").filter("underscoreToDash",function(){return function(e){return e.replace(/_/g,"-")}}),angular.module("bulbApp.filtersModule").filter("zeroPad",function(){return function(e,t){void 0===e&&(e=0);var n=e.toString();return n.length>=t?n:"0".repeat(t-n.length)+n}}),angular.module("foundationModule",[]).factory("Foundation",["$window",function(e){return e.Foundation}]),angular.module("googleModule",[]).factory("google",["$window",function(e){return e.gapi||{}}]),angular.module("bulbApp.groupModule",["focus-if","lodash","mm.foundation","ui.router","bulbApp.ajaxModule","bulbApp.authModule","bulbApp.busyModule","bulbApp.configModule","bulbApp.errorModule","bulbApp.modalModule","bulbApp.translateModule"]).constant("GROUP",{PAGE_SIZE:18}).run(["$rootScope","GROUP",function(e,t){e.GROUP=t}]).config(["$stateProvider","AUTH","CONFIG",function(e,t,n){e.state("createGroup",{parent:"root",url:"^/b/group/create",resolve:{$title:["$translate",function(e){return e("create_group_title")}]},views:{content:{templateUrl:n.resource.cdnRoot+"ajs/components/group/create.html",controller:"GroupHeaderController as groupHeaderCtrl"}},bulbAuth:{isAuthorized:["BulbAuthService",function(e){return e.currentUser.canCreate("Group")}]}}).state("group",{parent:"root",url:"^/g/{groupUrl:pathVariable}?welcome",resolve:{groupDTO:["$stateParams","Restangular",function(e,t){return t.one("groups",e.groupUrl).get()}],$title:["groupDTO",function(e){return e.name}]},views:{content:{templateUrl:n.resource.cdnRoot+"ajs/components/group/group.html",controller:"GroupController as groupCtrl"}}})}]),function(){"use strict";function e(e,t,n,o){var i=this;this.importGroup=null,this.classList=o.courses,this.importClassroomGroup=function(){var r={id:i.importGroup.id,name:i.importGroup.name,description:i.importGroup.descriptionHeading,ownerId:i.importGroup.ownerId,ownerEmail:i.importGroup.ownerEmail};t.showBusyDuring(n.createClassroomGroup(r,o.oauthToken).then(function(t){e.go("group",{groupUrl:t.url},{location:"replace"})},function(e){o.showError(e)}))}}e.$inject=["$state","BulbBusyService","BulbGroupService","BulbGoogleClassroomImportService"],angular.module("bulbApp.groupModule").controller("GoogleClassroomImportController",e)}(),angular.module("bulbApp.groupModule").directive("bulbGoogleClassroomImport",["CONFIG",function(e){return{restrict:"E",templateUrl:e.resource.cdnRoot+"ajs/components/group/google-classroom-import.html",controller:"GoogleClassroomImportController as googleClassroomImportCtrl",link:function(e,t,n){}}}]),function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c,u,d,p,h,g,m){var f,b,v=this;if(this.group=e,this.dateGroupWasClosed=h.getDateGroupWasClosed(v.group),this.emailOrUsername="",this.remainingGroups=h.getRemainingGroups(),this.isOwner=l.currentUser.hasPermission(this.group,m.PERMISSIONS.DELETE),r.viewSwitcherService=c,this.isMember=!1,this.groupInviteToken="",s.one("token/group/"+this.group.id).get().then(function(e){v.groupInviteToken=e.token},function(){s.all("token/group/"+v.group.id).post().then(function(e){v.groupInviteToken=e.token})}),this.isMobile=u.isIOSMobile()||u.isAndroid()||u.isWindowsMobile(),this.members=this.group.members,this.members.length>0&&(f=a.find(this.members,function(e){return e.statuses.isOwner}),(b=a.find(this.members,"accountId",l.currentUser.id))&&(this.isMember=!0,this.showGroupWelcomeDialog=b.statuses.isPending)),i.$on("members",function(e,t){v.members=t}),n.welcome&&(this.showGroupWelcomeDialog=n.welcome&&!1===this.isMember),this.showGroupWelcomeDialog){var C="group_welcome_body",y="group_welcome_visit",w=l.currentUser.isAuthenticated();w||(C="group_welcome_anonymous_body",y="sign_in");var A={titleCode:"group_welcome_title",okButtonCode:y,showCancelButton:!1,templateUrl:"groupwelcome.nested",controller:["$scope",function(e){e.group=v.group.name,e.welcomeBody=C,e.authenticated=w,e.signUp=function(){e.$dismiss(),t.go("signUp",{targetUrl:o.location.href})}}]};g.show(A).then(function(){w?v.updateMemberStatus():t.go("signIn",{targetUrl:o.location.href})},function(){})}this.addMember=function(){d.showBusyDuring(s.one("groups",v.group.id).all("members").customPOST({emailOrUsername:v.emailOrUsername}).then(function(e){v.members.push(e),v.emailOrUsername=""},function(e){e.data.errorMap?v.addMemberForm.handleRemoteErrors(e):p.showError(null,e)}))},this.removeMember=function(e){if(this.isOwner&&f.accountId!==e.accountId){var t=e.username,n=!1;null===t&&(t=e.displayName,n=!0),d.showBusyDuring(s.one("groups",v.group.id).one("members").customOperation("remove","",null,{"content-type":"application/json"},{emailOrUsername:t}).then(function(e){v.group=e,v.members=e.members},function(t){if(406===t.status&&n){var o=v.members.indexOf(e);o>-1&&v.members.splice(o,1)}else p.error("Cannot delete a group member",t)}))}},this.toggleGroupActive=function(){var e=this.group.active;this.isOwner&&(e?g.show(h.closeGroupModalOptions).then(function(){h.toggleGroupStatus(v.group).then(function(e){v.group=e.updatedGroup,v.remainingGroups=e.remainingGroups})},{}):h.toggleGroupStatus(v.group).then(function(e){v.group=e.updatedGroup,v.remainingGroups=e.remainingGroups}))},this.updateMemberStatus=function(){b&&b.statuses.isPending&&(b.statuses.isPending=!1,s.one("groups",v.group.id).one("members",l.currentUser.id).patch(b.statuses).then(function(e){if(e){var t=a.findIndex(v.members,"accountId",l.currentUser.id);t>0&&e.accountId===l.currentUser.id&&(v.members[t]=e,v.isMember=!0)}},function(e){p.error("Cannot update the group member status",e)}))},this.getMemberUiSref=function(e){return e.username?'author({username: "'+e.username+'"})':"."},this.getPrimaryMemberStatus=function(e){return e.isOwner?"OWNER":e.isPending?"PENDING":"MEMBER"},this.isAddMemberButtonDisabled=function(){return this.addMemberForm.$invalid||this.addMemberForm.$pristine||!this.emailOrUsername||""===this.emailOrUsername}}e.$inject=["groupDTO","$state","$stateParams","$window","$rootScope","$scope","_","Restangular","BulbAuthService","BulbBlockViewSwitcherService","BulbBrowserService","BulbBusyService","BulbErrorService","BulbGroupService","BulbModalService","AUTH"],angular.module("bulbApp.groupModule").controller("GroupController",e)}(),angular.module("bulbApp.groupModule").factory("BulbGroupService",["$filter","$q","Restangular","BulbAuthService","BulbErrorService","BulbModalService","GROUP","_",function(e,t,n,o,i,r,a,s){return{groups:[],fetchedAllGroupsForToggle:!1,currentStatus:"open",groupListWasToggled:!1,deletedGroupUsingDevTool:!1,closeGroupModalOptions:{titleCode:"close_group_modal_title",okButtonCode:"close_group_button_text",fontAwesomeCode:"fas fa-minus-octagon",bodyCode:"close_group_modal_body_text",showOkButton:!0,showCancelButton:!0,windowClass:"updated-modal-design red-button-updated-modal"},openGroupFilterStatusForGroupHeader:!0,fetchGroups:function(t,r,l){var c=this;return l="undefined"===l?null:c.currentStatus,r||(r=a.PAGE_SIZE),n.all("groups").getList({size:r,after:t,memberId:o.currentUser.id,filter:l}).then(function(t){t.length<r&&(c.fetchedAllGroupsForToggle=!0),t&&t.length>0?(("open"===l||"closed"===l)&&c.groupListWasToggled?(c.groups=t,c.groupListWasToggled=!1):c.groups=c.groups.concat(t),c.groups=s.uniq(c.groups,"id"),c.groups=e("orderBy")(c.groups,"sortKey")):(c.groupListWasToggled&&(c.groups=[],c.groupListWasToggled=!1),c.deletedGroupUsingDevTool&&(c.groups=[],c.groupListWasToggled=!1))},function(e){i.error("Group service fetch groups error.",e)})},updateGroup:function(e){for(var t=0;t<this.groups.length;t+=1)if(this.groups[t].id===e.id)return void(this.groups[t]=e)},createGroup:function(i){var r=t.defer(),a=this;return n.all("groups").post(i).then(function(t){a.groups.push(t),a.groups=e("orderBy")(a.groups,"sortKey"),o.currentUser.features.GroupFeature.currentGroups+=1,r.resolve(t)},function(e){r.reject(e)}),r.promise},createMacMillanGroup:function(i){var r=t.defer(),a=this;return n.all("groups").customPOST({},"",{macmillan:i}).then(function(t){a.groups.push(t),a.groups=e("orderBy")(a.groups,"sortKey"),o.currentUser.features.GroupFeature.currentGroups+=1,r.resolve(t)},function(e){r.reject(e)}),r.promise},joinedGroup:function(e){this.groups.push(e)},getRemainingGroups:function(){return o.currentUser.id?o.currentUser.features.GroupFeature.maxGroups<0?Number.MAX_VALUE:o.currentUser.features.GroupFeature.maxGroups-o.currentUser.features.GroupFeature.currentGroups:0},createClassroomGroup:function(i,r){var a=t.defer(),s=this;return n.one("groups").customPOST(i,"",{token:r,type:"google_classroom"}).then(function(t){s.groups.push(t),s.groups=e("orderBy")(s.groups,"sortKey"),o.currentUser.features.GroupFeature.currentGroups+=1,a.resolve(t)},function(e){a.reject(e)}),a.promise},reSyncClassroomGroup:function(e,o,i){var r=t.defer(),a=this;return n.one("groups/"+e).patch("",{token:i,type:"google_classroom"}).then(function(e){a.updateGroup(e),r.resolve(e)},function(e){r.reject(e)}),r.promise},toggleGroupStatus:function(t){var r=!t.active,a=this;return n.one("groups",t.id).patch({active:r}).then(function(t){var n=s.findIndex(a.groups,{id:t.id});return-1===n?(a.groups.push(t),a.groups=e("orderBy")(a.groups,"sortKey")):a.groups.splice(n,1),r?o.currentUser.features.GroupFeature.currentGroups+=1:o.currentUser.features.GroupFeature.currentGroups-=1,{updatedGroup:t,remainingGroups:a.getRemainingGroups()}},function(e){i.error("Cannot change the active status for group",e)})},getDateGroupWasClosed:function(e){return e.lastDateClosed?new Date(e.lastDateClosed).toLocaleDateString(void 0,{day:"2-digit",month:"2-digit",year:"numeric"}):null}}}]),function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c,u,d,p,h,g,m,f,b){var v=this;this.translatedGroupCloseText=o.instant("close_group_button_text");var C=s.currentUser.features.ActivatedCodesFeature.codes;this.ableToCreateMacMillanGroups=s.isAbleToMakeMacMillanGroups(C),this.isOwnerOfGroup=function(e){return s.currentUser.hasPermission(e,g.PERMISSIONS.DELETE)},this.groups=d.groups,this.currentDisplayedGroupStatus=d.currentStatus,this.enteredGroupCode="",this.getRemainingGroups=d.getRemainingGroups(),this.fieldErrors={},this.canImportClassFromGoogleClassroom=function(){return"FREE"!==s.currentUser.billing.plan&&"BULBFREE2018"!==s.currentUser.billing.plan},this.isEducator="EDUCATOR"===s.currentUser.position,this.getBookCodes=function(){var e=s.currentUser.features.ActivatedCodesFeature;"EDUCATOR"===s.currentUser.position&&e&&(e.codes.length>0&&(this.isMacMillanTeacher=!0))},this.getBookCodes(),this.isMobile=l.isIOSMobile()||l.isAndroid()||l.isWindowsMobile(),this.getInitialGroups=function(e){!s.currentUser.isAuthenticated()||!e&&this.groups&&0!==this.groups.length||d.fetchGroups(null,f.PAGE_SIZE,v.currentDisplayedGroupStatus)},this.getNextPage=function(){if(!d.fetchedAllGroupsForToggle){var e=this.groups.length;if(0===e)this.getInitialGroups();else{var t=this.groups[e-1];d.fetchGroups(t.sortKey,f.PAGE_SIZE,v.currentDisplayedGroupStatus)}}},this.createGroup=function(){this.fieldErrors={},d.createGroup(this.group).then(function(e){n.go("group",{groupUrl:e.url},{location:"replace"})},function(e){if(e.data&&e.data.errorMap){var t=e.data.errorMap.fieldErrors;t&&(v.fieldErrors=t)}})},this.joinGroupFromCode=function(e,t){var i={titleCode:"join_group_modal_title",templateUrl:"joingroupmodal.nested",fontAwesomeCode:"fas fa-users",showOkButton:!1,showCancelButton:!1,windowClass:"updated-modal-design group-join-specific-modal-designs",controller:["$scope",function(n){e&&(n.enteredGroupCode=t,n.codeJustFailed=!0,n.inputChanged=function(){n.codeJustFailed=!1})}]};p.show(i).then(function(e){e=e.toUpperCase(),c.showBusyDuring(r.all("token/member/"+e).post({}).then(function(){r.one("groups/"+e).get().then(function(e){iziToast.show({theme:"dark",timeout:2e3,close:!1,icon:"fas fa-users",message:o.instant("joined_group_text",{group:e.name}),position:"center",progressBarColor:"rgb(0,174,239)",onClosed:function(){n.go("group",{groupUrl:e.url})}}),d.joinedGroup(e)})},function(){v.joinGroupFromCode(!0,e)}))})},this.navigateCreateGroup=function(){var e={};s.currentUser.canCreate("Group")?d.getRemainingGroups()>=1?n.go("createGroup"):(e={titleCode:"group_limit_reached_title",templateUrl:"grouplimitreached.nested",showOkButton:!1,showCancelButton:!1},p.show(e)):(e={titleCode:"group_upgrade_from_free_tier_title",templateUrl:"groupupgrade.nested",showOkButton:!0,showCancelButton:!0},p.show(e))},this.back=function(){i.history.back()},this.needsUpgrade=function(){h.displayNeedsUpgradeDialog(v.compositeUnit)},this.changeGroupListFilter=function(e){d.fetchedAllGroupsForToggle=!1,v.currentDisplayedGroupStatus=e,e!==d.currentStatus&&(d.currentStatus=e,d.groupListWasToggled=!0),v.getInitialGroups(!0)},this.showCloseGroupModal=function(e,t){e.stopPropagation(),e.stopImmediatePropagation(),p.show(d.closeGroupModalOptions).then(function(){v.toggleGroupStatus(e,t)},{})},this.toggleGroupStatus=function(e,t){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),this.isOwnerOfGroup(t)&&d.toggleGroupStatus(t).then(function(e){var t=e.updatedGroup.active?"group_toast_group_opened":"group_toast_group_closed";iziToast.show({theme:"dark",timeout:2e3,close:!1,icon:"fas fa-inbox",message:o.instant(t),position:"bottomRight",progressBarColor:"rgb(0,174,239)"})})},this.getDateGroupWasClosed=function(e){return d.getDateGroupWasClosed(e)},t.$watchCollection(function(){return d.groups},function(e){v.groups=e}),this.importFromClassroom=function(){u.importGroupFromClassroom()},this.openBookDialog=function(){a.showMacMillanBookDialog(!0,!0)}}e.$inject=["$rootScope","$scope","$state","$translate","$window","Restangular","AeroDynamicDialogService","BulbAuthService","BulbBrowserService","BulbBusyService","BulbGoogleClassroomImportService","BulbGroupService","BulbModalService","BulbOnboardingService","AUTH","CONFIG","GROUP","_"],angular.module("bulbApp.groupModule").controller("GroupHeaderController",e)}(),angular.module("bulbApp.compositeViewModule").directive("bulbGroupHeader",["CONFIG",function(e){return{restrict:"E",templateUrl:e.resource.cdnRoot+"ajs/components/group/groupheader.html",controller:"GroupHeaderController as groupHeaderCtrl",link:function(e,t,n){if("initializeTrigger"in n)var o=n.$observe("initializeTrigger",function(t){e.$eval(t)&&(e.groupHeaderCtrl.getInitialGroups(),o())})}}}]),angular.module("bulbApp.imageEditorModule",["bulbApp.busyModule","bulbApp.configModule"]),function(){"use strict";angular.module("bulbApp.imageEditorModule").controller("ImageEditorController",function(){this.isActive=!1,this.isMoving=!1,this.isAtBottom=!1,this.isCanceled=!1,this.isCommitted=!1,this.isDeleted=!1})}(),function(){"use strict";function e(e,t,n,o,i,r,a,s,l){return{restrict:"E",scope:{edit:"=*",imageTypeDescription:"@",isActive:"=",isMoving:"=",onDelete:"&",onEditComplete:"&"},templateUrl:l.resource.cdnRoot+"ajs/components/imageeditor/imageeditor.html",controller:"ImageEditorController as imageEditorCtrl",bindToController:!0,transclude:!0,link:function(l,c,u){var d,p,h,g,m,f,b=1300,v=$(".bulb-state-unit, .bulb-state-unit-page, .bulb-state-preview-page, .bulb-state-live-page").length>0?420:500,C=jQuery(o),y={CROP_COVER_IMAGE:{autoCrop:!0,autoCropArea:1,background:!1,checkCrossOrigin:!1,dragMode:"move",viewMode:1,guides:!1,center:!1,highlight:!1,modal:!1,movable:!0,zoomOnWheel:!1,responsive:!1,zoomOnTouch:!1,zoomable:!1,cropBoxMovable:!1,cropBoxResizable:!1,toggleDragModeOnDblclick:!1},CROP_AUTHOR_IMAGE:{},CROP_INLINE_IMAGE:{guides:!1,highlight:!1,background:!1}};function w(e,t){l.$apply(function(){l.imageEditorCtrl[e]=t})}function A(){jQuery().cropper("destroy")}l.$watchCollection("imageEditorCtrl.edit",function(e){var t;(h=jQuery("img",c)).length>0&&e&&e.asset.url&&(g=angular.copy(e.asset),m=g.width/g.height,f=e.isNew,l.imageEditorCtrl.isActive=!0,l.imageEditorCtrl.isNew=e.isNew,h.on("build.cropper",function(e){d=C.width(),p=C.width()>=b?v:d*v/b;var t=jQuery(".bulb-image-editor-wrapper");t.width(d),t.height(p)}),h.on("built.cropper",function(e){!function(e){var t,n,o,i=d/p,r={};g.center&&void 0===e&&(e=g.center),e?(t=d/g.width,n=p/g.height,(e.X===Math.round(g.width/2)&&e.Y===Math.round(g.height/2)?m<i:e.X===Math.round(g.width/2))?(o=t,r.left=0,r.top=p/2-o*e.Y):(o=n,r.left=(d-o*g.width)/2,r.top=0),r.width=o*g.width,r.height=o*g.height):(t=d/g.width,n=p/g.height,m>i?(o=n,r.left=(d-o*g.width)/2):(o=t,r.left=0),r.width=o*g.width,r.height=o*g.height,r.top=0),h.cropper("setCanvasData",r);var a={};a.width=d,a.height=p,a.top=0,a.left=0,h.cropper("setCropBoxData",a)}(void 0);try{w("isMoving",!0),w("isMoving",!1)}catch(e){}}),h.on("cropstart.cropper",function(e){w("isMoving",!0),t=h.cropper("getCropBoxData"),t.width/2,t.height/2}),h.on("cropend.cropper",function(e){w("isMoving",!1),t=null,null,null}),h.cropper(y[e.cropType]))}),l.$watch("imageEditorCtrl.isCanceled",function(e){e&&(l.imageEditorCtrl.isActive=!1,f&&s.cancelUpload(g.id),u.onEditComplete&&i.showBusyDuring(t.when(l.imageEditorCtrl.onEditComplete({data:null})).finally(function(e){A()}))),l.imageEditorCtrl.isCanceled=!1}),l.$watch("imageEditorCtrl.isCommitted",function(n){if(n){l.imageEditorCtrl.isActive=!1;var o=h.cropper("getCanvasData"),r=h.cropper("getCropBoxData");if(u.onEditComplete){var a=g.width/o.width,c={X:Math.round(a*(r.width/2-o.left)),Y:Math.round(a*(p/2-o.top))},d={asset:g,center:c,width:g.width,height:g.height};i.showBusyDuring(t.when(l.imageEditorCtrl.onEditComplete({data:d})).finally(function(t){e.reload(),A()}))}else A();f&&s.endUpload(g.id)}l.imageEditorCtrl.isCommitted=!1}),l.$watch("imageEditorCtrl.isDeleted",function(e){e&&(l.imageEditorCtrl.isActive=!1,u.onDelete&&n("modal_delete_confirm_body",{type:l.imageEditorCtrl.imageTypeDescription}).then(function(e){a.show({titleCode:"modal_delete_confirm_title",bodyText:e,okButtonCode:"button_delete",showCancelButton:!1}).then(function(){i.showBusyDuring(t.when(l.imageEditorCtrl.onDelete()).then(function(){l.imageEditorCtrl.isActive=!1},function(e){l.imageEditorCtrl.isActive=!0,r.error("Cannot delete: "+e)}))},function(e){l.imageEditorCtrl.isActive=!0})})),l.imageEditorCtrl.isDeleted=!1})}}}e.$inject=["$state","$q","$translate","$window","BulbBusyService","BulbErrorService","BulbModalService","BulbUploadService","CONFIG"],angular.module("bulbApp.imageEditorModule").directive("bulbImageEditor",e)}(),angular.module("bulbApp.inappropriateContentModule",["ui.router","bulbApp.authModule","bulbApp.configModule","bulbApp.unitModule"]),function(){"use strict";function e(e,t,n,o,i,r){var a=this;this.getType=function(e){var t;switch(e["@c"]){case".PageUnitDTO":t="page";break;case".CompositeUnitDTO":t="collection";break;case".UserUnitDTO":t="profile";break;case".GroupDTO":t="group"}return t},this.openModal=function(s,l){var c=a.getType(l);t("inappropriate_content_modal_title",{type:c}).then(function(t){var a={fontAwesomeCode:"fas fa-exclamation-triangle",titleText:t,showOkButton:!1,showCancelButton:!1,templateUrl:i.resource.cdnRoot+"ajs/components/inappropriatecontent/inappropriatecontent-modal.html",windowClass:"inappropriate-content-modal scrollable",controller:["$scope",function(t){t.formData={reason:null,details:null},t.reasons=["Inappropriate Content","Inaccurate Content","Copyright Infringement","Spam","Other"],t.close=function(e){o.cancel(e)},t.report=function(){var i=e.getTop();e.close(i.key),n.showBusyDuring(r.all("inappropriatecontent").all("report").one(c,l.id).post("",{reason:t.formData.reason,details:t.formData.details}).then(function(){o.showMessage("inappropriate_content_report_success")},function(){o.showMessage("inappropriate_content_report_error")}))}}],focusAfterClosed:s.currentTarget};o.open(a)})}}e.$inject=["$modalStack","$translate","BulbBusyCoverService","BulbModalService","CONFIG","Restangular"],angular.module("bulbApp.inappropriateContentModule").service("BulbInappropriateContentService",e)}(),angular.module("bulbApp.inappropriateContentModule").directive("bulbInappropriateContentButton",["$translate","BulbInappropriateContentService","CONFIG",function(e,t,n){return{restrict:"E",templateUrl:n.resource.cdnRoot+"ajs/components/inappropriatecontent/inappropriatecontentbutton.html",scope:{unit:"="},link:function(n,o,i){n.inappropriateContentService=t,o.on("keypress",function(e){13!==e.keyCode&&32!==e.keyCode||t.openModal(n.unit)});e("inappropriate_content_btn_tooltip_unreported",{type:t.getType(n.unit)}).then(function(e){n.tooltip=e})}}}]),angular.module("bulbApp.iziToastModule",[]).constant("IZITOAST",{defaultOptions:{theme:"dark",timeout:2e3,close:!1,icon:"fas fa-inbox",position:"center",progressBarColor:"rgb(0,174,239)"}}).value("iziToast",window.iziToast).service("BulbToastService",BulbToastService),angular.module("bulbApp.jplayerModule",["bulbApp.errorModule","bulbApp.scriptLoaderModule"]).constant("JPLAYER",{defaultOptions:{swfPath:"https://d88n5qxmt9dn1.cloudfront.net/jPlayer-2.9.2/dist/jplayer/jquery.jplayer.swf",supplied:"mp3, mp4, wav",backgroundColor:"#737c89",volume:.5,muted:!1,smoothPlayBar:!0,toggleDuration:!0,remainingDuration:!0,useStateClassSkin:!0,autoBlur:!1,errorAlerts:!1,warningAlerts:!1},bitrate:[32,96,128,192]}),angular.module("bulbApp.jplayerModule").directive("bulbJplayer",["$timeout","BulbBitRateService","BITRATE","CONFIG","JPLAYER","_",function(e,t,n,o,i,r){return{restrict:"E",require:"?^contentBlock",scope:{targetEntry:"="},link:function(o,r,a,s){if(!angular.isString(a.targetEntry))throw"bulb-jplayer requires an targetEntry attribute";function l(e,t,n){var o=t[e];return 0===e?o.url:o.bitrate>=n?o.url:l(e-1,t,n)}var c,u,d={};c=o.targetEntry.id,u=o.targetEntry.audio,d={playerId:c,transcodedAssets:[]},u.transcodedAssets.forEach(function(e){d.transcodedAssets.push({url:e.url,bitrate:e.bitrate})}),t.getOptimalQuality(function(t){var o,r,a=t>=n.defaultOptions.highestBoundBitrate?n.defaultOptions.highestBoundBitrate/1e4:t/1e4,c=d.transcodedAssets.length-1,u={};s?(o="#jquery_jplayer_"+d.playerId,r={volume:$(".jp-volume-bar_"+d.playerId)},u={volumeBar:".jp-volume-bar_"+d.playerId,volumeBarValue:".jp-volume-bar-value_"+d.playerId,volumeMax:".jp-volume-max"},e(function(){$(o).jPlayer({ready:function(e){r.volume.find(u.volumeBarValue).width(parseInt(100*e.jPlayer.options.volume)+"%"),$(this).jPlayer("setMedia",{mp3:l(c,d.transcodedAssets,a)}),function(e){$(e).bind($.jPlayer.event.play,function(){$(this).jPlayer("pauseOthers")})}(o)},volumechange:function(e){e.jPlayer.options.muted?r.volume.find(u.volumeBarValue).width(0):r.volume.find(u.volumeBarValue).width(parseInt(100*e.jPlayer.options.volume)+"%")},swfPath:i.defaultOptions.swfPath,supplied:i.defaultOptions.supplied,volume:i.defaultOptions.volume,useStateClassSkin:i.defaultOptions.useStateClassSkin,cssSelectorAncestor:"#jp_container_"+d.playerId,cssSelector:u,autoBlur:i.defaultOptions.autoBlur,smoothPlayBar:i.defaultOptions.smoothPlayBar,remainingDuration:i.defaultOptions.remainingDuration,toggleDuration:i.defaultOptions.toggleDuration})})):(r={volume:$(".jp-volume-bar")},u={volumeBar:".jp-volume-bar",volumeBarValue:".jp-volume-bar-value",volumeMax:".jp-volume-max"},o="#jquery_jplayer_1",$(o).jPlayer({ready:function(e){r.volume.find(u.volumeBarValue).width(parseInt(100*e.jPlayer.options.volume)+"%"),$(this).jPlayer("setMedia",{mp3:l(c,d.transcodedAssets,a)})},volumechange:function(e){e.jPlayer.options.muted?r.volume.find(u.volumeBarValue).width(0):r.volume.find(u.volumeBarValue).width(parseInt(100*e.jPlayer.options.volume)+"%")},swfPath:i.defaultOptions.swfPath,supplied:i.defaultOptions.supplied,volume:i.defaultOptions.volume,useStateClassSkin:i.defaultOptions.useStateClassSkin,cssSelectorAncestor:"#jp_container_1",cssSelector:u,autoBlur:i.defaultOptions.autoBlur,smoothPlayBar:i.defaultOptions.smoothPlayBar,remainingDuration:i.defaultOptions.remainingDuration,toggleDuration:i.defaultOptions.toggleDuration}))})}}}]),angular.module("bulbApp.jwplayerModule",["bulbApp.errorModule","bulbApp.scriptLoaderModule"]).constant("JWPLAYER",{defaultOptions:{autostart:!1,controls:!0,displaydescription:!1,displaytitle:!1,flashplayer:"https://d88n5qxmt9dn1.cloudfront.net/jwplayer-7.2.2/jwplayer.flash.swf",height:"100%",mute:!1,ph:1,primary:"html5",repeat:!1,skin:{active:"#ffffff",inactive:"#4bb0dd",name:"bekle",background:"#4f5967"},stagevideo:!1,stretching:"uniform",visualplaylist:!1,width:"100%",timeout:250}}),angular.module("bulbApp.jwplayerModule").directive("bulbJwplayer",["$timeout","BulbBrowserService","BulbErrorService","BulbScriptLoaderService","CONFIG","JWPLAYER",function(e,t,n,o,i,r){return{restrict:"E",require:["^?contentEditor","^?contentBlock"],scope:{video:"=",audio:"=",playerId:"=",splashImageUrl:"="},link:function(a,s,l,c){var u=c[0],d=c[1];o.load({src:i.vendor.jwplayer.url,reference:"jwplayer",timeout:2e4}).then(function(n){if(!angular.isString(l.video)&&!angular.isString(l.audio))throw"bulb-jwplayer requires a video or audio attribute";function o(e){for(var t=!1,n=0;n<e.length;n++)if("mp3"===e[n].type){t=!0;break}return t}function c(e){return jQuery("#content-block-"+d.contentBlock.id).find(".jw-controls").find(".jw-controlbar").find(".jw-controlbar-"+e+"-group")}s.on("click",function(e){e.stopPropagation()}),n.key=i.vendor.jwplayer.key,n.defaults=r.defaultOptions;var p=null,h=function(o,i,l){var c=null;p&&p();var u=[];switch(o.jspType){case"ASSET":o.transcodedAssets.forEach(function(e){Math.min(e.width,e.height)>620&&t.isChromeBook()||u.push({file:e.url,label:e.height})}),d(i,u,l||o.splashImage.url);break;case"YOUTUBE":u.push({file:o.videoHref}),d(i,u,l||o.videoSplashImageHref);break;default:throw"Unknown type: "+o.jspType}function d(o,i,a){$(s).empty(),s.append('<div id="'+o+'"></div>'),(c=n(o)).setup({image:a,sources:i,plugins:{"//d88n5qxmt9dn1.cloudfront.net/getvideodata.js":{}}}),t.isFireFox()&&"assetlibrary-detail-modal-player"!==o&&e(function(){s.find('div[id="'+o+'"]').css("height",s[0].style.height)},r.defaultOptions.timeout)}p=a.$on("bulb-video-play-toggle",function(e,t){i===t&&c.play()})};a.video?h(a.video,a.playerId,a.splashImageUrl):a.audio&&"TRANSCODING"!==a.audio.jspType&&function(t,i){var a=null,l=[];t.transcodedAssets.forEach(function(e){l.push({file:e.url,bitrate:e.bitrate})}),function(e,t){s.empty(),s.append('<div id="'+e+'"></div>'),(a=n(e)).setup({sources:t,height:"40px"})}(i,l),e(function(){if(d){var e=jQuery("#"+d.contentBlock.id),t=c("center"),i=c("right");t.css("pointer-events","none"),i.css("pointer-events","none"),jQuery("#content-block-"+d.contentBlock.id).find(".jw-controls").click(function(){u.insertBlockExtension.selectBlock(e[0])}),a.on("play",function(){t.css("pointer-events",""),i.css("pointer-events",""),u.insertBlockExtension.selectBlock(e[0]);for(var r=jQuery(".jwplayer"),a=0;a<=r.length;a++){var s=r[a],l=o(n(s).getConfig().sources);s.id!==this.id&&l&&n(s).play(!1)}}),a.on("pause",function(){t.css("pointer-events","none"),i.css("pointer-events","none")})}},r.defaultOptions.timeout)}(a.audio,a.playerId),a.$watchGroup(["video.id","video.splashImage.url"],function(){a.video&&h(a.video,a.playerId,a.splashImageUrl)})}).catch(function(e){n.showError(e)})}}}]),angular.module("lodash",[]).factory("_",["$window",function(e){return e._}]),angular.module("bulbApp.modalModule",["mm.foundation","bulbApp.configModule","bulbApp.translateModule","bulbApp.utilsModule"]).constant("MODAL_ARIA",{OpenDialogList:[],Utils:{IgnoreUtilFocusChanges:!1,dialogOpenClass:"has-dialog"},MODAL_TIMEOUT:100,AERO_DIALOG_KEY:"aero-dialog"}).run(["$rootScope","MODAL_ARIA",function(e,t){e.MODAL_ARIA=t}]),function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c,u){var d=this;var p={templateUrl:c.resource.cdnRoot+"ajs/components/modal/modal.html"},h={titleCode:"modal_default_title",bodyCode:"modal_default_body",offline:!1,okButtonCode:"button_ok",cancelButtonCode:"button_cancel",showOkButton:!0,showCancelButton:!0,keyboard:!0,backdrop:!0,closeOnClick:!0};this.open=function(e){var n=angular.extend({},h,e);n.bodyText&&(n.bodyText=i.trustAsHtml(n.bodyText));var r=e.offline?{}:angular.copy(p);r.scope=n.scope?o.$new(!1,n.scope):o.$new(),r.scope.customOptions=n,r.controller=n.controller,n.scope&&(r.scope=n.scope),r.controllerAs=n.controllerAs,r.parent=n.parent||r.parent,r.windowClass=n.windowClass||r.windowClass,r.backdrop=n.backdrop,!1===n.keyboard&&(r.keyboard=n.keyboard),r.closeOnClick=n.closeOnClick,r.templateUrl=r.templateUrl||n.templateUrl;var a=t.open(r);return a.focusAfterClosed=e.focusAfterClosed,this.setAccessibilityOnModal(a),a},this.generateObjectId=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})},this.setAccessibilityOnDialog=function(e){r(function(){var t=$('div[role="dialog"]');if(t.length>0)for(var n=0;n<t.length;n++){var o=$(t[n]);if(void 0===o.attr("id")){var i=d.setTabOrderOnModal(o);if(1===o.length){$(".reveal-modal-bg").attr("role","none");var r=o.attr("id");new u.Dialog(r,e,i)}}}},u.MODAL_TIMEOUT)},this.setAccessibilityOnModal=function(e){e.opened.then(function(){r(function(){var t=$('div[role="dialog"]');if(t.length>0)for(var n=0;n<t.length;n++){var o=$(t[n]);if(void 0===o.attr("id")){var i=d.setTabOrderOnModal(o);if(1===o.length){$(".reveal-modal-bg").attr("role","none");var r=o.attr("id"),a=$(e.focusAfterClosed),s=localStorage.getItem(u.AERO_DIALOG_KEY);if(s){var l=JSON.parse(s);1===u.OpenDialogList.length&&l.modalClass.includes("aero-dynamic-dialog")&&(i=$("."+l.lastFocusClass.split(" ")[0]),a=u.OpenDialogList[0].focusAfterClosed,localStorage.removeItem(u.AERO_DIALOG_KEY),u.OpenDialogList.pop())}new u.Dialog(r,a,i)}}}},u.MODAL_TIMEOUT)})},this.show=function(e){return this.open(e).result},this.showCustomModal=function(e){var n=t.open(e);return n.focusAfterClosed=e.focusAfterClosed,this.setAccessibilityOnModal(n),n},this.cancel=function(e){e.preventDefault(),e.stopPropagation(),this.clearDialog(e)},this.clearDialog=function(e){var t=n.getTop();t&&t.value.backdrop&&"static"!==t.value.backdrop&&e.target===e.currentTarget&&n.dismiss(t.key,"backdrop click");var o=u.getCurrentDialog();o&&(d.setAeroDialogModal(o),r(function(){u.closeCurrentDialog()&&e.stopPropagation()},u.MODAL_TIMEOUT))},this.alert=function(e){return this.open(e)},this.showModalOnlyOnce=function(e,t,n,o,i,r){return this.open(e).result.then(function(){"function"==typeof t&&t()&&t()},function(){"function"==typeof n&&n()&&n()}).finally(function(){var e=$("#showModalOnlyOnce").is(":checked");e&&function(e,t,n,o){var i={},r={};i[t]=e,r.prefs=i,l.one("accounts",n.currentUser.id).patch(r).then(function(e){n.setCurrentUser(e)}).catch(function(e){o.handleException(e)})}(e,o,i,r)})},this.showMessage=function(e,t,n){return a(e,n).then(function(e){var n={titleCode:"",showOkButton:!0,showCancelButton:!1,templateUrl:c.resource.cdnRoot+"ajs/components/modal/message-modal.html",windowClass:"scrollable",controller:["$scope",function(t){t.message=e}]};return d.open(angular.extend({},n,t))})},this.initScrollableModalLayoutHandler=function(e){var t=$("body > .bulb-main").eq(0),n=$("body").find(".modal-bg-outer"),o=function(){return $("body").scrollTop()||$("html").scrollTop()},i=o(),r=null,a=function(){var e=Foundation.utils.is_small_only();null!==r&&r===e||(e||(i=o(),t.css("width","100%")),r=e)};$(s).on("resize",a),a(),t.css("position","fixed"),t.css("top",-i),n.css("position","absolute"),Foundation.utils.is_small_only()||($("body").css("overflow","hidden"),n.attr("style",function(e,t){return t+"top:"+i+"px !important;"})),Foundation.utils.is_small_only()&&$("body,html").scrollTop(0),e.$on("$destroy",function(){$(s).off("resize",a),d.getTopModalElement()||($("body").css("overflow",""),t.css("position",""),t.css("top",""),n.css("position",""),t.css("width","")),$("body,html").scrollTop(i)})},this.getTopModalElement=function(){var e=n.getTop();return e?$(e.value.modalDomEl[0]):null},this.dismissAllModals=function(){n.dismissAll()},this.setTabOrderOnModal=function(e){var t,n=d.generateObjectId();e.attr("id",n),void 0===e.attr("aria-label")&&e.attr("aria-label","modal"),void 0===e.attr("aria-modal")&&e.attr("aria-modal","true");var o=$(".bulb-modal-body h1");e.attr("class").includes("aero-dynamic-dialog")&&(o=$(".audio-recording-container h1"));for(var i=0;i<o.length;i++){var r=$(o[i]);if(void 0===r.attr("id")&&""!==$(r).text()){r.attr("tabindex","0"),t=r;break}}var a=$(".bulb-modal-content").find(":focusable");if(0===a.length)$(a.prevObject).attr("tabindex","0"),$(a.prevObject).attr("role","heading"),$(a.prevObject).attr("aria-level","2"),t||(t=$(a.prevObject));else if(1===a.length&&a.hasClass("ps__scrollbar-y")){$(a.prevObject).attr("tabindex","0"),$(a.prevObject).attr("role","heading"),$(a.prevObject).attr("aria-level","2"),t||(t=$(a.prevObject));var s=$(".ps__scrollbar-x-rail");s.length>0&&($(s[0]).attr("id","scroll-id"),$(".ps__scrollbar-y").attr("aria-controls","scroll-id"))}else for(var l=0;l<a.length;l++){var c=$(a[l]);if(!c.is("form")){c.attr("tabindex","0"),t||(t=c);break}}return t},this.setAeroDialogModal=function(e){var t={modalClass:$(e.dialogNode).attr("class"),lastFocusClass:$(e.focusAfterClosed).attr("class")};t.modalClass.includes("aero-dynamic-dialog")&&localStorage.setItem(u.AERO_DIALOG_KEY,JSON.stringify(t))},o.$watch(function(){return n.getTop()},function(e,t){var n=!1,o=null,i=null;e&&e.value&&(n=(o=$(e.value.modalDomEl[0])).find(".bulb-modal-body").eq(0).children(".bulb-busy").length>0),t&&t.value&&(i=$(t.value.modalDomEl[0])),o&&o.stop().fadeIn(50),!n&&i&&i.stop().fadeOut(u.MODAL_TIMEOUT)}),u.Utils.remove=function(e){return e.remove&&"function"==typeof e.remove?e.remove():!(!e.parentNode||!e.parentNode.removeChild||"function"!=typeof e.parentNode.removeChild)&&e.parentNode.removeChild(e)},u.Utils.isFocusable=function(e){if(e.tabIndex>0||0===e.tabIndex&&null!==e.getAttribute("tabIndex"))return!0;if(e.disabled)return!1;switch(e.nodeName){case"A":return!!e.href&&"ignore"!==e.rel;case"INPUT":return"hidden"!==e.type&&"file"!==e.type;case"BUTTON":case"SELECT":case"TEXTAREA":return!0;default:return!1}},u.Utils.focusFirstDescendant=function(e){for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(u.Utils.attemptFocus(n)||u.Utils.focusFirstDescendant(n))return!0}return!1},u.Utils.focusLastDescendant=function(e){for(var t=e.childNodes.length-1;t>=0;t--){var n=e.childNodes[t];if(u.Utils.attemptFocus(n)||u.Utils.focusLastDescendant(n))return!0}return!1},u.Utils.attemptFocus=function(e){if(!u.Utils.isFocusable(e))return!1;u.Utils.IgnoreUtilFocusChanges=!0;try{e.focus()}catch(e){}return u.Utils.IgnoreUtilFocusChanges=!1,document.activeElement===e},u.getCurrentDialog=function(){if(u.OpenDialogList&&u.OpenDialogList.length)return u.OpenDialogList[u.OpenDialogList.length-1]},u.closeCurrentDialog=function(){var e=u.getCurrentDialog();return!!e&&(e.close(),!0)},u.handleEscape=function(e){if("Escape"===e.key){var t=n.getTop();t&&n.dismiss(t.key,"backdrop click");var o=u.getCurrentDialog();o&&(d.setAeroDialogModal(o),u.closeCurrentDialog()&&e.stopPropagation())}},document.addEventListener("keyup",u.handleEscape),u.Dialog=function(e,t,n,o){this.dialogNode=document.getElementById(e),null===this.dialogNode&&o.handleException(new Error('No element found with id="'+e+'".'));var i=["dialog","alertdialog"];(this.dialogNode.getAttribute("role")||"").trim().split(/\s+/g).some(function(e){return i.some(function(t){return e===t})})||o.handleException(new Error("Dialog() requires a DOM element with ARIA role of dialog or alertdialog."));this.dialogNode.parentNode.classList.contains("dialog-backdrop")?this.backdropNode=this.dialogNode.parentNode:(this.backdropNode=document.createElement("div"),this.backdropNode.className="dialog-backdrop",this.dialogNode.parentNode.insertBefore(this.backdropNode,this.dialogNode),this.backdropNode.appendChild(this.dialogNode)),this.backdropNode.classList.add("active"),document.body.classList.add(u.Utils.dialogOpenClass),"string"==typeof t?this.focusAfterClosed=document.getElementById(t):"object"==typeof t?this.focusAfterClosed=t:o.handleException(new Error("the focusAfterClosed parameter is required for the MODAL_ARIA.Dialog constructor.")),this.focusFirst="string"==typeof n?document.getElementById(n):"object"==typeof n?n:null,u.OpenDialogList.length>0&&u.getCurrentDialog().removeListeners(),this.addListeners(),u.OpenDialogList.push(this),this.focusFirst?this.focusFirst.focus():u.Utils.focusFirstDescendant(this.dialogNode),this.lastFocus=document.activeElement},u.Dialog.prototype.clearDialog=function(){Array.prototype.map.call(this.dialogNode.querySelectorAll("input"),function(e){e.hasAttribute("readonly")||(e.value="")})},u.Dialog.prototype.close=function(){if(u.OpenDialogList.pop(),this.removeListeners(),this.preNode&&u.Utils.remove(this.preNode),this.postNode&&u.Utils.remove(this.postNode),this.dialogNode.className="hidden",this.backdropNode.classList.remove("active"),$(this.focusAfterClosed).hasClass("bulb-insert-block-buttons-media")){var e=$(".bulb-insert-block-buttons-media").parent().parent();$(e.find("p")[0]).addClass("bulb-media-active"),$(e.find("div")[0]).removeClass("hide"),e.attr("data-medium-focused","true")}var t=$(".ui-widget-overlay");1===t.length&&t.remove(),this.focusAfterClosed.focus(),u.OpenDialogList.length>0?u.getCurrentDialog().addListeners():document.body.classList.remove(u.Utils.dialogOpenClass)},u.Dialog.prototype.addListeners=function(){document.addEventListener("focus",this.trapFocus,!0)},u.Dialog.prototype.removeListeners=function(){document.removeEventListener("focus",this.trapFocus,!0)},u.Dialog.prototype.trapFocus=function(e){if(!u.Utils.IgnoreUtilFocusChanges){var t=u.getCurrentDialog();t.dialogNode.contains(e.target)?t.lastFocus=e.target:(u.Utils.focusFirstDescendant(t.dialogNode),t.lastFocus===document.activeElement&&u.Utils.focusLastDescendant(t.dialogNode),t.lastFocus=document.activeElement)}}}e.$inject=["$interval","$modal","$modalStack","$rootScope","$sce","$timeout","$translate","$window","Restangular","CONFIG","MODAL_ARIA"],angular.module("bulbApp.modalModule").service("BulbModalService",e)}(),angular.module("bulbApp.onboardingModule",["badwing.autoselect","mm.foundation","restangular","bulbApp.busyModule","bulbApp.configModule"]),function(){"use strict";function e(e,t,n,o,i){var r=this;t.currentUser.hasRole(i.ROLES.SWITCHED_USER)&&(r.switchedUser=!0),this.onboarding=function(){e.$close&&e.$close()},this.welcome=function(){r.switchedUser||o.open({template:"",windowClass:"bulb-onboarding-modal",backdrop:"static",closeOnClick:!1,showOkButton:!1,showCancelButton:!1})}}e.$inject=["$scope","BulbAuthService","BulbOnboardingService","BulbModalService","AUTH"],angular.module("bulbApp.onboardingModule").controller("OnboardingController",e)}(),angular.module("bulbApp.onboardingModule").directive("bulbOnboardingNeedsUpgrade",["BulbUnitService","CONFIG",function(e,t){return{restrict:"E",templateUrl:t.resource.cdnRoot+"ajs/components/onboarding/onboarding-needs-upgrade-modal.html",controller:"OnboardingController as onboardingCtrl",link:function(t,n,o){t.onboardingCtrl.unit=e.currentUnit}}}]),function(){"use strict";function e(e,t,n){e.currentUser.hasRole(n.ROLES.SWITCHED_USER)&&(this.swichedUser=!0),this.displayNeedsUpgradeDialog=function(){return t.open({titleCode:"",template:"<bulb-onboarding-needs-upgrade></bulb-onboarding-needs-upgrade>",windowClass:"bulb-onboarding-modal-with-close scrollable",closeOnClick:!0,showOkButton:!1,showCancelButton:!1})}}e.$inject=["BulbAuthService","BulbModalService","AUTH"],angular.module("bulbApp.onboardingModule").service("BulbOnboardingService",e)}(),angular.module("bulbApp.openGraphModule",["bulbApp.configModule"]).constant("OPEN_GRAPH",{defaultImage:{url:"resources/images/bulb_logo_social_media_default.jpg",width:478,height:250}}).value("openGraphValues",{"og:site_name":"bulb"}).run(["$rootScope","openGraphValues","CONFIG","OPEN_GRAPH",function(e,t,n,o){t["og:image"]=n.resource.cdnRoot+o.defaultImage.url,t["og:image:width"]=o.defaultImage.width,t["og:image:height"]=o.defaultImage.height,e.$watch("$title",function(e){t["og:title"]=e||"bulb"})}]),function(){"use strict";var e={"og:description":0,"og:image":0};angular.module("bulbApp.openGraphModule").directive("bulbOpenGraph",["openGraphValues","CONFIG","OPEN_GRAPH",function(t,n,o){return{restrict:"A",link:function(i,r,a){if(!angular.isString(a.bulbOpenGraph))throw"bulb-open-graph's value must be a string";switch(a.bulbOpenGraph){case"og:description":e["og:description"]++,i.$watch(function(){return r.text()},function(e){t["og:description"]=e}),i.$on("$destroy",function(){e["og:description"]--,e["og:description"]<=0&&(e["og:description"]=0,delete t["og:description"])});break;case"og:image":e["og:image"]++,a.$observe("src",function(e){t["og:image"]=e}),a.bulbOpenGraphImageWidth?a.$observe("bulbOpenGraphImageWidth",function(e){e?t["og:image:width"]=e:delete t["og:image:width"]}):delete t["og:image:width"],a.bulbOpenGraphImageHeight?a.$observe("bulbOpenGraphImageHeight",function(e){e?t["og:image:height"]=e:delete t["og:image:height"]}):delete t["og:image:height"],i.$on("$destroy",function(){e["og:image"]--,e["og:image"]<=0&&(e["og:image"]=0,t["og:image"]=n.resource.cdnRoot+o.defaultImage.url,t["og:image:width"]=o.defaultImage.width,t["og:image:height"]=o.defaultImage.height)});break;default:throw'unrecognized value for bulb-open-graph.  Should be "og:description" or "og:image"'}}}}])}(),angular.module("bulbApp.pageViewModule",["angular-bind-html-compile","focus-if","slickCarousel","thatisuday.ng-image-gallery","vimeoEmbed","xregexp","bulbApp.ajaxModule","bulbApp.authModule","bulbApp.autoSaveModule","bulbApp.bitRateModule","bulbApp.browserModule","bulbApp.configModule","bulbApp.contentEditorModule","bulbApp.contentSelectorModule","bulbApp.coverImageModule","bulbApp.errorModule","bulbApp.filtersModule","bulbApp.imageEditorModule","bulbApp.openGraphModule","bulbApp.pageModule","bulbApp.jwplayerModule","bulbApp.jplayerModule","bulbApp.permissionsModule","bulbApp.recommendModule","bulbApp.shareModule","bulbApp.translateModule","bulbApp.iziToastModule","bulbApp.unitModule","bulbApp.uploadModule","bulbApp.utilsModule"]),function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c,u,d,p,h,g,m,f,b,v,C,y,w,A,_,E,S,T){var I=this;if(this.page=y.page,this.parentUnit=_.parentUnit,this.previousUnit=_.previousSibling,this.navigationAwayApproval=!1,this.nextUnit=_.nextSibling,this.page.mode=a.current.data.mode||"default",this.page.editing=this.page.canEdit&&"default"===this.page.mode,jQuery("body").on("dragover drop",function(e){e.preventDefault(),e.stopPropagation()}),!1===I.page.editing)var B=0,k=e(function(){if(B<20){B++;var t=jQuery(".bulb-page-content");1===t.length&&l("pageview_content_label").then(function(n){t.attr("aria-label",n),e.cancel(k)})}else B>=20&&e.cancel(k)},100);var U=o.$on("update-page-details",function(){I.page=y.page,I.page.mode=a.current.data.mode||"default",I.page.editing=I.page.canEdit&&"default"===I.page.mode});i.$on("$destroy",U),this.page.canEdit&&(i.$on("navigationAwayApproval",function(e,t){I.navigationAwayApproval=t}),i.$on("$stateChangeStart",function(e,t,n,o,i){("unit.page"===o.name&&"preview_page"===t.name||"preview_page"===o.name&&"unit"===t.name)&&P(),i.unitPath===n.unitPath||I.navigationAwayApproval||"modified"!==I.publishStatus&&"unpublished"!==I.publishStatus||"live_page"===o.name||"preview_page"===o.name||"live_page"===t.name||"preview_page"===t.name||"presentation_page"===o.name||"presentation_page"===t.name||(e.preventDefault(),I.handleNavigationFromUnpublishedPage(t,n))})),this.handleNavigationFromUnpublishedPage=function(e,t){if(-1!==h.currentUser.features.PublishingFeature.maxPublishedPages&&h.currentUser.metrics.numPublishedPages>=h.currentUser.features.PublishingFeature.maxPublishedPages&&!_.currentUnit.isPublished)return I.navigationAwayApproval=!0,void a.go(e,t);C.show({okButtonCode:"pageview_unpublished_changes_publish",cancelButtonCode:"pageview_unpublished_changes_ignore",showCancelButton:!0,showOkButton:!0,titleCode:"pageview_unpublished_changes_title",bodyCode:"pageview_unpublished_changes_description"}).then(function(){var n={toState:e,toParams:t};s(function(){o.$broadcast("togglePanel","publish",n)})},function(){I.navigationAwayApproval=!0,a.go(e,t)})};function O(e){if(!e)return"";var t=e.toLowerCase().trim();return t=(t=(t=(t=(t=(t=t.replace(/[:\/?#\\[\]@!\$&\'\(\)\*\+,;=.~"<>%\{}\|\^`]/g," ")).replace(/_\s/g,"-")).replace(/\\ufffd/g,"-")).replace(/-+/g,"-")).replace(/^-+/g,"")).replace(/-+$/g,"")}this.page.unit.content||(this.page.unit.content="<p><br/></p>"),this.getPlaceholder=function(){return Foundation.utils.is_small_only()?"pageview_content_placeholder_short":"pageview_content_placeholder"},this.page.canEdit||"default"===this.page.mode||"presentation"===this.page.mode||a.go("accessDenied",{},{location:!1}),this.page.editing||(this.trustedContent=r.trustAsHtml(this.page.unit.content)),_.fetchParent(),this.page.unit.isPublished?this.publishStatus=this.page.unit.isModified?"modified":"published":this.publishStatus="unpublished",I.page.unit.coverImage?this.openGraphImage=I.page.unit.coverImage:I.page.unit.horizontalImage&&(this.openGraphImage=I.page.unit.horizontalImage),this.page.editing&&(h.currentUser.prefs.importingGoogleAssetAsPdfEnabled&&h.currentUser.connections.googleOAuthToken?p.updateSnapshotPdf(I.page.unit):h.currentUser.prefs.onBoarding.onboardingShowPageTour||h.currentUser.prefs.onBoarding.onboardingShowPageIntro||p.enableSnapshotPdf("page"),h.currentUser.prefs.onBoarding.onboardingShowPageIntro?s(function(){E.startPageIntro()},2e3):h.currentUser.prefs.onBoarding.onboardingShowPageTour&&s(function(){E.startPageTour()},2e3)),this.getContent=function(){return I.page.unit.content},this.defaultAutoSaveOptions={restId:I.page.unit.id,restCollection:"units"},this.contentAutoSaveOptions=angular.copy(this.defaultAutoSaveOptions),this.contentAutoSaveOptions.getter=this.getContent,this.edit=function(){a.go("unit",{unitPath:this.page.unit.path},{location:"replace"})},this.coverImageMode="default",this.coverImageEdit=null,this.isImageEditorActive=!1,this.isImageEditorMoving=!1,this.isCoverImageUploadActive=!1,this.isPresentationMode=w.isFullScreen(),this.page.coverImageLayout="default",this.onCoverImageUploaded=function(e){var t=n.defer();if(e){var o=T.coverimage;e.image.width<o.minwidth||e.image.height<o.minheight?(t.reject({message:"invalid image size (too small)."}),b.calculateCoverImageSize(e,o,I,"pageView")):e.image.width>o.maxwidth||e.image.height>o.maxheight?(d.dialog.showError("error_validation_image_size_large",{width:o.maxwidth,height:o.maxheight}),t.reject({message:"invalid image size (too large)."})):(I.coverImageMode="editor",I.isCoverImageUploadActive=!1,I.coverImageEdit={isNew:!I.page.unit.coverImage,asset:{id:e.image.id,assetDefinitionsKey:"coverImage",url:e.image.url,width:e.image.width,height:e.image.height},cropType:"CROP_COVER_IMAGE"},t.resolve())}else t.reject({message:"invalid entry"});var i=$(".bulb-main").parent();return i.hasClass("bulb-aria-hide")&&i.removeClass("bulb-aria-hide"),t.promise},this.editCoverImage=function(){var e=I.page.unit.coverImage.id;f.showBusyDuring(c.one("images",e).customGET("originalimage/coverImage").then(function(e){I.coverImageEdit={isNew:!I.page.unit.coverImage,asset:{id:e.id,assetDefinitionsKey:"coverImage",url:e.url,width:e.width,height:e.height,center:{X:e.centerX,Y:e.centerY}},cropType:"CROP_COVER_IMAGE"},I.coverImageMode="editor",I.isCoverImageUploadActive=!1},function(e){v.error("Cannot get original image for cover image",e)}))},this.onCoverImageEditComplete=function(e){var t=n.defer();if(I.edit=null,e){var o={assetId:e.asset.id,assetDefinitionsKey:"coverImage",centerX:e.center.X,centerY:e.center.Y};c.one("units",I.page.unit.id).customPOST(o,"coverimage").then(function(e){var n=e.plain();_.setCurrentUnit(n),A.updateRecommend(n),t.resolve(!0)},function(e){var n=v.error("Cannot update unit cover image",e);t.reject(n)})}else I.coverImageMode="default",I.isCoverImageUploadActive=!1,t.resolve(!0);return t.promise},this.onCoverImageDelete=function(){return c.one("units",I.page.unit.id).customDELETE("coverimage").then(function(e){var t=e.plain();_.setCurrentUnit(t),A.updateRecommend(t),a.reload()},function(e){v.error("Cannot delete page cover image",e)})},this.deleteCoverImage=function(){l("cover_image_type").then(function(e){l("modal_delete_confirm_body",{type:e}).then(function(e){C.show({titleCode:"modal_delete_confirm_title",bodyText:e,fontAwesomeCode:"fas fa-trash-alt",windowClass:"updated-modal-design updated-bulb-delete-modal",okButtonCode:"button_delete"}).then(function(){f.showBusyDuring(I.onCoverImageDelete())})})})},i.$watch("pageViewCtrl.page.unit.name",function(e){var n="";if("ArchivePageUnit"===I.page.unit.unitType)n="/u/"+(O(e)+"~a"+I.page.unit.id),t.path()!==n&&t.skipReload().path(n).replace();else if("PublishedPageUnit"!==I.page.unit.unitType&&!I.page.unit.isPublished){n="/u/"+(O(e)+"~i"+I.page.unit.id),t.path()!==n&&t.skipReload().path(n).replace()}});var M=s(function(){c.one("/unit/"+I.unit.id+"/viewcount").patch()},15e3);function P(){for(var e=$('div[id*="medium-editor-anchor-preview"]'),t=0;t<e.length;t++){var n=$(e[t]);n.attr("aria-hidden","true");var o=n.find("div"),i="medium-editor-toolbar-anchor-preview"+n.attr("id").split("-").slice(-1).pop();1===o.length&&o.attr("id")!==i&&o.attr("id",i)}for(var r=$('div[id*="medium-editor-toolbar"]'),a=0;a<r.length;a++){$(r[a]).attr("aria-hidden","true")}}i.$on("$destroy",function(){s.cancel(M)}),o.$on(S.EVENT,function(e,t){t.status===S.STATUS.SAVED&&t.restId===I.page.unit.id&&I.page.unit.isPublished&&(I.publishStatus="modified")});var D=0,R=e(function(){if(D<20){D++;var t=jQuery("#autosizejs");1===t.length&&(t.attr("aria-label","dummy-label"),t.attr("aria-hidden","true"),P(),e.cancel(R))}else D>=20&&e.cancel(R)},100)}e.$inject=["$interval","$location","$q","$rootScope","$scope","$sce","$state","$timeout","$translate","Restangular","XRegExp","BulbAssetLibraryService","BulbAssetLibrarySnapshotPdfService","BulbAuthService","BulbAutoSaveService","BulbBrowserService","BulbBusyService","BulbCoverImageService","BulbErrorService","BulbModalService","BulbPageService","BulbPresentationService","BulbRecommendService","BulbUnitService","TourService","AUTO_SAVE","CONFIG"],angular.module("bulbApp.pageViewModule").controller("PageViewController",e)}(),angular.module("bulbApp.pageViewModule").directive("bulbPageView",["$log","$state","$timeout","$window","Foundation","Restangular","BulbBusyService","BulbErrorService","BulbPresentationService","BulbRecommendService","BulbUnitService","CONFIG",function(e,t,n,o,i,r,a,s,l,c,u,d){return{restrict:"E",templateUrl:d.resource.cdnRoot+"ajs/components/pageview/pageview.html",controller:"PageViewController as pageViewCtrl",bindToController:{unit:"="},scope:!0,link:function(d,p,h){var g=d.pageViewCtrl;if(!angular.isString(h.unit))throw"bulb-auto-save requires a unit attribute";g.unit=d.$eval(h.unit);var m=jQuery(o),f=420;i.utils.is_large_up()||(f=m.height()/3);var b,v=function(){var t=i.utils.is_medium_up()?62:52,n=g.page.unit.coverImage;if(n){var o,r=jQuery(".bulb-cover-image"),a=l.isFullScreen(),s=a?l.getWidth():m.width(),c="",u="",p="",h="";d.style="",o=jQuery(".bulb-cover-image-banner").height()+t;var b=Math.max(f,o);a&&(b*=l.getWidth()/parseInt(m.width()),jQuery(".bulb-has-cover-image").css("min-height",b)),n.width/n.height>s/b?p=(s-(u=b)/n.height*n.width)/2:h=(b-(c=s)/n.width*n.height)/2;var v={width:c,height:u,top:h,left:p};e.debug("bulbCompositeView: setCoverImage: window width): "+s+" style: "+JSON.stringify(v,null,2)),r.css(v),d.style=v,jQuery(".bulb-unit-header").css({height:""})}else jQuery(".bulb-unit-header").css({height:""})};m.on("resize",function(){g.page.unit&&g.page.unit.coverImage&&v()}),d.$watch(function(){return jQuery(".bulb-cover-image-banner").height()},function(){v()}),d.$watchGroup(["pageViewCtrl.mode","pageViewCtrl.page.unit.coverImage.url","pageViewCtrl.page.unit.coverImage.width","pageViewCtrl.page.unit.coverImage.height"],function(e){"editor"!==e[0]&&n(v)}),g.cropStart=function(e){g.coverImageMode="editor",n(function(){var t=p.find(".cover-image-crop");t.attr("src",e.url);var n=p.find(".bulb-alt-cover-image-editor").width()/835,o=e.width/835,i=835/o*n,r=260/o*n;t.cropper({viewMode:3,checkCrossOrigin:!1,movable:!1,rotatable:!1,scalable:!1,zoomable:!1,zoomOnTouch:!1,zoomOnWheel:!1,minCropBoxWidth:i,minCropBoxHeight:r,data:e.cropRectangle}),b=e})},g.cropSave=function(){var e=p.find(".cover-image-crop").cropper("getData","rounded"),n={assetId:b.id,assetDefinitionsKey:"coverImage",cropRectangle:{x:e.x,y:e.y,width:e.width,height:e.height}};b=void 0,a.showBusyDuring(r.one("units",g.page.unit.id).customPOST(n,"coverimage").then(function(e){var t=e.plain();u.setCurrentUnit(t),c.updateRecommend(t)},function(e){s.error("Cannot update unit cover image",e)}).finally(function(){g.cropStop(),t.reload()}))},g.cropStop=function(){p.find(".cover-image-crop").cropper("destroy"),g.coverImageMode="default"}}}}]),function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c,u,d,p,h,g,m,f,b,v,C,y){var w=this;this.dataLayer=window.dataLayer||[],this.currentUserPrefs=s.currentUser.prefs,this.unit=e,this.canEdit=s.currentUser.hasPermission(this.unit,v.PERMISSIONS.UPDATE),this.canCopyTemplate=s.currentUser.isAuthenticated()&&this.unit.template&&("PublishedPageUnit"===this.unit.unitType||this.unit.isPublished),this.showQuestions=!1,this.loadedQuestions=!1,this.focusQuestion=!1,this.commentsOnPage=0,f.fetchParent().then(function(){w.parentUnit=f.parentUnit,w.previousUnit=f.previousSibling,w.nextUnit=f.nextSibling}),r(function(){w.commentsOnPage=u.getPageCommentsCount(),u.pageHasPrivateComments()&&"DraftPageUnit"===w.unit.unitType&&!w.unit.privateCommentModalShown&&w.canEdit&&w.showPrivateCommentModal(),u.pageHasArchivedComments()&&"DraftPageUnit"===w.unit.unitType&&!w.unit.archiveCommentModalShown&&w.canEdit&&w.showArchiveCommentModal()},1e3),this.showPrivateCommentModal=function(){p.show({titleCode:"private_comment_disabled_modal",bodyCode:"private_comment_disabled_modal_body",okButtonCode:"modal_convert",showOkButton:!0,showCancelButton:!0,fontAwesomeCode:"fas fa-exclamation-triangle",windowClass:"updated-modal-design private-comment-modal"}).then(function(){b.one("comment",w.unit.id).customPOST({confirm:!0},"convert?conversionType=private").then(function(){i.reload()})},function(){b.one("comment",w.unit.id).customPOST({confirm:!1},"convert?conversionType=private")})},this.showArchiveCommentModal=function(){p.show({titleCode:"archive_comment_disabled_modal",bodyCode:"archive_comment_disabled_modal_body",okButtonCode:"modal_convert",showOkButton:!0,showCancelButton:!0,fontAwesomeCode:"fas fa-exclamation-triangle",windowClass:"updated-modal-design private-comment-modal"}).then(function(){b.one("comment",w.unit.id).customPOST({confirm:!0},"convert?conversionType=archive").then(function(){i.reload()})},function(){b.one("comment",w.unit.id).customPOST({confirm:!1},"convert?conversionType=archive")})},this.copyPageAsTemplate=function(e){a("pageview_template_modal_description").then(function(t){var o={titleCode:"pageview_template_modal_title",bodyText:t,showOkButton:!0,showCancelButton:!0,fontAwesomeCode:"far fa-clone",windowClass:"updated-modal-design copy-template-modal",focusAfterClosed:e.currentTarget};p.show(o).then(function(){b.one("units",w.unit.id).customPOST({},"copyTemplate",{isArchive:!1}).then(function(){w.dataLayer.push({event:"TemplateCopyEvent",copiedUnitId:w.unit.id,copyToUserId:s.currentUser.id,copyType:"Page"})}),n.path("/"+s.currentUser.username)})})},this.toggleQuestions=function(e){w.showQuestions?w.showQuestions=!1:(this.focusQuestion=e,c.showBusyDuring(b.one("units",w.unit.id).getList("questions").then(function(e){w.questions=e,w.loadedQuestions=!0,w.showQuestions=!0;var o=n.hash();o&&o.indexOf("questions")>-1&&r(function(){t()})})))},this.deleteQuestion=function(e){p.show({titleCode:"pageview_delete_question_confirm_title",bodyCode:"pageview_delete_question_confirm_body",okButtonCode:"pageview_delete_question"}).then(function(){c.showBusyDuring(e.remove().then(function(){y.pull(w.questions,e)}))})},o.$on("$viewContentLoaded",function(e){"isAuthorized"===localStorage.getItem("isAuthorized")&&w.toggleRecommend()}),this.toggleRecommend=function(){if(localStorage.removeItem("isAuthorized"),s.currentUser.isAuthenticated())w.unit.likedByUser?(w.unit.likedByUser=!1,w.unit.likeCount--,g.deleteRecommend(w.unit).catch(function(){w.unit.likedByUser=!0,w.unit.likeCount++})):(w.unit.likedByUser=!0,w.unit.likeCount++,g.createRecommend(w.unit).catch(function(){w.unit.likedByUser=!1,w.unit.likeCount--}));else{var e="/u/"+this.unit.path,t=this.unit.id;p.open({titleCode:"",template:"<bulb-recommend-login></bulb-recommend-login>",windowClass:"updated-modal-design bulb-pageview-login-modal",closeOnClick:!0,showOkButton:!1,showCancelButton:!1,controller:["$scope",function(n){n.targetUrl=e,n.unitId=t}]})}},this.applyFocusToCommentSection=function(){$(".bulb-comment-lower-container textarea").first().focus()},this.submitQuestion=function(){var e={questionText:this.newQuestionText,unitId:this.unit.id};c.showBusyDuring(w.questions.post(e).then(function(e){w.questions.unshift(e),delete w.newQuestionText}))},this.submitAnswer=function(e){var t={answerText:e.answerText};c.showBusyDuring(e.patch(t).then(function(t){w.questions[w.questions.indexOf(e)]=t}))},this.startAnswering=function(e){e.answering=!0,e.originalAnswerText=e.answerText},this.cancelAnswer=function(e){e.answering=!1,e.answerText=e.originalAnswerText,delete e.originalAnswerText},this.signIn=function(){var e="u/"+this.unit.path+"#questions";i.go("signIn",{targetUrl:e})}}e.$inject=["unit","$anchorScroll","$location","$scope","$state","$timeout","$translate","BulbAuthService","BulbBrowserService","BulbBusyService","BulbCommentService","BulbErrorService","BulbModalService","BulbPresentationService","BulbRecommendService","BulbShareService","BulbUnitService","Restangular","AUTH","CONFIG","_"],angular.module("bulbApp.pageViewModule").controller("PageViewFooterController",e)}(),function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c){var u=this;function d(){p(),localStorage.setItem("isAuthorized","isAuthorized"),o.location.href=t.targetUrl}function p(){t.$close&&t.$close()}this.credentials={usernameOrEmail:"",password:""},this.signInUnsuccessful=!1,this.signInWithGoogleInProgress=!1,this.googleSignInReady=!1,this.runningInPWAEnvironment=a.isPWAEnvironment(),i.load&&i.load("auth2",function(){u.googleSignInReady=!0}),this.signIn=function(){s.showBusyDuring(r.signIn(u.credentials).then(d,function(e){u.signInUnsuccessful=!0}))},this.signInWithGoogle=function(){u.signInWithGoogleInProgress=!0,s.showBusyDuring(r.authenticateViaGoogle().then(function(e){u.signInWithGoogleInProgress=!1,p(),"not_found"===e.status?n.go("signUp",{mode:"connectGoogle",connection:e.connection,targetUrl:t.targetUrl}):d()},function(e){u.signInWithGoogleInProgress=!1,l.error("Cannot sign in with Google",e)}))},this.signInWithMicrosoft=function(){var e=t.targetUrl?"&targetUrl="+encodeURIComponent(t.targetUrl+"?uid="+t.unitId):"";o.location.href=c.context.name+"/b/auth/microsoft?entryMode=sign-in"+e},this.signInWithClever=function(){var e=t.targetUrl?"&targetUrl="+encodeURIComponent(t.targetUrl+"?uid="+t.unitId):"";o.location.href=c.context.name+"/b/auth/clever?entryMode=sign-in"+e},this.signUp=function(){p();var e=t.targetUrl?"&targetUrl="+encodeURIComponent(t.targetUrl):"";o.location.href=c.context.name+"/b/trybulb?entryMode=default"+e},this.forgotPassword=function(){n.go("resetPassword"),p()}}e.$inject=["$location","$scope","$state","$window","google","BulbAuthService","BulbBrowserService","BulbBusyService","BulbErrorService","CONFIG"],angular.module("bulbApp.pageViewModule").controller("PageViewFooterLoginController",e)}(),angular.module("bulbApp.pageViewModule").directive("bulbRecommendLogin",["CONFIG",function(e){return{restrict:"E",templateUrl:e.resource.cdnRoot+"ajs/components/pageview/pageviewfooter-login.html",controller:"PageViewFooterLoginController as pageViewFooterLoginCtrl"}}]),function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c,u,d,p,h,g,m,f,b,v,C,y,w,A,_,E,S,T){var I=this;this.currentUserPrefs=p.currentUser.prefs,this.unit=e,this.page=y.page,this.isPanelActive=!1,this.isShareActive=!1,this.isMobile=g.isMobile(),this.previewStateActive="preview_page"===a.current.name||"live_page"===a.current.name,this.autoSaveOptions={restId:I.page.unit.id,restCollection:"units"},this.autoSaveOptionsAccount={restId:p.currentUser.id,restCollection:"accounts"},this.updateArchivedCommentsEnabled=function(){f.showArchivedComments=!f.showArchivedComments,f.refreshBubbleButtons(),f.api.updateAccountPreferences()},this.canEdit=p.currentUser.hasPermission(this.unit,S.PERMISSIONS.UPDATE),this.canDelete=p.currentUser.hasPermission(this.unit,S.PERMISSIONS.DELETE),this.canArchivePage=p.currentUser.features.ArchiveFeature.enabled,this.canSharePage=p.currentUser.hasPermission(this.unit,S.PERMISSIONS.READ)&&!this.unit.archivedDate,this.canArchivePage&&i.$on(T.EVENT,function(e,t){t.status===T.STATUS.SAVING&&t.restId===I.page.unit.id&&I.page.unit.isPublished&&(I.archiveReady=!1)}),this.canArchivePage&&p.currentUser.isAuthenticated()&&(I.archiveReady=I.unit.isPublished&&!I.unit.isModified),this.canCopyTemplate=p.currentUser.isAuthenticated()&&this.unit.template&&("PublishedPageUnit"===this.unit.unitType||this.unit.isPublished),this.showQuestions=!1,this.loadedQuestions=!1,this.focusQuestion=!1,E.fetchParent().then(function(){I.parentUnit=E.parentUnit,I.previousUnit=E.previousSibling,I.nextUnit=E.nextSibling}),this.showingPanel=null,r.$on("togglePanel",function(e,t,n){I.togglePanel(t,n)}),this.closeMoreActionsDropDown=function(){Foundation.libs.dropdown.close($("#drop1"))},this.togglePanel=function(e,t){if(t&&(y.pendingStateChangeOnPublish=t),e&&e!==I.showingPanel){if(p.fetchCurrentUser(),-1!==p.currentUser.features.PublishingFeature.maxPublishedPages&&p.currentUser.metrics.numPublishedPages>=p.currentUser.features.PublishingFeature.maxPublishedPages&&!E.currentUnit.isPublished){return void C.show({templateUrl:"publish.tooManyPublishedPages.nested",titleCode:"error_too_many_published_pages_header_text",showTitle:!0,showCancelButton:!1,showOkButton:!1,fontAwesomeCode:"fas fa-exclamation-triangle",windowClass:"updated-modal-design"})}I.showingPanel=e,I.isPanelActive=!0}else I.showingPanel=null,I.isPanelActive=!1;"share"===e?(I.isShareActive=!I.isShareActive,I.showingPanel=e,I.isShareActive||(I.showingPanel=null,$(".bulb-page-header-share-button").focus()),$(".bulb-page-header-share-button").attr("aria-expanded",I.isShareActive)):"publish"===e&&(I.isPanelActive||$(".publish-panel-button").focus(),$(".publish-panel-button").attr("aria-expanded",I.isPanelActive))},this.showPresentation=function(){w.startPresentation(I.unit)},this.toggleCommentButton=function(e){e.stopPropagation(),e.preventDefault(),this.page.unit.commentsEnabled=!this.page.unit.commentsEnabled;var t={commentsEnabled:this.page.unit.commentsEnabled};h.autoSave(this.autoSaveOptions.restId,this.autoSaveOptions.restCollection,t)},this.archivePage=function(e){var t={fontAwesomeCode:"fas fa-inbox",titleCode:"archive_modal_title",bodyCode:"archive_modal_body_text",okButtonCode:"archive_modal_archive_button",showCancelButton:!0,windowClass:"updated-modal-design bulb-pageview-dashboard-archive-modal",focusAfterClosed:e.currentTarget};C.show(t).then(function(){m.showBusyDuring(u.one("units",I.unit.id).customPOST({},"copyTemplate",{isArchive:!0}).then(function(){var e=l.instant("pageview_archived_page");e+="!",_.show(e),I.archivedSuccessfully=!0},function(e){b.showError(e.data||e.data.developerMessage||e.message,e)}))},function(e){})},this.delete=function(){var e=l.instant("type_draft_page_unit"),t=l.instant(" soft_delete_modal_delete_type_confirm_page",{type:e});C.show({titleCode:"modal_delete_confirm_title",bodyText:t,okButtonCode:"button_delete",showCancelButton:!0}).then(function(){i.$broadcast("navigationAwayApproval",!0),m.showBusyDuring(E.deleteUnit(I.unit).then(function(){I.parentUnit&&"UserUnit"!==I.parentUnit.unitType?a.go("unit",{unitPath:I.parentUnit.path}):a.go("author",{username:p.currentUser.username})},function(e){b.error("Cannot delete page",e)}))},function(e){})},this.handleBackArrow=function(){y.userClickedBackArrow=!0,a.previousState?a.go(a.previousState.name,a.previousState.params):a.go("author",{username:e.ownerUsername})},this.handleBulbLogoNavigation=function(){"Anonymous"!==p.currentUser.username?a.go("author",{username:p.currentUser.username}):window.location.href="/"},this.signIn=function(){a.go("signIn",{targetUrl:c.location.href})},this.toggleRecommend=function(){I.unit.likedByUser?A.deleteRecommend(this.unit).then(function(){I.unit.likedByUser=!1,I.unit.likeCount--}):A.createRecommend(this.unit).then(function(){I.unit.likedByUser=!0,I.unit.likeCount++})},this.reportPage=function(){v.openModal(I.unit)};var B=$(".header-right-side");function k(e){if(!B.is(e.target)&&0===B.has(e.target).length&&e.key&&"Enter"!==e.key||e.key&&"Escape"===e.key){var t=$("#drop1").hasClass("open");I.showingPanel?I.togglePanel(I.showingPanel):t&&I.closeMoreActionsDropDown()}}n.on("click",k),n.on("keyup",k);var U=i.$on("closePublishPanel",k);r.$on("$destroy",function(){n.off("click",k),U()}),r.$on("$destroy",function(){n.off("keyup",k)})}e.$inject=["unit","$anchorScroll","$document","$location","$rootScope","$scope","$state","$timeout","$translate","$window","Restangular","BulbAjaxService","BulbAuthService","BulbAutoSaveService","BulbBrowserService","BulbBusyService","BulbCommentService","BulbErrorService","BulbInappropriateContentService","BulbModalService","BulbPageService","BulbPresentationService","BulbRecommendService","BulbToastService","BulbUnitService","AUTH","AUTO_SAVE"],angular.module("bulbApp.pageViewModule").controller("PageViewHeaderController",e)}(),angular.module("bulbApp.permissionsModule",["angular-bind-html-compile","focus-if","bulbApp.authModule","bulbApp.autoSaveModule","bulbApp.configModule","bulbApp.pageModule","bulbApp.translateModule","bulbApp.unitModule"]).constant("PERMISSIONS",{COPY:{COPY_TIMEOUT:7e3}}).run(["$rootScope","PERMISSIONS",function(e,t){e.PERMISSIONS=t}]),function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c,u,d){var p=this;function h(){i.one("units",p.unit.id?p.unit.id:p.parentUnitId).customGET("visibilities").then(function(e){p.visibilityChoices=e.plain(),p.selectedVisibilityChoices=p.visibilityChoices.filter(function(e){return e.selected||e.pending}),p.visibilityChoices=e.plain().filter(function(e){return void 0!==e.type&&!e.selected&&(!("public"===e.name.toLowerCase()&&(p.currentUserRestrictions.PrivateProfileFeature.enabled||!p.currentUserRestrictions.PublishingFeature.publicPublishing))&&(!("organization"===e.type.toLowerCase()&&!p.currentUserRestrictions.PublishingFeature.organizationPublishing)&&!("group"===e.type.toLowerCase()&&!p.currentUserRestrictions.PublishingFeature.groupPublishing)))}),p.currentVisibility=p.selectedVisibilityChoices.map(function(e){return e.name}).join("; ")},function(e){s.error("Unable to fetch visibilities for creating a collection",e)})}this.currentUserRestrictions=r.currentUser.features,p.unit=c.currentUnit,p.selectedVisibilityChoices=[],c.currentUnit&&c.currentUnit.id?this.parentUnitId=c.currentUnit.id:this.parentUnitId=r.currentUser.authorUnitId,t.$watch(function(){return p.selectedVisibilityChoices},function(e,t){if(e.length<=t.length){var n=t.filter(function(t){return!e.some(function(e){return t.subjectId===e.subjectId})})[0];n&&n.subjectId&&n.subjectId.includes("PermissionsLink")&&p.removeShareableLink()}}),t.$watch(function(){return l.selectedVisibilityChoices},function(e){e&&(p.selectedVisibilityChoices=e)}),this.getReadAccessSubjectIds=function(){return jQuery.grep(p.selectedVisibilityChoices,function(e,t){return!e.inheritance&&!e.deleting}).map(function(e){return e.subjectId})},this.autoSaveOptions={restId:this.unit.id,restCollection:"units"},this.selectAutoSaveOptions=angular.copy(this.autoSaveOptions),this.selectAutoSaveOptions.getter=this.getReadAccessSubjectIds,this.groupVisibilityChoices=function(e){return"group"===e.type?o.instant("type_groups_unit"):"organization"===e.type?o.instant("type_organizations_unit"):"account"===e.type?o.instant("type_users_unit"):void 0},this.itemSelect=function(e,t){var n={};if("DraftPageUnit"===p.unit.unitType){var o={groupIdsAndRoles:p.getReadAccessSubjectIds()};n={status:u.STATUS.SAVING,restId:p.unit.id},a.autoSave(p.unit.id,"units",n),i.one("units",p.unit.id).customPOST(o,"updatePendingReadAccessList")}else n={status:u.STATUS.SAVING,restId:p.unit.id,readAccessSubjectIds:p.getReadAccessSubjectIds()},a.autoSave(p.unit.id,"units",n)},this.selectionRemoved=function(e,t,n,o){e.stopPropagation();var r,a=p.selectedVisibilityChoices[o];a.isActivePerm?(a.deleting=!0,p.selectedVisibilityChoices.splice(o,1),n.selected.splice(o,1),n.selected.push(a),r={groupIdsAndRoles:p.getReadAccessSubjectIds()},i.one("units",p.unit.id).customPOST(r,"updatePendingReadAccessList"),t.updateModel()):(t.removeChoice(o),r={groupIdsAndRoles:p.getReadAccessSubjectIds()},i.one("units",p.unit.id).customPOST(r,"updatePendingReadAccessList"))},this.accountSelect=function(e,t){var n;if(p.selectedVisibilityChoices.push(e),p.selectedVisibilityChoicesAccounts=[],"DraftPageUnit"===p.unit.unitType){var o={groupIdsAndRoles:p.getReadAccessSubjectIds()};i.one("units",p.unit.id).customPOST(o,"updatePendingReadAccessList"),n={status:u.STATUS.SAVING,restId:p.unit.id}}else n={status:u.STATUS.SAVING,restId:p.unit.id,readAccessSubjectIds:p.getReadAccessSubjectIds()};a.autoSave(p.unit.id,"units",n)},this.searchForAccounts=function(e){if(e.length>=3){var t=encodeURIComponent(e);i.all("accounts").getList({emailOrPartialUsername:t}).then(function(t){var n=[];t.plain().forEach(function(e){n.push({name:e.displayName,username:e.username,subjectId:"Account:"+e.id,pending:!0,type:"account",isActivePerm:"CompositeUnit"===p.unit.unitType})}),p.accountVisibilityChoices=p.sortAlphabeticallyWithMatchPrecedence(e,n)})}else p.accountVisibilityChoices=[]},this.sortAlphabeticallyWithMatchPrecedence=function(e,t){for(var n=t.sort(function(e,t){return e.name<t.name?-1:e.name>t.name?1:0}),o=0;o<n.length;o++)if(n[o].username.toLowerCase()===e.toLowerCase()){var i=n[o];i.name=i.name+" ("+i.username+")",n.splice(o,1),n.unshift(i);break}return n},this.removeShareableLink=function(){i.one("units",p.unit.id?p.unit.id:p.parentUnitId).customDELETE("shareableLink").then(function(){p.unit.shareableLink=null;var e={status:u.STATUS.SAVING,restId:p.unit.id,privateShareLink:!0};a.autoSave(p.unit.id,"units",e),h()})},this.generateShareableLink=function(){l.generateShareableLink().then(function(){h()})},this.copyShareableLink=function(){var e=$(".bulb-copy-text");e.addClass("bulb-show-copied-text"),$(".bulb-copy-button").focus(),n(function(){e.removeClass("bulb-show-copied-text")},d.COPY.COPY_TIMEOUT)},h();var g=0,m=e(function(){if(g<20){g++;var t=jQuery(".ui-select-container");0!==t.length&&(t.attr("tabindex","-1"),e.cancel(m))}else g>=20&&(g++,e.cancel(m))},100)}e.$inject=["$interval","$scope","$timeout","$translate","Restangular","BulbAuthService","BulbAutoSaveService","BulbErrorService","BulbShareableLinkService","BulbUnitService","AUTO_SAVE","PERMISSIONS"],angular.module("bulbApp.permissionsModule").controller("PermissionsSelectController",e)}(),angular.module("bulbApp.permissionsModule").directive("bulbPermissionsSelect",["$log","$state","Foundation","CONFIG",function(e,t,n,o){return{restrict:"E",templateUrl:o.resource.cdnRoot+"ajs/components/permissions/permissionsselect.html",controller:"PermissionsSelectController as permissionSelectCtrl",scope:!0}}]),function(){"use strict";function e(e,t,n,o,i,r,a,s){var l=this;l.unit=r.currentUnit,this.currentUserRestrictions=n.currentUser.features,l.selectedVisibilityChoices=[],this.generateShareableLink=function(){var n=e.defer();return t.one("units",l.unit.id?l.unit.id:l.parentUnitId).customPOST({},"shareableLink").then(function(e){l.unit.shareableLink=e.shareableLink;var t={status:s.STATUS.SAVING,restId:l.unit.id,privateShareLink:!0};return o.autoSave(l.unit.id,"units",t),n.resolve(l.unit.shareableLink)}),a.showBusyDuring(n.promise)}}e.$inject=["$q","Restangular","BulbAuthService","BulbAutoSaveService","BulbErrorService","BulbUnitService","BulbBusyService","AUTO_SAVE"],angular.module("bulbApp.permissionsModule").service("BulbShareableLinkService",e)}(),function(){"use strict";function e(e,t,n){return{restrict:"A",scope:{plProgressModel:"=?",plFilesModel:"=?",plFileExtensions:"=?",plUrl:"=",plMultiParamsModel:"=?",plInstance:"=?",onFileAdded:"&",onFileProgress:"&",onFileUploaded:"&",onFileError:"&"},link:function(t,o,i){var r,a={"X-XSRF-TOKEN":e.get("XSRF-TOKEN")};i.id||i.$set("id",function(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n="",o=0;o<e;o+=1){var i=Math.floor(Math.random()*t.length);n+=t.substring(i,i+1)}return n}(5)),i.plFileExtensions&&(r=[{title:"filter",extensions:t.plFileExtensions}]);var s={runtimes:"html5",browse_button:i.id,multi_selection:!1,file_data_name:"filenames[]",max_file_size:"10000000000",url:t.plUrl,headers:a,filters:r,multipart:!0,chunk_size:"5mb"};i.plMultiParamsModel&&(s.multipart_params=t.plMultiParamsModel);var l=new n.Uploader(s);l.getUploadingFile=function(){if(this.state!==n.STARTED)return null;for(var e=0;e<this.files.length;e+=1)if(this.files[e].status===n.UPLOADING)return this.files[e];return null},l.cancelUpload=function(e){this.state===n.STARTED&&e&&e.status===n.UPLOADING&&(this.stop(),this.removeFile(e),this.start())},l.init(),l.bind("FilesAdded",function(e,n){t.$apply(function(){i.plFilesModel&&angular.forEach(n,function(e,n){t.plFilesModel.push(e)}),i.onFileAdded&&t.onFileAdded()}),l.start()}),l.bind("UploadProgress",function(e,n){i.plProgressModel&&(i.plFilesModel?t.$apply(function(){var e=0;angular.forEach(t.plFilesModel,function(t,n){e+=t.percent}),t.plProgressModel=e/t.plFilesModel.length}):t.$apply(function(){t.plProgressModel=n.percent})),i.onFileProgress&&t.onFileProgress({file:n})}),l.bind("FileUploaded",function(e,n,o){i.onFileUploaded&&(i.plFilesModel?t.$apply(function(){var e=!0;angular.forEach(t.plFilesModel,function(t,n){t.percent<100&&(e=!1)}),e&&t.onFileUploaded({response:o})}):t.onFileUploaded({response:o}))}),i.onFileError&&l.bind("Error",function(e,n){t.onFileError({error:n}),e.refresh()}),i.plInstance&&(t.plInstance=l)}}}e.$inject=["$cookies","$parse","plupload"],angular.module("bulbApp.pluploadModule",[]).value("plupload",window.plupload).directive("plUpload",e)}(),angular.module("bulbApp.presentationModule",["ui.router","bulbApp.authModule","bulbApp.configModule","bulbApp.unitModule"]),function(){"use strict";function e(e,t,n,o,i,r){var a,s,l,c,u=this,d=!1;this.zoomed=!1,this.firstTimePresenting=!0;var p=!1;this.usePublishedVersion=!1,this.getWidth=function(){return Math.min(875,jQuery(window).width())},this.showTransitionCover=function(){if(!jQuery("#presentation-transition-cover").length){var t=e('<div id="presentation-transition-cover" class="presentation-transition-cover" bulb-inline-busy></div>')(n);jQuery("#bulb-main").append(t)}};var h=function(){jQuery(".presentation-transition-cover").fadeOut(500,function(){jQuery(this).remove()})};this.isFullScreen=function(){return d};var g=function(){$.fullscreen.isFullScreen()||u.exitPresentation()};this.enterFullscreen=function(){d=!0,c=jQuery("#bulb-content"),(l=jQuery("#bulb-main")).css("background","#ececee"),l.fullscreen(),l.css("overflow-y","scroll"),t.on("fscreenchange",g)};var m=function(){d=!1,t.off("fscreenchange",g),$.fullscreen.exit()},f=function(){jQuery("#bulb-content").find("iframe").removeAttr("allowfullscreen").removeAttr("webkitallowfullscreen").removeAttr("mozallowfullscreen"),jQuery("#bulb-content").find(".jw-icon-fullscreen").remove()},b=function(){return.8*l.innerHeight()},v=function(){return.1*l.innerHeight()},C=function(e){var t=l.scrollTop();0===t?"UserUnit"!==u.parentUnit.unitType&&u.previousUnit.path&&u.changePage(u.previousUnit):l.stop().animate({scrollTop:t-(e?b():v())},e?200:100)},y=function(e){var t=l.scrollTop();t+jQuery(window).height()>=Math.floor(c.innerHeight()*a)-1?"UserUnit"!==u.parentUnit.unitType&&u.nextUnit.path&&u.changePage(u.nextUnit):l.stop().animate({scrollTop:t+(e?b():v())},e?200:100)},w=function(e){if(p)switch(e.keyCode){case $.ui.keyCode.BACKSPACE:m(),u.exitPresentation();break;case $.ui.keyCode.LEFT:case $.ui.keyCode.PAGE_UP:C(!0);break;case $.ui.keyCode.RIGHT:case $.ui.keyCode.PAGE_DOWN:case $.ui.keyCode.SPACE:y(!0);break;case $.ui.keyCode.UP:C(!1);break;case $.ui.keyCode.DOWN:y(!1)}},A=function(e){p&&("slick-next"===e.target.classList[0]||"slick-prev"===e.target.classList[0]||"bulb-carousel-display-image"===e.target.classList[0]||e.target.classList.contains("next")&&e.target.classList.contains("bubbles-on")||e.target.classList.contains("prev")&&e.target.classList.contains("bubbles-on")||y(!0))};this.zoom=function(){if(c=jQuery("#bulb-content"),l.css("overflow-x","hidden"),jQuery("header.bulb-header").hide(),jQuery(".bulb-cover-image").css("z-index",0),i(f,1e3),t.on("keydown",w),jQuery("#bulb-main").on("click",A),jQuery("#bulb-content").find(".bulb-page-attached-file-title-section").find("a").click(function(e){e.stopPropagation()}),u.zoomed=jQuery(window).width()>875,u.zoomed){c.removeClass("bulb-content"),c.addClass("presentation-zoom");var e=jQuery(document).width();a=parseInt(e)/875;var n=jQuery(".bulb-has-cover-image").find("img");n.length?n.css("left",-(n.width()-875)/2):c.css("padding-top","20px");var o=c.parent().width()-c.width();c.width(875),c.css("transform","scale("+a+","+a+")");var r=e-o;jQuery("#presentation-footer").width(r),jQuery("#presentation-footer-thumbnail-container").width(r);var s=jQuery("bulb-page-view").height();c.parent().height(s)}else a=1,l.removeClass("bulb-main");i(function(){p=!0},300),l.scrollTop(0),h()},this.restoreZoom=function(){if(u.zoomed){u.zoomed=!1,c.css("width",""),c.css("padding-top",""),c.css("transform",""),c.removeClass("presentation-zoom"),c.addClass("bulb-content");var e=jQuery(".bulb-has-cover-image").find("img");e&&e.css("left","");var t=jQuery(document).width()-(c.parent().width()-c.width());jQuery("#presentation-footer").width(t),jQuery("#presentation-footer-thumbnail-container").width(t),c.parent().css("height","")}else l.addClass("bulb-main")},this.fetchUnits=function(){r.fetchParent().then(function(){u.parentUnit=r.parentUnit,u.previousUnit=r.previousSibling,u.nextUnit=r.nextSibling})},this.saveLastState=function(e){s={unitPath:e.path}};this.changePage=function(e){p=!1,o.go("presentation_page",{unitPath:e.path})},this.startPresentation=function(e){this.showTransitionCover(),this.enterFullscreen(),this.changePage(e)},this.exitPresentation=function(){h(),m(),this.restoreZoom(),jQuery("header.bulb-header").show(),l.css("background","transparent"),l.css("overflow-x",""),jQuery("#presentation-footer").remove(),jQuery("#presentation-footer-thumbnail-container").remove(),t.off("keydown",w),jQuery("#bulb-main").off("click",A),o.go("unit.page",s),s=null},this.createHref=function(e){return'presentation_page({unitPath: "'+e.path+'"})'}}e.$inject=["$compile","$document","$rootScope","$state","$timeout","BulbUnitService"],angular.module("bulbApp.presentationModule").service("BulbPresentationService",e)}(),function(){"use strict";function e(e,t){this.unit=t.currentUnit,e.fetchUnits(),this.exit=function(){e.exitPresentation()},this.goToPrevious=function(){e.firstTimePresenting=!1,e.changePage(e.previousUnit)},this.goToNext=function(){e.firstTimePresenting=!1,e.changePage(e.nextUnit)},this.toggleUsePublishedVersion=function(){e.usePublishedVersion=!e.usePublishedVersion,("PublishedPageUnit"===this.unit.unitType||this.unit.isPublished)&&e.changePage(this.unit)},this.pageFilter=function(e){return"CompositeUnit"!==e.unitType},this.consumeEvent=function(e){e.stopPropagation()},e.saveLastState(this.unit)}e.$inject=["BulbPresentationService","BulbUnitService"],angular.module("bulbApp.presentationModule").controller("PresentationFooterController",e)}(),angular.module("bulbApp.presentationModule").directive("bulbPresentationFooter",["$rootScope","$timeout","$window","BulbPresentationService","CONFIG","_",function(e,t,n,o,i,r){return{restrict:"E",templateUrl:i.resource.cdnRoot+"ajs/components/presentation/presentationfooter.html",controller:"PresentationFooterController as presentationFooterCtrl",scope:!0,link:function(e,i,a){var s=jQuery("#presentation-footer-inner"),l=s.outerHeight(),c=jQuery("#footer-show-btn"),u=jQuery("#footer-hide-btn"),d=jQuery("#presentation-footer-thumbnail-scroll-container"),p=jQuery("#presentation-footer-thumbnail-move-btn-prev"),h=jQuery("#presentation-footer-thumbnail-move-btn-next"),g=!1,m=!1;e.presentationService=o;e.showFooter=function(){s.stop().animate({top:-l},{duration:200}),c.hide(),u.show(),m&&e.showThumbnails()},e.hideFooter=function(){s.stop().animate({top:0},{duration:200}),c.show(),u.hide(),m=g,g&&e.hideThumbnails()};var f=!1;e.showThumbnails=function(){g=!0,jQuery("#presentation-footer-thumbnail-container").stop().fadeIn(200);var e=jQuery("#presentation-footer-thumbnail-inner-container").children().eq(0)[0];n.Ps.update(e);var t=jQuery("#current-thumbnail-cover").offset().left,o=jQuery(e).find(".ps__scrollbar-x").eq(0),i=o.offset().left,r=o.width(),a=jQuery(e).css("padding-left"),s=t-parseInt(a)-10;i+r<s&&(e.scrollLeft=s,n.Ps.update(e)),f||(!function(){p.hide();var e=d.parent().find(".ps__scrollbar-x").eq(0);0===e.width()?(h.hide(),p.hide()):(d.scrollLeft()>0?p.show():p.hide(),e.position().left+e.width()<d.outerWidth()?h.show():h.hide())}(),f=!0)},e.hideThumbnails=function(){g=!1,jQuery("#presentation-footer-thumbnail-container").stop().fadeOut(200)},e.toggleThumbnails=function(){(g=!g)?e.showThumbnails():e.hideThumbnails()};var b=function(e){var t=d.scrollLeft(),o=(e?1:-1)*d.width()*.9;d.animate({scrollLeft:t+o},{progress:function(){n.Ps.update(d.get(0))}})};e.scrollPrev=function(){b(!1)},e.scrollNext=function(){b(!0)};var v=function(){t(function(){o.restoreZoom(),o.zoom(),jQuery("#presentation-footer-thumbnail-scroll-container").removeAttr("bulb-themed-scrollbar"),t(function(){d.attr("bulb-themed-scrollbar"),n.Ps.update(d.get(0)),f=!1,g&&e.showThumbnails()},0)},500)};jQuery(n).on("orientationchange",v),e.$on("$destroy",function(){jQuery(n).off("orientationchange",v)}),t(function(){e.$watch(function(){return o.zoomed=!1,o.zoomed},function(e){o.isFullScreen()&&(e||o.zoomed||o.zoom())})},o.firstTimePresenting?500:0),e.hideFooter(),t(function(){e.showFooter()},500),d.parent().on("ps-scroll-x",function(){p.show(),h.show()}),d.parent().on("ps-x-reach-start",function(){p.hide()}),d.parent().on("ps-x-reach-end",function(){h.hide()});var C=e.$on("$includeContentLoaded",function(n){C(),t(function(){d.find("article").click(function(t){e.hideThumbnails();var n=r.find(o.parentUnit.children,function(e){return e.id===t.currentTarget.id});o.changePage(n)})})})}}}]),angular.module("bulbApp.pushNotificationModule",[]),function(){"use strict";function e(e,t,n,o){var i=this;this.checkRemotePermission=function(e,t,n){if("default"===e.permission)window.safari.pushNotification.requestPermission(o.base.url+"/b/rest/accounts",o.pushnotification.apns.safari.webPushId,{id:t.id},this.checkRemotePermission);else if("denied"===e.permission);else if("granted"===e.permission){var r;r={deviceToken:e.deviceToken},t.deviceTokens&&i.sendAccountUpdate(t,r,n)}},this.checkBrowserVersion=function(){var e=navigator.userAgent.substring(navigator.userAgent.indexOf("Version")+8);return e=e.substring(0,e.indexOf(" ")),parseInt(""+e,10)},this.sendAccountUpdate=function(o,i,r){e.showBusyDuring(n.one("accounts",o.id).patch(i).then(function(){},function(e){e.data.errorMap?r.handleRemoteErrors(e):t.showError(null,e)}))}}e.$inject=["BulbBusyService","BulbErrorService","Restangular","CONFIG"],angular.module("bulbApp.pushNotificationModule").service("PushNotificationService",e)}(),angular.module("bulbApp.radiobuttonModule",[]),angular.module("bulbApp.radiobuttonModule").directive("bulbRadiobutton",function(){return{restrict:"A",replace:!0,compile:function(){return{pre:function(e,t){t.wrap('<label class="bulb-radiobutton"></label>')}}}}}),angular.module("bulbApp.recommendModule",["lodash","bulbApp.ajaxModule","bulbApp.authModule","bulbApp.configModule"]),function(){"use strict";function e(e){this.recommends=e.recommends,this.initialRecommendsFetched=!1,this.getInitialRecommends=function(){this.initialRecommendsFetched||(this.getNextPage(),this.initialRecommendsFetched=!0)},this.getNextPage=function(){return e.fetchRecommends(10)}}e.$inject=["BulbRecommendService"],angular.module("bulbApp.recommendModule").controller("RecommendController",e)}(),angular.module("bulbApp.recommendModule").factory("BulbRecommendService",["$filter","$q","Restangular","BulbAuthService","BulbErrorService","_",function(e,t,n,o,i,r){return{recommends:{units:[],previous:null,done:!1},fetchRecommends:function(e){var t=this;if(!this.recommends.done){var a={size:e},s=this.recommends.previous;s&&(a.after=s);var l=o.currentUser.id;n.one("accounts",l).customGET("likes",a).then(function(n){n.length>0&&(jQuery.merge(t.recommends.units,n),t.recommends.units=r.uniq(t.recommends.units,"id"),t.recommends.previous=n[n.length-1].id),t.recommends.done=n.length<e},function(e){i.error("Cannot fetch recommends",e)})}},addRecommend:function(e){this.recommends.units.unshift(e)},removeRecommend:function(e){for(var t=this.recommends.units,n=0;n<t.length;n+=1)if(t[n].id===e)return void t.splice(n,1)},createRecommend:function(e){var t=this;return n.one("units",e.id).post("likes").then(function(){t.addRecommend(e)})},deleteRecommend:function(e){var t=this;return n.one("units",e.id).customDELETE("likes").then(function(){t.removeRecommend(e.id)})},updateRecommend:function(e){for(var t=this.recommends.units,n=0;n<t.length;n+=1)if(t[n].id===e.id)return void(t[n]=e)}}}]),angular.module("bulbApp.recommendModule").directive("bulbRecommendHeader",["CONFIG",function(e){return{restrict:"E",templateUrl:e.resource.cdnRoot+"ajs/components/recommend/recommendheader.html",controller:"RecommendController as recommendCtrl",link:function(e,t,n){if("initializeTrigger"in n)var o=n.$observe("initializeTrigger",function(t){e.$eval(t)&&(e.recommendCtrl.getInitialRecommends(),o())})}}}]),angular.module("bulbApp.scriptLoaderModule",[]).constant("SCRIPT_LOADER",{FACEBOOK:{src:"//connect.facebook.net/en_US/fbds.js",reference:"_fbq"},GOOGLE_ANALYTICS:{src:"https://ssl.google-analytics.com/analytics.js",reference:"ga"},GOOGLE_ADWORDS:{src:"//www.googleadservices.com/pagead/conversion_async.js",reference:"google_trackConversion"},PINGDOM:{src:"//rum-static.pingdom.net/prum.min.js",reference:"_prum"},TWITTER:{src:"//platform.twitter.com/oct.js",reference:"twttr"}}).service("BulbScriptLoaderService",["$interval","$log","$q","$window",function(e,t,n,o){var i={};o._prum=[],this.load=function(e){if(void 0===i[e.reference]){var r=n.defer();jQuery.ajax({dataType:"script",cache:!0,timeout:e.timeout||2e3,url:e.src}).done(function(){r.resolve(o[e.reference])}).fail(function(){t.warn(e.src+" failed to load"),r.reject()}),i[e.reference]=r.promise}return i[e.reference]}}]),angular.module("bulbApp.shareModule",["badwing.autoselect","mm.foundation","restangular","bulbApp.busyModule","bulbApp.configModule"]).constant("SHARE",{FACEBOOK:"facebook",GOOGLE:"google",LINKED_IN:"linkedin",TWITTER:"twitter",GENERATED_LINK:"generated link",EMAIL:"email",GOOGLE_CLASSROOM:"google classroom"}).run(["$rootScope","SHARE",function(e,t){e.SHARE=t}]),function(){"use strict";function e(e,t,n,o,i,r){var a=this;this.SHARE=r,this.doShortenURL=null!=this.shareLink,this.createShareLink=function(){this.shareLink||o.getShareUrl(this.unit,r.GENERATED_LINK).then(function(e){a.shareLink=e})},this.shareLinkToDisplay=function(e){return a.shareLink&&a.doShortenURL?a.shareLink:window.location.href},this.share=function(e,n){"click"!==e.type&&13!==e.keyCode&&32!==e.keyCode||(o.share(this.unit,n),t.$close&&t.$close())},this.copyShareableLink=function(){var e=$(".bulb-copy-text");e.addClass("bulb-show-copied-text"),$(".bulb-share-copy-button").focus(),n(function(){e.removeClass("bulb-show-copied-text")},i.COPY.COPY_TIMEOUT)},this.shareToGoogleClassRoom=function(e,n){"click"!==e.type&&13!==e.keyCode&&32!==e.keyCode||(o.shareToGoogleClassRoom(this.unit,n),t.$close&&t.$close())},this.closeSharePanel=function(){e.$broadcast("togglePanel")}}e.$inject=["$rootScope","$scope","$timeout","BulbShareService","PERMISSIONS","SHARE"],angular.module("bulbApp.shareModule").controller("ShareController",e)}(),angular.module("bulbApp.pageViewModule").directive("bulbShare",["BulbAuthService","BulbUnitService","CONFIG",function(e,t,n){return{restrict:"E",templateUrl:n.resource.cdnRoot+"ajs/components/share/share.html",controller:"ShareController as shareCtrl",link:function(n,o,i){var r=n.shareCtrl;r.unit=t.currentUnit,r.currentUser=e.currentUser}}}]),function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c,u,d){var p=this;this.displayShareDialog=function(e){var t={template:"<bulb-share></bulb-share>",windowClass:"bulb-share-modal",focusAfterClosed:e.currentTarget};l.showCustomModal(t)},this.getShareUrl=function(e,t){var o=i.location.pathname,l={path:o+="?utm_source="+a.currentUser.username+"&utm_medium=share&utm_campaign="+t+"&utm_content="+e.id},c=n.defer();return r.all("aliases").post(l).then(function(e){return c.resolve(e.alias)}),s.showBusyDuring(c.promise)},this.share=function(e,t){this.getShareUrl(e,t).then(function(n){p.createSharePopUpWindow(e,n,t)})},this.shareToGoogleClassRoom=function(e,t){if(e.shareableLink){var n=u.base.url+"/u/"+e.path+"?sharedLink="+e.shareableLink;p.createSharePopUpWindow(e,n,t)}else c.generateShareableLink().then(function(n){var o=u.base.url+"/u/"+e.path+"?sharedLink="+n;p.createSharePopUpWindow(e,o,t)})},this.createSharePopUpWindow=function(e,t,n){var r=600,s=500,l=encodeURIComponent(t);switch(n){case d.FACEBOOK:r=626,s=436,"https://www.facebook.com/sharer/sharer.php?u="+l;break;case d.GOOGLE:r=600,s=600,"https://www.facebook.com/sharer/sharer.php?u="+l;break;case d.TWITTER:r=550,s=420}var c="screenLeft"in i?i.screenLeft:i.screen.left,u="screenTop"in i?i.screenTop:i.screen.top,p=i.screen.width/2-r/2+c,h=i.screen.height/3-s/3+u;switch(n){case d.FACEBOOK:i.open("https://www.facebook.com/sharer/sharer.php?u="+l,"","width="+r+",height="+s+",top="+h+",left="+p);break;case d.GOOGLE:i.open("https://plus.google.com/share?url="+l,"","menubar=no,toolbar=no,resizable=yes,scrollbars=yes,width="+r+",height="+s+",top="+h+",left="+p);break;case d.LINKED_IN:i.open("http://www.linkedin.com/shareArticle?mini=true&url="+l,"","width="+r+",height="+s+",top="+h+",left="+p);break;case d.TWITTER:i.open("https://twitter.com/intent/tweet?url="+l,"","width="+r+",height="+s+",top="+h+",left="+p);break;case d.EMAIL:var g="email_share_subject",m="email_share_body";e.ownerUsername!==a.currentUser.username&&(g+="_not_owner",m+="_not_owner"),o(g).then(function(e){o(m,{url:t}).then(function(t){i.location="mailto:?subject="+e+"&body="+t})});break;case d.GOOGLE_CLASSROOM:i.open("https://classroom.google.com/share?url="+l,"","width="+r+",height="+s+",top="+h+",left="+p)}}}e.$inject=["$interval","$modal","$q","$translate","$window","Restangular","BulbAuthService","BulbBusyService","BulbModalService","BulbShareableLinkService","CONFIG","SHARE"],angular.module("bulbApp.shareModule").service("BulbShareService",e)}(),angular.module("stripeModule",["bulbApp.configModule"]).factory("Stripe",["$window","CONFIG",function(e,t){var n=e.Stripe;return n.setPublishableKey(t.stripe.publicKey),n}]),angular.module("bulbApp.translateModule",["pascalprecht.translate","bulbApp.configModule","bulbApp.authModule"]).config(["$translateProvider","CONFIG",function(e,t){e.useSanitizeValueStrategy(null).useStaticFilesLoader({prefix:t.resource.cdnRoot+"resources/translations/locale-",suffix:".json"}).registerAvailableLanguageKeys(["de","en","es","fi","fr","nl","no","pt","sv"],{"de*":"de","en*":"en","es*":"es","fi*":"fi","fr*":"fr","nl*":"nl","no*":"no","pt*":"pt","sv*":"sv"}).fallbackLanguage("en").determinePreferredLanguage()}]).run(["$cookies","$translate","$rootScope","BulbAuthService",function(e,t,n,o){var i=e.get("language");o.currentUser.isAuthenticated()&&!i||t.use(i),n.$watch(function(){return o.currentUser},function(){o.currentUser.isAuthenticated()?t.use(o.currentUser.language.toLowerCase()):i&&t.use(i)}),t.languages={de:"Deutsche",en:"English",es:"Espaol",fi:"Suomalainen",fr:"Franais",nl:"Nederlands",no:"Norsk",pt:"Portugus",sv:"Svenska"},t.getLanguage=function(){return t.proposedLanguage()||t.use()},t.getLanguagesList=function(){return Array.from(Object.entries(this.languages),([e,t])=>({value:e,display:t}))},t.localeToString=function(){return Object.keys(t.languages).includes(t.use().toString().toLowerCase())?t.languages[(t.proposedLanguage()||t.use()).toString().toLowerCase()]:t.use("en")}}]),function(){"use strict";angular.module("bulbApp.uploadModule",["bulbApp.busyModule","bulbApp.configModule","bulbApp.pluploadModule","bulbApp.translateModule","bulbApp.validationModule"])}(),function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c,u,d,p,h,g,m,f,b,v){var C=this;this.assetId=null,this.isActive=!1,this.stopBusyIndicatorCallback=null,this.percent=0,this.files=[],this.fileName=null,this.errorMessage="",this.isTooltipHidden=!1,this.multiParams={name:null,assetId:null,assetDefinitionsKey:this.assetDefinitionsKey},this.url=v.context.name+"/b/"+this.assetType+"/upload",this.uploader=null,this.onboardingIconStyle={backgroundImage:'url("'+v.resource.cdnRoot+'resources/images/onboarding_task_icon_background.png")'},this.showAssetLibrarySelectionModal=function(e){r.bulbVars.BulbUploadController=this;var t="circularImage"===this.assetDefinitionsKey?"avatar":"coverimage";c.dialog.image.showSelectionModal(C.finishProcess,function(e){c.dialog.closeCurrentModal(),p.uploadImageBySelectionModal(C,"addFileHandler","submitFileHandler","progressFileHandler","doneFileHandler",!1,t)},function(){c.dialog.closeCurrentModal(),s.openImageTypePicker(function(e,t,n,o){g.showBusyDuring(c.api.importFromGoogleDrive(e,null,t,n,o).then(function(e){C.finishProcess(e.entry)}))})},function(){c.dialog.closeCurrentModal(),l.initializeGooglePhotoPicker(function(e,t){g.showBusyDuring(c.api.importFromGooglePhoto(e,null,t).then(function(e){C.finishProcess(e.entry)}))})},function(){d.initializeUnsplashPhotoPicker(function(e){g.showBusyDuring(d.importFromUnsplash(e,null).then(function(e){C.finishProcess(e.entry)}))})},function(){c.dialog.closeCurrentModal(),u.initializeOneDrivePicker(function(e){g.showBusyDuring(u.importFromOneDrive(e.id,C.currentFolderId).then(function(e){C.finishProcess(e.entry)}))},[v.image.extensions])},p.createImageUploadOptions(null,C,"addFileHandler","submitFileHandler","progressFileHandler","doneFileHandler"),!1,t,e.currentTarget)},this.finishProcess=function(e){return c.dialog.dismissAllModals(),C.onFileUploaded(e).then(function(){C.isActive=!1})},this.addFileHandler=function(e,t){C.stopBusyIndicatorCallback=h.showBusy(),C.fileName=t.files[0].name,C.isActive=!0},this.submitFileHandler=function(e,t){},this.progressFileHandler=function(e,t,n){C.percent=n},this.doneFileHandler=function(e,t){C.percent=100,C.waitEntryReady(t.entry.id).then(function(){},function(e){C.errorMessage=m.error("onFileUploaded error: "+e)}).finally(function(){C.stopBusyIndicatorCallback()})},this.waitEntryReady=function(e){var o=n.defer(),i=t(function(){c.api.getEntry(e).then(function(e){var n=e.entry;"COMPLETE"===n.status?(C.finishProcess(n),t.cancel(i),o.resolve()):"ERROR"===n.status&&(t.cancel(i),o.reject())},function(){t.cancel(i),o.reject()})},1e3);return C.isActive=!1,o.promise},this.fileUploaded=function(e){C.uploadComplete=!0,C.percent=100;var t=jQuery.parseJSON(e.response);t.success?C.onFileUploaded&&h.showBusyDuring(n.when(C.onFileUploaded({response:t})).then(function(){C.isActive=!1,C.clearUpload()},function(e){C.errorMessage=m.error("onFileUploaded error: "+e),C.clearUpload()})):t.message?C.errorMessage=t.message:C.errorMessage="Cannot upload"},this.fileError=function(e){switch(e.code){case a.FILE_SIZE_ERROR:i("upload_error_size_exceeded").then(function(e){C.errorMessage=e});break;case a.FILE_EXTENSION_ERROR:i("upload_error_invalid_type").then(function(e){C.errorMessage=e});break;case a.FILE_DUPLICATE_ERROR:return void(this.errorMessage="plupload File Duplicate Error");case a.GENERIC_ERROR:return this.errorMessage="plupload Generic Error",void(e.message&&(this.errorMessage+=": "+e.message));case a.HTTP_ERROR:return void(this.errorMessage="plupload HTTP Error: status: "+e.status);case a.IMAGE_FORMAT_ERROR:return this.errorMessage="plupload Image Format Error",void(e.message&&(this.errorMessage+=": "+e.message));case a.IMAGE_DIMENSIONS_ERROR:return this.errorMessage="plupload Image Dimensions Error",void(e.message&&(this.errorMessage+=": "+e.message));case a.INIT_ERROR:return this.errorMessage="plupload Initialization Error",void(e.message&&(this.errorMessage+=": "+e.message));case a.IO_ERROR:return this.errorMessage="plupload IO Error",void(e.message&&(this.errorMessage+=": "+e.message));case a.MEMORY_ERROR:return this.errorMessage="plupload Memory Error",void(e.message&&(this.errorMessage+=": "+e.message));case a.SECURITY_ERROR:return this.errorMessage="plupload Security Error",void(e.message&&(this.errorMessage+=": "+e.message));default:switch(e.status){case 504:break;case 410:return this.uploader.cancelUpload(e.file),void(this.errorMessage="");default:e.message&&(this.errorMessage=e.message),this.errorMessage+=" status: "+e.status}}b.endUpload(e.file)},this.clearUpload=function(e){e&&b.endUpload(e),C.percent=0,C.errorMessage=null,C.uploadComplete=!1,C.fileName=null,C.multiParams.name=null,C.multiParams.assetId=null,b.getNewAssetId().then(function(e){C.assetId=e},function(e){C.errorMessage=m.error("Cannot get new asset Id: "+e)})},this.cancel=function(){if(this.isActive=!1,this.errorMessage||this.uploadComplete)this.clearUpload();else{var e=this.uploader.getUploadingFile();e&&(this.uploader.cancelUpload(e),b.cancelUpload(e).then(function(){C.clearUpload(e)},function(t){C.errorMessage=m.error("Cannot cancel upload for "+e.name+": "+t)}))}}}e.$inject=["$cookies","$interval","$q","$rootScope","$translate","$window","plupload","BulbAssetLibraryGoogleDriveService","BulbAssetLibraryGooglePhotoService","BulbAssetLibraryService","BulbAssetLibraryOneDriveService","BulbAssetLibraryUnsplashService","BulbAssetLibraryUploadService","BulbBusyService","BulbBusyCoverService","BulbErrorService","BulbModalService","BulbUploadService","CONFIG"],angular.module("bulbApp.uploadModule").controller("BulbUploadController",e)}(),function(){"use strict";function e(e,t){return{restrict:"E",templateUrl:t.resource.cdnRoot+"ajs/components/upload/upload.html",controller:"BulbUploadController as uploadCtrl",bindToController:!0,scope:{assetDefinitionsKey:"@",assetType:"@",fileExtensions:"@",isActive:"=",useButton:"=",buttonClass:"@",fontAwesomePrefix:"@",fontAwesomeCode:"@",onFileUploaded:"=",uploadLabel:"@",customClass:"@"},transclude:!0,link:function(t,n,o){function i(){e(function(){var e=jQuery(".bulb-progressbar-wrapper",n);e.trigger("showTooltip"),t.$evalAsync(function(){var n=e.next(".tooltip");n.length>0&&(n.on("click",r),t.uploadCtrl.isTooltipHidden=!1)})})}function r(){e(function(){var e=jQuery(".bulb-progressbar-wrapper",n);e.trigger("hideTooltip"),e.on("click",i),t.uploadCtrl.isTooltipHidden=!0})}t.$watch("uploadCtrl.errorMessage",function(e){e&&i()})}}}e.$inject=["$timeout","CONFIG"],angular.module("bulbApp.uploadModule").directive("bulbUpload",e)}(),function(){"use strict";function e(e,t,n,o){var i=this;function r(e){return"string"==typeof e?i.uploads[e]:e.id?i.uploads[e.id]:void 0}this.currentUpload=null,this.uploads={},this.startUpload=function(e,t){t.assetId=e,this.currentUpload=t,this.uploads[t.id]=t,this.uploads[e]=t},this.isCurrentUpload=function(e){var t=r(e);return!(!t||!this.currentUpload)&&t.id===this.currentUpload.id},this.endUpload=function(e){var t=r(e);t&&(this.currentUpload.id===t.id&&(this.currentUpload=null),delete this.uploads[t.id],delete this.uploads[t.assetId])},this.getNewAssetId=function(){var t=e.defer();return o.all("assets").customGET("newId").then(function(e){t.resolve(e)},function(e){var o=n.error("Cannot get new asset Id",e);t.reject(o)}),t.promise},this.cancelUpload=function(t){var a=e.defer(),s=r(t);return s?o.one("assets",s.assetId).customDELETE("").then(function(){i.endUpload(s),a.resolve(!0)},function(e){var t=n.error("Cannot cancel upload of "+s.name,e);i.endUpload(s),a.reject(t)}):a.resolve(!1),a.promise}}e.$inject=["$q","BulbAjaxService","BulbErrorService","Restangular"],angular.module("bulbApp.uploadModule").service("BulbUploadService",e)}(),angular.module("bulbApp.utilsModule",[]),angular.module("bulbApp.utilsModule").directive("bulbActionLink",["$compile",function(e){return{restrict:"A",link:function(t,n,o){if(void 0===o.tooltip)return o.$set("tooltip","{{tooltip}}"),o.$set("roll","button"),void e(n)(t);var i=o.bulbActionLink;t.text=t.$eval(i),void 0===t.text&&(t.text=i),t.$watch(function(){return Foundation.utils.is_small_only()},function(e){e?(t.tooltip=t.text,n.empty()):(t.tooltip="",n.text(t.text))})}}}]),angular.module("bulbApp.utilsModule").directive("bulbDisallowNewline",["$timeout",function(e){function t(e,t){return t=t||" ",!!e.match(/[\n\r]/)&&e.replace(/[\n\r]+/g,t)}return{restrict:"A",require:"?ngModel",link:function(n,o,i,r){o.on("keydown keyup",function(e){13===e.which&&e.preventDefault()}),o.on("paste",function(n){var i=n.originalEvent.clipboardData,a=t(i?i.getData("text/plain"):window.clipboardData.getData("text"));a&&(n.preventDefault(),e(function(){var e=o.get(0),t=e.selectionStart,n=o.val(),i=n.substring(0,t)+a+n.substring(e.selectionEnd);o.val(i),r&&r.$setViewValue(i),e.selectionEnd=t+a.length}))}),o.on("drop",function(n){var i=n.originalEvent.dataTransfer.getData("text"),a=t(i);a&&o.one("input",function(){var n=o.val(),s=t(n);e(function(){o.val(s),r&&r.$setViewValue(s),o.trigger("autosize.resize");var e=n.search(t(i,"\\n")),l=o.get(0);l.focus(),l.setSelectionRange(e,e+a.length)})})}),o.on("blur",function(n){var i=t(o.val());i&&e(function(){o.val(i),r&&r.$setViewValue(i),o.trigger("autosize.resize")})})}}}]),angular.module("bulbApp.utilsModule").directive("bulbFitVids",["$interval",function(e){return{restrict:"A",link:function(t,n,o){t.videoReady=!1;var i=e(function(){if(n.find("iframe").length>0){e.cancel(i);var o=n.find("iframe").load(function(){o.unbind(),n.fitVids(),t.videoReady=!0,t.$apply()})}},100)}}}]),angular.module("bulbApp.utilsModule").directive("bulbIncludeTemplate",["$compile",function(e){return{restrict:"A",link:function(t,n,o){var i=o.bulbIncludeTemplate;n.html(i),e(n.contents())(t)}}}]),angular.module("bulbApp.utilsModule").directive("bulbInfiniteScroll",["$window",function(e){return{restrict:"A",link:function(t,n,o){var i=function(){n.offset().top+n.height()<e.scrollY+jQuery(e).height()&&t.$apply(o.bulbInfiniteScroll)},r=n[0];t.$watch(o.bulbThemedScrollbar,function(){if("false"!==o.bulbThemedScrollbar){jQuery(window).unbind("scroll.infiniteScroll",i);var e=!1;n.on("scroll",function(){r.scrollTop+1.5*r.offsetHeight>=r.scrollHeight?e||(t.$apply(o.bulbInfiniteScroll),e=!0):e=!1})}else n.unbind("scroll"),t.$watch(function(){return n.is(":visible")},function(e){e?jQuery(window).on("scroll.infiniteScroll",i):jQuery(window).unbind("scroll.infiniteScroll")})})}}}]),angular.module("bulbApp.utilsModule").directive("bulbInfiniteScrollWindow",["$log","$window",function(e,t){var n="scroll.infiniteScrollWindow",o=1;return{restrict:"A",link:function(i,r,a){var s=jQuery(t),l=a.bulbInfiniteScrollWindow,c=i[l],u=0;function d(i){if(t.scrollY<u)s.one(n,d);else{u=t.scrollY;var a=t.scrollY+s.height(),l=r.offset().top+r.height();l-a<o*s.height()?(e.debug("calling getNextPage: elem height: "+r.height()+", remaining elem: "+(l-a)),c.getNextPage().then(function(){s.one(n,d)})):s.one(n,d)}}e.debug("viewport height: "+s.height()+", "+o+" * viewport height: "+o*s.height()),c.getNextPage&&i.$watch(l+".infiniteScrollWindowEnabled",function(e){e?s.one(n,d):s.off(n)})}}}]),angular.module("bulbApp.utilsModule").directive("bulbInlineEditable",["$compile",function(e){return{restrict:"A",require:"ngModel",priority:"1",link:{pre:function(t,n,o,i){n.attr("contenteditable",!0),n.removeAttr("bulb-inline-editable"),e(n)(t)},post:function(e,t,n,o){function i(){var e=t.html();e=e.replace(/&nbsp;/g,""),o.$setViewValue(e)}o.$render=function(){t.html(o.$viewValue||"")},t.bind("blur keyup change",function(){e.$apply(i)})}}}}]),angular.module("bulbApp.utilsModule").directive("ngInput",["$parse",function(e){return{restrict:"A",compile:function(t,n){var o=e(n.ngInput,null,!0);return function(e,t){t.on("input",function(t){e.$apply(function(){o(e,{$event:t})})})}}}}]),angular.module("bulbApp.utilsModule").directive("bulbOnUiSelectClose",function(){return{restrict:"A",link:function(e,t,n){e.$on("uis:close",function(){e.$root.$$phase||e.$apply(n.bulbOnUiSelectClose)})}}}),angular.module("bulbApp.utilsModule").directive("resize",["$window",function(e){return{link:function(t){angular.element(e).on("resize",function(e){t.$broadcast("resize::resize")})}}}]),angular.module("bulbApp.utilsModule").directive("bulbThemedScrollbar",["$interval","$parse","$timeout",function(e,t,n){function o(e){return""===e||void 0===e||"true"===e}function i(o,i){jQuery(o).addClass("ps-container");var r={};["wheelSpeed","wheelPropagation","minScrollbarLength","useBothWheelAxes","useKeyboard","suppressScrollX","suppressScrollY","scrollXMarginOffset","scrollYMarginOffset","includePadding"].forEach(function(e){void 0!==i[e]&&(r[e]=t(i[e])())}),window.Ps.initialize(o,r),n(function(){window.Ps.update(o);var t=0,n=e(function(){if(t<20){t++;var o=jQuery(".ps__scrollbar-y");void 0!==o&&(o.attr("role","scrollbar"),o.attr("aria-valuenow","0"),e.cancel(n))}else t>=20&&e.cancel(n)},100)},1)}return{restrict:"A",transclude:!0,template:'<div><div class="bulb-scroll-content" ng-transclude></div></div>',link:function(e,t,n){var r=t.get(0),a=o(n.bulbThemedScrollbar);a&&i(r,n),e.$watch(n.bulbThemedScrollbar,function(){o(n.bulbThemedScrollbar)!==a&&((a=!a)?i(r,n):window.Ps.destroy(r))}),n.refreshOnChange&&e.$watchCollection(n.refreshOnChange,function(){a&&e.$evalAsync(function(){window.Ps.update(r)})}),n.observingContentSize&&e.$watch(function(){var e=jQuery(r).find(".bulb-scroll-content").eq(0);return e.width()+" "+e.height()},function(){a&&e.$evalAsync(function(){window.Ps.update(r)})}),t.bind("$destroy",function(){a&&window.Ps.destroy(r)})}}}]),angular.module("bulbApp.utilsModule").directive("bulbTooltipHelper",["$document","$compile","$timeout",function(e,t,n){return{restrict:"A",link:function(e,t,o){var i=o.bulbTooltipHelper,r=$(t).find("input").eq(0);function a(){n(function(){t.trigger("hideTooltip"),e.$eval(i+"= null")})}e.$watch(i,function(o){o?n(function(){t.trigger("showTooltip"),e.$evalAsync(function(){var e=t.next(".tooltip");e.length>0&&e.on("click",a)})}):a()}),e.$watch(function(){return r.val()},function(){a()})}}}]),angular.module("bulbApp.utilsModule").directive("bulbTabset",["$interval",function(e){return{restrict:"A",terminal:!0,transclude:!1,link:function(t,n){var o=0,i=e(function(){if(o<20){o++;var r=n.is("accordion"),a=n.find("dl dd");if(a.length>0){for(var s=0;s<a.length;s++){$(a[s]).before("<dt></dt>"),r&&$(a[s]).removeAttr("role");var l=$(a[s]).find("a");1===l.length&&void 0===l.attr("href")&&l.attr("href","javascript:void(0)")}r||function(){var e,o,i,r={end:"End",home:"Home",left:"ArrowLeft",right:"ArrowRight",enter:"Enter"};e=n[0].querySelectorAll('[role="tab"]'),o=n[0].querySelectorAll('[role="tabpanel"]');for(var a=0;a<e.length;++a)e[i=a].addEventListener("click",s),e[i].addEventListener("keydown",c);function s(e){u(e.target.closest("dd"))}var l=0;function c(t){var n=t.key;if(n===r.left)l>0?l--:l=e.length-1,setTimeout(function(){e[l].focus()},500);else if(n===r.right)l<e.length-1?l++:l=0,setTimeout(function(){e[l].focus()},500);else if(n===r.enter){u(t.target)}else n===r.home?(l=0,setTimeout(function(){e[l].focus()},500)):n===r.end&&(t.preventDefault(),l=e.length-1,setTimeout(function(){e[l].focus()},500))}function u(t){!function(){for(var t=0;t<e.length;t++)e[t].children[0].setAttribute("tabindex","-1"),e[t].setAttribute("tabindex","-1"),e[t].setAttribute("aria-selected","false");for(var n=0;n<o.length;n++)o[n].setAttribute("hidden","hidden")}(),t.setAttribute("aria-selected","true"),t.setAttribute("tabindex","0");var n=t.getAttribute("aria-controls"),i=document.getElementById(n);i&&i.removeAttribute("hidden")}function d(t){e[t].removeEventListener("click",s),e[t].removeEventListener("keydown",c)}u(e[0]),t.$on("$destroy",function(){for(var t=0;t<e.length;++t)d(t)})}(),e.cancel(i)}}else e.cancel(i)},100)}}}]),angular.module("bulbApp.utilsModule").directive("bulbTaborder",["$interval","BulbBrowserService",function(e,t){return{restrict:"A",link:function(n,o){var i=0,r=e(function(){if(i<50){i++;var n=o.find('input, textarea, button, form, a, h1, label[role="button"], article, figure');if(n.length>0){for(var s=0;s<n.length;s++){var l=$(n[s]);if(1===l.length&&l.is("a")&&!l.hasClass("error-icon-tooltip")&&!l.hasClass("bulb-header-icon")){var c=l.attr("class");if(c&&c.includes("error"))continue;l.attr("tabindex","0"),void 0===l.attr("href")&&l.attr("href","javascript:void(0);")}if(t.isMsEdge()&&1===l.length){var u=!0;l.is("a")&&(l.hasClass("error-icon-tooltip")||l.hasClass("sign-up-page-error-icon-tooltip"))?u=!1:l.is("button")&&(l.hasClass("button-clever")||l.hasClass("button-microsoft")||l.hasClass("button-google")||l.hasClass("bulb-page-cover-image-upload-button"))?u=!0:!l.is("button")||"submit"!==l.attr("type")&&void 0===l.attr("ng-click")||(u=!1),u&&(l.is("input")?l.on("click",function(e){a(e,!0)}):l.is("textarea")?l.on("change keyup paste",function(e){a(e,!0)}):(l.is("button"),l.on("focus",function(e){a(e,!0)})),l.on("blur",function(e){a(e,!1)}))}}e.cancel(r)}}else e.cancel(r)},100);function a(e,t){var n=$(".bulb-main"),o=n.parent();t?(o.hasClass("bulb-aria-hide")||o.addClass("bulb-aria-hide"),void 0===o.attr("aria-hidden")&&o.attr("aria-hidden","true"),n.hasClass("bulb-aria-reshow")||n.addClass("bulb-aria-reshow"),void 0===n.attr("aria-hidden")&&n.attr("aria-hidden","false")):(o.hasClass("bulb-aria-hide")&&o.removeClass("bulb-aria-hide"),void 0!==o.attr("aria-hidden")&&o.removeAttr("aria-hidden"),n.hasClass("bulb-aria-reshow")&&n.removeClass("bulb-aria-reshow"),void 0!==n.attr("aria-hidden")&&n.removeAttr("aria-hidden"));var i=$(e.currentTarget),r=!1;if(i.is("input")){var a=i.attr("type");"radio"!==a&&"checkbox"!==a||(r=!0)}return r||e.preventDefault(),!1}}}}]),angular.module("bulbApp.validationModule",["angularPayments","mm.foundation","bulbApp.ajaxModule","bulbApp.translateModule"]).config(["$tooltipProvider",function(e){e.setTriggers({showTooltip:"hideTooltip"})}]),angular.module("bulbApp.validationModule").directive("bulbValidationCardCvc",["_Validate",function(e){return{restrict:"A",require:"ngModel",link:function(t,n,o,i){i.$validators.cardCvc=function(n){return e("cvc",n,i,t,o)},i.errorCodes=i.errorCodes||{},i.errorCodes.cardCvc="validation_error_credit_card_cvc"}}}]),angular.module("bulbApp.validationModule").directive("bulbValidationCardNumber",["_Validate",function(e){return{restrict:"A",require:"ngModel",link:function(t,n,o,i){i.$validators.cardNumber=function(n){return e("card",n,i,t,o)},i.errorCodes=i.errorCodes||{},i.errorCodes.cardNumber="validation_error_credit_card_number"}}}]),angular.module("bulbApp.validationModule").directive("bulbValidationField",["$compile","$q","$timeout","$translate","BulbBrowserService","BulbAjaxService","_",function(e,t,n,o,i,r,a){return{restrict:"A",scope:!0,require:["ngModel","^form"],link:function(i,s,l,c){var u=c[0],d=c[1];i.errorMessage="",i.model=u,u.errorCodes=u.errorCodes||{};var p="",h="",g={nubOffset:34,tooltipClass:"error-tooltip-override",iconClass:"error-icon-tooltip",topPos:0},m={};s.attr("aria-invalid",!1),s.attr("aria-describedby",l.id+"-validation-error-label");var f=s.closest("form");f.attr("bulb-error-tooltip-overrides")&&(g=a.assign(g,i.$eval(f.attr("bulb-error-tooltip-overrides")))),l.bulbErrorTooltipOverrides&&(g=a.assign(g,i.$eval(l.bulbErrorTooltipOverrides))),f.attr("bulb-error-message-overrides")&&(m=a.assign(m,i.$eval(f.attr("bulb-error-message-overrides")))),l.bulbErrorMessageOverrides&&(m=a.assign(m,i.$eval(l.bulbErrorMessageOverrides)));var b='<div tooltip-trigger="showTooltip" class="tip-right bulb-form-error-message" id="'+l.id+'-error">{{errorMessage}}</div>';"below"===m.messagePosition&&(b="",h=jQuery('<div class="bulb-form-error-message-override" id="'+l.id+'-error">{{errorMessage}}</div>'),e(h)(i),h.hide(),s.after(h)),p=jQuery(b+'<div class="right" tooltip="{{errorMessage}}"tooltip-trigger="showTooltip" tooltip-animation="false"><a class="'+g.iconClass+' right"><i class="fa fa-exclamation-circle error-icon" aria-hidden="true"></i></a></div>'),e(p)(i),p.hide(),p.hover(E,S),s.before(p);var v=p.before();function C(e,t){!function(e,t){var o=$("#"+l.id+"-error")[0];if("below"!==m.messagePosition){if(e){var i=e.width.split("px")[0],r=s[0].clientWidth-i;o.style.marginLeft=i+"px",o.style.width=r+"px"}else o.style.position="relative";o.style.textAlign="right",m.setMargin&&n(function(){var e=o.offsetHeight/parseInt(o.style.lineHeight);o.style.marginTop=-(1===e?18:15*e)+"px"})}else o.style.width=s[0].clientWidth+2+"px";if(m)for(var a in m)"useClientWidth"===a&&m[a]?o.style.width=s[0].clientWidth+"px":o.style[a]=m[a]}(e)}if(i.$on("positionChange",function(){u.$validate()}),l.bulbAjaxValidation){var y,w=!1,A=l.bulbAjaxValidation,_=i.$eval(l.bulbAjaxValidation);_&&(A=_.validator,y=_.callback,w=_.validatePristine),u.$asyncValidators=s.$asyncValidators||{},u.$asyncValidators[A]=function(e,n){var o=e||n,i=t.defer();return u.$isEmpty(o)||!w&&u.$pristine?i.resolve():r.validateField(A,o,l.bulbAjaxValidationOptions).then(function(e){y&&y(e),e.valid?(delete u.errorCodes[A],i.resolve()):(u.errorCodes[A]=e.code,i.reject(e.code))}),i.promise}}function E(){n(function(){var e;(e=$("#"+l.id+"-error")[0])&&e.offsetWidth<e.scrollWidth&&(v.trigger("showTooltip"),i.$evalAsync(function(){var e=p.next(".tooltip"),t=parseInt(function(e){var t=jQuery('<span class="tooltip-width-calculator" content="'+e+'">'+e+"</span>");s.before(t);var n=t[0].clientWidth;return t.remove(),parseInt(n)-25}(e[0].innerText));t>=300?(t=300,e.css("text-align","right")):e.css("text-align","center"),n(function(){e.find(".nub").css("left",e[0].offsetWidth-g.nubOffset)}),e.css("min-width",t),e.css("top",(parseInt(s.position().top)-parseInt(e.height())-2)*g.topPos),e.css("left","username"===l.id||"email"===l.id?parseInt(e.position().left)-t:"auto"),e.css("right","username"===l.id?null:0),e.addClass(g.tooltipClass),g.rightPos&&e.css("right",g.rightPos+"px"),e.length>0&&e.on("click",S)}))})}function S(){n(function(){v.trigger("hideTooltip"),v.on("click",E)})}function T(){p.show(),h&&h.show(),C(s[0].labels[0]?getComputedStyle(s[0].labels[0]):null,l.id),s.addClass("bulb-invalid"),s.attr("aria-invalid",!0),u.bulbInvalid=!0,d.updateStatus(u.$name,!1)}function I(){if(void 0===u.$valid||u.$valid||u.$pristine&&!u.$touched&&u.$isEmpty(u.$viewValue))i.errorMessage="",p.hide(),h&&h.hide(),s.removeClass("bulb-invalid"),s.attr("aria-invalid",!1),u.bulbInvalid=!1,d.updateStatus(u.$name,!0);else if(u.$error.remoteValidator)i.errorMessage=i.remoteValidatorMessage,T();else{var e="validation_error_standard";i.errorCodeOverride&&(e=i.errorCodeOverride);var t={};u.$error.required?e="validation_error_required":u.$error.pattern?e=l.bulbMessageOverridePattern?l.bulbMessageOverridePattern:"validation_error_pattern":u.$error.email?e="validation_error_email":u.$error.minlength?(e="validation_error_min_length",t={value:l.minlength}):u.$error.maxlength?(e="validation_error_max_length",t={value:l.maxlength}):angular.forEach(u.$error,function(t,n){u.errorCodes[n]&&(e=u.errorCodes[n])}),o(e,t).then(function(e){i.errorMessage=e,T()})}}l.bulbValidationFieldMatch&&(u.$validators.fieldMatch=function(e,t){var n=i.$eval(l.bulbValidationFieldMatch);return u.errorCodes.fieldMatch=n.errorCode,(e||t)===n.field},i.$watch(l.bulbValidationFieldMatch,function(e){u.$validate()})),l.bulbValidationCouponMatchesPeriod&&(u.$validators.couponMatchesPeriod=function(e,t){var n=i.$eval(l.bulbValidationCouponMatchesPeriod),o=e||t;if(!o)return!0;var r=o.toUpperCase().charAt(0);return"M"===r&&"MONTH"!==n?(u.errorCodes.couponMatchesPeriod="account_billing_month_only_discount",!1):"Y"===r&&"YEAR"!==n?(u.errorCodes.couponMatchesPeriod="account_billing_year_only_discount",!1):(delete u.errorCodes.couponMatchesPeriod,!0)},i.$watch(l.bulbValidationCouponMatchesPeriod,function(){u.$validate()})),i.$on("bulbRemoteValidationErrors",function(e,t){if(t.fieldErrors[u.$name]){u.$setValidity("remoteValidator",!1),i.remoteValidatorMessage=t.fieldErrors[u.$name];var n=function(){u.$setValidity("remoteValidator",!0),delete i.remoteValidatorMessage;var e=u.$viewChangeListeners.indexOf(n);u.$viewChangeListeners.splice(e,1)};u.$viewChangeListeners.push(n)}}),i.$watchGroup(["model.$valid","model.$pristine","model.$touched"],function(){I()}),i.$watchCollection("model.$error",function(){I()})}}}]),angular.module("bulbApp.validationModule").directive("bulbValidationForm",["$compile",function(e){return{restrict:"A",require:"form",link:function(e,t,n,o){n.$set("novalidate",""),o.handleRemoteErrors=function(t){t.data.errorMap.fieldErrors&&e.$broadcast("bulbRemoteValidationErrors",{fieldErrors:t.data.errorMap.fieldErrors,form:this})};var i={};o.updateStatus=function(e,t){i[e]=t;var n=!1;angular.forEach(i,function(e){e||(n=!0)}),o.bulbInvalid=n}}}}]),angular.module("xregexp",[]).factory("XRegExp",["$window",function(e){return e.XRegExp}]),angular.module("bulbApp.createModule",["bulbApp.configModule"]),angular.module("bulbApp.createModule").directive("bulbCreate",["CONFIG",function(e){return{restrict:"E",scope:!0,templateUrl:e.resource.cdnRoot+"ajs/create/create.html",controller:function(){},controllerAs:"createCtrl",bindToController:{createCollection:"&",createPage:"&"}}}]),angular.module("bulbApp.devToolsModule",[]),angular.module("bulbApp.explorerModule",["ui.router","bulbApp.authModule","bulbApp.configModule"]).config(["$stateProvider","AUTH","CONFIG",function(e,t,n){e.state("explore",{parent:"root",url:"^/b/explore",resolve:{$title:["$translate",function(e){return e("explore_text")}]},views:{"content@root":{templateUrl:n.resource.cdnRoot+"ajs/explore/explore.html"}},bulbAuth:{authorizedRoles:[t.ROLES.USER]}})}]),angular.module("bulbApp.foundationModule",[]),function(){"use strict";function e(e,t,n){this.close=function(e){n.cancel(e)},this.onCloseKeydown=function(e){"Escape"===e.key&&this.close(e)};var o=e.parent().attr("window-class");o&&o.match(/(assetlibrary)|(scrollable)/)&&n.initScrollableModalLayoutHandler(t)}e.$inject=["$element","$scope","BulbModalService"],angular.module("bulbApp.foundationModule").controller("ModalController",e)}(),angular.module("bulbApp.headerModule",["foundationModule","ngAnimate","lodash","bulbApp.activityModule","bulbApp.alertsModule","bulbApp.busyModule","bulbApp.configModule","bulbApp.createModule","bulbApp.pageModule","bulbApp.translateModule","bulbApp.unitModule"]),function(){"use strict";function e(e,t){var n=this;this.setActiveTab=function(t){void 0!==t&&e.$emit("headerTabSelected",t),this.activeTab={},this.activeTab[t]=!0},this.setActiveTabForEvent=function(e,t){13!==e.keyCode&&32!==e.keyCode||this.setActiveTab(t)},t.menuTour=function(e){n.setActiveTab(e)}}e.$inject=["$rootScope","$window"],angular.module("bulbApp.headerModule").controller("HeaderTabsController",e)}(),angular.module("bulbApp.headerModule").directive("bulbHeaderTabs",["CONFIG",function(e){return{restrict:"E",templateUrl:e.resource.cdnRoot+"ajs/header/headertabs.html",controller:"HeaderTabsController as headerTabsCtrl"}}]),function(){"use strict";function e(e,t,n){this.setActiveTab=function(t){e.activeTab[t]=!0},e.$watch("activeTab",function(e,o){var i=n.findKey(e,function(e){return e});void 0!==i&&t.$emit("headerTabSelected",i)},!0)}e.$inject=["$scope","$rootScope","_"],angular.module("bulbApp.headerModule").controller("MobileHeaderTabsController",e)}(),angular.module("bulbApp.headerModule").directive("bulbMobileHeaderTabs",["CONFIG",function(e){return{restrict:"E",templateUrl:e.resource.cdnRoot+"ajs/header/mobileheadertabs.html",controller:["$scope","BulbBrowserService","BulbPageService",function(e,t,n){this.page=n.page,e.$watch("mobileHeaderTabsCtrl.page.editing",function(){jQuery(document).foundation("accordion","reflow")}),e.$on("togglePanel",function(n,o){t.isMobile()&&Foundation.utils.is_small_only()&&(e.headerCtrl.toggleHeader(n,"general-mobile"),e.mobileHeaderTabsCtrl.isPagePublishOpen=!0)})}],controllerAs:"mobileHeaderTabsCtrl"}}]),angular.module("bulbApp.organizationModule",["ui.router","bulbApp.authModule","bulbApp.configModule","bulbApp.filtersModule","bulbApp.utilsModule"]).constant("ORGANIZATION",{MAIN_BULB_ORGANIZATION_ID:999999}).run(["$rootScope","ORGANIZATION",function(e,t){e.ORGANIZATION=t}]).config(["$stateProvider","AUTH","CONFIG",function(e,t,n){e.state("organizations_admin",{parent:"bulbView",url:"^/b/organizations",resolve:{allOrganizations:["Restangular","BulbBusyService",function(e,t){return t.showBusyDuring(e.all("organizations").getList().then(function(e){return e}))}],$title:["$translate",function(e){return e("organization_title")}]},views:{bulbView:{templateUrl:n.resource.cdnRoot+"ajs/organization/organizations.html",controller:"OrganizationsController as organizationsCtrl"}},bulbAuth:{authorizedRoles:[t.ROLES.ADMIN]}}).state("organizations_bulb_admin",{parent:"bulbView",url:"^/b/organizations/bulb",resolve:{allMetrics:["Restangular","BulbBusyService",function(e,t){return t.showBusyDuring(e.one("admin/metrics").get().then(function(e){return e}))}],topOrganization:["allMetrics","BulbOrganizationService","ORGANIZATION",function(e,t,n){return{id:n.MAIN_BULB_ORGANIZATION_ID,metrics:e}}],$title:["$translate",function(e){return e("organization_title")}]},views:{bulbView:{templateUrl:n.resource.cdnRoot+"ajs/organization/organization-bulb-admin.html",controller:"OrganizationBulbAdminController as organizationBulbAdminCtrl"}},bulbAuth:{authorizedRoles:[t.ROLES.ADMIN]}}).state("organization",{parent:"bulbView",url:"^/b/organization/~i{id}",resolve:{topOrganization:["$stateParams","Restangular","BulbBusyService",function(e,t,n){return n.showBusyDuring(t.one("groups",e.id).customGET(null,{metrics:!0}).then(function(e){return e}))}],planInfo:["$http",function(e){return e.get(n.resource.path+"/public/planinfo.json").then(function(e){return e.data})}],$title:["$translate",function(e){return e("organization_title")}]},views:{bulbView:{templateUrl:n.resource.cdnRoot+"ajs/organization/organization.html",controller:"OrganizationController as organizationCtrl"}},bulbAuth:{authorizedRoles:[t.ROLES.ADMIN,t.ROLES.ORGANIZATION_ADMIN]}})}]),angular.module("bulbApp.organizationModule").component("dashboardAccountHover",{templateUrl:["CONFIG",function(e){return e.resource.cdnRoot+"ajs/organization/organization-account-hover.html"}],bindings:{name:"@"},controller:["BulbAuthService",function(e){this.signInAs=function(){e.adminSignInAs(this.name)}}]}),angular.module("bulbApp.organizationModule").component("archiveLoadingIndicator",{templateUrl:["CONFIG",function(e){return e.resource.cdnRoot+"ajs/organization/organization-archive-loading-indicator.html"}]}),function(){"use strict";function e(e){this.current={topOrg:e,dashMetrics:e.metrics,id:e.id,item:""}}e.$inject=["topOrganization"],angular.module("bulbApp.organizationModule").controller("OrganizationBulbAdminController",e)}(),function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c,u,d,p,h,g,m){var f=this;this.currentUser=d.currentUser,this.isUserBulbAdmin=d.currentUser.hasRole(g.ROLES.ADMIN),this.isUserBulbOrganizationAdmin=d.currentUser.hasRole(g.ROLES.ORGANIZATION_ADMIN),this.defaultRestrictions=m.cloneDeep(e.EDUCATION.organizations.restrictions),this.defaultRestrictions.publishing.publicPublishing=!1,this.certFileName=null,this.settingsHasBeenClicked=!1,this.hasGrades=!1,this.hasSchools=!1,this.isAnyFieldUpdated=!1,this.schools={current:{data:null,restrictions:null},withoutRestrictions:[],withRestrictions:[]},this.connectionOptions=["password_connection","google_connection","azure_ad_connection","clever_connection"],this.importType=["full_import","delta_import"],this.sessionTimeoutOptions=[{display:"session_timeout_disabled",value:-1},{display:"session_timeout_half_hour",value:30},{display:"session_timeout_hour",value:60},{display:"session_timeout_day",value:1440},{display:"session_timeout_week",value:10080}],this.organizations=[],this.accordion={},a.onRouteChangeOff=a.$on("$stateChangeStart",function(e,t,n,o){if(!(f.isAnyFieldUpdated&&o.url.indexOf("organization/~i")>-1))return;return h.show({titleCode:"organization_integration_unsaved_changes_modal_title",bodyCode:"organization_integration_unsaved_changes_modal_body",okButtonCode:"organization_integration_unsaved_changes_modal_continue_button"}).then(function(){a.onRouteChangeOff(),s.go(t,n,{location:!1})},function(){r.changingState=!1,delete r.pendingUrl}),void e.preventDefault()}),this.storedOrganization=c.copy(t),this.accordion={},this.current={topOrg:t,dashMetrics:t.metrics,id:t.id,item:""};var b=null;function v(){c.one("organizations",f.current.topOrg.id).customGET("archiveStatus").then(function(e){f.current.topOrg.archiveStatus.secondsRemaining=e.secondsRemaining,f.current.topOrg.archiveStatus.status=e.status,"ENABLED"===e.status&&b&&(n.cancel(b),b=null)})}this.changeOrgSessionTimeout=function(e){p.showBusyDuring(c.one("organizations",f.current.topOrg.id).patch({sessionTimeout:e}))},this.generateInviteToken=function(e){p.showBusyDuring(c.all("token/group/"+e.id).post().then(function(t){e.inviteToken=t.token}))},this.deleteInviteToken=function(e){h.show({titleCode:"organization_bulb_school_direct_toggle_warning_title",bodyCode:"organization_access_token_toggle_warning",showOkButton:!0,showCancelButton:!0}).then(function(){p.showBusyDuring(c.all("token/group/"+e.id).remove().then(function(){f.accordion.isInviteTokenSet=!1,delete e.inviteToken}))})},this.toggleInviteToken=function(e){f.accordion.isInviteTokenSet?f.accordion.isInviteTokenSet&&!e.inviteToken&&f.generateInviteToken(e):(f.accordion.isInviteTokenSet=!0,f.deleteInviteToken(e))},"PROCESSING"===this.current.topOrg.archiveStatus.status&&(b||(b=n(v,3e3))),a.$on("$destroy",function(){b&&n.cancel(b)}),this.enableArchiving=function(){h.show({fontAwesomeCode:"fas fa-inbox",titleCode:"organization_archive_collection_header",bodyCode:"organization_archive_collection_body_instructions",okButtonCode:"organization_archive_enable_button",cancelButtonCode:"organization_archive_cancel_button",showCancelButton:!0,windowClass:"updated-modal-design bulb-admin-dashboard-archive-modal"}).then(function(){p.showBusyDuring(c.one("organizations",f.current.topOrg.id).patch({enableArchiving:!0}).then(function(e){f.current.topOrg.archiveStatus.status=e.archiveStatus.status,v(),b=n(v,3e3)}))})},this.enableActiveAccordion=function(e){f.accordion={},e.inviteToken&&(f.accordion.isInviteTokenSet=!0)},this.checkAndPromptUnsavedChanges=function(e){if("ADMIN"===e&&!f.settingsHasBeenClicked)return f.settingsHasBeenClicked=!0,void f.setupSettingsPage(f.current.topOrg);f.isAnyFieldUpdated&&(f.activeTab={},f.activeTab.ADMIN=!0,f.onTabChangePromptUnsavedChanges().then(function(){f.isAnyFieldUpdated=!1,f.activeTab={},f.activeTab[e]=!0,"ADMIN"===e&&f.setupSettingsPage(f.current.topOrg)}))},this.enableActiveAccordion=function(e){f.accordion={},e.inviteToken&&(f.accordion.isInviteTokenSet=!0),m.forEach(e.integrationsMap,function(e,t){f.accordion[t]=!0})};var C={};this.setupSettingsPage=function(t){l(function(){C={restrictions:{element:$(".publishing-sharing-group:first-child > a")}},p.showBusyDuring(c.one("groups",t.id).customGET(null,{metrics:!1}).then(function(e){f.setDummyPassword(e),f.current.topOrg=e,c.one("token/group/"+e.id).get().then(function(e){e&&(f.current.topOrg.inviteToken=e.token)}).finally(function(){f.enableActiveAccordion(f.current.topOrg)})}).then(function(){f.unbindAccordions(t),null===f.current.topOrg.restrictions&&(f.current.topOrg.restrictions=e.EDUCATION.organizations.restrictions),r.$broadcast("$orgRestrictionsLoaded")}))})},this.setDummyPassword=function(e){a.password=Math.random().toString(36).slice(2),m.forEach(e.integrationsMap,function(t,n){"fTP"!==n&&"oneRoster"!==n&&"classLink"!==n||(e.integrationsMap[n].password=a.password)})},this.unbindAccordions=function(e){C.restrictions.element.off("click"),C.restrictions.element.off("click")},this.removeSchoolRestrictions=function(e,t){e.preventDefault(),e.stopPropagation();h.show({titleCode:"organization_custom_restrictions_delete_warning_title",bodyCode:"organization_custom_restrictions_delete_warning",showOkButton:!0,showCancelButton:!0}).then(function(){p.showBusyDuring(c.one("organizations",f.current.topOrg.id).one("schools",t.id).remove()),m.remove(f.schools.withRestrictions,function(e){return f.schools.withoutRestrictions.push(t),e.id===t.id})})},this.schoolSelected=function(e){m.remove(f.schools.withoutRestrictions,function(t){return f.schools.withRestrictions.push(e),t.id===e.id}),r.$broadcast("$orgRestrictionsLoaded")},this.enableLTI=function(e){f.accordion.lTILaunch&&!e.integrationsMap.lTILaunch?e.integrationsMap.lTILaunch={key:"",type:"LTILaunchConfiguration",importAccountsOnly:!1}:f.accordion.lTILaunch||(f.storedOrganization.integrationsMap.lTILaunch?(f.accordion.lTILaunch=!0,f.confirmModal(e,"lTILaunch","LTILaunchConfiguration")):delete e.integrationsMap.lTILaunch)},this.editLtiKey=function(e){var t={ltiKey:e.integrationsMap.lTILaunch.key};p.showBusyDuring(c.one("organizations",e.id).patch(t).then(function(t){e.integrationsMap=t.integrationsMap,f.enableActiveAccordion(t),f.storedOrganization.integrationsMap=c.copy(t.integrationsMap),f.isAnyFieldUpdated=!1}))},this.enableMo365Integration=function(e){f.accordion.mo365&&!e.integrationsMap.mo365?e.integrationsMap.mo365={type:"mo365Config",importAccountsOnly:!1}:f.accordion.mo365||(f.storedOrganization.integrationsMap.mo365?(f.accordion.mo365=!0,f.confirmModal(e,"mo365","mo365Config")):delete e.integrationsMap.mo365)},this.updateMo365Config=function(e){var t={mo365Config:e.integrationsMap.mo365};p.showBusyDuring(c.one("organizations",e.id).patch(t).then(function(t){e.integrationsMap=t.integrationsMap,f.enableActiveAccordion(t),f.storedOrganization.integrationsMap=c.copy(t.integrationsMap),f.isAnyFieldUpdated=!1}))},this.enableFTPIntegration=function(e){f.accordion.fTP&&!e.integrationsMap.fTP?e.integrationsMap.fTP={type:"ftpConfig",port:22,folder:"/",importType:this.importType[0],importAccountsOnly:!1,accountPositionConnectionMap:{STUDENT:this.connectionOptions[0],EDUCATOR:this.connectionOptions[0],ADMINISTRATOR:this.connectionOptions[0],OTHER:this.connectionOptions[0]},protocol:"SFTP"}:f.accordion.fTP||(f.storedOrganization.integrationsMap.fTP?(f.accordion.fTP=!0,f.confirmModal(e,"fTP","ftpConfig")):delete e.integrationsMap.fTP)},this.handleSettingFtpImportType=function(e){f.current.topOrg.integrationsMap.fTP.importType=e.selectedOption,f.ftpConfigForm.$pristine=!1},this.handleSettingFtpConnectionOptions=function(e,t){f.current.topOrg.integrationsMap.fTP.accountPositionConnectionMap[t]=e.selectedOption,f.ftpConfigForm.$pristine=!1},this.updateFTPConfig=function(e){f.removeDummyPassword(e,"fTP");var t={ftpConfig:e.integrationsMap.fTP};p.showBusyDuring(c.one("organizations",e.id).patch(t).then(function(t){f.setDummyPassword(t),e.integrationsMap=t.integrationsMap,f.enableActiveAccordion(t),f.storedOrganization.integrationsMap=c.copy(t.integrationsMap),f.isAnyFieldUpdated=!1}))},this.enableOneRosterIntegration=function(e){f.accordion.oneRoster&&!e.integrationsMap.oneRoster?e.integrationsMap.oneRoster={type:"oneRosterConfig",port:22,folder:"/",importType:this.importType[0],importAccountsOnly:!1,accountPositionConnectionMap:{STUDENT:this.connectionOptions[0],EDUCATOR:this.connectionOptions[0],ADMINISTRATOR:this.connectionOptions[0],OTHER:this.connectionOptions[0]},or_Version:"1.1",protocol:"SFTP"}:f.accordion.oneRoster||(f.storedOrganization.integrationsMap.oneRoster?(f.accordion.oneRoster=!0,f.confirmModal(e,"oneRoster","oneRosterConfig")):delete e.integrationsMap.oneRoster)},this.updateOneRosterConfig=function(e){f.removeDummyPassword(e,"oneRoster");var t={oneRosterConfig:e.integrationsMap.oneRoster};Object.keys(t.oneRosterConfig).forEach(function(e){"oneroster_csv"===t.oneRosterConfig.or_ImportType?"clientId"!==e&&"clientSecret"!==e&&"endpointUrl"!==e||(t.oneRosterConfig[e]=null):"oneroster_api"===t.oneRosterConfig.or_ImportType&&("folder"!==e&&"host"!==e&&"password"!==e&&"protocol"!==e&&"username"!==e||(t.oneRosterConfig[e]=null))}),p.showBusyDuring(c.one("organizations",e.id).patch(t).then(function(t){f.setDummyPassword(t),e.integrationsMap=t.integrationsMap,f.enableActiveAccordion(t),f.storedOrganization.integrationsMap=c.copy(t.integrationsMap),f.isAnyFieldUpdated=!1}))},this.handleSettingOneRosterImportType=function(e){f.current.topOrg.integrationsMap.oneRoster.importType=e.selectedOption,f.oneRosterForm.$pristine=!1},this.handleSettingOneRosterConnectionOptions=function(e,t){f.current.topOrg.integrationsMap.oneRoster.accountPositionConnectionMap[t]=e.selectedOption,f.oneRosterForm.$pristine=!1},this.enableClassLinkIntegration=function(e){f.accordion.classLink&&!e.integrationsMap.classLink?e.integrationsMap.classLink={type:"classLinkConfig",port:22,folder:"/",importType:this.importType[0],importAccountsOnly:!1,or_Version:"1.1",protocol:"SFTP"}:f.accordion.classLink||(f.storedOrganization.integrationsMap.classLink?(f.accordion.classLink=!0,f.confirmModal(e,"classLink","classLinkConfig")):delete e.integrationsMap.classLink)},this.updateClassLinkConfig=function(e){f.removeDummyPassword(e,"classLink");var t={classLinkConfig:e.integrationsMap.classLink};Object.keys(t.classLinkConfig).forEach(function(e){"classLink_csv"===t.classLinkConfig.or_ImportType?"clientId"!==e&&"clientSecret"!==e&&"endpointUrl"!==e||(t.classLinkConfig[e]=null):"classLink_api"===t.classLinkConfig.or_ImportType&&("folder"!==e&&"host"!==e&&"password"!==e&&"protocol"!==e&&"username"!==e||(t.classLinkConfig[e]=null))}),p.showBusyDuring(c.one("organizations",e.id).patch(t).then(function(t){f.setDummyPassword(t),e.integrationsMap=t.integrationsMap,f.enableActiveAccordion(t),f.storedOrganization.integrationsMap=c.copy(t.integrationsMap),f.isAnyFieldUpdated=!1}))},this.handleSettingClasslinkImportType=function(e){f.current.topOrg.integrationsMap.classLink.importType=e.selectedOption,f.classLinkConfigForm.$pristine=!1},this.enableCleverIntegration=function(e){f.accordion.clever&&!e.integrationsMap.clever?e.integrationsMap.clever={type:"cleverConfig",importAccountsOnly:!1}:f.accordion.clever||(f.storedOrganization.integrationsMap.clever?(f.accordion.clever=!0,f.confirmModal(e,"clever","cleverConfig")):delete e.integrationsMap.clever)},this.updateCleverConfig=function(e){var t={cleverConfig:e.integrationsMap.clever};p.showBusyDuring(c.one("organizations",e.id).patch(t).then(function(t){e.integrationsMap=t.integrationsMap,f.enableActiveAccordion(t),f.storedOrganization.integrationsMap=c.copy(t.integrationsMap),f.isAnyFieldUpdated=!1}))},this.enableGoogleIntegration=function(e){f.accordion.google&&!e.integrationsMap.google?e.integrationsMap.google={type:"googleConfig"}:f.accordion.google||(f.storedOrganization.integrationsMap.google?(f.accordion.google=!0,f.confirmModal(e,"google","googleConfig")):delete e.integrationsMap.google)},this.updateGoogleConfig=function(e){var t={googleConfig:e.integrationsMap.google};"google_p12"===t.googleConfig.googleKeyType&&(t.googleConfig.privateKeyContent=null),p.showBusyDuring(c.one("organizations",e.id).patch(t).then(function(t){e.integrationsMap=t.integrationsMap,f.enableActiveAccordion(t),f.storedOrganization.integrationsMap=c.copy(t.integrationsMap),f.isAnyFieldUpdated=!1}))},this.enableIFrameEmbedIntegration=function(e){f.accordion.iFrameEmbed&&!e.integrationsMap.iFrameEmbed?e.integrationsMap.iFrameEmbed={type:"iFrameEmbedConfig"}:f.accordion.iFrameEmbed||(f.storedOrganization.integrationsMap.iFrameEmbed?(f.accordion.iFrameEmbed=!0,f.confirmModal(e,"iFrameEmbed","iFrameEmbedConfig")):delete e.integrationsMap.iFrameEmbed)},this.updateIFrameEmbedConfig=function(e){var t={iframeEmbedConfig:e.integrationsMap.iFrameEmbed};p.showBusyDuring(c.one("organizations",e.id).patch(t).then(function(t){e.integrationsMap=t.integrationsMap,f.enableActiveAccordion(t),f.storedOrganization.integrationsMap=c.copy(t.integrationsMap),f.isAnyFieldUpdated=!1}))},this.toggleBulbSchoolDirect=function(e){f.isUserBulbAdmin&&(e.bulbSchoolDirect?f.editBulbSchoolDirect(e,!1):f.editBulbSchoolDirect(e,!0))},this.editBulbSchoolDirect=function(e,t){h.show({titleCode:"organization_bulb_school_direct_toggle_warning_title",bodyCode:"organization_bulb_school_direct_toggle_warning",showOkButton:!0,showCancelButton:!0}).then(function(){var n={bulbSchoolDirect:t};p.showBusyDuring(c.one("organizations",e.id).patch(n).then(function(t){e.bulbSchoolDirect=t.bulbSchoolDirect}))})},this.sendBSDEmails=function(e){var t={titleCode:"organization_bulb_school_direct_already_sent",bodyCode:"organization_bulb_school_direct_already_sent_body",showOkButton:!0,showCancelButton:!0};h.show({titleCode:"organization_bulb_school_direct_emails",bodyCode:"organization_bulb_school_direct_emails_body",showOkButton:!0,showCancelButton:!0}).then(function(){var n={sentBSDEmail:!0};e.sentBSDEmail?h.show(t).then(function(){c.one("organizations",e.id).patch(n).then(function(t){e.sentBSDEmail=t.sentBSDEmail})}):c.one("organizations",e.id).patch(n).then(function(t){e.sentBSDEmail=t.sentBSDEmail})})},this.isAdministrator=function(e){return-1!==e.administratorIds.indexOf("Account:"+d.currentUser.id)||d.currentUser.hasRole(g.ROLES.ADMIN)},this.setActiveTab=function(e){void 0!==e&&r.$emit("tabSelected",e),this.activeTab={},this.activeTab[e]=!0},this.toggleChevron=function(e){$("#chevron_for_"+e).toggleClass("rot180")};var y=function(){return"google_json"===f.current.topOrg.integrationsMap.google.googleKeyType?"application/json":".p12"};this.uploadOptions={createAttachedFileUploadOptions:function(e){return f.createAttachedFileUploadOptions(f,e)}},this.uploadAttachedFiles=function(e,t){var n=f.uploadOptions.createAttachedFileUploadOptions(!0,e,t,!1);u.uploadFile(n,y,!1)},this.createAttachedFileUploadOptions=function(e,t){var n;return angular.merge({},{add:function(e,o){o.abortUploading||(n=o.files[0],o.process().done(function(){var i=new FileReader;n.name.match("json")?i.readAsBinaryString(o.files[0]):i.readAsArrayBuffer(o.files[0]),i.onload=function(i){o.target=i.target;var r=o.target.result;if(f.certFileName=n.name,n.name.match("json"))f.parsePrivateKeyJson(r);else{var s=[];new Uint8Array(r).map(function(e,t){s[t]=e}),f.current.topOrg.integrationsMap.google.p12Content=s,f.current.topOrg.integrationsMap.google.privateKeyContent=f.certFileName}a.$apply(),t&&$(e.target).remove()}}))}})},this.resetPrivateKey=function(){f.current.topOrg.integrationsMap.google.privateKeyContent=null},a.$watch("organizationCtrl.current.topOrg.integrationsMap.google.privateKeyContent",function(e){e&&f.parsePrivateKeyJson(e)}),this.isJson=function(e){try{JSON.parse(e)}catch(e){return!1}return!0},this.parsePrivateKeyJson=function(e){var t;t=(t=(t=(t=(t=f.isJson(e)?JSON.parse(e).private_key:e.indexOf("private_key")>-1?(t=e.replace('"private_key":',"")).replace(/[,'":*{}\n]/g,""):e).replace("-----BEGIN PRIVATE KEY-----","")).replace("-----END PRIVATE KEY-----","")).replace(/\s/g,"")).replace(/\\n/g,""),f.current.topOrg.integrationsMap.google.privateKeyContent=t},this.confirmModal=function(e,t,n){h.show({titleCode:"organization_turn_off_integration_modal_title",bodyCode:"organization_turn_off_integration_modal_body",okButtonCode:"organization_turn_off_integration_modal_confirm_button"}).then(function(){p.showBusyDuring(c.one("organizations",e.id).one("integrationType",n).remove().then(function(){f.accordion[t]=!1,delete e.integrationsMap[t],delete f.storedOrganization.integrationsMap[t]}))})},this.removeDummyPassword=function(e,t){e.integrationsMap[t].password===a.password&&delete e.integrationsMap[t].password},this.onTabChangePromptUnsavedChanges=function(){var e=i.defer();return h.show({titleCode:"organization_integration_unsaved_changes_modal_title",bodyCode:"organization_integration_unsaved_changes_modal_body",okButtonCode:"organization_integration_unsaved_changes_modal_continue_button"}).then(function(){e.resolve(!0)},function(){e.reject(!1)}),e.promise},window.onbeforeunload=function(){if(f.isAnyFieldUpdated)return"organization_integration_unsaved_changes_modal_body"}}e.$inject=["planInfo","topOrganization","$interval","$log","$q","$rootScope","$scope","$state","$timeout","Restangular","BulbAssetLibraryUploadService","BulbAuthService","BulbBusyService","BulbModalService","AUTH","_"],angular.module("bulbApp.organizationModule").controller("OrganizationController",e)}(),angular.module("bulbApp.organizationModule").directive("organizationDatatable",["$compile","$cookies","$rootScope","$timeout","$translate","magnitudeFilter","CONFIG",function(e,t,n,o,i,r,a){return{scope:{},link:function(n,s,l){var c=l.topOrganizationId,u=l.organizationDatatable;function d(){for(var e=$('[role="row"]').not(".bulb-dashboard-lower-table-first-row"),t=0;t<e.length;t++){var n=$(e[t]);n.find("td:first-child").mouseenter(function(e){p($(e.currentTarget),"enter")}),n.find("td:first-child").mouseleave(function(e){p($(e.currentTarget),"leave")})}}function p(e,t){var n=e.parent();"enter"===t?(n.addClass("highlighted-table-row"),n.children().first().attr("colspan",4)):(n.removeClass("highlighted-table-row"),n.children().first().removeAttr("colspan"))}o(function(){var e=$("#"+u.toLowerCase()+"-table_filter input");e.attr("placeholder",i.instant("organization_dashboard_table_search_placeholder"));var t,n=null;e.unbind(),e.keyup(function(e){t=this.value,n&&o.cancel(n),n=o(function(){s.DataTable().search(t).draw()},1e3),13===e.keyCode&&(s.DataTable().search(t).draw(),o.cancel(n))})});var h,g,m=i.instant(["organization_dashboard_lower_table_info_organization","organization_dashboard_lower_table_info_school","organization_dashboard_lower_table_info_grade","organization_dashboard_lower_table_info_class","organization_dashboard_lower_table_info_admin","organization_dashboard_lower_table_info_teacher","organization_dashboard_lower_table_info_student","organization_dashboard_lower_table_info_other","organization_dashboard_lower_table_previous_button","organization_dashboard_lower_table_next_button","unit_abbrev_bytes"]),f="ADMINISTRATOR"===u?"organization_dashboard_lower_table_info_admin":"EDUCATOR"===u?"organization_dashboard_lower_table_info_teacher":"STUDENT"===u?"organization_dashboard_lower_table_info_student":"organization_dashboard_lower_table_info_other",b=(h=c,g=[{name:"displayName",width:"35%",targets:0,searchable:!1,render:function(e,t,n){return"<span>"+n.displayName+'</span><dashboard-account-hover name="'+n.username+'"></dashboard-account-hover>'}},{name:"metrics.numPublishedPages",targets:1,searchable:!1,render:function(e,t,n){return n.metrics.numPublishedPages}},{name:"metrics.numDraftPages",targets:2,searchable:!1,render:function(e,t,n){return n.metrics.numDraftPages}},{name:"storageInMagnitudeShown",targets:3,searchable:!1,orderData:4,render:function(e,t,n){return r(n.features.StorageFeature.currentUsedStorageBytes,{factor:1024})+m.unit_abbrev_bytes}},{name:"features.StorageFeature.currentUsedStorageBytes",targets:4,visible:!1,searchable:!1,render:function(e,t,n){return n.features.StorageFeature.currentUsedStorageBytes}},{name:"searchString",targets:5,visible:!1,searchable:!0,render:function(e,t,n){for(var o=n.username+" "+n.defaultEmail,i=0;i<n.emails.length;i++)!0===n.emails[i].verified&&(o+=" "+n.emails[i].email);return o}}],s.DataTable({createdRow:function(t){e(angular.element(t).contents())(n)},columnDefs:g,processing:!0,serverSide:!0,ajax:{url:a.context.name+"/b/rest/organizations/"+h+"/members?position="+u,type:"POST",contentType:"application/json",dataType:"json",headers:{"X-XSRF-TOKEN":t.get("XSRF-TOKEN")},data:function(e){return e.columns=e.columns.map(function(e){return delete e.searchable,delete e.orderable,delete e.search,e}),JSON.stringify(e)}},autoWidth:!1,lengthChange:!1,pagingType:"full_numbers",pageLength:20,order:[[0,"asc"]],language:{paginate:{first:"&laquo;",last:"&raquo;",previous:m.organization_dashboard_lower_table_previous_button,next:m.organization_dashboard_lower_table_next_button},info:m[f]}}));d(),b.on("draw",function(){d()}),s.bind("$destroy",function(){s.DataTable().clear().destroy()})}}}]),function(){"use strict";function e(e,t,n,o,i,r,a,s,l){var c,u,d,p=this;function h(t){r.showBusyDuring(o.one("groups",t.id).customGET("members",{metrics:!1,filter:'class:"GRADE"',pageSize:14}).then(function(n){var o=n.members;if(o.length>0){p.hasGrades=!0;for(var i=0;i<o.length;i++)p.containedGrades.push(o[i].grade),p.enabledGrades[o[i].grade]=l.cloneDeep(e.defaultRestrictions);if(null!==t.gradeRestrictions)for(var r=0;r<Object.keys(t.gradeRestrictions).length;r++){var a=Object.keys(t.gradeRestrictions)[r];-1!==p.containedGrades.indexOf(a)&&(p.enabledGrades[a]=t.gradeRestrictions[a])}}else t.restrictions?p.restrictions=t.restrictions:p.restrictions=l.cloneDeep(e.defaultRestrictions);p.checkIfAllCheckboxesAreStillActive(t)}))}function g(){for(var t=$("."+e.currentRestrictedOrg.id+"-main-restriction-checkbox"),n=$("."+e.currentRestrictedOrg.id+"-main-grade-checkbox:not(:disabled)"),o=0;o<t.length;o++){var i=$(t[o]),r=$('[name="'+e.currentRestrictedOrg.id+"_"+i.prop("name")+'[]"]:not(:disabled)'),a={totalItems:r.length,numDisabled:0,numEnabled:0};if("privateProfilesEnabled"!==i.prop("name")){for(var s=0;s<r.length;s++)$(r[s]).prop("disabled")&&(a.numDisabled++,a.totalItems--),$(r[s]).prop("checked")&&a.numEnabled++;0===a.totalItems?(i.prop("checked",!1),i.prop("disabled",!0)):a.totalItems>0&&(i.prop("disabled",!1),a.numEnabled===a.totalItems?i.prop("checked",!0):i.prop("checked",!1))}}for(var l=0;l<n.length;l++){for(var c=$(n[l]),u=$("."+e.currentRestrictedOrg.id+"-"+c.prop("name")+"-checkbox").not('[name="'+e.currentRestrictedOrg.id+'_privateProfiles[]"]'),d={totalItems:u.length,numDisabled:0,numEnabled:0},p=0;p<u.length;p++)$(u[p]).prop("disabled")&&(d.numDisabled++,d.totalItems--),$(u[p]).prop("checked")&&d.numEnabled++;0===d.totalItems?(c.prop("checked",!1),c.prop("disabled",!0)):d.totalItems>0&&(c.prop("disabled",!1),d.numEnabled===d.totalItems?c.prop("checked",!0):c.prop("checked",!1))}}function m(t,n){p.hasGrades?t?(c.attr({checked:!1,disabled:!1}),u.attr({checked:!1,disabled:!1}),d.attr({checked:!1,disabled:!1})):jQuery.each($("."+e.currentRestrictedOrg.id+"-"+n+"-checkbox"),function(e,t){var n=jQuery(t);(n.attr("name").includes("publicPublishing")||n.attr("name").includes("privateLinks")||n.attr("name").includes("socialSharing"))&&n.attr({checked:!1,disabled:!1})}):(p.restrictions.privateProfilesEnabled=!1,c.attr("disabled",!1),u.attr("disabled",!1),d.attr("disabled",!1))}this.hasGrades=null,this.enabledGrades={},this.containedGrades=[],this.restrictions={},this.hasRunLoad=!1,this.isUserOrgAdmin=i.currentUser.hasRole(s.ROLES.ORGANIZATION_ADMIN),this.grades=[{long:"PRESCHOOL",short:n.instant("organization_dashboard_preschool_letter")},{long:"KINDERGARTEN",short:n.instant("organization_dashboard_kindergarten_letter")},{long:"FIRST_GRADE",short:"1"},{long:"SECOND_GRADE",short:"2"},{long:"THIRD_GRADE",short:"3"},{long:"FOURTH_GRADE",short:"4"},{long:"FIFTH_GRADE",short:"5"},{long:"SIXTH_GRADE",short:"6"},{long:"SEVENTH_GRADE",short:"7"},{long:"EIGHTH_GRADE",short:"8"},{long:"NINTH_GRADE",short:"9"},{long:"TENTH_GRADE",short:"10"},{long:"ELEVENTH_GRADE",short:"11"},{long:"TWELFTH_GRADE",short:"12"},{long:"OTHER",short:n.instant("organization_dashboard_other_letters")}],h(e.currentRestrictedOrg),this.checkIfAllCheckboxesAreStillActive=function(){p.hasGrades&&("SCHOOL"===e.currentRestrictedOrg.type?t(g):g())},this.handleDualPurposeCheckbox=function(t,n,o,i){var r=jQuery(n.currentTarget).prop("checked"),a=jQuery(n.currentTarget).prop("name"),s=jQuery("."+t.id+"-"+a+'-checkbox[restriction="privateProfilesEnabled"]').prop("checked");if(void 0===o){var c=jQuery("."+t.id+"-"+a+"-checkbox");l.mapValues(p.enabledGrades[a],function(e){for(var t in e)e[t]=("publicPublishing"!==t&&"privateLinks"!==t||!s)&&r}),c.not('[name="'+e.currentRestrictedOrg.id+'_privateProfiles[]"]').not(":disabled").prop("checked",r),p.checkIfAllCheckboxesAreStillActive(e.currentRestrictedOrg)}else{if(p.hasGrades){for(var u=0;u<Object.keys(p.enabledGrades).length;u++){var d=p.enabledGrades[Object.keys(p.enabledGrades)[u]];if(""===i)d[o]=r;else{if(("publicPublishing"===o||"privateLinks"===o)&&d.privateProfilesEnabled){d[i][o]=!1;continue}d[i][o]=r}}$('[name="'+e.currentRestrictedOrg.id+"_"+o+'[]"]:not(:disabled)').prop("checked",r).trigger("input")}else"publishing"===i&&p.restrictions.publishing[o]?p.restrictions.publishing[o]=!1:"publishing"!==i||p.restrictions.publishing[o]||(p.restrictions.publishing[o]=!0),"sharing"===i&&p.restrictions.sharing[o]?p.restrictions.sharing[o]=!1:"sharing"!==i||p.restrictions.sharing[o]||(p.restrictions.sharing[o]=!0),""===i&&p.restrictions[o]?p.restrictions[o]=!1:""!==i||p.restrictions[o]||(p.restrictions[o]=!0);p.checkIfAllCheckboxesAreStillActive(e.currentRestrictedOrg)}},t(function(){c=jQuery("#"+e.currentRestrictedOrg.id+"_publishToPublic").parent().parent().find("input:not(:disabled)"),u=jQuery("#"+e.currentRestrictedOrg.id+"_createPrivateLinks").parent().parent().find("input:not(:disabled)"),d=jQuery("#"+e.currentRestrictedOrg.id+"_shareToSocial").parent().parent().find("input:not(:disabled)")}),this.togglePrivateProfilesCheckbox=function(t,n,o){var i=jQuery(t.currentTarget);if(i.prop("checked")){a.show({titleCode:"private_profiles_modal_title",bodyCode:"private_profiles_modal_description",okButtonCode:"private_profiles_modal_button_text",showCancelButton:!0}).then(function(){n&&p.handleDualPurposeCheckbox(e.currentRestrictedOrg,t,"privateProfilesEnabled",""),function(t,n,o){if(p.hasGrades)if(n){for(var i=0;i<Object.keys(p.enabledGrades).length;i++){var r=p.enabledGrades[Object.keys(p.enabledGrades)[i]];r.publishing.publicPublishing=!1,r.sharing.privateLinks=!1,r.sharing.socialSharing=!1}c.attr({checked:!1,disabled:!0}),u.attr({checked:!1,disabled:!0}),d.attr({checked:!1,disabled:!0})}else p.enabledGrades[o].sharing.privateLinks=!1,p.enabledGrades[o].sharing.socialSharing=!1,p.enabledGrades[o].publishing.publicPublishing=!1,jQuery.each($("."+e.currentRestrictedOrg.id+"-"+o+"-checkbox"),function(e,t){var n=jQuery(t);(n.attr("name").includes("publicPublishing")||n.attr("name").includes("privateLinks")||n.attr("name").includes("socialSharing"))&&(n.attr("checked",!1),n.attr("disabled",!0))});else c.attr({checked:!1,disabled:!0}),u.attr({checked:!1,disabled:!0}),d.attr({checked:!1,disabled:!0}),p.restrictions.publishing.publicPublishing=!1,p.restrictions.sharing.privateLinks=!1,p.restrictions.sharing.socialSharing=!1}(0,n,o)},function(){i.prop("checked",!1),m(n,o)})}else m(n,o);p.checkIfAllCheckboxesAreStillActive()},this.isGradeEnabled=function(e){return-1!==p.containedGrades.indexOf(e)},this.setRestrictions=function(t){var n={},i={};p.hasGrades?t.id===e.topOrg.id?(n={gradeRestrictions:p.enabledGrades},r.showBusyDuring(o.one("organizations",t.id).patch(n))):(i={gradeRestrictions:p.enabledGrades},r.showBusyDuring(o.one("organizations",e.topOrg.id).one("schools",t.id).patch(i))):t.id===e.topOrg.id?(n={restrictions:p.restrictions},r.showBusyDuring(o.one("organizations",t.id).patch(n))):(i={restrictions:p.restrictions},r.showBusyDuring(o.one("organizations",e.topOrg.id).one("schools",t.id).patch(i)))},e.$on("$orgRestrictionsLoaded",function(){p.hasRunLoad||(p.hasRunLoad=!0,t(function(){h(e.currentRestrictedOrg),p.containedGrades.forEach(function(t){var n="."+e.currentRestrictedOrg.id+"-"+t+"-checkbox";jQuery(n+'[restriction="privateProfilesEnabled"]').prop("checked")&&(jQuery(n+'[restriction="publicPublishing"]').attr("disabled",!0),jQuery(n+'[restriction="privateLinks"]').attr("disabled",!0),jQuery(n+'[restriction="socialSharing"]').attr("disabled",!0))})}))})}e.$inject=["$scope","$timeout","$translate","Restangular","BulbAuthService","BulbBusyService","BulbModalService","AUTH","_"],angular.module("bulbApp.organizationModule").controller("OrganizationRestrictionsController",e)}(),angular.module("bulbApp.organizationModule").directive("restrictionsTable",["$translate","$rootScope","$compile","CONFIG",function(e,t,n,o){return{scope:{topOrg:"<",currentRestrictedOrg:"=",defaultRestrictions:"<"},templateUrl:o.resource.cdnRoot+"ajs/organization/organization-restrictions.html",controller:"OrganizationRestrictionsController as organizationRestrictionsCtrl"}}]),function(){"use strict";angular.module("bulbApp.organizationModule").service("BulbOrganizationService",function(){var e=this;this.breadcrumbStack=[],this.addToBreadcrumb=function(t){var n=e.breadcrumbStack.map(function(e){return e.id}).indexOf(t.id);-1===n?e.breadcrumbStack.push(t):e.goToBreadcrumb(t,n)},this.goToBreadcrumb=function(t,n){e.breadcrumbStack.length=n+1},this.getBreadcrumbStack=function(){return e.breadcrumbStack},this.deleteBreadcrumbStack=function(){e.breadcrumbStack=[]}})}(),angular.module("bulbApp.organizationModule").directive("organizationUnsavedChanges",function(){return{restrict:"A",require:"form",link:function(e,t){t.on("change",function(){e.organizationCtrl.isAnyFieldUpdated=!0})}}}),function(){"use strict";function e(e,t,n,o){var i=this;this.allOrganizations=e.plain().sort(function(e,t){return e.displayName.toUpperCase().localeCompare(t.displayName.toUpperCase())}),this.createOrganization=function(){var e=t.open({templateUrl:o.resource.cdnRoot+"ajs/organization/create-organization.html",controller:function(){var t=this;t.groupTypes=["DISTRICT","SCHOOL","GRADE","CLASS","OTHER"],t.submitOrg=function(){e.close(t)},t.handleSettingFormGroupType=function(e){this.groupType=e.selectedOption}},controllerAs:"createOrgFormCtrl",scope:this.scope,backdrop:!0,windowClass:"bulb-media-transient"});e.result.then(function(e){var t={displayName:e.displayName,groupType:e.groupType};n.all("organizations").post(t).then(function(e){i.allOrganizations.push(e)})})}}e.$inject=["allOrganizations","$modal","Restangular","CONFIG"],angular.module("bulbApp.organizationModule").controller("OrganizationsController",e)}(),angular.module("bulbApp.pageModule",["restangular","bulbApp.authModule","bulbApp.errorModule","bulbApp.permissionsModule","bulbApp.unitModule"]),function(){"use strict";function e(e,t,n,o,i,r,a,s,l){var c=this;this.page=s.page,c.parentUnit=l.parentUnit,this.delete=function(){n("type_draft_page_unit").then(function(s){n("modal_delete_confirm_page",{type:s}).then(function(n){a.show({titleCode:"modal_delete_confirm_title",bodyText:n,okButtonCode:"button_delete",showCancelButton:!0}).then(function(){e.$broadcast("navigationAwayApproval",!0),i.showBusyDuring(l.deleteUnit(c.page.unit).then(function(){c.parentUnit&&"UserUnit"!==c.parentUnit.unitType?t.go("unit",{unitPath:c.parentUnit.path}):t.go("author",{username:o.currentUser.username})},function(e){r.error("Cannot delete page",e)}))},function(e){})})})}}e.$inject=["$rootScope","$state","$translate","BulbAuthService","BulbBusyService","BulbErrorService","BulbModalService","BulbPageService","BulbUnitService"],angular.module("bulbApp.pageModule").controller("DeletePanelController",e)}(),function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c){var u=this;u.currentUser=i.currentUser,u.currentUserPrefs=u.currentUser.prefs,u.userClickedBackArrow=!1,u.pendingStateChangeOnPublish=null;var d={canEdit:!1,mode:"default",editing:!1};function p(){"DraftPageUnit"===s.currentUnit.unitType||"PublishedPageUnit"===s.currentUnit.unitType||"ArchivePageUnit"===s.currentUnit.unitType?(angular.copy(d,u.page),u.page.unit=s.currentUnit,u.page.canEdit=i.currentUser.hasPermission(u.page.unit,c.PERMISSIONS.UPDATE)):angular.copy({},u.page)}this.page={},this.fetchQuestions=function(){if(!this.currentUnit||"???"!==this.currentUnit.unitType){var e=t.defer();return e.resolve(),e.promise}return o.one("units",this.currentUnit.id).getList("questions").then(function(e){u.page.questions=e,u.page.questionsLoaded=!0})},this.updatePageAfterReplaceEmbed=function(){p(),n.$broadcast("update-page-details")},p(),n.$watch(function(){return s.currentUnit.id},function(){p(),n.$broadcast("update-page-details")}),this.createPage=function(t){a.showBusyDuring(r.createPage(t).then(function(t){t.success?e.go("unit",{unitPath:t.path}):l.error("Cannot create page: "+t.message)},function(e){l.error("Cannot create page",e)}))}}e.$inject=["$state","$q","$rootScope","Restangular","BulbAuthService","BulbAjaxService","BulbBusyService","BulbUnitService","BulbErrorService","AUTH"],angular.module("bulbApp.pageModule").service("BulbPageService",e)}(),function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c,u,d,p,h,g){var m,f=this;function b(e){27===e.which&&n.$emit("closePublishPanel")}f.page=p.page,f.parentUnit=h.parentUnit,f.draftParentUnit=[],f.selectedVisibilityChoices=[],this.canUseTemplateFeature=l.currentUser.isAuthenticated()&&l.currentUser.features.TemplateFeature.enabled,this.defaultAutoSaveOptions={restId:f.page.unit.id,restCollection:"units"},this.visibilityAutoSaveOptions={restId:f.page.unit.id,customSave:function(){var e={groupIdsAndRoles:f.getReadAccessSubjectIds()};return s.one("units",f.page.unit.id).customPOST(e,"updatePendingReadAccessList")},getter:this.getReadAccessSubjectIds},this.collectionAutoSaveOptions={restId:f.page.unit.id,customSave:function(){var e=f.draftParentUnit[0]?f.draftParentUnit[f.draftParentUnit.length-1].id:l.currentUser.authorUnitId;return s.one("units",f.page.unit.id).customPOST({parentUnitId:e},"moveUnit").then(function(e){i.reload()})}},this.showHelpModal=function(e){var t={titleCode:"pageview_publish_panel_help_title",templateUrl:"pagehelpmodal.nested",showOkButton:!1,showCancelButton:!1,focusAfterClosed:e.currentTarget};d.show(t)},this.groupVisibilityChoices=function(e){return"group"===e.type?a.instant("type_groups_unit"):"organization"===e.type?a.instant("type_organizations_unit"):"account"===e.type?a.instant("type_users_unit"):void 0},this.getReadAccessSubjectIds=function(){return g.filter(f.selectedVisibilityChoices,{inheritance:!1}).map(function(e){return e.subjectId})},this.publish=function(){n.$broadcast("navigationAwayApproval",!0),c.showBusyDuring(s.one("units",this.page.unit.id).customPOST({},"publish").then(function(e){n.$broadcast("togglePanel"),f.page.unit.path===e.path?i.reload():t.path("/u/"+e.path).replace(),p.pendingStateChangeOnPublish&&(i.go(p.pendingStateChangeOnPublish.toState,p.pendingStateChangeOnPublish.toParams),p.pendingStateChangeOnPublish=null)}))},this.unpublish=function(){c.showBusyDuring(s.one("units",this.page.unit.id).customPOST({},"unpublish").then(function(){t.path("/u/"+f.page.unit.path+"~i"+f.page.unit.id).replace(),l.fetchCurrentUser()}))},this.onSelectCollection=function(){2===f.draftParentUnit.length&&(f.draftParentUnit=[f.draftParentUnit[1]])},s.one("units",f.page.unit.id).customGET("visibilities").then(function(e){f.visibilityChoices=e.plain(),f.selectedVisibilityChoices=f.visibilityChoices.filter(function(e){return e.selected||e.pending}),f.currentVisibility=f.selectedVisibilityChoices.map(function(e){return e.name}).join("; ")},function(e){u.error("Unable to fetch visibilities for creating a collection",e)}),s.all("compositeUnits").getList().then(function(e){var t=e.plain();angular.forEach(t,function(e){for(var t=[],n=0,o=e.ancestorUnits.length-1;n<o;n++)t.push("&nbsp;&nbsp;&nbsp;&nbsp;");e.indentName=t.join("")+e.name}),f.collections=t}),h.fetchParent(m).then(function(){f.draftParentUnit="UserUnit"===f.parentUnit.unitType?[]:[f.parentUnit]}),e.on("keyup",b),o.$on("$destroy",function(){e.off("keyup",b)})}e.$inject=["$document","$location","$rootScope","$scope","$state","$timeout","$translate","Restangular","BulbAuthService","BulbBusyService","BulbErrorService","BulbModalService","BulbPageService","BulbUnitService","_"],angular.module("bulbApp.pageModule").controller("PublishPanelController",e)}(),angular.module("bulbApp.pageModule").directive("publishPanel",["$compile","$document","$log","$q","$timeout","$window","Restangular","BulbAssetLibraryService","BulbAssetLibraryGoogleDriveService","BulbAssetLibraryUploadService","BulbBrowserService","BulbBusyService","BulbBusyCoverService","BulbModalService","CONFIG",function(e,t,n,o,i,r,a,s,l,c,u,d,p,h,g){return{restrict:"E",controller:"PublishPanelController as publishPanelCtrl",templateUrl:g.resource.cdnRoot+"ajs/page/publishpanel.html",link:function(e,n,r){var a=jQuery(".bulb-page-post-footer")[0],s=jQuery("#bulb-main"),l=null,c=null,u=null;function d(e,t){o.when(c,function(){var n=parseInt(s.css("height"),10),o=parseInt(e.css("height"),10);if(o>n-100){var i=o-n+100;s.css("height",n+i)}var r,l,u=(r=e[0].getBoundingClientRect(),l=a.getBoundingClientRect(),{footerOverlap:!(r.right<l.left||r.left>l.right||r.bottom<l.top||r.top>l.bottom),panel:r,footer:l});if(u.footerOverlap){t&&!0;var d=parseInt(e.css("margin-top"),10),p="-"+(u.panel.bottom-u.footer.top-d+15)+"px";c=e.animate({"margin-top":p},150,"linear").promise(),e.css("border-top-right-radius","5px")}else!1})}i(function(){l=jQuery(".bulb-page-panel"),u=e.$watch(function(){return l.outerHeight()},function(){d(l)}),$(window).scroll(function(){jQuery(window).scrollTop()+jQuery(window).height()>jQuery(document).height()-1&&d(l,!0)})});var p=0,h=n.offset().top;function g(e){var t=n.offset().top;if(!(jQuery(window).scrollTop()+jQuery(window).height()>jQuery(document).height()-50)){var o=parseInt(l.css("margin-top"),10),i=t-h,r=jQuery(this).scrollTop();r>p?function(e,t){"undefined"!=typeof jQuery&&e instanceof jQuery&&(e=e[0]);var n=e.getBoundingClientRect(),o=window.innerHeight||document.documentElement.clientHeight,i=window.innerWidth||document.documentElement.clientWidth;return"top"===t?n.left>=0&&n.top>=0&&n.left+n.width<=i&&n.top+n.height<=o:"bottom"===t?n.top+n.height<=o:null}(l,"bottom")||l.css("margin-top","-"+(i-o)+"px"):(i=-i,o>-50?l.css("margin-top",""):l.css("margin-top",o+i+"px")),p=r,h=t}}t.on("scroll",g),e.$on("$destroy",function(){t.off("scroll",g),u&&u()})}}}]),function(){"use strict";function e(e){this.page=e.page,this.autoSaveOptions={restId:this.page.unit.id,restCollection:"units"}}e.$inject=["BulbPageService"],angular.module("bulbApp.pageModule").controller("QuestionPanelController",e)}(),function(){"use strict";function e(e,t,n){this.page=n.page}e.$inject=["$scope","$state","BulbPageService"],angular.module("bulbApp.pageModule").controller("ViewPanelController",e)}(),angular.module("bulbApp.searchModule",["restangular","ui.router","bulbApp.configModule","bulbApp.errorModule","bulbApp.filtersModule","bulbApp.translateModule"]).constant("SEARCH",{MIN_PREFIX_LENGTH:2,SEARCH_RESULTS_STATE:"searchresults",SEARCH_RESULTS_SIZE:20}).run(["$rootScope","SEARCH",function(e,t){e.SEARCH=t}]).config(["$stateProvider","SEARCH","CONFIG",function(e,t,n){e.state(t.SEARCH_RESULTS_STATE,{parent:"bulbView",url:"^/b/search?{query}",resolve:{initialResults:["$stateParams","BulbSearchService","SEARCH","BulbBusyService",function(e,t,n,o){return e.query?o.showBusyDuring(t.search(e.query,0,n.SEARCH_RESULTS_SIZE)):{}}],$title:["$filter","$stateParams","$translate",function(e,t,n){return t.query?n("search_results_title",{query:decodeURIComponent(t.query)}):n("search_title")}]},views:{bulbView:{templateUrl:n.resource.cdnRoot+"ajs/search/searchresults.html",controller:"SearchResultsController as searchResultsCtrl"}}})}]),function(){"use strict";function e(e,t){this.searchResource=t.all("search"),this.search=function(e,t,n){return this.searchResource.customGET("",{query:e,from:t,size:n})},this.suggest=function(e){return this.searchResource.customGETLIST("suggest",{prefix:e,filter:null,sort:null})}}e.$inject=["$log","Restangular"],angular.module("bulbApp.searchModule").service("BulbSearchService",e)}(),function(){"use strict";function e(e,t,n,o,i,r,a){var s=this;function l(e){var t=-1;if(e)for(var n=0;n<s.suggestions.length;n+=1)if(e===s.suggestions[n]){t=n;break}return t}function c(e){var t=l(s.activeSuggestion);(t+=e)<0?t=s.suggestions.length-1:t>s.suggestions.length-1&&(t=0),s.activeSuggestion=s.suggestions[t]||""}this.prefix="",this.suggestions=[],this.activeSuggestion="",this.clearSearchResults=function(){this.suggestions=[],n.go("searchresults",{query:""},{reload:!0})},this.suggest=function(e){this.prefix=e?e.trim():"",this.prefix&&this.prefix.length>=a.MIN_PREFIX_LENGTH?r.suggest(this.prefix).then(function(e){s.suggestions=e,s.activeSuggestion=""},function(e){i.error("Cannot get suggestions",e),s.suggestions=[],s.activeSuggestion=""}):(s.suggestions=[],s.activeSuggestion="")},this.getPrefix=function(e){return e.substring(0,this.prefix.length)},this.stripPrefix=function(e){return e.substring(this.prefix.length)},this.setActiveSuggestion=function(e){l(e)>=0&&(this.activeSuggestion=e,this.query=e)},this.key=function(e){switch(e.keyCode){case 9:e.preventDefault(),c(e.shiftKey?-1:1),this.activeSuggestion&&(this.query=this.activeSuggestion);break;case 27:e.preventDefault(),this.query===this.prefix?(this.activeSuggestion="",this.prefix=null,this.query=null,this.suggestions=[]):(this.activeSuggestion="",this.query=this.prefix);break;case 40:e.preventDefault(),c(1),this.activeSuggestion&&(this.query=this.activeSuggestion);break;case 38:e.preventDefault(),c(-1),this.activeSuggestion&&(this.query=this.activeSuggestion)}},this.submit=function(){this.suggestions=[],n.go("searchresults",{query:this.query},{reload:!0})},n.current.name===a.SEARCH_RESULTS_STATE&&(this.query=n.params.query,this.suggestions=[],this.activeSuggestion=""),t.$on("$stateChangeSuccess",function(e,t,n,o,i){"searchresults"===t.name&&(s.query=n.query,s.suggestions=[],s.activeSuggestion="")})}e.$inject=["$log","$rootScope","$state","BulbBrowserService","BulbErrorService","BulbSearchService","SEARCH"],angular.module("bulbApp.searchModule").controller("SearchFormController",e)}(),angular.module("bulbApp.searchModule").directive("bulbSearchForm",["$timeout","CONFIG",function(e,t){return{restrict:"E",scope:!0,controller:"SearchFormController as searchFormCtrl",templateUrl:t.resource.cdnRoot+"ajs/search/searchform.html",link:function(t,n,o){var i=jQuery("#query");function r(){i.is(":visible")?i.focus():e(r,100)}t.$watch('headerCtrl.headerType === "search"',function(t){t&&e(r,500)})}}}]),function(){"use strict";function e(e,t,n,o,i,r,a){var s=this;this.query=n.query,this.results={totalResults:0,units:[]},this.from=0,this.infiniteScrollWindowEnabled=!0,this.initialized=r?(e.debug("searchResultsCtrl: initialize: initializing"),s.results.totalResults=r.totalResults,s.results.query=r.query,r.unitDTOs&&(s.results.units=r.unitDTOs,s.from=r.unitDTOs.length,s.from>=s.results.totalResults&&(e.debug("searchResultsCtrl.initialize: disabling scroll"),s.infiniteScrollWindowEnabled=!1)),!0):(e.error("searchResultsCtrl: initialize: no initialResults"),!1),this.getNextPage=function(){var n=t.defer();if(this.initialized)this.from<this.results.totalResults?(e.debug("searchResultsCtrl.getNextPage: loading more results"),i.search(this.results.query,this.from,a.SEARCH_RESULTS_SIZE).then(function(t){t.unitDTOs&&t.unitDTOs.length>0&&(s.results.units=s.results.units.concat(t.unitDTOs),s.from+=t.unitDTOs.length,s.from>=s.results.totalResults&&(e.debug("searchResultsCtrl.getNextPage: disabling scroll"),s.infiniteScrollWindowEnabled=!1),n.resolve())},function(e){o.error("Cannot get next search results",e),n.reject(e)})):(e.debug("searchResultsCtrl.getNextPage: no more results: disabling scroll"),s.infiniteScrollWindowEnabled=!1,n.resolve());else{var r="searchResultsCtrl.getNextPage: not initialized";e.error(r),n.reject(r)}return n.promise}}e.$inject=["$log","$q","$stateParams","BulbErrorService","BulbSearchService","initialResults","SEARCH"],angular.module("bulbApp.searchModule").controller("SearchResultsController",e)}(),angular.module("bulbApp.unitModule",["focus-if","restangular","ui.router","bulbApp.authModule","bulbApp.busyModule","bulbApp.configModule","bulbApp.errorModule","bulbApp.translateModule"]).config(["$stateProvider","AUTH","CONFIG",function(e,t,n){var o={parent:"root",resolve:{unit:function(){},$title:["$translate",function(e){return e("create_collection")}]},views:{content:{templateUrl:n.resource.cdnRoot+"ajs/unit/createcollection.html",controller:"CreateCollectionController as createCollectionCtrl"}},bulbAuth:{isAuthorized:["BulbAuthService",function(e){return e.currentUser.canCreate("Collection")}]}};e.state("unit",{parent:"root",url:"^/u/{unitPath:pathVariable}?publish&uid",params:{expandHeader:null,uid:null},resolve:{unit:["$stateParams","BulbAjaxService",function(e,t){return t.getUnit(e.unitPath,!1).then(function(e){return e.unitDTOs[0]})}],$title:["unit",function(e){return e.name}]},data:{mode:"default"},bulbAuth:{authorizedRoles:[t.ROLES.USER]},onEnter:["unit","$location","$state","$stateParams","$timeout","$window","BulbAuthService","BulbUnitService","BulbPresentationService",function(e,t,n,o,i,r,a,s,l){s.setCurrentUnit(e),o.uid===e.id&&a.currentUser.isAuthenticated()&&(o.uid=null,localStorage.setItem("isAuthorized","isAuthorized"),r.history.replaceState({},"","/u/"+o.unitPath)),o.unitPath.toLowerCase()!==e.path.toLowerCase()&&(t.skipReload().path("/u/"+e.path).replace(),o.unitPath=e.path),i(function(){l.isFullScreen()&&"CompositeUnit"===e.ancestorUnits[1].unitType?n.go("presentation_page",{unitPath:e.path}):"CompositeUnit"===e.unitType||"ArchiveCompositeUnit"===e.unitType?n.go("unit.collection"):n.go("unit.page")})}],onExit:["BulbUnitService",function(e){e.setCurrentUnit(null)}]}).state("unit.page",{resolve:{$title:["$title","$translate",function(e,t){return e||t("pageview_unnamed_title")}]},views:{"header@root":{templateUrl:n.resource.cdnRoot+"ajs/components/pageview/pageviewheader.html",controller:"PageViewHeaderController as pageViewHeaderCtrl"},"content@root":{templateUrl:n.resource.cdnRoot+"ajs/unit/page.html",controller:"PageController as pageCtrl"},"footer@root":{templateUrl:n.resource.cdnRoot+"ajs/components/pageview/pageviewfooter.html",controller:"PageViewFooterController as pageViewFooterCtrl"}}}).state("unit.collection",{views:{"content@root":{templateUrl:n.resource.cdnRoot+"ajs/unit/collection.html",controller:["unit",function(e){this.unit=e}],controllerAs:"collectionCtrl"},"footer@root":{templateUrl:n.resource.cdnRoot+"ajs/components/compositeview/compositeviewfooter.html",controller:["unit",function(e){this.unit=e}],controllerAs:"compositeViewFooterCtrl"}}}).state("live_page",{parent:"root",url:"^/u/{unitPath:pathVariable}/live",resolve:{unit:["$stateParams","BulbAjaxService",function(e,t){return t.getUnit(e.unitPath,!0).then(function(e){return e.unitDTOs[0]})}],$title:["unit",function(e){return e.name}]},views:{"header@root":{templateUrl:n.resource.cdnRoot+"ajs/components/pageview/pageviewheader.html",controller:"PageViewHeaderController as pageViewHeaderCtrl"},"content@root":{templateUrl:n.resource.cdnRoot+"ajs/unit/page.html",controller:"PageController as pageCtrl"},"footer@root":{templateUrl:n.resource.cdnRoot+"ajs/components/pageview/pageviewfooter.html",controller:"PageViewFooterController as pageViewFooterCtrl"}},data:{mode:"live"},bulbAuth:{authorizedRoles:[t.ROLES.USER]},onEnter:["unit","BulbUnitService",function(e,t){t.setCurrentUnit(e)}],onExit:["BulbUnitService",function(e){e.setCurrentUnit(null)}]}).state("preview_page",{parent:"root",url:"^/u/{unitPath:pathVariable}/preview",resolve:{unit:["$stateParams","BulbAjaxService",function(e,t){return t.getUnit(e.unitPath,!1).then(function(e){return e.unitDTOs[0]})}],$title:["unit",function(e){return e.name}]},views:{"header@root":{templateUrl:n.resource.cdnRoot+"ajs/components/pageview/pageviewheader.html",controller:"PageViewHeaderController as pageViewHeaderCtrl"},"content@root":{templateUrl:n.resource.cdnRoot+"ajs/unit/page.html",controller:"PageController as pageCtrl"},"footer@root":{templateUrl:n.resource.cdnRoot+"ajs/components/pageview/pageviewfooter.html",controller:"PageViewFooterController as pageViewFooterCtrl"}},data:{mode:"preview"},bulbAuth:{authorizedRoles:[t.ROLES.USER]},onEnter:["unit","BulbUnitService",function(e,t){t.setCurrentUnit(e)}],onExit:["BulbUnitService",function(e){e.setCurrentUnit(null)}]}).state("unit.page.comment",{parent:"root",url:"^/u/{unitPath:pathVariable}/comment/{threadId}",onEnter:["BulbCommentService","$stateParams","$location",function(e,t,n){e.setDefaultThread(t.threadId),n.url("/u/"+t.unitPath)}]}).state("presentation_page",{parent:"root",url:"^/u/{unitPath:pathVariable}?{usePublishedVersion}",resolve:{unit:["$stateParams","BulbAjaxService",function(e,t){var n="true"===e.usePublishedVersion;return t.getUnit(e.unitPath,n).then(function(e){return e.unitDTOs[0]})}],$title:["unit",function(e){return e.name}]},views:{"content@root":{templateUrl:n.resource.cdnRoot+"ajs/unit/page.html",controller:"PageController as pageCtrl"},"footer@root":{template:"<bulb-presentation-footer></bulb-presentation-footer>"}},data:{mode:"presentation"},bulbAuth:{authorizedRoles:[t.ROLES.USER]},onEnter:["unit","BulbUnitService",function(e,t){t.setCurrentUnit(e)}],onExit:["BulbUnitService",function(e){e.setCurrentUnit(null)}]}).state("createCollection",angular.merge({},o,{url:"^/b/collection/create"})).state("createSubCollection",angular.merge({},o,{url:"^/u/{unitPath:pathVariable}/collection/create",resolve:{unit:["$stateParams","BulbAjaxService",function(e,t){return t.getUnit(e.unitPath,!1).then(function(e){return e.unitDTOs[0]})}]},onEnter:["$state","BulbUnitService","BulbSubCollectionService","BulbAuthService","unit",function(e,t,n,o,i){return t.setCurrentUnit(i),n.isSubCollectionCountUnderLimit()?o.currentUser.features.SubCollectionFeature.enabled?void 0:e.go("accessDenied",{},{location:!1}):e.go("notFound",{},{location:!1})}],onExit:["BulbUnitService",function(e){e.setCurrentUnit(null)}]}))}]),angular.module("bulbApp.unitModule").directive("bulbUnitBreadcrumb",["CONFIG",function(e){return{restrict:"E",scope:!0,bindToController:{unit:"="},templateUrl:e.resource.cdnRoot+"ajs/unit/breadcrumb.html",controller:["$rootScope","$scope","$translate","BulbAuthService","BulbUnitDroppableService","AUTH",function(e,t,n,o,i,r){this.breadcrumbList=[],this.ownerAvatarImage=null,this.readOnly=t.readOnly=!o.currentUser.hasPermission(this.unit,r.PERMISSIONS.UPDATE);var a=this,s=a.unit.ancestorUnits;angular.forEach(s,function(e){var t="unit({unitPath: '"+e.path+"'})";"UserUnit"===e.unitType&&(t="author({username: '"+e.ownerUsername+"'})",e.name||(e.name=n.instant("organization_dashboard_back_to_profile")),a.unit.deleteAfterDays>0&&(function(e){var t=angular.copy(e),o="unit({unitPath: '"+t.path+"'})";t.name=n.instant("soft_delete_home"),t.unitType="DeletedUserUnit",a.breadcrumbList.push(angular.merge({},t,{uiSref:o,isUserUnit:"UserUnit"===e.unitType}))}(e),e.name=n.instant("soft_delete_home_recently_deleted"))),a.breadcrumbList.push(angular.merge({},e,{uiSref:t,isUserUnit:"UserUnit"===e.unitType}))}),"CompositeUnit"===a.unit.unitType&&a.breadcrumbList.push(angular.merge({},a.unit,{uiSref:null})),this.onEntryDrop=function(e,t,n){i.onUnitDroppable(a.unit.children,t.draggable.scope().childUnit,n)},this.broadcastForDeletedUnit=function(t){e.$broadcast("openDeletedCollection",t)}}],controllerAs:"breadcrumbCtrl"}}]),function(){"use strict";function e(e,t,n,o,i,r,a,s,l){var c=this,u=null;this.unit={name:"",description:"",readAccessSubjectIds:[]},this.selectedVisibilityChoices=[],l.currentUnit&&l.currentUnit.id?(this.parentUnitId=l.currentUnit.id,u=i.one("units",this.parentUnitId).customGET("visibilities").then(function(e){return e.plain().filter(function(e){return e.selected})})):this.parentUnitId=r.currentUser.authorUnitId,t.when(u).then(function(e){i.one("accounts",r.currentUser.id).customGET("visibilities").then(function(t){c.visibilityChoices=t.plain(),c.selectedVisibilityChoices=e||[]},function(e){s.error("Unable to fetch visibilities for creating a collection",e)})}),this.createCollection=function(){c.selectedVisibilityChoices.forEach(function(e){e.inheritance||c.unit.readAccessSubjectIds.push(e.subjectId)}),a.showBusyDuring(i.all("units").customPOST(c.unit,c.parentUnitId+"/children").then(function(e){n.go("unit",{unitPath:e.path,expandHeader:!0},{location:"replace"})},function(e){s.error("Unable to create a new collection",e)}))};var d=0,p=e(function(){if(d<20){d++;var t=jQuery("#autosizejs");1===t.length&&(t.attr("aria-label","dummy-label"),e.cancel(p))}else d>=20&&e.cancel(p)},100);this.back=function(){o.history.back()}}e.$inject=["$interval","$q","$state","$window","Restangular","BulbAuthService","BulbBusyService","BulbErrorService","BulbUnitService"],angular.module("bulbApp.unitModule").controller("CreateCollectionController",e)}(),function(){"use strict";function e(e,t){this.unit=e,this.serverContext=t.context.name}e.$inject=["unit","CONFIG"],angular.module("bulbApp.unitModule").controller("PageController",e)}(),function(){"use strict";function e(e,t){var n=parseInt(t.subcollection.max.count,10),o=function(){var t=0,n=e.currentUnit.ancestorUnits.concat(e.currentUnit);return angular.forEach(n,function(e){"CompositeUnit"===e.unitType&&(t+=1)}),t};this.isSubCollectionCountUnderLimit=function(){return-1===n||o()<n},this.canDropCollectionIntoSubCollection=function(){return-1===n||o()<n-1}}e.$inject=["BulbUnitService","CONFIG"],angular.module("bulbApp.unitModule").service("BulbSubCollectionService",e)}(),function(){"use strict";function e(e,t,n,o){var i=this;this.currentUnit={},this.parentUnit={},this.previousSibling={},this.nextSibling={};var r={};this.setCurrentUnit=function(e){null!==e&&e===this.currentUnit||(this.currentUnit&&this.currentUnit.parentId&&delete r[this.currentUnit.parentId],angular.copy(e,this.currentUnit),angular.copy({},this.parentUnit),angular.copy({},this.previousSibling),angular.copy({},this.nextSibling))},this.fetchParent=function(o){if(o=o||{},!this.currentUnit||!this.currentUnit.parentId){var a=e.defer();return a.resolve(),a.promise}return r[this.currentUnit.parentId]&&!o.forceRefetch||(r[this.currentUnit.parentId]=t.one("units",this.currentUnit.parentId).get().then(function(e){var t=e.unitDTOs[0];if(r[t.id]){angular.copy(t,i.parentUnit);var o=n.findIndex(i.parentUnit.children,{id:i.currentUnit.id});angular.copy(o>0?i.parentUnit.children[o-1]:{},i.previousSibling),angular.copy(o<i.parentUnit.children.length-1?i.parentUnit.children[o+1]:{},i.nextSibling)}})),r[this.currentUnit.parentId]},this.deleteUnit=function(e){return o.showBusyDuring(t.one("units",e.id).remove())}}e.$inject=["$q","Restangular","_","BulbBusyService"],angular.module("bulbApp.unitModule").service("BulbUnitService",e)}(),function(){"use strict";function e(e,t,n){var o,i;this.onUnitDroppable=function(e,n,r){var a;n.id!==r.id&&(a=n,(i=e).forEach(function(e,t){if(e===a)return i.splice(t,1),void(o=t)}),t.one("units",n.id).customPOST({parentUnitId:r.id},"moveUnit").catch(function(e){var t;t=n,i.splice(o,0,t)}))}}e.$inject=["$q","Restangular","BulbModalService"],angular.module("bulbApp.unitModule").service("BulbUnitDroppableService",e)}(),function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c,u,d,p,h,g,m){var f=this;this.currentUser=o.currentUser;var b=["https://www.googleapis.com/auth/userinfo.profile","https://www.googleapis.com/auth/drive.readonly"];this.oauthCode=null;var v=!1,C=null,y=u.all("snapshotPdf");g.client&&g.auth?v=!0:g.client||g.auth||!window.gapi?!g.client&&window.gapi?window.gapi.load("client",function(){g.client=window.gapi.client,v=!0}):!g.auth&&window.gapi&&window.gapi.load("auth",function(){g.auth=window.gapi.auth,v=!0}):window.gapi.load("client",function(){g.client=window.gapi.client,window.gapi.load("auth",function(){g.auth=window.gapi.auth,v=!0})});var w={fontAwesomeCode:["fas fa-certificate fa-stack-2x","fab fa-google-drive fa-stack-1x fa-inverse"],titleCode:"snapshot_pdf_modal_heading",bodyCode:"snapshot_pdf_modal_content",okButtonCode:"snapshot_modal_enable",cancelButtonCode:"snapshot_modal_not_now",showCancelButton:!0,windowClass:"updated-modal-design bulb-snapshot-pdf",overlayIcon:!0,focusAfterClosed:void 0},A={fontAwesomeCode:"fab fa-google-drive",titleCode:"snapshot_resigin_modal_heading",bodyCode:"snapshot_resigin_modal_content",okButtonCode:"snapshot_resigin_modal_signin",cancelButtonCode:"snapshot_modal_not_now",showCancelButton:!0,windowClass:"updated-modal-design bulb-snapshot-pdf",focusAfterClosed:void 0},_={fontAwesomeCode:"fab fa-google-drive",titleCode:"snapshot_resigin_modal_heading",bodyCode:"snapshot_file_deleted_modal_content",okButtonCode:"snapshot_file_deleted_modal_yes",cancelButtonCode:"snapshot_modal_not_now",showCancelButton:!0,windowClass:"updated-modal-design bulb-snapshot-pdf"},E={fontAwesomeCode:"fab fa-google-drive",titleCode:"assetlibrary_googledoc_org_permission_heading",bodyCode:"assetlibrary_googledoc_org_permission_subheading",okButtonCode:"assetlibrary_googledoc_org_permission_enable",cancelButtonCode:"assetlibrary_googledoc_org_permission_cancel",showCancelButton:!0,windowClass:"updated-modal-design bulb-aero-modal"};function S(){var t=e.defer();return g.client&&g.client.request({path:p.USER_INFO_URL}).then(function(e){C=e.result.id,t.resolve()},function(e){t.reject(e)}),t.promise}var T=function(t){var n=e.defer();return t&&!t.error?(f.oauthCode=t.code,S().then(function(){n.resolve()})):n.reject(),n.promise};function I(){var n=e.defer();return v?(f.oauthCode=null,g.auth.signOut(),g.auth.authorize({client_id:h.google.client.id,scope:b,response_type:"code token",prompt:"consent"},function(e){T(e).then(n.resolve)})):a.showError(t.instant("google_drive_api_not_loaded")),n.promise}function B(t){var n=e.defer();return S().then(function(e){u.one("accounts/verifyGoogleConnection/GOOGLE_OAUTH_TOKEN").get({code:t}).then(function(e){n.resolve(e)}).catch(function(e){f.showError(e),n.reject(e)})}),n.promise}function k(){var t=e.defer();I().then(function(e){O(t).then(function(){o.fetchCurrentUser(),t.resolve()})})}function U(){u.one("snapshotPdf/updateModalCount").patch({}).then(function(e){o.setCurrentUser(e)}).catch(function(e){a.error("Cannot update the user preferences",e)})}var O=function(e){return i.showBusyDuring(y.all("importAll").post("",{code:f.oauthCode,googleId:C}).then(function(t){f.oauthCode=null,e.resolve(t)}).catch(function(t){f.showError(t),e.reject(t)})),e.promise},M=function(t,n,o,r){var a=e.defer();return i.showBusyDuring(y.all("import").post("",{code:n,fileId:t,googleId:C,contentBlockId:o,unitId:r}).then(function(e){f.oauthCode=null,a.resolve(e)}).catch(function(e){a.reject(e),401!==e.status||F()?f.showError(e):s.show(A).then(function(){I().then(function(e){M(t,f.oauthCode,o,r).then(a.resolve)})})})),a.promise};this.importPdfForOrgRestrictedDoc=function(t,n,i){var r=e.defer();return o.currentUser.prefs.importingGoogleAssetAsPdfEnabled?o.currentUser.connections.googleOAuthToken?B(i).then(function(e){!0===e?M(t,null,null,n).then(function(e){r.resolve(e)}):$(t,n).then(function(e){r.resolve(e)})}):$(t,n).then(function(e){r.resolve(e)}):s.show(E).then(function(){R(),$(t,n).then(function(e){r.resolve(e)})}),r.promise},this.importPdfFromGoogleDrive=function(t,n,i,r){var a=e.defer();return o.currentUser.connections.googleOAuthToken&&(n?F()||B(n).then(function(e){!0===e?M(t,null,i,r).then(a.resolve):s.show(A).then(function(){R(),I().then(function(e){M(t,f.oauthCode,i,r).then(a.resolve)})})}):M(t,null,i,r).then(a.resolve)),a.promise};var $=function(t,n){var o=e.defer();return I().then(function(){M(t,f.oauthCode,null,n).then(function(e){o.resolve(e)})}),o.promise};function P(t,n,o){var r=e.defer();return i.showBusyDuring(y.all("update").patch("",{code:n,googleId:o,unitId:t}).then(function(e){f.oauthCode=null,r.resolve(e)}).catch(function(e){401!==e.status&&f.showError(e),r.reject(e)})),r.promise}this.enableSnapshotPdf=function(t,n){if(!F()){if(!o.currentUser.features.SnapshotPdfFeature.enabled)return!1;var i=o.currentUser.features.SnapshotPdfFeature.shownModalCount;o.currentUser.prefs.importingGoogleAssetAsPdfEnabled||"settings"===t?"settings"!==t&&"page"!==t&&localStorage.getItem("googleModalShown")||(!function(t,n){var i=e.defer();"settings"===n&&(A.focusAfterClosed=t.currentTarget),o.currentUser.connections.googleOAuthToken||F()?"settings"===n&&O(i).then(i.resolve):s.show(A).then(function(){k()})}(n,t),localStorage.setItem("googleModalShown","true")):("home"==t&&0===i||"page"==t&&1===i)&&(r=e.defer(),u.one("accounts/"+f.currentUser.id+"/hasGoogleDocEmbed").get().then(function(e){r.resolve(e)},function(e){r.reject(),a.showError(null,e)}),r.promise).then(function(t){t&&(e.defer(),s.show(w).then(function(){R(),1===f.currentUser.features.SnapshotPdfFeature.shownModalCount&&U(),k()}),U())})}var r},this.updateSnapshotPdf=function(t){if(!t.contentBlocks)return!1;var n=!1;for(var o in t.contentBlocks)if(n=t.contentBlocks[o].hasOwnProperty("snapshotPdfId")||t.contentBlocks[o].hasOwnProperty("html")&&t.contentBlocks[o].html.includes("docs.google.com"))break;if(!n)return!1;var r=e.defer();return D(t).then(function(){P(t.id,null,null).catch(function(e){401!==e.status||F()||s.show(A).then(function(){I().then(function(e){(function(e){return i.showBusyDuring(y.all("updateRefreshToken").post("",{code:f.oauthCode,googleId:C}).then(function(t){f.oauthCode=null,e.resolve(t)}).catch(function(t){f.showError(t),e.reject(t)})),e.promise})(r).then(function(){P(t.id,f.oauthCode,C).then(r.resolve)})})}),r.reject(e)})}),r.promise};var D=function(t){var o=e.defer();return t.deletedGoogleDocEmbedIds&&t.deletedGoogleDocEmbedIds.length>0?s.show(_).then(function(){i.showBusyDuring(y.all("replace").patch("",{deletedGoogleDocEmbedIds:t.deletedGoogleDocEmbedIds,unitId:t.id}).then(function(e){n.getUnit(t.id,!1).then(function(e){c.setCurrentUnit(e.unitDTOs[0]),l.updatePageAfterReplaceEmbed(),o.resolve()})}).catch(function(e){o.resolve()}))}):o.resolve(),o.promise},R=function(){var e={prefs:f.currentUser.prefs};void 0===f.currentUser.prefs||f.currentUser.prefs.importingGoogleAssetAsPdfEnabled||(e.prefs.importingGoogleAssetAsPdfEnabled=!0),m.isEmpty(e)||x(e)},x=function(e){r.showBusyDuring(u.one("accounts",f.currentUser.id).patch(e).then(function(){},function(e){a.showError(null,e)}))};this.showError=function(e){if(409===e.status&&e.data&&e.data.developerMessage){var n=e.data.developerMessage.split(","),o={email:"<strong>"+n[0]+"</strong>"},i=h.base.url+"/"+n[1];a.showError(t.instant("account_already_exists_error",o)+'<a href="'+i+'" target="_blank">'+i+"</a>",e)}else a.showError(null,e)};var F=function(){return o.currentUser.hasRole(d.ROLES.SWITCHED_USER)}}e.$inject=["$q","$translate","BulbAjaxService","BulbAuthService","BulbBusyCoverService","BulbBusyService","BulbErrorService","BulbModalService","BulbPageService","BulbUnitService","Restangular","AUTH","SNAPSHOTPDF","CONFIG","google","_"],angular.module("bulbApp.assetLibraryModule").constant("SNAPSHOTPDF",{USER_INFO_URL:"https://www.googleapis.com/oauth2/v1/userinfo"}).service("BulbAssetLibrarySnapshotPdfService",e)}(),angular.module("bulbApp.assetLibraryModule").constant("MAX_ITEM_THRESHOLD_SIZE",50).component("assetLibraryGooglePhoto",{templateUrl:["CONFIG",function(e){return e.resource.cdnRoot+"ajs/assetlibrary/google-photo/assetlibrary-google-photo.html"}],controllerAs:"googlePhotoCtrl",controller:AssetLibraryGooglePhotoController});var __awaiter=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(i,r){function a(e){try{l(o.next(e))}catch(e){r(e)}}function s(e){try{l(o.throw(e))}catch(e){r(e)}}function l(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(a,s)}l((o=o.apply(e,t||[])).next())})},__generator=this&&this.__generator||function(e,t){var n,o,i,r,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return r={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function s(r){return function(s){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,o&&(i=2&r[0]?o.return:r[0]?o.throw||((i=o.return)&&i.call(o),0):o.next)&&!(i=i.call(o,r[1])).done)return i;switch(o=0,i&&(r=[2&r[0],i.value]),r[0]){case 0:case 1:i=r;break;case 4:return a.label++,{value:r[1],done:!1};case 5:a.label++,o=r[1],r=[0];continue;case 7:r=a.ops.pop(),a.trys.pop();continue;default:if(!(i=(i=a.trys).length>0&&i[i.length-1])&&(6===r[0]||2===r[0])){a=0;continue}if(3===r[0]&&(!i||r[1]>i[0]&&r[1]<i[3])){a.label=r[1];break}if(6===r[0]&&a.label<i[1]){a.label=i[1],i=r;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(r);break}i[2]&&a.ops.pop(),a.trys.pop();continue}r=t.call(e,a)}catch(e){r=[6,e],o=0}finally{n=i=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,s])}}};function AgeVerificationController(e,t,n,o,i,r,a,s,l,c,u,d){var p=this,h=d.minimumAgeYears;this.loginExists=i.instant("age_verification_modal_login_exists"),this.currentUser=s.currentUser,this.dateOptions={dateFormat:"m/d/Y",maxDate:"today"},this.submit=function(){s.fetchCurrentUser().then(function(){l.showBusyDuring(u.one("accounts",p.currentUser.id).post("ageverify",{dateOfBirth:p.inputDateInMillis}).then(function(e){if(e){return c.open({fontAwesomeCode:"fas fa-exclamation-triangle",templateUrl:"signin.coppa.nested",windowClass:"updated-modal-design bulb-coppa-modal",titleCode:"coppa_underaged_user_modal_title",backdrop:"static",keyboard:!1,showCancelButton:!1,showOkButton:!1,closeOnClick:!1}),!1}r.location.href="/"+p.currentUser.username}))})},this.showCOPPADateValidationModal=function(){return c.show({titleCode:"coppa_date_validation_alert_title",bodyCode:"coppa_date_validation_alert_body",showCancelButton:!1,showOkButton:!1,closeOnClick:!0})},this.underAgedUserCheck=function(e){+e>=+a().subtract(h,"years").valueOf()&&p.showCOPPADateValidationModal(),p.inputDateInMillis=e},this.validateDateOfBirth=function(e){var t;if(!(p.dateOfBirth.length>=6&&p.dateOfBirth.length<=10))return e.dateOfBirth.$setValidity("dateOfBirth",!1),void p.showCOPPADateValidationModal();(t=a(p.dateOfBirth,["MM/DD/YYYY","MM-DD-YYYY","MMDDYYYY","YYYY-MM-DD"],!0))&&t.isValid()?(e.dateOfBirth.$setValidity("dateOfBirth",!0),p.inputDateInMillis=t.valueOf()):e.dateOfBirth.$setValidity("dateOfBirth",!1)}}!function(){"use strict";function e(e,t,n,o,i,r,a,s,l){var c,u=this,d=null,p=!1;this.albumList=[],this.mediaItemList=[],this.nextPhotoPageToken="",this.allowMultipleSelection=!1,this.showOnlyVideo=!1,this.showAll=!1;var h={titleCode:"",template:"<asset-library-google-photo></asset-library-google-photo>",windowClass:"updated-modal-design bulb-assetlibrary-googlephoto",closeOnClick:!0,showOkButton:!1,showCancelButton:!1};r.client&&r.load&&r.load("auth2",function(){p=!0});var g=function(){var t=e.defer();return p||t.reject("Could not load the google client"),d=null,r.auth2.getAuthInstance()&&r.auth2.getAuthInstance().signOut(),r.auth2.authorize({client_id:a.google.client.id,scope:"https://www.googleapis.com/auth/photoslibrary.readonly",prompt:"select_account"},function(n){(function(t){var n=e.defer();return t&&!t.error?(d=t.access_token,n.resolve()):n.reject(),n.promise})(n).then(t.resolve)}),t.promise};function m(){return __awaiter(this,void 0,void 0,function(){var n,i;return __generator(this,function(a){switch(a.label){case 0:n=e.defer(),u.albumList=[],i="",!1,a.label=1;case 1:return[4,function(n){var i=e.defer();return r.client.request({path:s.ALBUM_LIST+n,method:"GET"}).then(function(e){e.result.albums&&(u.albumList=u.albumList.concat(e.result.albums)),i.resolve(e.result.nextPageToken)},function(e){o.showError(t.instant("assetlibrary_google_photos_album_import_error"),e),i.reject()}),i.promise}(i).then(function(e){i=e},function(){!0,n.reject()})];case 2:a.sent(),a.label=3;case 3:if(i)return[3,1];a.label=4;case 4:return n.resolve(),[2,n.promise]}})})}function f(n){var i,a=e.defer();return function(n){var i=e.defer(),a={path:s.MEDIA_SEARCH_BY_ID,method:"POST",body:{}},l=u.showAll?s.ALL:u.showOnlyVideo?s.MEDIA_TYPE.VIDEO:s.MEDIA_TYPE.PHOTO;a.body=n?{albumId:n,pageSize:s.PAGE_SIZE,pageToken:u.nextPhotoPageToken}:{filters:{mediaTypeFilter:{mediaTypes:l}},pageSize:s.PAGE_SIZE,pageToken:u.nextPhotoPageToken};return r.client.request(a).then(function(e){i.resolve(e.result)},function(e){o.showError(t.instant(u.showOnlyVideo?"assetlibrary_google_photos_video_import_error":"assetlibrary_google_photos_photo_import_error"),e),i.reject()}),i.promise}(n).then(function(e){e.mediaItems&&(i=u.showAll?e.mediaItems:l.filter(e.mediaItems,function(e){return l.has(e.mediaMetadata,u.showOnlyVideo?"video":"photo")}),u.mediaItemList=u.mediaItemList.concat(i)),u.nextPhotoPageToken=e.nextPageToken,a.resolve()}).catch(function(e){a.reject()}),a.promise}this.initializeGooglePhotoPicker=function(t,o,r,a){return void 0===o&&(o=!1),void 0===r&&(r=!1),void 0===a&&(a=!1),u.allowMultipleSelection=o,u.showOnlyVideo=r,u.showAll=a,g().then(function(){u.albumList=[],u.mediaItemList=[],u.nextPhotoPageToken=null,n.showBusyDuring(function(t,n){c=t;var o=e.defer();return m().then(function(e){f(n).then(function(){o.resolve(),i.open(h)})},function(e){o.reject()}),o.promise}(t,null))})},this.selectPhotoHandler=function(e){c(d,u.allowMultipleSelection?e:e[0])},this.getAlbumPhotos=function(t,n){var o=e.defer();return n&&(u.mediaItemList=[],u.nextPhotoPageToken=null),f(t).then(function(e){e?o.reject():o.resolve(u.mediaItemList)}),o.promise}}e.$inject=["$q","$translate","BulbBusyCoverService","BulbErrorService","BulbModalService","google","CONFIG","GOOGLEPHOTO","_"],angular.module("bulbApp.assetLibraryModule").constant("GOOGLEPHOTO",{ALBUM_LIST:"https://photoslibrary.googleapis.com/v1/albums?pageToken=",MEDIA_SEARCH_BY_ID:"https://photoslibrary.googleapis.com/v1/mediaItems:search",MEDIA_TYPE:{PHOTO:["PHOTO"],VIDEO:["VIDEO"],ALL:["PHOTO","VIDEO"]},PAGE_SIZE:100}).service("BulbAssetLibraryGooglePhotoService",e)}(),function(){"use strict";function e(e,t,n,o,i,r,a,s){var l,c=this,u=a.all("assetlibrary"),d=null;function p(e){return c.isOneDriveAsset(e)||e&&e.mimeType.startsWith("application/pdf")||e.mimeType.startsWith("image/")}this.isOneDriveAsset=function(e){return e&&e.mimeType.startsWith("application/vnd.openxmlformats")},this.initializeOneDrivePicker=function(e,t,o,i){void 0===t&&(t=[]),void 0===o&&(o=!1),void 0===i&&(i=!1),r||(console.log("Initializing OneDrive service..."),r=window.OneDrive),l=e;var a={clientId:s.onedrive.client.id,action:i?"share":"query",multiSelect:!1,accountSwitchEnabled:!1,advanced:{navigation:{disable:!0},queryParameters:"select=id,file",redirectUri:s.onedrive.redirectUri,filter:c.generateFilterString(t)},success:function(e){!o||e.value[0].file&&!c.isOneDriveAsset(e.value[0].file)?(d=e.accessToken,l(e.value[0])):n.dialog.showError("assetlibrary_onedrive_file_selection_error")},cancel:function(){},error:function(e){console.log("OneDrive Picker Error: ",e)}};r.open(a)},this.importFromOneDrive=function(e,t){return u.all("onedrive").all("upload").post("",{token:d,fileId:e,folderId:t}).catch(c.errorFn)},this.errorFn=function(e){e.data&&e.data.message?n.dialog.showError(e.data.message):n.dialog.showError("unknown_error")},this.generateFilterString=function(e){return 0===e.length?"":"folder,."+e.join(",").split(",").join(",.")},this.getSharedEmbedUrl=function(e){var n=t.defer();return u.all("onedrive").all("generateEmbedUrl").post("",{documentUrl:e}).then(function(e){if(e.error)n.reject("embed_onedrive_url_access_denied");else{var t=e["@content.downloadUrl"];t&&p(e.file)?n.resolve(t):n.reject("embed_onedrive_file_not_supported")}}).catch(function(e){console.log("Error ",e),n.reject(e)}),n.promise},this.createSharableLinkForDocument=function(e){var n=t.defer();return c.authenticateUser().then(function(t){u.all("onedrive").all("generateSharedUrl").post("",{url:e,token:t.accessToken}).then(function(e){var t=e["@content.downloadUrl"];t&&p(e.file)?n.resolve(t):n.reject("embed_onedrive_file_not_supported")}).catch(function(e){console.log("Error",e),n.reject(e)})}),n.promise},this.authenticateUser=function(){i||(i=window.Msal);var e={auth:{clientId:s.onedrive.client.id,redirectUri:s.onedrive.redirectUri}},t={scopes:["onedrive.readwrite"]},n=new i.UserAgentApplication(e);return n.getAccount()?n.acquireTokenPopup(t):n.loginPopup(t).then(function(e){return n.acquireTokenPopup(t)},function(e){console.log("Login Error "+e)})},this.showEmbedError=function(e){n.dialog.closeCurrentModal(),o.show(e)},this.getItemContentByShareId=function(e){return"https://api.onedrive.com/v1.0/shares/"+e+"/root/content"},this.updateOneDriveItemUrl=function(t,n,o,i,r){e({method:"GET",url:"https://api.onedrive.com/v1.0/shares/"+n+"/driveItem"}).then(function(e){var n=decodeURIComponent(t.src).split("src=")[1].split("com/")[1].split("/")[0],s=e.data["@content.downloadUrl"];if(n!==s.split("com/")[1].split("/")[0]){var l=unescape(r.split("?src=")[1]).split('"')[0],c={html:r.replace(encodeURIComponent(l),encodeURIComponent(s))};a.one("units",o).one("embedblock",i).patch(c),t.src="https://view.officeapps.live.com/op/embed.aspx?src="+encodeURIComponent(s)}},function(e){console.log("Error",e)})}}e.$inject=["$http","$q","BulbAssetLibraryService","BulbModalService","Msal","OneDrive","Restangular","CONFIG"],angular.module("bulbApp.assetLibraryModule").service("BulbAssetLibraryOneDriveService",e).value("OneDrive",window.OneDrive).value("Msal",window.Msal)}(),angular.module("bulbApp.assetLibraryModule").component("bulbAssetLibraryUnsplash",{templateUrl:["CONFIG",function(e){return e.resource.cdnRoot+"ajs/assetlibrary/unsplash/assetlibrary-unsplash.html"}],controllerAs:"unsplashCtrl",controller:["$translate","BulbAssetLibraryUnsplashService","BulbBusyCoverService","BulbErrorService",function(e,t,n,o){var i=this;this.query,this.imageList=[],this.page=1,this.message="",this.resultString="",this.totalPages=0,this.newSearch=function(){i.clearSearchResults(!1),i.search()},this.search=function(){i.message="",""!==i.query&&n.showBusyDuring(t.searchPhoto(i.query,i.page).then(function(t){i.isSearching=!1,i.imageList=i.imageList.concat(t.results),i.imageList&&0!==i.imageList.length?(i.message="",i.resultString=t.total+e.instant("assetlibrary_search_images_result"),i.totalPages=t.total_pages):(i.message=e.instant("assetlibrary_unsplash_no_photos_found"),i.resultString="")},function(t){o.showError(e.instant("assetlibrary_unsplash_photos_search_error"),t)}))},this.clearSearchResults=function(e){!0===e&&(i.query=""),i.message="",i.imageList=[],i.page=1,i.resultString="",i.totalPages=0},this.selectPhoto=function(e){t.selectPhoto(e)},this.handlePagination=function(e){if("next"===e){if(i.page==i.totalPages)return;i.page++}i.search()}}]}),function(){"use strict";function e(e,t,n,o){var i,r=this,a=n.all("assetlibrary");this.initializeUnsplashPhotoPicker=function(e){i=e},this.selectPhoto=function(e){i(e)},this.searchPhoto=function(t,n){var i=e.defer();return a.all("unsplash").all("search").customGET("",{query:escape(t),pageSize:o,page:n}).then(function(e){return i.resolve(e)}).catch(function(){return i.reject("Could not load Photos")}),i.promise},this.updateViewCount=function(t){var n=e.defer();return a.one("unsplash/updateViewCount").customPOST({},"",{photoId:t}).then(function(e){return n.resolve(e)}).catch(function(){return n.reject("View count update failed")}),n.promise},this.importFromUnsplash=function(e,t){return a.all("unsplash").all("upload").post("",{photoId:e,folderId:t}).catch(r.errorFn)},this.errorFn=function(e){e.data&&e.data.message?t.dialog.showError(e.data.message):t.dialog.showError("unknown_error")}}e.$inject=["$q","BulbAssetLibraryService","Restangular","UNSPLASH_PAGE_SIZE"],angular.module("bulbApp.assetLibraryModule").constant("UNSPLASH_PAGE_SIZE",30).service("BulbAssetLibraryUnsplashService",e)}(),angular.module("bulbApp.ageVerificationModule",["angular-flatpickr","restangular","bulbApp.configModule"]),angular.module("bulbApp.ageVerificationModule").component("bulbAgeVerification",{templateUrl:["CONFIG",function(e){return e.resource.cdnRoot+"ajs/components/ageverification/age-verification-modal.html"}],controllerAs:"ageVerificationCtrl",controller:AgeVerificationController}),function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c,u,d,p,h,g){var m=this;function f(t){(function(e){var t=!1;"STUDENT"!==e.position||function(e){return g.countBy(e.groupMemberships,"type").ORGANIZATION>0}(e)||e.prefs.offBoarding&&null!==e.prefs.offBoarding||e.ageVerified||(t=!0);return t})(t)?(e.ageVerifyModalOpen=!0,u.open({fontAwesomeCode:"fas fa-birthday-cake",titleCode:"age_verification_modal_header",template:"<bulb-age-verification></bulb-age-verification>",windowClass:"updated-modal-design one-button-modal-design bulb-age-verification-modal",backdrop:"static",closeOnClick:!1,showOkButton:!1,showCancelButton:!1})).result.then(function(){a.fetchCurrentUser().then(function(e){e.enabled?b(t):i.location="/"})}):b(t)}function b(e){m.checkPushEnabled(e.notificationPref.pushNotification.enabled,e),n.targetUrl?i.location.href=n.targetUrl:i.location.href="/"+e.username}this.credentials={usernameOrEmail:"",password:""},this.signInUnsuccessful=!1,this.signInWithGoogleInProgress=!1,this.googleSignInReady=!1,this.createAccountTranslation=o.instant("sign_in_or_create_new_account"),this.runningInPWAEnvironment=s.isPWAEnvironment(),this.isMultiFactorLogin=n.mfa,n.redirected?this.redirected=n.redirected:this.redirected=!1,r.load&&r.load("auth2",function(){m.googleSignInReady=!0}),this.signIn=function(){this.signInUnsuccessful=!1,l.showBusyDuring(a.signIn(m.credentials).then(f,function(e){m.signInUnsuccessful=!0}))},this.redirectToCreateAccount=function(e){"click"===e.type?t.go("signUp"):"Enter"!==e.key&&" "!==e.key||t.go("signUp",{redirected:!0})},this.redirectToResetPassword=function(e){"click"===e.type?t.go("resetPassword"):"Enter"!==e.key&&" "!==e.key||t.go("resetPassword",{redirected:!0})},this.signInWithGoogle=function(){m.signInWithGoogleInProgress=!0,l.showBusyDuring(a.authenticateViaGoogle().then(function(e){m.signInWithGoogleInProgress=!1,"not_found"===e.status?t.go("signUp",{mode:"connectGoogle",connection:e.connection,targetUrl:n.targetUrl}):f(e)},function(e){m.signInWithGoogleInProgress=!1,c.error("Cannot sign in with Google",e)}))},this.signInWithMicrosoft=function(){var e=n.targetUrl?"&targetUrl="+encodeURIComponent(n.targetUrl):"";i.location.href=h.context.name+"/b/auth/microsoft?entryMode=sign-in"+e},this.signInWithClever=function(){var e=n.targetUrl?"&targetUrl="+encodeURIComponent(n.targetUrl):"";i.location.href=h.context.name+"/b/auth/clever?entryMode=sign-in"+e},this.checkPushEnabled=function(e,t){if("safari"in window&&"pushNotification"in window.safari&&e&&d.checkBrowserVersion()>=11){var n=window.safari.pushNotification.permission(h.pushnotification.apns.safari.webPushId);"default"===n.permission&&d.checkRemotePermission(n,t,m.signInForm)}},this.sendCOPPAEmail=function(){null!==m.form.coppaModalEmail&&a.fetchCurrentUser().then(function(){l.showBusyDuring(p.one("/accounts/coppaEmail/").customPOST({email:m.form.coppaModalEmail}).then(function(){a.signOut(null,!0),i.location.href="/"}).catch(function(e){c.showError(null,e)}))})}}e.$inject=["$scope","$state","$stateParams","$translate","$window","google","BulbAuthService","BulbBrowserService","BulbBusyService","BulbErrorService","BulbModalService","PushNotificationService","Restangular","CONFIG","_"],angular.module("bulbApp.authModule").controller("SignInController",e)}(),function(){"use strict";t.$inject=["$cookies","$http","$log","$scope","$state","$stateParams","$timeout","$translate","$window","google","moment","Restangular","BulbAjaxService","BulbBrowserService","BulbBusyService","BulbErrorService","BulbModalService","CONFIG","_"],angular.module("bulbApp.authModule").controller("SignUpController",t).filter("countryFilter",function(){return function(t,n){var o=[];if(Array.isArray(t))for(var i=0,r=t;i<r.length;i++){var a=r[i];a.display.toLocaleLowerCase().includes(n.toLocaleLowerCase())?o.push(a):a.value===e&&o.push(a)}return o}}).directive("countryControl",function(){return{restrict:"A",require:"uiSelect",link:function(e,t,n,o){e.$on("countryClose",function(e,t){o.close()}),e.$on("countryScroll",function(e,n){var o=t.querySelectorAll(".ui-select-choices-content");o[0].scrollTop=0})}}});var e="...";function t(t,n,o,i,r,a,s,l,c,u,d,p,h,g,m,f,b,v,C){var y=this;i.CONFIG=v;var w=v.minimumAgeYears;switch(this.isMobile=g.isMobile(),this.mode=a.mode,this.subscribeMode=a.subscribeMode,a.redirected?this.redirected=a.redirected:this.redirected=!1,this.signInUnsuccessful=!1,this.organizationConnectionToken=a.orgToken,this.form={prepaidCode:a.prepaidCode},this.marketingOptIn=!1,this.googleSignInReady=!1,this.signInAccountTranslation=l.instant("sign_up_or_sign_into_account"),this.defaultCountries=["US","GB","CA","BR","MX","BE","NL","DE","AU","IN"],this.countries=[],this.allCountries=[],this.grade=a.grade,this.grades=[{display:"Pre-K"},{display:"K"},{display:"1"},{display:"2"},{display:"3"},{display:"4"},{display:"5"},{display:"6"},{display:"7"},{display:"8"},{display:"9"},{display:"10"},{display:"11"},{display:"12"},{display:"13+"},{display:"Other"}],this.dateOptions={dateFormat:"m/d/Y",maxDate:"today",allowInput:!0,onOpen:[function(e,t,n){$("#dobWrapper").toggleClass("close")}],onClose:[function(e,t,n){$("#dobWrapper").toggleClass("close")}]},this.fetchCountries=function(t){var o=navigator.language.replace("-","_");n({method:"get",url:"https://d88n5qxmt9dn1.cloudfront.net/countries/"+o,dataType:"json",contentType:"application/json"}).success(function(n){var o=[];if(t)y.countries=n;else{for(var i=0,r=y.defaultCountries;i<r.length;i++){var a=r[i],s=C.find(n,{value:a});o.push(s)}o.push({value:e,display:y.moreDisplay}),y.countries=o,y.allCountries=n}})},this.countrySelected=function(){y.form.country===e?(y.countries=y.allCountries,y.form.country="",s(function(){i.$broadcast("countryScroll")})):i.$broadcast("countryClose")},this.handleSettingFormPosition=function(e){this.form.position=e.selectedOption},this.handleSettingFormCountry=function(e){"..."!==e.selectedOption?this.form.country=e.selectedOption:y.fetchCountries(!0)},this.handleSettingFormGrade=function(e){this.form.grade=e.selectedOption},l("sign_up_country_more").then(function(e){y.moreDisplay=e,y.fetchCountries()}),this.redirectToSignIn=function(e){"click"===e.type?r.go("signIn"):"Enter"!==e.key&&" "!==e.key||r.go("signIn",{redirected:!0})},this.isCleverStudent=("connectClever"===this.mode||"signUpClever"===this.mode)&&"Student"===a.position,this.runningInPWAEnvironment=g.isPWAEnvironment(),u.load&&u.load("auth2",function(){y.googleSignInReady=!0}),this.requireInstitutionFor=["Educator","Administrator","Other"],a.connection&&(this.connection=a.connection),this.showCOPPADateValidationModal=function(){return b.show({titleCode:"coppa_date_validation_alert_title",bodyCode:"coppa_date_validation_alert_body",showCancelButton:!1,showOkButton:!1,closeOnClick:!1})},this.showCOPPAactionModal=function(){y.submitBtnPrimary=jQuery("#submitBtnPrimary"),y.submitBtnPrimary.prop("disabled",!0),y.submitBtnPrimary.prop("innerText",l.instant("button_submitted")),b.show({templateUrl:"coppa.modal.nested",titleCode:"coppa_underaged_user_modal_title",controller:["$scope","BulbErrorService",function(e,t){var n=this;e.$on("$destroy",function(){c.location="/"}),n.emailSent=function(){var e=jQuery("#coppaModalSubmit");e.prop("disabled",!0),e.prop("innerText",l.instant("button_submitted"))},n.sendCOPPAEmail=function(e){m.showBusyDuring(p.one("/accounts/coppaEmail/").customPOST({email:e}).then(function(e){e?t.showError(null,e):n.emailSent()}))},n.submit=function(){null!==n.form.email&&(n.sendCOPPAEmail(n.form.email),c.location="/")}}],controllerAs:"coppaModalCtrl",showCancelButton:!1,showOkButton:!1,closeOnClick:!1})},this.underAgedUserCheck=function(e){+e>=+d().subtract(w,"years").valueOf()&&y.showCOPPADateValidationModal(),y.inputDateInMillis=e},this.validateDateOfBirth=function(){var e,t=new RegExp("^(0?[1-9]|1[012])\\/(0?[1-9]|[12][0-9]|3[01])\\/((19\\d{2})|([2-9]\\d{3}))$");if(y.form.dateOfBirth.length>=6&&y.form.dateOfBirth.length<=10&&(((e=d(y.form.dateOfBirth,["MM/DD/YYYY"],!0)).month()+1+"/"+e.date()+"/"+e.year()).match(t)&&e.isValid()))return y.signUpForm.dateOfBirth.$setValidity("dateOfBirth",!0),void y.underAgedUserCheck(e.valueOf());y.signUpForm.dateOfBirth.$setValidity("dateOfBirth",!1),y.showCOPPADateValidationModal()},this.goBack=function(){switch(this.mode){case"connectGoogle":this.goSignUpGoogle();break;case"connectMicrosoft":this.goSignUpMicrosoft();break;case"connectClever":this.goSignUpClever();break;case"connectClassLink":this.goSignUpClassLink();break;default:if(this.form={prepaidCode:a.prepaidCode},this.connection){if("google"===this.connection.type)return c.location.reload(),void m.showBusy();delete this.connection}this.mode="default"}},this.positionCodes=["sign_up_bulb_position_educator","sign_up_bulb_position_student","sign_up_bulb_position_administrator","sign_up_bulb_position_parent_guardian","sign_up_bulb_position_other"],l(this.positionCodes).then(function(e){y.positions=[{value:"Educator",display:e.sign_up_bulb_position_educator},{value:"Student",display:e.sign_up_bulb_position_student},{value:"Administrator",display:e.sign_up_bulb_position_administrator},{value:"FamilyMember",display:e.sign_up_bulb_position_parent_guardian},{value:"Other",display:e.sign_up_bulb_position_other}],-1!==["Educator","Student","Administrator","FamilyMember","Other"].indexOf(a.position)&&(y.form.position=a.position,y.positionDisabled=!0)}),this.goConnectGoogle=function(e){this.form={prepaidCode:a.prepaidCode},e&&(this.form.usernameOrEmail=e),this.mode="connectGoogle"},this.goConnectMicrosoft=function(){this.form={prepaidCode:a.prepaidCode,uniqueName:a.uniqueName},this.mode="connectMicrosoft"},this.goConnectClever=function(){this.form={prepaidCode:a.prepaidCode,uniqueName:a.uniqueName},this.mode="connectClever"},this.goConnectClassLink=function(){this.form={prepaidCode:a.prepaidCode,uniqueName:a.uniqueName},this.mode="connectClassLink"},this.goSignUpGoogle=function(){this.form={prepaidCode:a.prepaidCode,email:this.connection.email},this.mode="signUpGoogle"},this.goSignUpMicrosoft=function(){this.form={prepaidCode:a.prepaidCode,uniqueName:a.uniqueName},this.mode="signUpMicrosoft"},this.goSignUpClever=function(){this.form={prepaidCode:a.prepaidCode,uniqueName:a.uniqueName,email:a.email},this.mode="signUpClever"},this.goSignUpClassLink=function(){this.form={prepaidCode:a.prepaidCode,uniqueName:a.uniqueName,email:a.email},this.mode="signUpClassLink"},this.mode){case"connectGoogle":this.goConnectGoogle();break;case"connectMicrosoft":this.goConnectMicrosoft();break;case"connectClever":this.goConnectClever();break;case"connectClassLink":this.goConnectClassLink();break;case"signUpGoogle":this.goSignUpGoogle();break;case"signUpMicrosoft":this.goSignUpMicrosoft();break;case"signUpClever":this.goSignUpClever();break;case"signUpClassLink":this.goSignUpClassLink()}function A(e){if(e.error)o.debug("User did not sign into google");else{var t={client_name:"GoogleTokenClient",code:e.code,targetUrl:"/b/rest/auth/current"};p.one("auth","authenticate").customGET("",t).then(function(e){"not_found"===e.status?(y.connection=e.connection,h.validateField("emailUnique",y.connection.email).then(function(e){e.valid?y.goSignUpGoogle():y.goConnectGoogle(y.connection.email)})):y.handleSuccessfulSignUp(e,!1)},function(e){f.showError("Unable to sign up via google",e)})}}this.handleSuccessfulSignUp=function(e,t){if(e.enabled)if(t)if(y.organizationConnectionToken)p.all("token/member/"+y.organizationConnectionToken).post().then(function(e){if(a.targetUrl)r.go("successfulSignup",{setStorage:!0,reloadUrl:a.targetUrl});else if(e.bulbSchoolDirectMemberships>0)r.go("successfulSignup",{reloadUrl:"/b/account/billing/NEW"});else{var t="/"+e.username+"?welcome";e.email&&(t+="&verifyEmail"),r.go("successfulSignup",{reloadUrl:t})}});else if(a.targetUrl)r.go("successfulSignup",{setStorage:!0,reloadUrl:a.targetUrl});else{var n="/"+e.username+"?welcome";e.email&&(n+="&verifyEmail"),r.go("successfulSignup",{reloadUrl:n})}else a.targetUrl?function(){a.targetUrl.startsWith("/u/")&&localStorage.setItem("isAuthorized","isAuthorized");c.location.href=a.targetUrl}():c.location.href="/"+e.username;else y.showCOPPAactionModal()},this.submit=function(){var e={username:y.form.username,email:y.form.email,position:y.form.position,country:y.form.country,language:l.getLanguage(),dateOfBirth:y.inputDateInMillis,zipCode:y.form.zipCode,secretQuestion:y.form.secretQuestion,marketingOptIn:y.marketingOptIn,termsOfUseCheckbox:y.form.agreement,prepaidCode:y.form.prepaidCode};switch(y.form.grade&&(e.gradeLevel=y.form.grade),y.organizationConnectionToken&&(e.orgToken=y.organizationConnectionToken),y.mode){case"signUpGoogle":e.connection={type:"google"};break;case"signUpMicrosoft":e.connection={type:"mo365"};break;case"signUpClever":e.connection={type:"clever"};break;case"signUpClassLink":e.connection={type:"classLink"};break;case"default":e.firstName=y.form.firstName?y.form.firstName.trim():"",e.lastName=y.form.lastName?y.form.lastName.trim():"",e.displayName=(e.firstName+" "+e.lastName).substring(0,72).trim(),e.connection={type:"password",password:y.form.password}}e.institutionName=y.form.institutionName;var t=a.targetUrl?a.targetUrl:"/"+y.form.username;"buy"===y.subscribeMode&&"Educator"!==y.form.position?a.targetUrl="/b/account/planoptions":"tryit60"===y.subscribeMode?(e.trialDays=60,a.targetUrl=t+"?trial=true"):"tryit180"===y.subscribeMode&&(e.trialDays=180,a.targetUrl=t+"?trial=true"),m.showBusyDuring(p.all("accounts").post(e).then(function(e){y.handleSuccessfulSignUp(e,!0)},function(e){e.data.errorMap?i.signUpForm.handleRemoteErrors(e):f.showError(null,e)}))},this.connect=function(){y.signInUnsuccessful=!1;var e={usernameOrEmail:y.form.usernameOrEmail,password:y.form.password};m.showBusyDuring(p.all("accounts").customPOST(e,"connect").then(function(e){y.handleSuccessfulSignUp(e,!1)},function(e){e.data.errorMap?i.signUpForm.handleRemoteErrors(e):e.data&&"account_already_connected"===e.data.developerMessage?b.show({titleCode:"account_connection_info_title",bodyCode:"account_already_connected",showOkButton:!1,showCancelButton:!1}):e.data&&"sign_in_unsuccessful"===e.data.developerMessage?y.signInUnsuccessful=!0:f.showError(null,e)}))},this.signUpWithGoogle=function(){u.load("auth2",function(){u.auth2.authorize({client_id:v.google.client.id,scope:"email profile",response_type:"code",prompt:"select_account",cookie_policy:"single_host_origin"},A)})},this.signUpWithMicrosoft=function(){var e=a.targetUrl?"&targetUrl="+encodeURIComponent(a.targetUrl):"",t="free"!==y.subscribeMode?"&subscribeMode="+y.subscribeMode:"",n=y.organizationConnectionToken?"&orgToken="+y.organizationConnectionToken:"",o=y.form.prepaidCode?"&prepaidCode="+y.form.prepaidCode:"";c.location.href=v.context.name+"/b/auth/microsoft?entryMode=sign-up"+t+e+n+o},this.signUpWithClever=function(){var e=a.targetUrl?"&targetUrl="+encodeURIComponent(a.targetUrl):"",t="&subscribeMode="+y.subscribeMode,n=y.organizationConnectionToken?"&orgToken="+y.organizationConnectionToken:"",o=y.form.prepaidCode?"&prepaidCode="+y.form.prepaidCode:"";c.location.href=v.context.name+"/b/auth/clever?entryMode=sign-up"+t+e+n+o},this.toggleMarketing=function(){this.marketingOptIn=!this.marketingOptIn},this.showConnectionInfo=function(e){var t={titleCode:"account_connection_info_title",templateUrl:"connectioninfo.nested",showOkButton:!1,showCancelButton:!1,focusAfterClosed:e.currentTarget};b.show(t)},i.$watch("signUpCtrl.form.position",function(e,t){i.$broadcast("positionChange"),e!==t&&"Student"===t&&(delete y.form.dateOfBirth,delete y.inputDateInMillis)})}}();__awaiter=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(i,r){function a(e){try{l(o.next(e))}catch(e){r(e)}}function s(e){try{l(o.throw(e))}catch(e){r(e)}}function l(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(a,s)}l((o=o.apply(e,t||[])).next())})},__generator=this&&this.__generator||function(e,t){var n,o,i,r,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return r={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function s(r){return function(s){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,o&&(i=2&r[0]?o.return:r[0]?o.throw||((i=o.return)&&i.call(o),0):o.next)&&!(i=i.call(o,r[1])).done)return i;switch(o=0,i&&(r=[2&r[0],i.value]),r[0]){case 0:case 1:i=r;break;case 4:return a.label++,{value:r[1],done:!1};case 5:a.label++,o=r[1],r=[0];continue;case 7:r=a.ops.pop(),a.trys.pop();continue;default:if(!(i=(i=a.trys).length>0&&i[i.length-1])&&(6===r[0]||2===r[0])){a=0;continue}if(3===r[0]&&(!i||r[1]>i[0]&&r[1]<i[3])){a.label=r[1];break}if(6===r[0]&&a.label<i[1]){a.label=i[1],i=r;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(r);break}i[2]&&a.ops.pop(),a.trys.pop();continue}r=t.call(e,a)}catch(e){r=[6,e],o=0}finally{n=i=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,s])}}};function OffBoardingController(e,t,n,o,i,r,a){var s=this;function l(){n.dismissAll("cancel")}this.loginExists=t.instant("off_board_modal_login_exists"),this.currentUser=i.currentUser,this.currentUserPrefs=this.currentUser.prefs,this.submit=function(){r.showBusyDuring(a.one("accounts",s.currentUser.id).customPOST({email:s.newEmail},"emails").then(function(){s.currentUserPrefs.offBoarding.isEmailAdded=!0,a.one("accounts",s.currentUser.id).patch({prefs:s.currentUserPrefs}).catch(function(t){e.error("Failed to update the currentUsers offboarding isEmailAdded flag for account id: ",s.currentUser.id," with error: ",t)})}).catch(function(t){e.error("failed to update the currentUsers email with account id: ",s.currentUser.id," with error: ",t)}).then(function(){void 0!==s.newPasword&&a.one("accounts",s.currentUser.id).patch({password:s.newPasword}).catch(function(t){e.error("Failed to update the currentUsers password with account id: ",s.currentUser.id," with error: ",t)})})).finally(function(){l()})},this.remindMeLater=function(){var t=o.utc(Date.now())+6048e5;s.currentUserPrefs.offBoarding.remindMeLaterDate=t,a.one("accounts",s.currentUser.id).patch({prefs:s.currentUserPrefs}).catch(function(t){e.error("Failed to save offboarding remind me later date "+t)}),l()},this.alreadyHaveAccount=function(){s.currentUserPrefs.offBoarding.isEmailAdded=!0,a.one("accounts",s.currentUser.id).patch({prefs:s.currentUserPrefs}).catch(function(t){e.error("failed to save acceptance of latest terms "+t)}),l()}}function DeletedUnitBlockController(e,t,n,o,i,r,a,s,l,c,u,d,p,h,g){var m=this;this.deletedUnits=[],this.isSingleAuthor="GroupUnit"!==this.compositeUnit.unitType,this.isSingleType="CompositeUnit"===this.compositeUnit.unitType,this.restoreIndex=void 0,this.infoType=this.compositeUnit.unitType,this.collectionId=void 0;var f={fontAwesomeCode:"fas fa-trash-alt",titleCode:"permanent_delete_heading",bodyCode:"permanent_delete_body",okButtonCode:"button_delete",showCancelButton:!0,windowClass:"updated-modal-design red-button-updated-modal bulb-permanent-deleted-modal"},b={fontAwesomeCode:"fa fa-exclamation-triangle",titleCode:"soft_delete_page_limit_heading",bodyCode:"soft_delete_page_limit_body",okButtonCode:"button_upgrade",cancelButtonCode:"button_restore",windowClass:"updated-modal-design bulb-snapshot-pdf bulb-restore-modal"},v={fontAwesomeCode:"fa fa-exclamation-triangle",titleCode:"soft_delete_storage_limit_heading",bodyText:i.instant("soft_delete_storage_limit_body",{storage:p(a.currentUser.features.StorageFeature.maxStorageBytes,{factor:1024})}),okButtonCode:"button_upgrade",cancelButtonCode:"button_view_media",windowClass:"updated-modal-design bulb-snapshot-pdf bulb-restore-modal"};function C(e){switch(e.unitType){case"CompositeUnit":return"Collection";case"DraftPageUnit":case"PublishedPageUnit":case"ArchivePageUnit":return"Page";default:return e.unitType}}this.$onInit=function(){this.currentUser=a.currentUser,this.currentUserPrefs=m.currentUser.prefs,this.isAdmin=c.isAdmin(),n.CONFIG=h,n.viewSwitcherService=s,this.permanentlyDeleteInfo=i.instant("soft_delete_after_days",{days:c.getDaysForDelete()}),this.getDeletedUnitList()},this.showToastMessage=function(e,t,o){var a="";if("restore"===e){var l=i.instant("soft_delete_view_now_text");a=i.instant("soft_delete_unit_restore_toast",{unitType:t})+'<br/><a href="u/'+o+'"> '+l+"</a></span>"}else a=i.instant("soft_delete_unit_delete_toast",{unitType:t});r.show({theme:"dark",timeout:5e3,close:!1,icon:"far fa-trash-restore-alt",message:a,position:"bottomRight",progressBarColor:"rgb(0,174,239)"}),n.viewSwitcherService=s},this.delete=function(e){d.show(f).then(function(t){var n=e.softDelete?"force":"permanent";l.showBusyDuring(c.delete(e.id,n).then(function(t){m.showToastMessage("delete",C(e)),m.getDeletedUnitList()},function(e){u.showError(e)}))},function(e){"cancel"===e&&"backdrop click"===e&&u.showError("Error occurred during delete",e)})},this.restore=function(i,r,a,s){m.restoreIndex=r,function(o){var i=n.viewSwitcherService.isTile("profile"),r="#block-"+(i?"tile":"list")+(o?"-soft":"-hard"),a=t.find(r+m.restoreIndex);e(a,{addClass:"fadeInAndOut"}).start(),i?function(n){var o=t.find(n?".bulb-soft-delete-tile":".bulb-hard-delete-tile"),i="#block-tile"+(n?"-soft":"-hard");if(o&&o.length-1!==m.restoreIndex)for(var r=0;r<o.length;r++)if(r>m.restoreIndex){var a=t.find(i+r);if(r%4!=0){var s=t.find(i+(r>0?r-1:0)).width();e(a,{from:{right:"0px"},to:{right:s+15+"px"},duration:1}).start()}else a.css({position:"relative"}),a.animate({opacity:0,left:-20},1e3,function(){})}}(o):function(n){var o=t.find(n?".bulb-soft-delete-list":".bulb-hard-delete-list"),i="#block-list"+(n?"-soft":"-hard");if(o&&o.length-1!==m.restoreIndex)for(var r=0;r<o.length;r++)if(r>m.restoreIndex){var a=t.find(i+r),s=t.find(i+r).offset().top-t.find(i+(r-1)).offset().top,l=e(a,{addClass:"fadeOutTop",from:{top:"0px"},to:{top:-s+"px"},duration:3});l.start()}}(o)}(a),c.restore(i,s).then(function(e){m.showToastMessage("restore",C(e),e.path),m.getDeletedUnitList()},function(e){e.data&&e.data.developerMessage?"page_limit_reached"===e.data.developerMessage?d.show(b).then(function(){o.go("account.planlist")},function(e){"cancel"===e&&m.restore(i,r,a,!0)}):"storage_limit_reached"===e.data.developerMessage&&d.show(v).then(function(){o.go("account.planlist")},function(e){"cancel"===e&&o.go("assetlibrary")}):u.showError("Error occurred during restore",e)})},n.$on("openDeletedCollection",function(e,t){m.infoType=t.unitType,m.collectionId=t.id,m.getDeletedUnitList()}),this.getDeletedUnitList=function(){"UserUnit"===m.infoType||"DeletedUserUnit"===m.infoType?(this.collectionId=void 0,n.$parent.showBreadcrumbForDeletedUnit(m.compositeUnit,m.infoType),l.showBusyDuring(c.getDeletedUnits(c.authorAccountId).then(function(e){m.deletedUnits=e},function(e){u.showError(e)}))):"CompositeUnit"===m.infoType&&m.collectionId&&l.showBusyDuring(c.getDeletedUnit(m.collectionId).then(function(e){if(m.deletedUnits=[],e){var t=e.unitDTOs[0],o={id:m.compositeUnit.id,unitType:m.compositeUnit.unitType,path:m.compositeUnit.path,ownerDisplayName:m.compositeUnit.ownerDisplayName,ownerUsername:m.compositeUnit.ownerUsername};t.ancestorUnits.splice(0,0,o),m.deletedUnits=t.children,n.$parent.showBreadcrumbForDeletedUnit(t)}},function(e){u.showError(e)}))}}!function(){"use strict";function e(e,t,n,o,i,r,a,s,l,c,u,d){var p=this,h=["email","https://www.googleapis.com/auth/classroom.courses.readonly","https://www.googleapis.com/auth/classroom.rosters.readonly","https://www.googleapis.com/auth/classroom.profile.emails"],g=["https://www.googleapis.com/discovery/v1/apis/classroom/v1/rest"];this.oauthToken=null,this.courses=[];var m=!1;u.client&&u.auth&&(m=!0);var f=function(e){var n=t.defer();return e&&!e.error?(p.oauthToken=e.access_token,d.one("accounts/verifyGoogleConnection/GOOGLE").get({code:e.code}).then(function(){n.resolve()}).catch(function(e){p.showError(e),n.reject(e)})):n.reject(),n.promise};function b(){var e=t.defer();return m&&(u.auth.setToken(null),p.oauthToken=null,u.auth.signOut(),u.auth.authorize({client_id:c.google.client.id,scope:h,response_type:"code token",discovery_docs:g,prompt:"select_account"},function(t){f(t).then(e.resolve)})),e.promise}function v(e,n){var o=t.defer();return u.client.request({path:l.COURSES_URL+n}).then(function(t){var n=t.result.courses;n&&function(e,t){for(var n=0;n<e.length;n++)a.groups.some(function(t){return t.googleCourseId===e[n].id})||(e[n].ownerId=t.id,e[n].ownerEmail=t.email,p.courses.push(e[n]))}(n,e),o.resolve(t.result.nextPageToken)},function(e){r.showError("Cannot fetch courses from classroom",e),o.reject()}),o.promise}var C=function(){p.courses=[];var e,o="",i=!1,a=t.defer();return u.client.request({path:l.USER_INFO_URL}).then(function(t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(n){switch(n.label){case 0:e=t.result,n.label=1;case 1:return n.trys.push([1,3,,4]),[4,v(e,o)];case 2:return o=n.sent(),[3,4];case 3:return n.sent(),i=!0,[3,4];case 4:if(o)return[3,1];n.label=5;case 5:return a.resolve(),i||(p.courses.length>0?s.open({titleCode:"",template:"<bulb-google-classroom-import></bulb-google-classroom-import>",windowClass:"bulb-onboarding-modal-with-close scrollable bulb-classroom-modal",closeOnClick:!0,showOkButton:!1,showCancelButton:!1}):(console.log("No courses found."),s.showMessage("import_class_from_classroom_no_more_class"))),[2]}})})},function(e){var t=n.instant("import_class_from_classroom_error_import");401==e.result.error.code&&(t=n.instant("import_class_from_classroom_error_authentication_failed")),r.showError(t),a.reject()}).catch(function(e){a.reject()}),a.promise};this.importGroupFromClassroom=function(){b().then(function(e){i.showBusyDuring(C())})},this.reSyncGroupWithClassroom=function(e){var n=t.defer();return b().then(function(){u.client.request({path:l.COURSE_BY_ID_URL+e}).then(function(e){"ACTIVE"===e.result.courseState?n.resolve():(s.showMessage("import_class_from_classroom_inactive_class"),n.reject())},function(t){r.error("Cannot fetch courses from classroom with this courseId"+e,t),n.reject()})}),n.promise},this.showError=function(e){if(409===e.status&&e.data&&e.data.developerMessage){var t=e.data.developerMessage.split(","),o={email:"<strong>"+t[0]+"</strong>"},i=c.base.url+"/"+t[1];r.showError(n.instant("account_already_exists_error",o)+'<a href="'+i+'" target="_blank">'+i+"</a>",e)}else 409===e.status&&e.data&&!e.data.developerMessage?r.showError(n.instant("import_class_from_classroom_error_conflict"),e):r.showError(n.instant("import_class_from_classroom_error_import"),e)}}e.$inject=["$document","$q","$translate","$window","BulbBusyService","BulbErrorService","BulbGroupService","BulbModalService","CLASSROOM","CONFIG","google","Restangular"],angular.module("bulbApp.groupModule").constant("CLASSROOM",{COURSES_URL:"https://classroom.googleapis.com/v1/courses?teacherId=me&courseStates=ACTIVE&pageToken=",COURSE_BY_ID_URL:"https://classroom.googleapis.com/v1/courses/",USER_INFO_URL:"https://www.googleapis.com/oauth2/v1/userinfo"}).service("BulbGoogleClassroomImportService",e)}(),angular.module("bulbApp.assetLibraryModule").constant("UnsplashNameThreshold",10).component("imageAsset",{templateUrl:["CONFIG",function(e){return e.resource.cdnRoot+"ajs/components/image/image-asset.html"}],bindings:{imageUrl:"@",imageClass:"@",imageMetaInfo:"=",creditType:"@",ngStyle:"<",ngClass:"<",ngClick:"&",imageId:"@"},controller:["$window","$scope","BulbAssetLibraryUnsplashService","CONFIG","UnsplashNameThreshold",function(e,t,n,o,i){var r=this;this.id="",this.photographerProfileUrl="",this.photographerName="",this.utmUrl="",this.unsplashUrl="",t.$watch(function(){return r.imageMetaInfo},function(e){e&&e.source===o.unsplash.label&&(r.photographerName=r.trimName(e),r.utmUrl="?utm_source="+o.unsplash.client.application.name+"&utm_medium=referral",r.photographerProfileUrl=""+e.photographerProfileUrl+r.utmUrl,r.unsplashUrl="https://unsplash.com"+r.utmUrl,r.id=e.id)}),this.redirectTo=function(t,n){e.open(t,"_blank"),n.stopPropagation()},this.$onInit=function(){this.imageMetaInfo&&this.imageMetaInfo.source===o.unsplash.label&&(this.photographerName=r.trimName(this.imageMetaInfo),this.photographerProfileUrl=this.imageMetaInfo.photographerProfileUrl,n.updateViewCount(this.imageMetaInfo.imageId))},this.trimName=function(e){return"circularImage"===e.assetDefinitionsKey&&e.photographerName.length>=i?e.photographerName.substring(0,i):e.photographerName}}]}),angular.module("bulbApp.offBoardingModule",["restangular","bulbApp.configModule"]),angular.module("bulbApp.offBoardingModule").component("bulbOffboarding",{templateUrl:["CONFIG",function(e){return e.resource.cdnRoot+"ajs/components/offboarding/offboarding-modal.html"}],controllerAs:"offBoardingCtrl",controller:OffBoardingController}),angular.module("bulbApp.blockModule").component("bulbDeletedUnitBlock",{templateUrl:["CONFIG",function(e){return e.resource.cdnRoot+"ajs/components/block/deletedunitblock/deletedunitblock.html"}],bindings:{compositeUnit:"="},controllerAs:"deletedUnitBlockCtrl",controller:DeletedUnitBlockController}),function(){"use strict";function e(e,t,n,o,i){var r=this;this.authorAccountId=null,this.isAdmin=function(){return i.intersection(n.currentUser.roles,["ADMIN"]).length>0},this.getDeletedUnitCount=function(){var n=e.defer();return t.one("accounts/"+r.authorAccountId+"/deletedUnitsCount").get().then(function(e){n.resolve(e)}).catch(function(e){n.reject(e)}),n.promise},this.getDeletedUnits=function(n){var o=e.defer();return t.one("accounts/"+n+"/deletedUnits").get().then(function(e){o.resolve(e)}).catch(function(e){o.reject(e)}),o.promise},this.delete=function(n,o){var i=e.defer();return t.one("units",n).remove({mode:o}).then(function(e){i.resolve(e)}).catch(function(e){i.reject(e)}),i.promise},this.restore=function(n,o){var i=e.defer(),r=o?"?unpublished=true":"";return t.one("units/"+n+"/restore"+r).post().then(function(e){i.resolve(e)}).catch(function(e){i.reject(e)}),i.promise},this.getDeletedUnit=function(n){var o=e.defer();return t.one("units",n).get({deleted:!0}).then(function(e){o.resolve(e)}).catch(function(e){o.reject(e)}),o.promise},this.getDaysForDelete=function(){var e=24*Math.pow(60,2),t=Number(o.unit.softDeleteSeconds-o.unit.hardDeleteSeconds);return t<=e?1:Math.floor(t/e)}}e.$inject=["$q","Restangular","BulbAuthService","CONFIG","_"],angular.module("bulbApp.blockModule").service("BulbDeletedUnitService",e)}(),angular.module("bulbApp.offlineModule",[]).factory("Offline",["$window",function(e){return e.Offline}]),angular.module("bulbApp.offlineModule").component("bulbOfflineAlertIndicator",{controller:["$modalStack","BulbModalService","Offline",function(e,t,n){var o,i=jQuery(".online"),r=jQuery(".offline");jQuery(".offline-ui-retry").removeAttr("href"),n.on("down",function(){o=t.alert({templateUrl:"offlinemodalwindow.nested",offline:!0,fontAwesomeCode:"fas fa-wifi-slash",backdrop:"static",titleCode:"offline_indicator_code_header",bodyCode:"offline_indicator_body_instructions",okButtonCode:"button_ok",windowClass:"updated-modal-design bulb-offline-alert-modal"})}),n.on("confirmed-down",function(){return i.fadeOut(function(){return r.fadeIn()})}),n.on("confirmed-up",function(){return o&&o.close("cancel"),r.fadeOut(function(){return i.fadeIn()})})}]}),function(){"use strict";angular.module("bulbApp.bootstrapModule",[])}(),function(){"use strict";function e(e,t,n){this.open=function(){e.open({templateUrl:n.resource.cdnRoot+"ajs/components/sandbox/sandbox.html",controller:"SandboxController as sandboxCtrl"})},this.percent=0,this.files=[],this.items=["one","two","three","four","five"],this.multiParams={name:null,assetDefinitionsKey:"tileImages"},this.url=n.context.name+"/b/image/upload/angular",this.addFile=function(){var e=this.files[0];this.multiParams.name=e.name}}e.$inject=["$modal","$cookies","CONFIG"],angular.module("bulbApp.sandboxModule",["mm.foundation","ui.router","bulbApp.authModule","bulbApp.configModule","bulbApp.utilsModule"]).controller("SandboxController",e)}(),angular.module("ui-templates",[]);
//# sourceMappingURL=scripts.js.map